<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–ª–∞–¥ v92 - Speed</title>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --primary: #4f46e5;
            --success: #10b981; --danger: #ef4444; --text-main: #1e293b; --text-sub: #64748b;
        }
        .size-grid, .qty-badge, #logoutForm, .admin-only { display: none !important; }
        body.auth-ok .size-grid.active { display: grid !important; }
        body.auth-ok .qty-badge { display: inline-block !important; }
        body.auth-ok #logoutForm { display: block !important; }
        body.auth-ok .admin-only { display: block !important; }
        .qty-guest { display: inline-block; font-weight: 800; color: var(--success); }
        body.auth-ok .qty-guest { display: none !important; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 100px; }
        .category-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; position: sticky; top: 0; z-index: 1000; background: var(--bg); padding: 5px 0; }
        .btn-cat { padding: 12px 2px; border: none; border-radius: 10px; background: var(--card); font-size: 11px; font-weight: 800; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-cat.active { background: var(--primary); color: #fff; }
        .size-grid { grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-action { padding: 14px; border-radius: 12px; border: 2px solid var(--success); background: #fff; color: var(--success); font-weight: 800; }
        .main-card { background: var(--card); border-radius: 18px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table td { padding: 14px; border-bottom: 1px solid #f1f5f9; }
        .qty-badge { background: #f0fdf4; padding: 8px 12px; border-radius: 10px; font-weight: 800; color: var(--success); border: 1px solid #dcfce7; }
        .crit-bg { background: #fff1f2 !important; }
        .crit-text { color: var(--danger) !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; align-items: flex-start; justify-content: center; padding-top: 20px; overflow-y: auto; }
        .modal-box { background: #fff; width: 90%; max-width: 360px; padding: 25px; border-radius: 25px; text-align: center; }
        input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 18px; text-align: center; box-sizing: border-box; }
        .btn-push { background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 14px; width: 100%; font-weight: 800; margin-top: 10px; }
        .group-fas { background: #f1f5f9; border-radius: 12px; padding: 10px; margin-top: 8px; font-size: 13px; text-align: left; }
        .group-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #cbd5e1; padding: 6px 0; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 28px; border: none; z-index: 4000; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body id="appBody">

    <div class="category-menu">
        <button id="t-–ü–∞–∫–µ—Ç—ã" class="btn-cat" onclick="setCategory('–ü–∞–∫–µ—Ç—ã')">–ü–∞–∫–µ—Ç—ã</button>
        <button id="t-–ü–ª–µ–Ω–∫–∞" class="btn-cat" onclick="setCategory('–ü–ª–µ–Ω–∫–∞')">–ü–ª–µ–Ω–∫–∞</button>
        <button id="t-–°–∫–æ—Ç—á" class="btn-cat" onclick="setCategory('–°–∫–æ—Ç—á')">–°–∫–æ—Ç—á</button>
        <button id="t-–§–∞—Å–æ–≤–∫–∞" class="btn-cat" onclick="setCategory('–§–∞—Å–æ–≤–∫–∞')">–§–∞—Å–æ–≤–∫–∞</button>
        <button id="t-History" class="btn-cat" onclick="setCategory('History')">–ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="btn-cat" style="visibility:hidden"></button>
    </div>

    <div id="g-–§–∞—Å–æ–≤–∫–∞" class="size-grid"><button class="btn-action" style="grid-column: 1/3; background: var(--primary); color: #fff; border: none;" onclick="openFasovkaModal()">‚ûï –ù–û–í–ê–Ø –°–ú–ï–ù–ê</button></div>
    <div id="g-–ü–ª–µ–Ω–∫–∞" class="size-grid"><div id="plenkaCont" style="display: contents;"></div></div>
    <div id="g-–ü–∞–∫–µ—Ç—ã" class="size-grid">
        <button class="btn-action" onclick="openSimpleModal('300√ó400')">300√ó400</button>
        <button class="btn-action" onclick="openSimpleModal('370√ó500')">370√ó500</button>
        <button class="btn-action" onclick="openSimpleModal('400√ó500')">400√ó500</button>
        <button class="btn-action" onclick="openSimpleModal('420√ó550')">420√ó550</button>
    </div>
    <div id="g-–°–∫–æ—Ç—á" class="size-grid"><button class="btn-action" onclick="openSimpleModal('–°–∫–æ—Ç—á 360–≥')">–°–∫–æ—Ç—á 360–≥</button></div>

    <div id="display">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <button class="fab" onclick="handleFab()">‚öôÔ∏è</button>

    <div id="modalAuth" class="modal"><div class="modal-box"><h2>–î–æ—Å—Ç—É–ø</h2><div id="loginForm"><input type="email" id="email" placeholder="Email"><input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-push" onclick="doLogin()">–í–û–ô–¢–ò</button></div><div id="logoutForm"><p style="color:var(--success); font-weight:bold;">–ê–¥–º–∏–Ω</p><button class="btn-push" style="background:var(--danger)" onclick="doLogout()">–í–´–ô–¢–ò</button></div><button style="background:none;border:none;margin-top:15px;color:var(--text-sub)" onclick="closeAll()">–ó–ê–ö–†–´–¢–¨</button></div></div>
    <div id="modalSimple" class="modal"><div class="modal-box"><h2 id="simpleLabel"></h2><input type="number" id="simpleVal" inputmode="decimal"><button id="btnSimpleConfirm" class="btn-push" onclick="requestConfirm()">–î–û–ë–ê–í–ò–¢–¨</button><button style="background:none;border:none;margin-top:15px;color:var(--text-sub)" onclick="closeAll()">–û–¢–ú–ï–ù–ê</button></div></div>
    <div id="modalEdit" class="modal"><div class="modal-box"><h2 id="editLabel"></h2><input type="number" id="editVal" inputmode="decimal"><button class="btn-push" onclick="saveEdit()">–û–ë–ù–û–í–ò–¢–¨</button><button class="btn-push" style="background:var(--danger)" onclick="deleteLine()">–£–î–ê–õ–ò–¢–¨ –í–°–Å</button><button style="background:none;border:none;margin-top:15px;color:var(--text-sub)" onclick="closeAll()">–û–¢–ú–ï–ù–ê</button></div></div>
    <div id="modalFas" class="modal"><div class="modal-box"><h2>–°–º–µ–Ω–∞</h2><button class="btn-push" style="background:#f1f5f9;color:#333" onclick="openSub('modalListProd')"><span id="l-prod">–ü—Ä–æ–¥—É–∫—Ç</span></button><button class="btn-push" style="background:#f1f5f9;color:#333" onclick="openSub('modalListSize')"><span id="l-size">–†–∞–∑–º–µ—Ä</span></button><input type="number" id="f1" placeholder="–°—ã—Ä—å–µ (–∫–≥)"><input type="number" id="f2" placeholder="–í—ã—Ö–æ–¥ (—à—Ç)"><input type="number" id="f3" placeholder="–í–∑—è–ª (–∫–≥)"><input type="number" id="f4" placeholder="–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)"><button class="btn-push" onclick="saveFasovka()">–°–û–•–†–ê–ù–ò–¢–¨</button><button id="btnDelFas" class="btn-push" style="background:var(--danger);display:none" onclick="delFasovka()">–£–î–ê–õ–ò–¢–¨</button><button style="background:none;border:none;margin-top:15px;color:var(--text-sub)" onclick="closeAll()">–û–¢–ú–ï–ù–ê</button></div></div>
    <div id="modalListProd" class="modal"><div class="modal-box"><h3>–ü—Ä–æ–¥—É–∫—Ç—ã</h3><div id="listP" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div></div></div>
    <div id="modalListSize" class="modal"><div class="modal-box"><h3>–†–∞–∑–º–µ—Ä—ã</h3><div id="listS" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const cfg = { apiKey: "AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q", databaseURL: "https://myproductionapp-bd872-default-rtdb.firebaseio.com", projectId: "myproductionapp-bd872", appId: "1:606510957266:web:5a91f5bdadae4aa330e30b" };
        if (!firebase.apps.length) firebase.initializeApp(cfg);
        const auth = firebase.auth(), db = firebase.database();

        const PL = ["–ê—Ä–Ω–∞—É—Ç–∫–∞", "–ê—Ä—Ç–µ–∫", "–Ø—á–∫–∞", "–ü—à–µ–Ω–∏—á–∫–∞", "–ö—É–∫—É—Ä—É–∑–∞", "–ì–æ—Ä–æ—Ö", "–ú–∞–Ω–∫–∞", "–•–ª–æ–ø—å—è", "–ì—Ä–µ—á–∫–∞", "–†–∏—Å –¥–ª", "–†–∏—Å –∫—Ä", "–†–∏—Å –ø—Ä", "–ü–µ—Ä–ª–æ–≤–∫–∞", "–ü—à–æ–Ω–æ", "–ö—É–∫.–º—É–∫–∞", "–ë–∞—Å–º–∞—Ç–∏ –≥", "–ë–∞—Å–º–∞—Ç–∏ –∫", "–ö—É—Ç—è", "–ö—É—Å –∫—É—Å", "–ù—É—Ç", "–ß–µ—á–µ–≤–∏—Ü–∞", "–ë—É–ª–≥—É—Ä"];
        const SZ = ["300√ó400", "370√ó500", "400√ó500", "420√ó550"];
        let curCat = '–ü–∞–∫–µ—Ç—ã', selP = '', selS = '', edId = null, isConf = false, sName = '', edTot = 0;

        function init() {
            const pDiv = document.getElementById('listP'), sDiv = document.getElementById('listS'), cDiv = document.getElementById('plenkaCont');
            PL.forEach(p => {
                pDiv.innerHTML += `<div style="padding:10px;background:#f8fafc;border-radius:10px;font-size:12px;font-weight:bold" onclick="setP('${p}')">${p}</div>`;
                cDiv.innerHTML += `<button class="btn-action" onclick="openSimpleModal('${p}')">${p}</button>`;
            });
            SZ.forEach(s => sDiv.innerHTML += `<div style="padding:10px;background:#f8fafc;border-radius:10px;font-size:12px;font-weight:bold" onclick="setS('${s}')">${s}</div>`);
            setCategory('–ü–∞–∫–µ—Ç—ã');
        }

        function setCategory(c) { 
            curCat = c; 
            document.querySelectorAll('.btn-cat').forEach(b => b.classList.toggle('active', b.id === 't-'+c)); 
            document.querySelectorAll('.size-grid').forEach(g => { g.classList.remove('active'); if(g.id === 'g-'+c) g.classList.add('active'); });
            load(); 
        }

        function load() {
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
            db.ref('inventory').off();
            db.ref('inventory').on('value', snap => {
                const all = snap.val() || {}, cont = document.getElementById('display');
                if (curCat === 'History') {
                    renderHistory(all);
                } else if (curCat === '–§–∞—Å–æ–≤–∫–∞') {
                    renderFasovka(all['–§–∞—Å–æ–≤–∫–∞'] || {});
                } else {
                    renderStock(all[curCat] || {});
                }
            });
        }

        function renderStock(data) {
            const totals = {};
            Object.values(data).forEach(v => { if(v.size) totals[v.size] = (totals[v.size] || 0) + v.amount; });
            let h = '<div class="main-card"><table class="data-table">';
            Object.keys(totals).sort().forEach(k => {
                let v = totals[k];
                let isCrit = (curCat==='–ü–∞–∫–µ—Ç—ã' && v<3000) || (curCat==='–ü–ª–µ–Ω–∫–∞' && v<60) || (curCat==='–°–∫–æ—Ç—á' && v<30);
                h += `<tr class="${isCrit?'crit-bg':''}"><td><b class="${isCrit?'crit-text':''}">${k}</b></td><td align="right"><div class="qty-guest ${isCrit?'crit-text':''}">${v.toFixed(2)}</div><div class="qty-badge ${isCrit?'crit-text':''}" onclick="openEdit('${k}',${v})">${v.toFixed(2)}</div></td></tr>`;
            });
            document.getElementById('display').innerHTML = h + '</table></div>';
        }

        function renderFasovka(data) {
            let h = "";
            Object.entries(data).sort((a,b) => b[1].date.localeCompare(a[1].date)).forEach(([id, v]) => {
                const user = v.author ? v.author.split('@')[0] : '–≥–æ—Å—Ç—å';
                const rashod = (parseFloat(v.vzial || 0) - parseFloat(v.ostatok || 0)).toFixed(2);
                h += `<div style="background:white;border-radius:15px;padding:15px;margin-bottom:10px;border-left:5px solid var(--primary)" onclick="editFasovka('${id}')">
                    <div style="font-size:10px;color:#999;float:right">${user} | ${new Date(v.date).toLocaleDateString('ru-RU')}</div>
                    <b>${v.name}</b><div style="color:var(--success);font-weight:800;margin:5px 0">${v.prihod}–∫–≥ | ${v.vyhod}—à—Ç</div>
                    <div style="font-size:12px;color:#666">${v.size} | <b style="color:var(--danger)">–†–∞—Å—Ö–æ–¥: ${rashod}–∫–≥</b></div></div>`;
            });
            document.getElementById('display').innerHTML = h || "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π";
        }

        function renderHistory(all) {
            let combined = {};
            ['–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á'].forEach(cat => {
                if (all[cat]) Object.entries(all[cat]).forEach(([id, val]) => {
                    if (!val.date) return;
                    const key = val.linkedId || 's_' + id;
                    if (!combined[key]) combined[key] = { date: val.date, author: val.author, isFas: !!val.linkedId, items: [] };
                    combined[key].items.push({ ...val, cat });
                });
            });
            const sorted = Object.values(combined).sort((a,b) => new Date(b.date) - new Date(a.date));
            let h = '<div class="main-card"><table class="data-table">';
            sorted.forEach(g => {
                const dt = new Date(g.date).toLocaleString('ru-RU');
                const user = g.author ? g.author.split('@')[0] : '–≥–æ—Å—Ç—å';
                h += `<tr><td><div style="font-size:10px;color:#999">${dt} | –ê–≤—Ç–æ—Ä: ${user}</div>${g.isFas?'<b style="color:var(--primary)">üè≠ –§–∞—Å–æ–≤–∫–∞</b><div class="group-fas">':''}`;
                g.items.forEach(i => {
                    if(g.isFas) h += `<div class="group-item"><span>${i.cat}: ${i.size}</span><span style="color:var(--danger)">${i.amount.toFixed(2)}</span></div>`;
                    else h += `<b>${i.cat}</b>: ${i.size}</td><td align="right" style="color:${i.amount>0?'var(--success)':'var(--danger)'};font-weight:800">${i.amount>0?'+':''}${i.amount.toFixed(2)}`;
                });
                h += g.isFas ? `</div></td><td></td></tr>` : `</td></tr>`;
            });
            document.getElementById('display').innerHTML = h + '</table></div>';
        }

        function handleFab() { openSub('modalAuth'); }
        function openSub(id) { document.getElementById(id).style.display = 'flex'; }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); isConf = false; }
        function getAuthor() { return auth.currentUser ? auth.currentUser.email : "–≥–æ—Å—Ç—å"; }

        function openSimpleModal(n) { if(!auth.currentUser) return; sName = n; document.getElementById('simpleLabel').innerText = n; document.getElementById('simpleVal').value = ""; openSub('modalSimple'); }
        function requestConfirm() {
            const v = parseFloat(document.getElementById('simpleVal').value);
            if(!v) return;
            if(!isConf) { isConf = true; document.getElementById('btnSimpleConfirm').innerText = "–£–í–ï–†–ï–ù–´?"; } 
            else { db.ref('inventory/'+curCat).push({ size: sName, amount: v, date: new Date().toISOString(), author: getAuthor() }); closeAll(); }
        }
        function openEdit(n, c) { if(!auth.currentUser) return; sName = n; edTot = c; document.getElementById('editLabel').innerText = n; document.getElementById('editVal').value = c.toFixed(2); openSub('modalEdit'); }
        function saveEdit() { const v = parseFloat(document.getElementById('editVal').value); if(isNaN(v)) return; db.ref('inventory/'+curCat).push({ size: sName, amount: v - edTot, date: new Date().toISOString(), author: getAuthor() }); closeAll(); }
        async function deleteLine() { if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) { const s = await db.ref('inventory/'+curCat).once('value'); s.forEach(c => { if(c.val().size===sName) c.ref.remove(); }); closeAll(); } }
        
        function openFasovkaModal() { if(!auth.currentUser) return; edId = null; document.getElementById('btnDelFas').style.display = 'none'; ['f1','f2','f3','f4'].forEach(i => document.getElementById(i).value = ""); openSub('modalFas'); }
        function editFasovka(id) { 
            if(!auth.currentUser) return; edId = id; 
            db.ref('inventory/–§–∞—Å–æ–≤–∫–∞/'+id).once('value', s => { 
                const v = s.val(); selP = v.name; selS = v.size;
                document.getElementById('l-prod').innerText = v.name; document.getElementById('l-size').innerText = v.size;
                document.getElementById('f1').value = v.prihod; document.getElementById('f2').value = v.vyhod;
                document.getElementById('f3').value = v.vzial; document.getElementById('f4').value = v.ostatok;
                document.getElementById('btnDelFas').style.display = 'block'; openSub('modalFas'); 
            }); 
        }
        
        async function saveFasovka() { 
            const v1=parseFloat(document.getElementById('f1').value)||0, v2=parseFloat(document.getElementById('f2').value)||0, v3=parseFloat(document.getElementById('f3').value)||0, v4=parseFloat(document.getElementById('f4').value)||0; 
            if(!selP || !selS) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å—ë!"); 
            const ts = new Date().toISOString(), mail = getAuthor(); 
            if(edId) { for(let c of ['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á']) { const snap = await db.ref('inventory/'+c).once('value'); snap.forEach(x => { if(x.val().linkedId === edId) x.ref.remove(); }); } } 
            const ref = edId ? db.ref('inventory/–§–∞—Å–æ–≤–∫–∞/'+edId) : db.ref('inventory/–§–∞—Å–æ–≤–∫–∞').push(); 
            const nId = edId || ref.key;
            await ref.set({ name: selP, prihod: v1, vyhod: v2, vzial: v3, ostatok: v4, size: selS, date: ts, author: mail }); 
            if(v2 > 0) { 
                db.ref('inventory/–ü–∞–∫–µ—Ç—ã').push({ size: selS, amount: -(v2*0.103), date: ts, linkedId: nId, author: mail }); 
                db.ref('inventory/–°–∫–æ—Ç—á').push({ size: '–°–∫–æ—Ç—á 360–≥', amount: -((v2*0.12)/360), date: ts, linkedId: nId, author: mail }); 
            } 
            if((v3-v4) !== 0) db.ref('inventory/–ü–ª–µ–Ω–∫–∞').push({ size: selP, amount: -(v3-v4), date: ts, linkedId: nId, author: mail }); 
            closeAll(); 
        }

        async function delFasovka() {
            if(!edId || !confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
            for(let c of ['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á']) {
                const snap = await db.ref('inventory/'+c).once('value');
                snap.forEach(x => { if(x.val().linkedId === edId) x.ref.remove(); });
            }
            await db.ref('inventory/–§–∞—Å–æ–≤–∫–∞/'+edId).remove();
            closeAll();
        }

        function setP(p) { selP = p; document.getElementById('l-prod').innerText = p; document.getElementById('modalListProd').style.display='none'; }
        function setS(s) { selS = s; document.getElementById('l-size').innerText = s; document.getElementById('modalListSize').style.display='none'; }
        function doLogin() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e => alert(e.message)); closeAll(); }
        function doLogout() { auth.signOut().then(() => location.reload()); }
        
        init(); 
        auth.onAuthStateChanged((u) => { 
            const b = document.getElementById('appBody');
            if(u) b.classList.add('auth-ok'); else b.classList.remove('auth-ok');
        });
    </script>
</body>
</html>
