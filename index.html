<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>–°–∫–ª–∞–¥ v677 "Auth"</title><script>window.onerror=function(m,u,l){alert("–û–®–ò–ë–ö–ê:\n"+m+"\n–°—Ç—Ä–æ–∫–∞: "+l);return false;};</script><link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png"><style>*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:0}:root{--bg:#f8fafc;--p:#4338ca;--d:#dc2626;--s:#059669;--t:#0f172a;--w:#fff;--blue:#2563eb;--red:#e11d48}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:5px;padding-bottom:80px;color:var(--t);overflow-x:hidden;width:100vw}#lockScreen{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:opacity .3s}.lock-hidden{opacity:0;pointer-events:none}.lock-logo{width:100px;margin-bottom:20px}.lock-title{font-size:16px;font-weight:900;color:#475569;letter-spacing:2px;margin-bottom:30px;text-transform:uppercase}.lock-inp{width:100%;max-width:250px;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e1;border-radius:12px;margin-bottom:10px;color:#000;font-weight:700}.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:100%;margin:0 auto}.dash-item{background:var(--w);border-radius:16px;padding:8px;text-align:center;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);color:var(--p);font-weight:800;text-transform:uppercase;font-size:11px;letter-spacing:.5px;border:1px solid #cbd5e1;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;min-height:80px;position:relative;overflow:hidden}.dash-item:active{transform:scale(.97);background:#eef2ff;border-color:var(--p)}.dash-item span{font-size:12px;margin-bottom:2px;display:block;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.9);font-weight:900;z-index:2}.card{background:var(--w);border-radius:16px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px -1px rgba(0,0,0,.08);border:1px solid #e2e8f0;position:relative;width:100%}.btn-main{background:var(--p);color:#fff;border:none;width:100%;padding:14px;font-size:13px;font-weight:800;border-radius:12px;margin:5px 0;text-transform:uppercase;box-shadow:0 4px 10px rgba(67,56,202,.2);transition:.2s;cursor:pointer}.btn-main:active{transform:translateY(1px);box-shadow:none}.btn-main:disabled{background:#94a3b8;cursor:not-allowed}.bottom-nav{display:none;position:fixed;bottom:10px;left:10px;right:10px;background:#fff;border-radius:20px;box-shadow:0 10px 40px -5px rgba(0,0,0,.2);padding:5px;z-index:900;grid-template-columns:1fr 1fr;gap:5px;border:1px solid #cbd5e1}.bottom-nav button{background:0 0;border:none;padding:12px;border-radius:14px;color:#64748b;font-weight:900;font-size:11px;text-transform:uppercase;letter-spacing:1px;transition:.2s}.bottom-nav button.nav-btn-active{background:#e0e7ff;color:var(--p);box-shadow:0 2px 5px rgba(0,0,0,.05)}body.nav-active .bottom-nav{display:grid}input,select{width:100%;padding:12px;margin:5px 0;border:1px solid #94a3b8;border-radius:10px;font-size:16px;background:#fff;font-weight:700;color:#0f172a}input:focus,select:focus{border-color:var(--p);background:#f8fafc;outline:2px solid #e0e7ff}.item-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}.item-card{background:#fff;border-radius:12px;padding:10px 2px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.08);border:1px solid #cbd5e1;position:relative}.item-title{font-size:10px;font-weight:900;text-transform:uppercase;color:#1e293b;margin-bottom:4px;height:24px;overflow:hidden;line-height:1.1;word-break:break-word}.item-qty{font-size:15px;font-weight:900;color:#000;margin-bottom:4px}.alarm-blink{background:#fef2f2!important;border:1px solid var(--d)!important;animation:blink 1s infinite alternate}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}.modal-box{background:#fff;width:96%;max-width:400px;border-radius:20px;max-height:94vh;display:flex;flex-direction:column;box-shadow:0 20px 40px -10px rgba(0,0,0,.3)}.modal-body{overflow-y:auto;padding:15px}.report-line{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px dashed #cbd5e1;color:#000;font-weight:600}.history-btn{border:none;background:#e0e7ff;color:var(--p);border-radius:8px;padding:8px;font-weight:800;font-size:12px;width:45%}.corr-btn{display:none;border:none;background:#fef3c7;color:#d97706;border-radius:8px;padding:8px;font-weight:800;font-size:12px;width:45%;margin-top:4px}.show-corr .corr-btn{display:inline-block}.hist-pos,.val-pos{color:#2563eb!important;font-weight:900}.hist-neg,.val-neg{color:#dc2626!important;font-weight:900}.arch-y-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;width:100%}.arch-tile-y{background:#3b82f6;color:#fff;padding:25px 5px;border-radius:16px;text-align:center;font-weight:900;font-size:20px;cursor:pointer;box-shadow:0 8px 15px -3px rgba(59,130,246,.4)}.arch-m-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;width:100%}.arch-tile-m{background:#fff;border:1px solid #cbd5e1;border-radius:12px;padding:15px 2px;text-align:center;font-size:11px;font-weight:800;color:#334155;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.05);text-transform:uppercase}.arch-content{display:none;margin-bottom:15px;width:100%}.arch-inv{background:#fff;border-left:4px solid var(--p);border-radius:12px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px rgba(0,0,0,.06);display:flex;justify-content:space-between;align-items:center;font-size:13px;cursor:pointer;border:1px solid #e2e8f0;width:100%;font-weight:600;color:#000}.arch-tile-c{background:#fff;padding:12px;border-radius:10px;border:1px solid #cbd5e1;display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:13px;margin-bottom:5px;cursor:pointer;color:#1e293b}.arch-badge{background:#eef2ff;color:var(--p);padding:2px 6px;border-radius:6px;font-size:10px}.j-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:8px;box-shadow:0 2px 4px -1px rgba(0,0,0,.08);border:1px solid #e2e8f0;position:relative}.j-head{font-weight:900;font-size:14px;text-transform:uppercase;color:var(--p);margin-bottom:4px}.j-sub{font-size:12px;font-weight:700;color:#64748b;margin-bottom:12px;border-bottom:1px solid #f1f5f9;padding-bottom:6px}.j-title{font-size:16px;font-weight:900;color:#1e293b;margin-bottom:10px}.j-body{font-size:13px;color:#334155}.j-row{display:flex;justify-content:space-between;padding:4px 0;align-items:end;margin-bottom:2px}.j-dots{flex-grow:1;border-bottom:2px dotted #cbd5e1;margin:0 6px;position:relative;top:-5px;color:#1e293b;font-weight:700;font-size:13px}.j-val{font-weight:900;color:#000;white-space:nowrap}.bulk-q{border:2px solid #cbd5e1!important;text-align:center;color:var(--p);font-weight:700}.bulk-q:focus{border-color:var(--p)!important;background:#eef2ff}.ts-row{display:grid;grid-template-columns:30px 1fr 55px 45px 45px 30px;gap:2px;margin-bottom:2px;align-items:center;border-bottom:1px solid #f1f5f9;padding-bottom:2px}.btn-mini{width:100%;height:30px;border-radius:6px;border:1px solid #ccc;background:#f1f5f9;font-weight:900;font-size:14px;color:#64748b;padding:0;display:flex;align-items:center;justify-content:center}.btn-mini.red{color:red;background:#fee2e2;border-color:#fca5a5}.btn-mini.absent-active{background:#f43f5e;color:#fff;border-color:#e11d48}.ts-name-inp{width:100%;border:none;background:0 0;font-weight:700;font-size:14px;color:#1e293b;padding:5px 2px;outline:0;border-bottom:1px dashed #cbd5e1}.ts-rate-inp{width:100%;border:1px solid #cbd5e1;border-radius:4px;font-size:11px;text-align:center;padding:0;height:28px;font-weight:700;color:#059669}.ts-time-inp{width:100%;border:1px solid #e2e8f0;background:#fff;font-size:11px;text-align:center;padding:0;height:28px;border-radius:4px;font-weight:600;color:#334155}.ts-del-tile{position:absolute;top:2px;right:2px;width:24px;height:24px;background:#fee2e2;color:red;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;font-weight:700;z-index:5}.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}.cal-head{text-align:center;font-size:10px;font-weight:900;color:#64748b;padding-bottom:5px;text-transform:uppercase}.cal-cell{aspect-ratio:1;border:1px solid #e2e8f0;border-radius:8px;background:#fff;position:relative;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,.05);cursor:pointer}.cal-cell:active{background:#eef2ff;transform:scale(0.95)}.cal-date{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:900;color:#cbd5e1;z-index:1;opacity:.4}.cal-date.weekend{color:#fca5a5;opacity:.5}.cal-date.today{color:var(--p);opacity:.8;text-decoration:underline}.cal-overlay{position:absolute;inset:0;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;font-weight:900;line-height:1.2;text-shadow:0 1px 2px rgba(255,255,255,.8)}@keyframes pearl-green{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.pearl-green-text{background:linear-gradient(90deg,#166534,#22c55e,#15803d,#4ade80);background-size:300% 300%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:pearl-green 3s ease infinite;text-shadow:0 0 1px rgba(255,255,255,.5)}@keyframes pearl-pink{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.pearl-pink-text{background:linear-gradient(90deg,#be123c,#f43f5e,#9f1239,#fb7185);background-size:300% 300%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:pearl-pink 3s ease infinite;text-shadow:0 0 1px rgba(255,255,255,.5)}.logo-box{text-align:center;margin-bottom:20px;margin-top:5px}.logo-img{max-width:220px;height:auto;object-fit:contain}.l-t{font-size:10px;font-weight:900;color:#475569;margin-bottom:3px;display:block;text-transform:uppercase;letter-spacing:.5px}.smart-wrap{width:100%;height:30px;position:relative}.smart-sel,.smart-inp,.u-inp{width:100%;height:100%;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;background:#fff;padding:0 5px;margin:0;box-sizing:border-box;font-weight:700;color:#1e293b}.smart-inp{display:none;border:1px solid var(--p)}.u-inp{text-align:center}.del-row-btn{width:100%;height:30px;background:#fee2e2;border:1px solid #fca5a5;color:red;border-radius:6px;font-weight:900;display:flex;align-items:center;justify-content:center}.dyn-row{display:grid;grid-template-columns:32% 16% 16% 16% 8%;gap:4px;align-items:center;margin-bottom:5px}.z-head{font-size:11px;color:#047857;font-weight:900;text-align:center;margin:15px 0 5px;letter-spacing:1px;background:#ecfdf5;padding:5px;border-radius:4px;text-transform:uppercase;border:1px solid #a7f3d0}.z-col-h{display:grid;grid-template-columns:32% 16% 16% 16% 8%;gap:4px;text-align:center;font-size:10px;color:#475569;font-weight:800;margin-bottom:4px}.del-rep-btn{position:absolute;top:5px;right:5px;background:#fee2e2;color:#ef4444;border:1px solid #fca5a5;width:28px;height:28px;border-radius:50%;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:99;opacity:.3;transition:.2s}.del-rep-btn:active{opacity:1;transform:scale(1.1)}.day-rep-box{background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #cbd5e1;font-family:monospace;font-size:12px;color:#000;white-space:pre-wrap;margin-bottom:10px;font-weight:600}.dr-h{font-weight:900;border-bottom:1px dashed #94a3b8;margin:10px 0 5px;color:#000;text-transform:uppercase}.fas-row{display:grid;grid-template-columns:25% 45% 20% 10%;gap:3px;align-items:center;margin-bottom:5px;background:#f8fafc;padding:3px;border-radius:6px;border:1px solid #cbd5e1}.fas-out-row{display:grid;grid-template-columns:45% 25% 20% 10%;gap:3px;align-items:center;margin-bottom:5px;background:#eef2ff;padding:3px;border-radius:6px;border:1px solid #c7d2fe}.pay-alert{background:#dc2626;color:#fff;text-align:center;padding:15px;font-weight:900;font-size:18px;margin-bottom:10px;border-radius:12px;animation:blink 1s infinite;box-shadow:0 5px 15px rgba(220,38,38,.4);text-transform:uppercase}@media print{body{background:#fff;padding:0}#lockScreen,#act,.bottom-nav,.dash-item,.btn-main,.logo-box,#corrCtls,.history-btn,.corr-btn,#navM,#navB{display:none!important}#cnt{display:block!important;position:static;width:100%}.z-head{background:0 0!important;border:none!important;color:#000!important;font-size:14px!important;text-align:left!important;padding-left:0!important;margin-top:20px!important;border-bottom:2px solid #000!important}.item-card{box-shadow:none!important;border:none!important;border-bottom:1px dotted #ccc!important;padding:5px 0!important;margin:0!important}.item-grid{display:block!important}}@keyframes blink{from{opacity:1}to{opacity:.7}}</style></head><body><div id="lockScreen"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo"><div class="lock-title">–°–ò–°–¢–ï–ú–ê –£–ß–ï–¢–ê</div><input type="email" id="appEmail" class="lock-inp" placeholder="Email" value="nukonor@gmail.com"><input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-main" style="max-width:250px" onclick="tryLogin()">–í–û–ô–¢–ò</button><div id="loginStatus" style="margin-top:10px;color:#64748b;font-weight:700;font-size:12px"></div></div><div id="act"></div><div id="cnt"></div><div class="bottom-nav"><button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button><button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button></div><div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:15px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0;font-size:16px;font-weight:900;color:#1e293b"></h4><button onclick="closeModal()" style="border:none;background:0 0;font-size:24px;color:#999">‚úï</button></div><div id="mB" class="modal-body"></div></div></div><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script><script>
const WS_CFG={'VIBRO':{title:'–í–∏–±—Ä–æ—Å—Ç–æ–ª',db:'Vibro_Report',prefix:'v',note:'–í–∏–±—Ä–æ'},'KRUP':{title:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞',db:'Krup_Report',prefix:'k',note:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞'},'ZSHM':{title:'–ó–®–ú –°–º–µ–Ω–∞',db:'ZSHM_Report',prefix:'z',note:'–ó–®–ú'}};
const D=document,gID=i=>D.getElementById(i);
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();
let cur='Home',data={},aId=null,archSub='',corrMode=!1,isLogged=!1,corrCtx={},useStretch=!1,shipBasket={},calCurMonth=new Date();
const stockCatsAll=['Stock_DV','Stock_Semi','Stock_Feed','Stock_Raw','WeightStock','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','Timesheet','Timesheet_Notes'];
auth.onAuthStateChanged(user=>{if(user){gID('lockScreen').classList.add('lock-hidden');D.body.classList.add('nav-active');isLogged=!0;renderHome()}else{gID('lockScreen').classList.remove('lock-hidden');D.body.classList.remove('nav-active');isLogged=!1;gID('cnt').innerHTML=''}});
function tryLogin(){const e=gID('appEmail').value,p=gID('appPass').value,s=gID('loginStatus');if(!e||!p){alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');return}s.innerText='–í—Ö–æ–¥...';auth.signInWithEmailAndPassword(e,p).catch(err=>{alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: "+err.message);s.innerText='–û—à–∏–±–∫–∞'})}
window.delRec=async(c,i)=>{if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –Ω–∞–≤—Å–µ–≥–¥–∞?')){await db.child(c).child(i).remove();closeModal()}};
window.delInvoiceFull=async(c,i)=>{if(confirm('–£–¥–∞–ª–∏—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é –∏ –æ—Ç–º–µ–Ω–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è?')){const u={};u[`/${c}/${i}`]=null;stockCatsAll.forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([k,v])=>{if(v.fLink===i)u[`/${s}/${k}`]=null})});try{await db.update(u)}catch(e){alert("Err:"+e)}}};
window.delWorkshopReportFull=async(n,i)=>{if(confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞?')){const u={};u[`/${n}/${i}`]=null;stockCatsAll.forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([k,v])=>{if(v.fLink===i)u[`/${s}/${k}`]=null})});try{await db.update(u);alert("–£–¥–∞–ª–µ–Ω–æ")}catch(e){alert("Err:"+e)}}};
window.delFasFull=async(i)=>{if(confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç —Ñ–∞—Å–æ–≤–∫–∏?')){const u={};u['/–§–∞—Å–æ–≤–∫–∞/'+i]=null;stockCatsAll.forEach(c=>{if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.fLink===i)u[`/${c}/${k}`]=null})});try{await db.update(u);alert("–û—Ç–º–µ–Ω–µ–Ω–æ")}catch(e){alert("Err:"+e)}}};
window.delFas=i=>window.delRec('–§–∞—Å–æ–≤–∫–∞',i);window.delKrup=i=>window.delRec('Krup_Report',i);window.delVibro=i=>window.delRec('Vibro_Report',i);window.delZSHM=i=>window.delRec('ZSHM_Report',i);window.delArchRec=(c,i)=>window.delRec(c,i);
const bP=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1 —Ñ—Ä","–ê—Ä–Ω–∞—É—Ç–∫–∞ 2 —Ñ—Ä","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"],szs=["300√ó400","370√ó500","400√ó500","420√ó550"],mths=["–Ø–ù–í","–§–ï–í","–ú–ê–†–¢","–ê–ü–†","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì","–°–ï–ù–¢","–û–ö–¢","–ù–û–Ø–ë","–î–ï–ö"];
const fd=i=>{if(!i)return'';const p=i.split('T')[0].split('-');return `${p[2]}.${p[1]}.${p[0]} ${p[1]}:${p[2]}`},fd2=i=>{if(!i)return'';const p=i.split('T')[0].split('-');return `${p[2]}.${p[1]}.${p[0]}`};
function closeModal(){gID('mdl').style.display='none';aId=null}
function toggleF(i){const e=gID(i);e.style.display=e.style.display==='block'?'none':'block'}
function toggleC(i,b){const e=gID(i);if(e.style.display==='block'){e.style.display='none';b.style.background='#fff';b.style.borderColor='#e2e8f0'}else{e.style.display='block';b.style.background='#eef2ff';b.style.borderColor='var(--p)'}}
const gP=c=>{let i=[];if(c==='WeightStock'||c==='–ì–æ—Ç–æ–≤–∞—è')i=bP;const s=new Set(i),k=(c==='WeightStock')?'WeightStock':(c==='Stock_DV'?'Stock_DV':(c==='Stock_Feed'?'Stock_Feed':(c==='Stock_Raw'?'Stock_Raw':(c==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è'))));if(data[k])Object.values(data[k]).forEach(v=>s.add(v.name));return Array.from(s).filter(x=>x).sort()};
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort()};
const gPack=c=>{const s=new Set();if(c==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));if(c==='–°–∫–æ—Ç—á')s.add('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º');if(c==='–ü–ª–µ–Ω–∫–∞')bP.forEach(x=>s.add(x));const k=c==='–°–∫–æ—Ç—á'?'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':c;if(data[k])Object.values(data[k]).forEach(v=>{if(v.name)s.add(v.name)});return Array.from(s).filter(x=>x).sort()};
const gPackS=()=>{const s=new Set();if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.supplier)s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const gBuyS=()=>{const s=new Set();if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.supplier&&v.type==='GOODS')s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const gRawActive=()=>{const s=new Set();if(data.Stock_Raw){const m={};Object.values(data.Stock_Raw).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});Object.keys(m).forEach(n=>{if(m[n]>.01){const r=n.match(/\[(.*?)\]/);if(r&&r[1])s.add(r[1])}})}return Array.from(s).filter(x=>x).sort()};
const getPayMsg=()=>{const t=new Date(),y=t.getFullYear(),m=t.getMonth(),d=t.getDate(),g=(k)=>{let n=new Date(y,m,k),w=n.getDay();if(w===0)return k-2;if(w===6)return k-1;return k};if(d===g(5))return "üí∞ –°–ï–ì–û–î–ù–Ø –ó–ê–†–ü–õ–ê–¢–ê";if(d===g(15))return "üí∏ –°–ï–ì–û–î–ù–Ø –ê–í–ê–ù–°";return null};
function renderHome(){if(!isLogged)return;cur='Home';D.body.classList.remove('nav-active');gID('act').innerHTML='';const m=getPayMsg(),a=m?`<div class="pay-alert">${m}</div>`:'';const lBtn=`<button onclick="firebase.auth().signOut()" style="position:absolute;top:10px;right:10px;background:#fee2e2;color:red;border:1px solid #fca5a5;border-radius:8px;padding:5px 10px;font-weight:900;z-index:90">–í–´–ô–¢–ò</button>`;gID('cnt').innerHTML=lBtn+a+`<div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div><div class="dash-grid"><div class="dash-item" onclick="setCat('StockRoot')" style="background:url(https://i.ibb.co/ZpmvHK8j/istockphoto-2182205419-612x612.jpg) center/cover"><span>–°–ö–õ–ê–î</span></div><div class="dash-item" onclick="setCat('ProdSub')" style="background:url(https://i.ibb.co/n80ztFdm/images-3.jpg) center/cover"><span>–ü–†–û–ò–ó–í–û–î–°–¢–í–û</span></div><div class="dash-item" onclick="setCat('Timesheet')" style="background:url(https://i.ibb.co/JFyZ2dWf/dg-ra-calendar-6623042-1920.jpg) center/cover"><span>–¢–ê–ë–ï–õ–¨</span></div><div class="dash-item" onclick="setCat('Consolidated')" style="background:url(https://i.ibb.co/hJL68gt8/istockphoto-1563201032-612x612.jpg) center/cover"><span>–°–í–û–î–ù–´–ô –û–¢–ß–ï–¢</span></div></div>`;updNav()}
function goBack(){const m={'TsCal':'Timesheet','Timesheet':'Home','StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','PackSub':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'PackSub','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'PackSub','ArchPackIn':'PackSub','Consolidated':'Home'};let n=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')n=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(n)}
function updNav(){gID('navM').className=cur==='Home'?'nav-btn-active':'';gID('navB').className=cur!=='Home'?'nav-btn-active':''}
function setCat(c){cur=c;D.body.classList.add('nav-active');const a=gID('act'),ct=gID('cnt');a.innerHTML='';if(c==='Home'){renderHome();return}if(c==='Timesheet'){const td=new Date().toISOString().split('T')[0];ct.innerHTML=`<div class="card" style="margin-top:10px"><div style="font-size:14px;font-weight:900;color:var(--p);text-align:center;margin-bottom:10px;text-transform:uppercase">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–µ–ª—è</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="gTD" value="${td}" style="height:35px"></div><div><label class="l-t">–û–ë–©–ï–ï –í–†–ï–ú–Ø</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px"><input type="time" id="gTS" value="08:00" style="height:35px;font-size:11px"><input type="time" id="gTE" value="17:00" style="height:35px;font-size:11px"></div></div></div><div class="l-t" style="margin-bottom:5px">–°–û–¢–†–£–î–ù–ò–ö–ò [–¢–∞—Ä–∏—Ñ]</div><div id="tsRows"></div><button class="btn-main" onclick="addTimeRow()" style="background:#fff;color:var(--p);border:1px solid #ccc;margin-top:10px">+ –î–û–ë–ê–í–ò–¢–¨ –ß–ï–õ–û–í–ï–ö–ê</button><button class="btn-main" onclick="saveTimesheetBatch()" style="margin-top:10px">–°–û–•–†–ê–ù–ò–¢–¨ –¢–ê–ë–ï–õ–¨</button></div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);margin-top:10px;border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–†–¨ –°–ú–ï–ù</button>`;setTimeout(()=>{const s=localStorage.getItem('activeCrew');if(s){const n=JSON.parse(s);if(n.length>0)n.forEach(x=>{if(typeof x==='object')addTimeRow(x.name,x.rate);else addTimeRow(x)});else addTimeRow()}else addTimeRow()},50)}else if(c==='TsCal'){ct.innerHTML=`<div class="z-head">–í–´–ë–ï–†–ò–¢–ï –°–û–¢–†–£–î–ù–ò–ö–ê</div><div id="tsList" class="item-grid" style="grid-template-columns:repeat(3,1fr)"></div>`;loadData()}else if(c==='StockRoot'){ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="openModal('inc')" style="border:2px solid var(--s);color:var(--s)"><span>üì•</span>–ü–†–ò–•–û–î</div><div class="dash-item" onclick="openModal('ship')" style="border:2px solid var(--d);color:var(--d)"><span>üöö</span>–û–¢–ì–†–£–ó–ö–ê</div><div class="dash-item" onclick="setCat('StockList')">–§–ê–°–û–í–ê–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø</div><div class="dash-item" onclick="setCat('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø –í–ï–°–û–í–ê–Ø</div><div class="dash-item" onclick="setCat('Stock_DV')">–°–ö–õ–ê–î –ì–û–¢–û–í–û–ô –í–ï–°–û–í–û–ô –ü–†–û–î–£–ö–¶–ò–ò –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê</div><div class="dash-item" onclick="setCat('Stock_Feed')">–û–¢–•–û–î–´ –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê</div><div class="dash-item" onclick="setCat('Stock_Raw')">–°–´–†–¨–Å(–ó–ï–†–ù–û)–°–´–†–¨–ï–í–´–ï –°–ö–õ–ê–î–´</div><div class="dash-item" onclick="setCat('Stock_Semi')">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢</div><div class="dash-item" onclick="setCat('PackSub')">–£–ü–ê–ö. –ú–ê–¢.</div><div class="dash-item" onclick="setCat('Invoices')">–ê–†–•–ò–í –ù–ê–ö–õ–ê–î–ù–´–•</div><div id="corrTile" class="dash-item" onclick="toggleCorr()" style="grid-column:1/-1">–ö–û–†–†–ï–ö–¶–ò–Ø</div></div><div id="corrCtls" style="margin-top:15px;display:flex;gap:5px;justify-content:center"></div>`}else if(c==='PackSub'){a.innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü—Ä–∏—Ö–æ–¥ —É–ø–∞–∫–æ–≤–∫–∏</button>`;ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–õ–ï–ù–ö–ê</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–ê–ö–ï–¢–´</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–ö–û–¢–ß</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–ï–®–ö–ò</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–ò–¢–ö–ò</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–≠–¢–ò–ö–ï–¢–ö–ê</div><div class="dash-item" onclick="setCat('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')">–°–¢–†–ï–ô–ß –ü–õ–ï–ù–ö–ê</div><div class="dash-item" onclick="setCat('–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')">–¢–ï–†–ú–û –õ–ï–ù–¢–ê</div></div>`}else if(c==='ProdSub')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–¶–µ—Ö —Ñ–∞—Å–æ–≤–∫–∏</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö—Ä—É–ø–æ—Ä—É—à–∫–∞</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í–∏–±—Ä–æ—Å—Ç–æ–ª</div></div><button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–û–î –°–´–†–¨–Ø</button>`;else if(c==='–§–∞—Å–æ–≤–∫–∞')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('fas')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='Kruporushka')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('KRUP')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='Vibro')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('VIBRO')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='ZSHM')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('ZSHM')">–ù–û–í–ê–Ø –°–ú–ï–ù–ê</button>`;else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü—Ä–∏—Ö–æ–¥—ã</div><div class="dash-item" onclick="setCat('ArchSubOut')">–û—Ç–≥—Ä—É–∑–∫–∏</div></div>`;else if(c==='ArchSubIn'||c==='ArchSubOut'){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ü–æ –¥–∞—Ç–∞–º</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ü–æ –∏–º–µ–Ω–∞–º</div></div>`}else if(c==='Consolidated'){ct.innerHTML='<div style="text-align:center;padding:20px;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';loadData()}loadData();updCorrBtn();updNav()}
function toggleCorr(){corrMode=!corrMode;updCorrBtn();loadData()}
function updCorrBtn(){const t=gID('corrTile');if(t){t.innerText=corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'–ö–û–†–†–ï–ö–¶–ò–Ø';t.style.background=corrMode?'#fef3c7':'#fff';t.style.color=corrMode?'#d97706':'var(--p)'}const c=gID('corrCtls');if(c)c.innerHTML=''}
function loadData(){db.on('value',s=>{data=s.val()||{};const c=gID('cnt');if(!c||['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub','Timesheet'].includes(cur))return;if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(cur==='Kruporushka')rKrup(c);else if(cur==='Vibro')rVibro(c);else if(cur==='ZSHM')rZSHM(c);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Stock_Raw')rRaw(c);else if(cur==='Consolidated')rConsolidated(c);else if(cur==='TsCal')renderTsList(c);else rGen(c)})}
function toggleInput(i){const s=gID('s_'+i),n=gID('i_'+i);if(s.value==='NEW'){s.style.display='none';n.style.display='block';n.focus()}else n.style.display='none'}
function drawShipItem(s){let p=s.split('|');if(p.length<2&&s.includes(':'))p=s.split(':');let n=p[0],a=p[1],u=p[2],c=p[3],l='';if(c==='–ì–æ—Ç–æ–≤–∞—è')l='(—Ñ–∞—Å)';else if(c==='WeightStock')l='(–ø–æ–∫)';else if(c==='Stock_DV')l='(–¥–≤)';else if(c==='Stock_Feed')l='(–∫–æ—Ä–º)';let lh=l?`<span style="color:var(--blue);font-size:10px;margin-left:4px">${l}</span>`:'';if(!u)u=bP.includes(n)?'—à—Ç':'–∫–≥';return `<div class="j-row"><span class="j-dots">${n}${lh}</span><span class="j-val">${a}${u}</span></div>`}
function rConsolidated(c){const sumCat=x=>{let r={};x.forEach(n=>{if(data[n])Object.values(data[n]).forEach(v=>r[v.name]=(r[v.name]||0)+v.amount)});return r};const drawSec=(t,o,u,cl)=>{let i=Object.keys(o).filter(k=>Math.abs(o[k])>.1).sort();if(i.length===0)return'';let h=`<div class="z-head" style="background:${cl};color:#1e293b;border:1px solid #cbd5e1">${t}</div><div class="item-grid" style="grid-template-columns:1fr 1fr;">`;i.forEach(k=>{let v=o[k],d=Math.round(v);if(t.includes('–ü–õ–ï–ù–ö–ê'))d=v.toFixed(2);h+=`<div class="item-card" style="text-align:left;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:11px;font-weight:700;color:#475569">${k}</span><span style="font-size:14px;font-weight:900;color:#0f172a">${d}<small style="font-size:9px;color:#94a3b8;margin-left:2px">${u}</small></span></div>`});return h+`</div>`};let h='<div id="print-area" style="padding-bottom:20px">';h+=`<div style="margin-bottom:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="openModal('dayRep')" style="background:#4f46e5;border:1px solid #4338ca">üìÖ –î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢</button><button class="btn-main" onclick="shareRep()" style="background:#fff;color:#4f46e5;border:1px solid #4f46e5">üì§ –û–¢–ü–†–ê–í–ò–¢–¨ –°–í–û–î–ö–£</button></div>`;h+=drawSec('üì¶ –§–ê–°–û–í–ö–ê',sumCat(['–ì–æ—Ç–æ–≤–∞—è']),'—à—Ç','#dbeafe');h+=drawSec('üè≠ –°–ö–õ–ê–î –î–í',sumCat(['Stock_DV']),'–∫–≥','#bfdbfe');h+=drawSec('‚öñÔ∏è –ü–û–ö–£–ü–ù–ê–Ø',sumCat(['WeightStock']),'–∫–≥','#dcfce7');h+=drawSec('üöú –°–´–†–¨–Å',sumCat(['Stock_Raw']),'–∫–≥','#bbf7d0');h+=drawSec('‚öôÔ∏è –ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢',sumCat(['Stock_Semi']),'–∫–≥','#ffedd5');h+=drawSec('üçÇ –ö–û–†–ú–ê',sumCat(['Stock_Feed']),'–∫–≥','#fef3c7');h+=drawSec('ü•° –ü–ê–ö–ï–¢–´',sumCat(['–ü–∞–∫–µ—Ç—ã']),'—à—Ç','#f1f5f9');h+=drawSec('üéûÔ∏è –ü–õ–ï–ù–ö–ê',sumCat(['–ü–ª–µ–Ω–∫–∞']),'–∫–≥','#f1f5f9');h+=drawSec('üß¥ –°–ö–û–¢–ß',sumCat(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º']),'—à—Ç','#f1f5f9');h+=drawSec('üí∞ –ú–ï–®–ö–ò',sumCat(['–ú–µ—à–∫–∏']),'—à—Ç','#f1f5f9');h+=drawSec('üßµ –ù–ò–¢–ö–ò',sumCat(['–ù–∏—Ç–∫–∏']),'—à—Ç','#f1f5f9');h+=drawSec('üè∑Ô∏è –≠–¢–ò–ö–ï–¢–ö–ê',sumCat(['–≠—Ç–∏–∫–µ—Ç–∫–∞']),'—à—Ç','#f1f5f9');h+=drawSec('üåÄ –°–¢–†–ï–ô–ß',sumCat(['–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞']),'—à—Ç','#f1f5f9');h+=drawSec('üî• –¢–ï–†–ú–û –õ–ï–ù–¢–ê',sumCat(['–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞']),'—à—Ç','#f1f5f9');h+='</div>';h+=`<div style="margin-top:15px;border-top:1px dashed #ccc;padding-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" onclick="openModal('fixBal')" style="background:#f59e0b;color:#fff;border:1px solid #d97706;font-size:10px">üîí –ó–ê–§–ò–ö–°–ò–†–û–í–ê–¢–¨</button><button class="btn-main" onclick="openModal('archiveOld')" style="background:#dc2626;color:#fff;border:1px solid #b91c1c;font-size:10px">üßπ –°–í–ï–†–¢–ö–ê –ë–ê–ó–´</button><div style="font-size:10px;color:#666;text-align:center;margin-top:5px;grid-column:1/-1">–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Å—Ç–∞—Ç–∫–æ–≤</div></div>`;c.innerHTML=h||'<div style="text-align:center;padding:20px;color:#999">–°–∫–ª–∞–¥—ã –ø—É—Å—Ç—ã</div>'}
function shareRep(){let t="üìä –°–í–û–î–ù–´–ô –û–¢–ß–ï–¢ ["+new Date().toLocaleDateString()+"]\n\n";const g=(c,l,u)=>{let d={};if(data[c])Object.values(data[c]).forEach(v=>d[v.name]=(d[v.name]||0)+v.amount);let i=Object.keys(d).filter(k=>Math.abs(d[k])>.1).sort();if(i.length){t+=l+":\n";i.forEach(k=>t+=`- ${k}: ${Math.round(d[k])} ${u}\n`);t+="\n"}};g('–ì–æ—Ç–æ–≤–∞—è','üì¶ –§–ê–°–û–í–ö–ê','—à—Ç');g('Stock_DV','üè≠ –°–ö–õ–ê–î –î–í','–∫–≥');g('WeightStock','‚öñÔ∏è –ü–û–ö–£–ü–ù–ê–Ø','–∫–≥');if(navigator.share)navigator.share({title:'–û—Ç—á–µ—Ç',text:t}).catch(console.error);else navigator.clipboard.writeText(t).then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')).catch(e=>alert('–û—à–∏–±–∫–∞'))}
function renderByTiles(c,r,t){const g={};if(r)Object.entries(r).forEach(([i,v])=>{if(!v.date)return;const d=new Date(v.date),y=d.getFullYear(),m=d.getMonth();if(!g[y])g[y]={};if(!g[y][m])g[y][m]=[];g[y][m].push({...v,id:i})});let h='';Object.keys(g).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}${t}')">${y}</div></div><div id="y${y}${t}" class="arch-content"><div class="arch-m-grid">`;Object.keys(g[y]).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}${t}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(g[y]).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="m${y}${m}${t}" class="arch-content" style="grid-column:1/-1;">`;g[y][m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{if(t==='FAS'){let n=v.name?v.name.toUpperCase():"–§–ê–°–û–í–ö–ê";if(v.outputItems&&v.outputItems.length>0)n=(v.outputItems.length>1)?`–§–ê–°–û–í–ö–ê`:v.outputItems[0].name.toUpperCase();h+=`<div class="card" style="padding-top:5px;padding-bottom:5px"><button class="del-rep-btn" onclick="event.stopPropagation();delFasFull('${v.id}')">üóëÔ∏è</button><div style="text-align:center;font-weight:900;border-bottom:1px solid #000;margin-bottom:5px;padding-bottom:5px;font-size:14px;color:#000">${n} ${fd2(v.date)}</div>`;h+=`<div style="font-weight:700;font-size:12px;color:#000;margin-bottom:2px">—Å—ã—Ä—å—ë:</div>`;if(v.items)v.items.forEach(i=>{let l=(i.source==='WeightStock')?'<span style="color:var(--s);font-size:9px;margin-left:2px">(–ø–æ–∫)</span>':'<span style="color:var(--p);font-size:9px;margin-left:2px">(–î–í)</span>';h+=`<div class="j-row" style="margin:0"><span class="j-dots">${i.name} ${l}</span><span class="j-val val-neg">-${i.amount}–∫–≥</span></div>`});else h+=`<div class="j-row"><span class="j-dots">${v.rawItem}</span><span class="j-val val-neg">-${v.prihod}–∫–≥</span></div>`;h+=`<div style="border-bottom:1px dashed #000;margin:5px 0"></div>`;h+=`<div style="font-weight:700;font-size:12px;color:#000;margin-bottom:2px">–í—ã—Ö–æ–¥:</div>`;if(v.outputItems)v.outputItems.forEach(o=>h+=`<div class="j-row" style="margin:0"><span class="j-dots">${o.name}</span><span class="j-val val-pos">+${o.count}—à—Ç</span></div>`);else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val val-pos">+${v.vyhod}—à—Ç</span></div>`;h+=`<div style="border-bottom:1px dashed #000;margin:5px 0"></div>`;let pl=[];if(v.outputItems)v.outputItems.forEach(o=>pl.push({n:`–ü–∞–∫–µ—Ç—ã ${o.size}`,v:Math.round(o.count/((o.name==="–ö—É—Ç—è")?19.8:9.9))}));else pl.push({n:`–ü–∞–∫–µ—Ç—ã ${v.size}`,v:Math.round(v.vyhod/((v.name==="–ö—É—Ç—è")?19.8:9.9))});pl.forEach(p=>h+=`<div class="j-row" style="margin:0"><span class="j-dots">${p.n}</span><span class="j-val val-neg">-${p.v}—à—Ç</span></div>`);let pv=v.vzial?Math.abs(v.vzial-(v.ostatok||0)).toFixed(2):'0',fn=(v.filmName)?v.filmName:(v.outputItems&&v.outputItems.length>0?v.outputItems[0].name:'–ü–ª–µ–Ω–∫–∞');let ffn=fn.toLowerCase().includes('–ø–ª–µ–Ω–∫–∞')?fn:'–ü–ª–µ–Ω–∫–∞ '+fn;h+=`<div class="j-row" style="margin:0"><span class="j-dots">${ffn}</span><span class="j-val val-neg">-${pv}–∫–≥</span></div><div class="j-row" style="margin:0"><span class="j-dots">–°–∫–æ—Ç—á</span><span class="j-val val-neg">-${v.scotch||0}—à—Ç</span></div></div>`}else if(t==='KRUP'||t==='VIBRO'||t==='ZSHM'){let ts=(v.timeStart||'??')+' ‚Äî '+(v.timeEnd||'??'),tb=0,lm={};if(v.items)v.items.forEach(i=>{if(i.w===25&&!i.n.toLowerCase().includes('–∞—Ä–Ω–∞—É—Ç–∫–∞ 3'))tb+=i.q;if(i.w===25){let nl=i.n.toLowerCase(),ln=null;if(!nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞ 3')){if(nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞'))ln='–≠—Ç-–∫–∞ –ê—Ä–Ω–∞—É—Ç–∫–∞';else if(nl.includes('—è—á–∫–∞'))ln='–≠—Ç-–∫–∞ –Ø—á–∫–∞';else if(nl.includes('–ø—à–µ–Ω–∏—á–∫–∞'))ln='–≠—Ç-–∫–∞ –ü—à–µ–Ω–∏—á–∫–∞';else if(nl.includes('–ø–µ—Ä–ª–æ–≤–∫–∞'))ln='–≠—Ç-–∫–∞ –ü–µ—Ä–ª–æ–≤–∫–∞';else if(nl.includes('–≥–æ—Ä–æ—Ö'))ln='–≠—Ç-–∫–∞ –ì–æ—Ä–æ—Ö';else if(nl.includes('–ø—à–æ–Ω–æ'))ln='–≠—Ç-–∫–∞ –ü—à–æ–Ω–æ';else if(nl.includes('–∫—É–∫—É—Ä—É–∑–∞'))ln='–≠—Ç-–∫–∞ –ö—É–∫—É—Ä—É–∑–∞'}if(ln)lm[ln]=(lm[ln]||0)+i.q}});let bh=tb>0?`<div class="report-line"><span>–ú–µ—à–∫–∏</span><b class="val-neg">-${tb}—à—Ç</b></div>`:'',lh='';Object.keys(lm).forEach(k=>lh+=`<div class="report-line"><span>${k}</span><b class="val-neg">-${lm[k]}—à—Ç</b></div>`);h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delWorkshopReportFull('${WS_CFG[t].db}','${v.id}')">üóëÔ∏è</button><b>${WS_CFG[t].title}</b> [${fd2(v.date)}]<div style="font-size:11px;color:#333;margin-bottom:5px;font-weight:bold">üïë ${ts}</div><div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator||'-'} / ${v.assistant||'-'}</div><div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">`+v.items.map(i=>{let r=i.l?` <span style="color:#d97706;font-weight:bold">+ ${i.l}–∫–≥</span>`:'';return `<div class="report-line"><span>${i.n}</span><div style="text-align:right"><b class="val-pos">${i.q}–º √ó ${i.w}–∫–≥</b>${r}</div></div>`}).join('')+bh+lh+`</div>`}});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π'}
function rFas(c){renderByTiles(c,data.–§–∞—Å–æ–≤–∫–∞,'FAS')}function rKrup(c){renderByTiles(c,data.Krup_Report,'KRUP')}function rVibro(c){renderByTiles(c,data.Vibro_Report,'VIBRO')}function rZSHM(c){renderByTiles(c,data.ZSHM_Report,'ZSHM')}
function rArchPack(c){const d=data.ArchPackIn||{},g={};if(d)Object.entries(d).forEach(([i,v])=>{if(!v.date)return;const o=new Date(v.date),y=o.getFullYear(),m=o.getMonth();if(!g[y])g[y]={};if(!g[y][m])g[y][m]=[];g[y][m].push({...v,id:i})});let h='';Object.keys(g).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('py${y}')">${y}</div></div><div id="py${y}" class="arch-content"><div class="arch-m-grid">`;Object.keys(g[y]).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('pm${y}${m}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(g[y]).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="pm${y}${m}" class="arch-content">`;g[y][m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{h+=`<div class="arch-inv"><div><b>${(v.num||'–ë/–ù')}</b>${v.name} (<span class="val-pos">+${v.amount} ${v.category==='–ü–ª–µ–Ω–∫–∞'?'–∫–≥':'—à—Ç'}</span>)</div><div style="font-size:10px;color:#888">${v.supplier||'-'}</div></div>`});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('–ì–æ—Ç–æ–≤–∞—è','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','–ì–æ—Ç–æ–≤–∞—è','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('WeightStock','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','WeightStock','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rRaw(c){const t={};gP('Stock_Raw').forEach(p=>t[p]=0);if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('Stock_Raw','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','Stock_Raw','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rGen(c){const d=data[cur]||{},t={};Object.values(d).forEach(v=>{let k=v.name;if(k)t[k]=(t[k]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const val=t[k];let alarm=val<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&val<50)alarm=!0;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&val<30)alarm=!0;if(cur==='–ü–∞–∫–µ—Ç—ã'&&val<3000)alarm=!0;if(cur==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'&&val<5)alarm=!0;if(cur==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'&&val<5)alarm=!0;let u='–∫–≥',dv=Math.round(val);if(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(cur))u='—à—Ç';if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')dv=val.toFixed(1);if(cur==='–ü–ª–µ–Ω–∫–∞'){dv=val.toFixed(2);u='–∫–≥'}if(cur==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'){dv=val.toFixed(2);u='—à—Ç'}h+=`<div class="item-card ${alarm?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty ${val>=0?'val-pos':'val-neg'}">${dv} <small style="font-size:10px">${u}</small></div><button class="history-btn" onclick="showH('${cur}','${k}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}','${k}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function addTimeRow(p="",r=""){const i=Date.now()+Math.random(),s=gID('gTS')?gID('gTS').value:'08:00',e=gID('gTE')?gID('gTE').value:'17:00';gID('tsRows').insertAdjacentHTML('beforeend',`<div class="ts-row" id="tr_${i}"><button class="btn-mini" onclick="this.classList.toggle('absent-active');this.classList.toggle('red')">(-)</button><input type="text" id="tn_${i}" class="ts-name-inp" placeholder="–§–∞–º–∏–ª–∏—è" value="${p}"><input type="number" id="rate_${i}" class="ts-rate-inp" placeholder="–≥—Ä–Ω" value="${r}"><input type="time" id="ts_${i}" value="${s}" class="ts-time-inp"><input type="time" id="te_${i}" value="${e}" class="ts-time-inp"><button class="btn-mini red" onclick="removeTimeRow('${i}')">√ó</button></div>`)}
function removeTimeRow(i){gID('tr_'+i).remove();saveCurrentCrewToLocal()}
function saveCurrentCrewToLocal(){const r=gID('tsRows').children,c=[];for(let w of r){const i=w.id.split('_')[1],n=gID('tn_'+i).value.trim(),ra=gID('rate_'+i).value.trim();if(n)c.push({name:n,rate:ra})}localStorage.setItem('activeCrew',JSON.stringify(c))}
async function saveTimesheetBatch(){const d=gID('gTD').value,r=gID('tsRows').children,u={},dv=d+"T12:00:00Z",ts=new Date().toISOString(),c=[];let k=0;for(let w of r){const i=w.id.split('_')[1],n=gID('tn_'+i).value.trim(),rt=parseFloat(gID('rate_'+i).value)||0;if(!n)continue;c.push({name:n,rate:gID('rate_'+i).value});const a=w.querySelector('.btn-mini').classList.contains('absent-active'),s=gID('ts_'+i).value,e=gID('te_'+i).value;let pay=0;if(!a&&s&&e&&rt>0){const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);let dr=(eh*60+em)-(sh*60+sm);if(dr<0)dr+=24*60;pay=Math.round((dr/60)*rt)}const key=db.child('Timesheet').push().key;u['/Timesheet/'+key]={date:dv,name:n,s:s,e:e,absent:a,ts:ts,rate:rt,pay:pay};k++}if(k===0)return alert("–ü—É—Å—Ç–æ");if(confirm(`–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–µ–ª—å –∑–∞ ${d}?`)){try{await db.update(u);localStorage.setItem('activeCrew',JSON.stringify(c));alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")}catch(e){alert("Err:"+e)}}}
function renderTsList(c){const r=data.Timesheet,n=new Set();if(r)Object.values(r).forEach(v=>n.add(v.name));let h='';Array.from(n).sort().forEach(x=>{h+=`<div class="item-card" onclick="openPersCal('${x}')" style="cursor:pointer;position:relative"><div class="item-title" style="font-size:12px;margin-bottom:0;height:auto;padding:10px 0">${x}</div><div class="ts-del-tile" onclick="event.stopPropagation();delPersonHistory('${x}')">√ó</div></div>`});const t=c||gID('tsList');if(t)t.innerHTML=h||'<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
async function delPersonHistory(n){if(confirm(`–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ${n}?`)){const u={};if(data.Timesheet)Object.entries(data.Timesheet).forEach(([k,v])=>{if(v.name===n)u['/Timesheet/'+k]=null});await db.update(u)}}
function openPersCal(n){calCurMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);renderPersCalGrid(n)}
function changeCalMonth(d,n){calCurMonth.setMonth(calCurMonth.getMonth()+d);renderPersCalGrid(n)}
function renderPersCalGrid(n){const y=calCurMonth.getFullYear(),m=calCurMonth.getMonth(),mn=mths[m],td=new Date(),dim=new Date(y,m+1,0).getDate(),fd=new Date(y,m,1).getDay()||7,sh={},nts=[];let tPay=0;if(data.Timesheet)Object.entries(data.Timesheet).forEach(([k,v])=>{if(v.name===n&&v.date){const d=new Date(v.date);if(d.getFullYear()===y&&d.getMonth()===m){sh[d.getDate()]={...v,id:k};tPay+=(v.pay||0)}}});if(data.Timesheet_Notes)Object.entries(data.Timesheet_Notes).forEach(([id,v])=>{if(v.name===n&&v.date){const d=new Date(v.date);if(d.getFullYear()===y&&d.getMonth()===m)nts.push({...v,day:d.getDate(),id:id})}});nts.sort((a,b)=>a.day-b.day);let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0"><button onclick="changeCalMonth(-1, '${n}')" style="border:none;background:0 0;font-size:20px;color:#334155">‚óÄ</button><div style="font-weight:900;color:#0f172a">${mn} ${y}</div><button onclick="changeCalMonth(1, '${n}')" style="border:none;background:0 0;font-size:20px;color:#334155">‚ñ∂</button></div><div class="cal-grid"><div class="cal-head">–ü–ù</div><div class="cal-head">–í–¢</div><div class="cal-head">–°–†</div><div class="cal-head">–ß–¢</div><div class="cal-head">–ü–¢</div><div class="cal-head" style="color:#ef4444">–°–ë</div><div class="cal-head" style="color:#ef4444">–í–°</div>`;for(let i=1;i<fd;i++)h+=`<div></div>`;for(let d=1;d<=dim;d++){let cur=new Date(y,m,d),dow=cur.getDay(),isW=(dow===0||dow===6),cl=isW?"cal-date weekend":"cal-date";if(y===td.getFullYear()&&m===td.getMonth()&&d===td.getDate())cl+=" today";let o='',sid=sh[d]?sh[d].id:'';if(sh[d]){const s=sh[d];if(s.absent)o=`<div class="cal-overlay pearl-pink-text">–û–¢–ì–£–õ</div>`;else o=`<div class="cal-overlay pearl-green-text"><div>${s.s||''}</div><div>${s.e||''}</div></div>`}h+=`<div class="cal-cell" onclick="openDayModal('${n}','${y}-${m+1}-${d}','${sid}')"><div class="${cl}">${d}</div>${o}</div>`}h+=`</div><div style="margin-top:10px;background:#ecfdf5;padding:10px;border-radius:10px;border:1px solid #a7f3d0;text-align:center;font-weight:900;color:#065f46">–ó–ê–†–ü–õ–ê–¢–ê –ó–ê ${mn}: ${tPay} –≥—Ä–Ω</div><div style="margin-top:15px;background:#fff;border-radius:10px;border:1px solid #e2e8f0;padding:10px"><div style="font-size:12px;font-weight:900;color:#64748b;margin-bottom:5px;text-transform:uppercase">–ó–∞–ø–∏—Å–∏</div>`;if(nts.length===0)h+=`<div style="font-size:12px;color:#999;text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>`;else nts.forEach(x=>{h+=`<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #eee;padding:5px 0;font-size:13px"><div style="color:#333"><b style="color:var(--p)">${x.day}.</b> ${x.note}</div><button onclick="delTsNote('${x.id}','${n}')" style="border:none;background:none;color:red;font-weight:bold">√ó</button></div>`});h+=`</div><button class="btn-main" onclick="closeModal()" style="margin-top:15px;background:#64748b">–ó–ê–ö–†–´–¢–¨</button>`;gID('mT').innerText=n;gID('mB').innerHTML=h;gID('mdl').style.display='flex'}
function openDayModal(n,d,sid){let h=`<div style="text-align:center;font-weight:900;color:#333;margin-bottom:10px;font-size:16px">${d}</div>`;if(sid){const s=data.Timesheet[sid];h+=`<div style="background:#f8fafc;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:15px"><div style="font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–ú–ï–ù–´</div><div style="display:flex;gap:5px;align-items:center;justify-content:center;margin-bottom:10px"><input type="time" id="edS" value="${s.s}" class="ts-time-inp" style="width:80px"><span style="font-weight:bold">-</span><input type="time" id="edE" value="${s.e}" class="ts-time-inp" style="width:80px"></div><div style="text-align:center;font-size:12px;margin-bottom:10px">–¢–∞—Ä–∏—Ñ: <b>${s.rate}</b> –≥—Ä–Ω/—á–∞—Å</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" onclick="saveShiftEdit('${sid}','${n}')" style="margin:0">–ü–ï–†–ï–°–ß–ò–¢–ê–¢–¨</button><button class="btn-main" onclick="delShift('${sid}','${n}')" style="margin:0;background:#fee2e2;color:red;border:1px solid #fca5a5">–£–î–ê–õ–ò–¢–¨</button></div></div>`}h+=`<div style="border-top:1px dashed #ccc;padding-top:10px"><label class="l-t">–î–û–ë–ê–í–ò–¢–¨ –ó–ê–ú–ï–¢–ö–£ (–ê–í–ê–ù–°)</label><input type="text" id="newNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–≤–∞–Ω—Å 500"><button class="btn-main" onclick="addTsNoteDirect('${n}','${d}')" style="background:#e0e7ff;color:var(--p)">–î–û–ë–ê–í–ò–¢–¨ –ó–ê–ü–ò–°–¨</button></div>`;gID('mB').innerHTML=h;gID('mT').innerText=n;gID('mdl').style.display='flex'}
async function saveShiftEdit(id,n){const s=gID('edS').value,e=gID('edE').value,rec=data.Timesheet[id],rt=rec.rate||0;let pay=0;if(s&&e&&rt>0){const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);let dr=(eh*60+em)-(sh*60+sm);if(dr<0)dr+=24*60;pay=Math.round((dr/60)*rt)}await db.child('Timesheet').child(id).update({s:s,e:e,pay:pay});openPersCal(n)}
async function delShift(id,n){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?'))return;await db.child('Timesheet').child(id).remove();openPersCal(n)}
async function addTsNoteDirect(n,d){const t=gID('newNote').value;if(!t)return;const u={};u['/Timesheet_Notes/'+db.child('Timesheet_Notes').push().key]={name:n,date:d,note:t};await db.update(u);openPersCal(n)}
async function delTsNote(id,n){if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?'))return;await db.child('Timesheet_Notes').child(id).remove();openPersCal(n)}
function showH(c,k){const t=gID('mT'),b=gID('mB');t.innerText=k;const l=[];if(data[c])Object.entries(data[c]).filter(([i,v])=>v.name===k).forEach(([i,v])=>{let n=v.note||'–ó–∞–ø–∏—Å—å';if(v.supplier)n='–ü—Ä–∏—Ö–æ–¥: '+v.supplier;if(v.client)n='–û—Ç–≥—Ä—É–∑–∫–∞: '+v.client;l.push({d:v.date,ts:v.ts||'',n:n,a:v.amount,id:i,isFix:v.isFix})});const cm=new Date().toISOString().slice(0,7),ar={},cl=[];l.forEach(v=>{const m=v.d.slice(0,7);if(m===cm)cl.push(v);else{if(!ar[m])ar[m]=[];ar[m].push(v)}});cl.sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts));let h='<div style="margin-top:10px">';const sm=Object.keys(ar).sort().reverse();if(sm.length>0){h+=`<div class="arch-y-grid" style="margin-bottom:15px">`;sm.forEach(k=>{const[y,m]=k.split('-'),nm=mths[parseInt(m)-1];h+=`<div class="arch-tile-y" style="font-size:12px;padding:15px 5px;background:#f1f5f9;color:#64748b;box-shadow:none;border:1px solid #cbd5e1" onclick="toggleF('h_${k}')">üìÅ ${nm} ${y}</div>`});h+=`</div>`;sm.forEach(k=>{h+=`<div id="h_${k}" class="arch-content" style="border-left:2px solid #ccc;padding-left:10px;margin-bottom:10px">`;ar[k].sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts)).forEach(v=>{h+=renderHistRow(c,v)});h+=`</div>`})}if(cl.length>0){h+=`<div style="font-size:10px;color:#94a3b8;font-weight:800;margin-bottom:5px;text-transform:uppercase">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (${mths[new Date().getMonth()]})</div><div style="display:flex;flex-direction:column;gap:0;">`;cl.forEach(v=>{h+=renderHistRow(c,v)});h+='</div>'}else h+=`<div style="text-align:center;padding:20px;color:#94a3b8;font-size:12px">–ü—É—Å—Ç–æ</div>`;h+='</div>';b.innerHTML=h;gID('mdl').style.display='flex'}
function renderHistRow(c,v){if(v.isFix)return `<div style="background:#fffbeb;padding:10px;border-radius:8px;margin:5px 0;font-size:12px;color:#92400e;display:flex;justify-content:space-between;align-items:center;border:1px solid #fcd34d;"><span style="font-weight:700">üìå ${v.n}</span><span style="font-size:10px;color:#b45309">${fd2(v.d)}</span>${corrMode?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;font-size:14px;margin-left:5px">üóëÔ∏è</button>`:''}</div>`;const p=v.a>0?'+':'',vd=(c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')?v.a.toFixed(2):(c==='–ü–∞–∫–µ—Ç—ã'||c==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'?Math.round(v.a):v.a.toFixed(1));return `<div style="display:flex;align-items:center;border-bottom:1px solid #f1f5f9;justify-content:space-between;padding:2px 0"><div style="padding:8px 0;width:60%"><div style="font-weight:600;color:#1e293b;font-size:13px">${v.n}</div><div style="font-size:10px;color:#94a3b8">${fd2(v.d)}</div></div><div style="text-align:right;font-weight:800;font-size:14px;width:30%" class="${v.a>=0?'hist-pos':'hist-neg'}">${p}${vd}</div><div style="width:30px;text-align:center">${corrMode?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;font-size:16px;color:red">üóëÔ∏è</button>`:''}</div></div>`}
async function sFixBal(){const d=gID('fixDate').value;if(!d)return alert('–î–∞—Ç—É!');const ds=d+"T00:00:00.000Z",u={},b=gID('btnFix');b.disabled=!0;b.innerText="...";let k=0;stockCatsAll.forEach(c=>{if(!data[c])return;const s={};Object.values(data[c]).forEach(v=>s[v.name]=(s[v.name]||0)+v.amount);Object.keys(s).forEach(n=>{const a=s[n];if(Math.abs(a)>.01){u[`/${c}/${db.child(c).push().key}`]={name:n,amount:0,date:ds,ts:ds,note:`üü¢ –û–°–¢–ê–¢–û–ö: ${Math.round(a)}`,isFix:!0};k++}})});try{await db.update(u);alert("–ì–æ—Ç–æ–≤–æ");closeModal()}catch(e){alert(e);b.disabled=!1;b.innerText="–°–û–•–†–ê–ù–ò–¢–¨"}}
async function runArchive(){const d=gID('archDate').value;if(!d||!confirm(`–°–í–ï–†–ù–£–¢–¨ –±–∞–∑—É –¥–æ ${d}?\n\n–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`))return;const b=gID('btnArch'),cd=d+"T00:00:00.000Z",u={};b.disabled=!0;b.innerText="...";let f=0,l=0;stockCatsAll.forEach(c=>{if(!data[c])return;const s={};Object.entries(data[c]).forEach(([k,v])=>{if(v.date<cd){s[v.name]=(s[v.name]||0)+v.amount;u[`/${c}/${k}`]=null;l++}});Object.keys(s).forEach(n=>{const a=s[n];if(Math.abs(a)>.01){u[`/${c}/${db.child(c).push().key}`]={name:n,amount:a,date:cd,ts:new Date().toISOString(),note:`üü¢ –°–í–ï–†–¢–ö–ê –ë–ê–ó–´`,isFix:!0};f++}})});['–§–∞—Å–æ–≤–∫–∞','Krup_Report','Vibro_Report','ZSHM_Report','ArchInvoices','ArchIncoming','ArchPackIn'].forEach(c=>{if(!data[c])return;Object.entries(data[c]).forEach(([k,v])=>{if(v.date<cd){u[`/${c}/${k}`]=null;l++}})});try{await db.update(u);alert("–ì–æ—Ç–æ–≤–æ");closeModal()}catch(e){alert(e);b.disabled=!1;b.innerText="–°–í–ï–†–ù–£–¢–¨ –ë–ê–ó–£"}}
function rInvD(c){const k=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[k]||{},t={};Object.entries(d).forEach(([i,v])=>{if(!v.date)return;const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth();if(!t[y])t[y]={m:{}};if(!t[y].m[m])t[y].m[m]=[];t[y].m[m].push({...v,id:i})});let h='';Object.keys(t).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}')">${y}</div></div><div id="y${y}" class="arch-content"><div class="arch-m-grid">`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="m${y}${m}" class="arch-content" style="grid-column:1/-1;">`;t[y].m[m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{if(k==='ArchIncoming'){h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`);else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`;h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`}else{h+=`<div class="j-card"><div class="j-head">–û–¢–ì–†–£–ó–ö–ê</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=drawShipItem(i));h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`}});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
function rInvC(c){const k=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[k]||{},t={};Object.entries(d).forEach(([i,v])=>{if(!v.date)return;const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth(),cl=v.client||v.supplier||'–ë–µ–∑ –∏–º–µ–Ω–∏';if(!t[y])t[y]={m:{}};if(!t[y].m[m])t[y].m[m]={cl:{}};if(!t[y].m[m].cl[cl])t[y].m[m].cl[cl]=[];t[y].m[m].cl[cl].push({...v,id:i})});let h='';Object.keys(t).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('cy${y}')">${y}</div></div><div id="cy${y}" class="arch-content"><div class="arch-m-grid">`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('cm${y}${m}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="cm${y}${m}" class="arch-content" style="grid-column:1/-1;">`;Object.keys(t[y].m[m].cl).sort().forEach(n=>{const id=`c${y}${m}${n.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/g,'')}`,cnt=t[y].m[m].cl[n].length;h+=`<div class="arch-tile-c" style="margin-bottom:2px" onclick="toggleF('${id}')">${n}<div class="arch-badge">${cnt}</div></div><div id="${id}" class="arch-content" style="margin-bottom:10px;border-left:2px solid var(--p);padding-left:5px;">`;t[y].m[m].cl[n].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{if(k==='ArchIncoming'){h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`);else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`;h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`}else{h+=`<div class="j-card"><div class="j-head">–û–¢–ì–†–£–ó–ö–ê</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=drawShipItem(i));h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`}});h+=`</div>`});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
function makeSelect(i,c,p,so,nl){let o=`<option value="">${p}...</option>`,l=[];if(so)l=so;else{if(c==='Stock_DV'){const r=new Set();gP(c).forEach(f=>r.add(f.split(' [')[0]));l=Array.from(r).sort()}else l=gP(c)}l.forEach(n=>o+=`<option value="${n}">${n}</option>`);o+=`<option value="NEW" style="font-weight:bold;color:var(--p)">${nl||'+ –ù–û–í–´–ô –í–ò–î'}</option>`;return `<select id="s_${i}" onchange="toggleInput('${i}')" style="width:100%">${o}</select><input type="text" id="i_${i}" class="new-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="display:none;width:100%">`}
function makeSmart(i,l,p){let o=`<option value="">${p}</option>`;if(l)l.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW_ENTRY" style="font-weight:900;color:blue">(+) –í–í–ï–°–¢–ò...</option>`;return `<div class="smart-wrap"><select id="s_${i}" class="smart-sel" onchange="checkSmart('${i}')">${o}</select><input type="text" id="i_${i}" class="smart-inp" placeholder="${p}"></div>`}
function checkSmart(i){const s=gID('s_'+i);if(s.value==='NEW_ENTRY'){s.style.display='none';const n=gID('i_'+i);n.style.display='block';n.focus()}}
function getSmartVal(i){const n=gID('i_'+i);if(n&&n.style.display==='block')return n.value;const s=gID('s_'+i);return s?s.value:''}
function getHistoryDeep(k){const s=new Set(),scan=n=>{if(data[n])Object.values(data[n]).forEach(v=>{if(v[k])s.add(v[k]);if(v.items)v.items.forEach(i=>{if(k==='weight'&&i.w)s.add(i.w);if(k==='name'&&i.n)s.add(i.n)})})};scan('Vibro_Report');scan('Krup_Report');scan('ZSHM_Report');return Array.from(s).sort()}
function openModal(t,a1,a2){const ti=gID('mT'),b=gID('mB'),td=new Date().toISOString().split('T')[0];aId=null;if(WS_CFG[t]){renderWorkshopModal(t,ti,b,td);gID('mdl').style.display='flex';return}if(arguments.length===2&&(t!=='corr'))aId=a1;if(t==='corr'){const c=a1,n=a2;corrCtx={cat:c,name:n};ti.innerText='–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: '+n;b.innerHTML=`<div style="margin-bottom:15px;background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0"><div style="font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #cbd5e1;padding:8px;font-size:11px" onclick="renameItem('${n}','${c}')">‚úèÔ∏è –ò–ú–Ø</button><button class="btn-main" style="background:#fee2e2;color:red;border:1px solid #fca5a5;padding:8px;font-size:11px" onclick="delItemBatch('${n}','${c}')">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button></div></div><hr style="border:none;border-top:1px dashed #cbd5e1;margin:10px 0"><label class="l-t">–î–ê–¢–ê</label><input type="date" id="cD" value="${td}"><label class="l-t">–ò–ó–ú–ï–ù–ò–¢–¨ –û–°–¢–ê–¢–û–ö (+/-)</label><div style="display:flex;gap:5px"><input type="number" id="cA" placeholder="0"><button onclick="gID('cA').value *= -1" style="width:50px;font-weight:900;background:#eef2ff;border:1px solid #cbd5e1;border-radius:10px">+/-</button></div><label class="l-t">–ü–†–ò–ß–ò–ù–ê</label><input type="text" id="cR" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ—Ä–µ—É—á–µ—Ç"><button class="btn-main" id="btnS" onclick="sCorr()" style="margin-top:10px">–°–û–•–†–ê–ù–ò–¢–¨</button>`}else if(t==='fas'){ti.innerText='–§–∞—Å–æ–≤–∫–∞ (–ú—É–ª—å—Ç–∏)';b.innerHTML=`<label class="l-t">–î–ê–¢–ê</label><input type="date" id="fD" value="${td}"><div class="z-head" style="margin-top:10px">–°–´–†–¨–ï (–í–•–û–î)</div><div class="z-col-h" style="grid-template-columns:25% 45% 20% 10%"><div>–û–¢–ö–£–î–ê</div><div>–ß–¢–û</div><div>–ö–ì</div><div></div></div><div id="fasRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px solid #e2e8f0;padding:8px;font-size:11px" onclick="addFasRow()">+ –î–û–ë–ê–í–ò–¢–¨ –°–´–†–¨–ï</button><div class="z-head" style="margin-top:15px;background:#eef2ff;color:var(--p)">–ì–û–¢–û–í–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø (–í–´–•–û–î)</div><div class="z-col-h" style="grid-template-columns:45% 25% 20% 10%"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ü–ê–ö–ï–¢</div><div>–®–¢</div><div></div></div><div id="fasOutRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px solid #e2e8f0;padding:8px;font-size:11px" onclick="addFasOutRow()">+ –î–û–ë–ê–í–ò–¢–¨ –ü–†–û–î–£–ö–¶–ò–Æ</button><div style="margin-top:15px;border-top:1px dashed #e2e8f0;padding-top:10px"><label class="l-t">–í–ó–Ø–õ –ü–õ–ï–ù–ö–ò (—á–µ—Ä–µ–∑ +)</label><input type="text" id="fVz" placeholder="5+2.5"><label class="l-t">–û–°–¢–ê–¢–û–ö –ü–õ–ï–ù–ö–ò</label><input type="number" id="fOs" placeholder="–û—Å—Ç–∞—Ç–æ–∫"></div><button class="btn-main" id="btnS" onclick="sFas()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;setTimeout(()=>{addFasRow();addFasOutRow()},100)}else if(t==='addRaw'){ti.innerText='–ü—Ä–∏—Ö–æ–¥ –°—ã—Ä—å—è';b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="rD" value="${td}">–ù–∞–∑–≤–∞–Ω–∏–µ:${makeSelect('rN','Stock_Raw','–ù–∞–∑–≤–∞–Ω–∏–µ')}–ü–æ—Å—Ç–∞–≤—â–∏–∫:${makeSelect('rSupp','','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gRawActive(),'+ –ù–û–í–´–ô')}–í–µ—Å (–∫–≥):<input type="number" id="rA"><button class="btn-main" id="btnS" onclick="sRawInc()">–ü–†–ò–ù–Ø–¢–¨</button>`}else if(t==='inc'){ti.innerText='–ü–†–ò–•–û–î –ù–ê –°–ö–õ–ê–î';b.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:5px"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="iD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="iNum" placeholder="‚Ññ"></div></div><div style="margin-bottom:5px"><label class="l-t">–ü–û–°–¢–ê–í–©–ò–ö</label>${makeSelect('iS','ArchIncoming','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gBuyS(),'+ –ù–û–í–´–ô')}</div><div style="margin-bottom:5px"><label class="l-t">–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï</label>${makeSelect('iN','WeightStock','–¢–æ–≤–∞—Ä',gP('WeightStock'),'+ –ù–û–í–´–ô')}</div><div style="margin-bottom:15px"><label class="l-t">–í–ï–° (–ö–ì)</label><input type="number" id="iA" placeholder="0"></div><button class="btn-main" style="background:var(--s)" onclick="sInc()">–ü–†–ò–ù–Ø–¢–¨ –ù–ê –°–ö–õ–ê–î –ü–û–ö–£–ü–ù–ê–Ø</button>`}else if(t==='addMatPack'){ti.innerText='–ü–†–ò–•–û–î –£–ü–ê–ö–û–í–ö–ò';b.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:5px"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="pD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="pNum" placeholder="‚Ññ"></div></div><div style="margin-bottom:5px"><label class="l-t">–ü–û–°–¢–ê–í–©–ò–ö</label>${makeSelect('pS','ArchPackIn','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gPackS(),'+ –ù–û–í–´–ô')}</div><div style="margin-bottom:5px"><label class="l-t">–°–ö–õ–ê–î –ü–†–ò–ï–ú–ê</label><select id="pCat" onchange="updPackList()"><option value="–ü–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option><option value="–ü–ª–µ–Ω–∫–∞">–ü–ª–µ–Ω–∫–∞</option><option value="–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º">–°–∫–æ—Ç—á</option><option value="–ú–µ—à–∫–∏">–ú–µ—à–∫–∏</option><option value="–ù–∏—Ç–∫–∏">–ù–∏—Ç–∫–∏</option><option value="–≠—Ç–∏–∫–µ—Ç–∫–∞">–≠—Ç–∏–∫–µ—Ç–∫–∞</option><option value="–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞">–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞</option><option value="–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞">–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞</option></select></div><div style="margin-bottom:5px"><label class="l-t">–ü–†–û–î–£–ö–¶–ò–Ø</label><div id="pProdCont"></div></div><div style="margin-bottom:15px"><label class="l-t" id="pALbl">–ö–û–õ–ò–ß–ï–°–¢–í–û (–®–¢)</label><input type="number" id="pA" placeholder="0"></div><button class="btn-main" style="margin-top:10px;background:var(--s)" onclick="sPack()">–ü–†–ò–ù–Ø–¢–¨</button>`;setTimeout(updPackList,100)}else if(t==='ship'){useStretch=!1;shipBasket={};ti.innerText='–û–¢–ì–†–£–ó–ö–ê –°–û –°–ö–õ–ê–î–ê';b.innerHTML=`<div class="grid" style="grid-template-columns:2fr 1fr"><div class="col"><label class="lt">–î–ê–¢–ê</label><input type="date" id="hD" value="${td}"></div><div class="col"><label class="lt">‚Ññ –ù–ê–ö–õ</label><input type="text" id="hNum" placeholder="‚Ññ"></div></div><div style="margin:5px 0"><label class="lt">–ö–õ–ò–ï–ù–¢</label>${makeSelect('hC','ArchInvoices','–ö–ª–∏–µ–Ω—Ç',gCl(),'+ –ù–û–í–´–ô')}</div><div class="z-head">–û–¢–ö–£–î–ê –ì–†–£–ó–ò–ú:</div><div id="shipBtns" class="dash-grid" style="margin-bottom:10px;grid-template-columns:1fr 1fr"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('–ì–æ—Ç–æ–≤–∞—è')">–§–ê–°–û–í–ö–ê</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_DV')">–î–í</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_Feed')">–ö–û–†–ú–ê</button></div><div id="shpR"></div><div style="margin-top:10px;border-top:1px dashed #cbd5e1;padding-top:10px"><button id="btnStr" class="btn-main" onclick="toggleStr(this)" style="background:#f1f5f9;color:#333;border:1px solid #cbd5e1">–°–¢–†–ï–ô–ß: –ù–ï–¢</button></div><button class="btn-main" id="btnS" onclick="sShip()" style="margin-top:15px;background:var(--d)">–û–¢–ì–†–£–ó–ò–¢–¨</button>`}else if(t==='fixBal'){ti.innerText='–§–∏–∫—Å–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤';b.innerHTML=`<p style="font-size:12px;color:#666">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è?</p><input type="date" id="fixDate" value="${td}"><button class="btn-main" id="btnFix" onclick="sFixBal()" style="background:#f59e0b">–°–û–•–†–ê–ù–ò–¢–¨ –ú–ï–¢–ö–£</button>`}else if(t==='dayRep'){ti.innerText='–î–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç';b.innerHTML=`<label class="l-t">–î–ê–¢–ê</label><input type="date" id="repDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" onclick="genDayReport()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨</button>`}else if(t==='archiveOld'){ti.innerText='–°–í–ï–†–¢–ö–ê –ë–ê–ó–´ (–û–ü–ê–°–ù–û)';b.innerHTML=`<div style="background:#fee2e2;padding:10px;border-radius:10px;border:1px solid #f87171;color:#b91c1c;font-size:12px;margin-bottom:15px"><b>–í–ù–ò–ú–ê–ù–ò–ï!</b> –£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –æ—Å—Ç–∞—Ç–∫–∏.</div><label class="l-t">–°–í–ï–†–ù–£–¢–¨ –î–û:</label><input type="date" id="archDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" id="btnArch" onclick="runArchive()" style="background:#dc2626;border:none">–ù–ê–ß–ê–¢–¨ –°–í–ï–†–¢–ö–£</button>`}gID('mdl').style.display='flex'}
function toggleStr(b){useStretch=!useStretch;if(useStretch){b.style.background='var(--p)';b.style.color='#fff';b.innerText='–°–¢–†–ï–ô–ß: –î–ê (–ê–í–¢–û)'}else{b.style.background='#f1f5f9';b.style.color='#333';b.innerText='–°–¢–†–ï–ô–ß: –ù–ï–¢'}}
window.updPackList=()=>{const c=gID('pCat').value;gID('pALbl').innerText=(c==='–ü–ª–µ–Ω–∫–∞')?'–ö–û–õ–ò–ß–ï–°–¢–í–û (–ö–ì)':'–ö–û–õ–ò–ß–ï–°–¢–í–û (–®–¢)';const s=new Set();if(data[c])Object.values(data[c]).forEach(v=>s.add(v.name));if(c==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));gID('pProdCont').innerHTML=makeSelect('pN','','–í—ã–±–µ—Ä–∏—Ç–µ...',Array.from(s).sort(),'+ –ù–û–í–´–ô')}
function addFasRow(){const i=Date.now()+Math.random();gID('fasRows').insertAdjacentHTML('beforeend',`<div class="fas-row" id="fr_${i}"><select class="smart-sel" id="src_${i}" onchange="updFasRawList('${i}')" style="font-size:10px;padding:0"><option value="WeightStock">–ü–æ–∫—É–ø–Ω</option><option value="Stock_DV">–î–í</option></select><div id="cont_${i}"></div><input type="number" id="qty_${i}" class="u-inp" placeholder="–ö–≥"><button class="del-row-btn" onclick="document.getElementById('fr_${i}').remove()">‚úï</button></div>`);updFasRawList(i)}
function updFasRawList(i){const s=gID('src_'+i).value,m={};if(data[s])Object.values(data[s]).forEach(v=>m[v.name]=(m[v.name]||0)+v.amount);let l=Object.keys(m).filter(k=>m[k]>0).sort(),o='<option value="">–í—ã–±—Ä–∞—Ç—å...</option>';l.forEach(k=>o+=`<option value="${k}">${k} [–û—Å—Ç: ${Math.round(m[k])}–∫–≥]</option>`);gID('cont_'+i).innerHTML=`<select id="nm_${i}" class="smart-sel" style="font-size:11px">${o}</select>`}
function addFasOutRow(){const i=Date.now()+Math.random(),o1=gP('–ì–æ—Ç–æ–≤–∞—è').map(p=>`<option>${p}</option>`).join(''),o2=szs.map(s=>`<option>${s}</option>`).join('');gID('fasOutRows').insertAdjacentHTML('beforeend',`<div class="fas-out-row" id="fo_${i}"><select id="outN_${i}" class="smart-sel" style="font-size:11px">${o1}</select><select id="outS_${i}" class="smart-sel" style="font-size:11px">${o2}</select><input type="number" id="outQ_${i}" class="u-inp" placeholder="–®—Ç"><button class="del-row-btn" onclick="document.getElementById('fo_${i}').remove()">‚úï</button></div>`)}
function genDayReport(){const d=gID('repDate').value;if(!d)return;const r={inc:[],out:{},used:{},prod:{},pack:{}},ds=d.split('-').reverse().join('.');if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.date&&v.date.startsWith(d))r.inc.push(`${v.name} (${v.supplier}) ${v.amount}–∫–≥`)});if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.date&&v.date.startsWith(d))r.inc.push(`${v.name} (${v.supplier}) ${v.amount}—à—Ç`)});if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>{if(v.date&&v.date.startsWith(d))v.items.forEach(i=>{let p=i.split('|');if(p.length<2&&i.includes(':'))p=i.split(':');let n=p[0],a=parseFloat(p[1])||0,u=p[2]||'–∫–≥';if(!r.out[n])r.out[n]={val:0,u:u};r.out[n].val+=a})});const au=(n,a,u)=>{if(!n)return;if(!r.used[n])r.used[n]={val:0,u:u};r.used[n].val+=a},ap=(n,a,u)=>{if(!n)return;if(!r.prod[n])r.prod[n]={val:0,u:u};r.prod[n].val+=a};if(data.–§–∞—Å–æ–≤–∫–∞)Object.values(data.–§–∞—Å–æ–≤–∫–∞).forEach(v=>{if(v.date&&v.date.startsWith(d)){if(v.items)v.items.forEach(i=>{let s=(i.source==='WeightStock')?'(–ø–æ–∫)':'(–î–í)';au(`${i.name} ${s}`,parseFloat(i.amount),'–∫–≥')});else au(v.rawItem,parseFloat(v.prihod),'–∫–≥');if(v.outputItems)v.outputItems.forEach(o=>ap(o.name,parseFloat(o.count),'—à—Ç'));else ap(v.name,parseFloat(v.vyhod),'—à—Ç')}});['Vibro_Report','Krup_Report','ZSHM_Report'].forEach(db=>{if(data[db])Object.values(data[db]).forEach(v=>{if(v.date&&v.date.startsWith(d)){if(v.rawMix){let m=v.rawMix.match(/^(.*)\s\((\d+(\.\d+)?)–∫–≥\)$/);if(m)au(m[1],parseFloat(m[2]),'–∫–≥');else au(v.rawMix,0,'')}if(v.items)v.items.forEach(i=>ap(i.n,(i.q*i.w)+i.l,'–∫–≥'))}})});['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].forEach(c=>{if(data[c])Object.values(data[c]).forEach(v=>{if(v.date&&v.date.startsWith(d)&&v.amount<0){let n=v.name,u=(c==='–ü–ª–µ–Ω–∫–∞')?'–∫–≥':'—à—Ç';if(!r.pack[n])r.pack[n]={val:0,u:u};r.pack[n].val+=Math.abs(v.amount)}})});const rd=t=>`<span style="color:var(--red)">${t}</span>`,bl=t=>`<span style="color:var(--blue)">${t}</span>`;let h=`<div class="day-rep-box">–û—Ç—á—ë—Ç –∑–∞ ${ds}<div class="dr-h">–ü—Ä–∏—Ö–æ–¥:</div>`;if(r.inc.length)r.inc.forEach(l=>h+=bl(`+ ${l}`)+`\n`);else h+=`-\n`;h+=`<div class="dr-h">–û—Ç–≥—Ä—É–∂–µ–Ω–æ:</div>`;let ok=Object.keys(r.out).sort();if(ok.length)ok.forEach(k=>h+=rd(`- ${k} ${parseFloat(r.out[k].val.toFixed(1))}${r.out[k].u}`)+`\n`);else h+=`-\n`;h+=`<div class="dr-h">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ:</div>`;let uk=Object.keys(r.used).sort();if(uk.length)uk.forEach(k=>h+=rd(`- ${k} ${r.used[k].val>0?parseFloat(r.used[k].val.toFixed(1))+r.used[k].u:''}`)+`\n`);else h+=`-\n`;h+=`<div class="dr-h">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ:</div>`;let pk=Object.keys(r.prod).sort();if(pk.length)pk.forEach(k=>h+=bl(`+ ${k} ${parseFloat(r.prod[k].val.toFixed(1))}${r.prod[k].u}`)+`\n`);else h+=`-\n`;h+=`<div class="dr-h">–£–ø–∞–∫–æ–≤–∫–∞:</div>`;let kk=Object.keys(r.pack).sort();if(kk.length)kk.forEach(k=>h+=rd(`- ${k} ${parseFloat(r.pack[k].val.toFixed(1))}${r.pack[k].u}`)+`\n`);else h+=`-\n`;h+=`</div><button class="btn-main" onclick="copyDayRep()" style="background:#334155">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>`;gID('mB').innerHTML=h}
function copyDayRep(){const e=document.querySelector('.day-rep-box');if(e)navigator.clipboard.writeText(e.innerText).then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')).catch(e=>alert('–û—à–∏–±–∫–∞'))}
function renderWorkshopModal(t,te,be,td){const c=WS_CFG[t],p=c.prefix;te.innerText=c.title;const o=getHistoryDeep('operator'),a=getHistoryDeep('assistant'),ts=getHistoryDeep('timeStart');if(ts.length===0)ts.push('07:00');const tE=getHistoryDeep('timeEnd');if(tE.length===0)tE.push('17:00');be.innerHTML=`<div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px"><div style="display:grid;grid-template-columns:1.5fr 1fr 1fr;gap:8px;margin-bottom:10px"><div><label class="l-t">–î–ê–¢–ê</label><div class="smart-wrap"><input type="date" id="${p}D" value="${td}" class="smart-sel"></div></div><div><label class="l-t">–°</label>${makeSmart(p+'TS',ts,'07:00')}</div><div><label class="l-t">–î–û</label>${makeSmart(p+'TE',tE,'17:00')}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart(p+'Op',o,'–§–∞–º–∏–ª–∏—è')}</div><div><label class="l-t">–ü–û–ú–û–©–ù–ò–ö</label>${makeSmart(p+'As',a,'–§–∞–º–∏–ª–∏—è')}</div></div></div><div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee"><div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div><div style="display:grid;grid-template-columns:1fr 1.5fr 0.8fr;gap:5px;margin-bottom:5px"><select id="${p}WH" class="smart-sel" onchange="updGenRaw('${p}')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw" ${t!=='VIBRO'?'selected':''}>–°—ã—Ä—å—ë</option><option value="Stock_DV">–î–í</option><option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option></select><div id="${p}RawCont"></div><input type="number" id="${p}RawW" placeholder="–ö–≥" class="smart-sel" readonly style="background:#eef2ff;font-weight:900;color:#333"></div><div style="font-size:10px;color:#888;font-weight:700;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px">–î–û–ë–ê–í–ö–ê</div><div style="display:grid;grid-template-columns:1fr 1.5fr 0.8fr;gap:5px;margin-bottom:5px"><select id="${p}AddWH" class="smart-sel" onchange="updGenAdd('${p}')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw">–°—ã—Ä—å—ë</option><option value="Stock_DV">–î–í</option><option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option></select><div id="${p}AddNameCont"></div><input type="number" id="${p}AddW" placeholder="–ö–≥" class="smart-sel" oninput="calcGen('${p}')"></div></div><div class="z-head">–ì–û–¢–û–í–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø (–°–ö–õ–ê–î –î–í)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div><div id="${p}RowsDV"></div><button class="btn-main" style="background:#fff;color:#3b82f6;border:1px solid #3b82f6;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','DV')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button><div class="z-head" style="color:#d97706;background:#fef3c7;">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢ (–°–ö–õ–ê–î –ü/–§)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div><div id="${p}RowsSemi"></div><button class="btn-main" style="background:#fff;color:#d97706;border:1px solid #d97706;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','Semi')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button><div class="z-head" style="color:#b45309;background:#fff7ed;">–û–¢–•–û–î–´ (–°–ö–õ–ê–î –ö–û–†–ú–ê)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div><div id="${p}RowsFeed"></div><button class="btn-main" style="background:#fff;color:#b45309;border:1px solid #b45309;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','Feed')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button><button class="btn-main" id="btnS" onclick="saveGen('${t}')">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>`;setTimeout(()=>{updGenRaw(p);updGenAdd(p);addGenRow(p,'DV');addGenRow(p,'Semi');addGenRow(p,'Feed')},50)}
function updGenRaw(p){const w=gID(p+'WH').value,l=Array.from(new Set(gP(w))).sort();gID(p+'RawCont').innerHTML=makeSmart(p+'RawItem',l,'–°—ã—Ä—å–µ')}function updGenAdd(p){const w=gID(p+'AddWH').value,l=Array.from(new Set(gP(w))).sort();gID(p+'AddNameCont').innerHTML=makeSmart(p+'AddItem',l,'–î–æ–±–∞–≤–∫–∞')}
function addGenRow(p,s){const i=Date.now()+Math.floor(Math.random()*1e3);let l;if(s==='DV')l=gP('Stock_DV');else if(s==='Semi')l=gP('Stock_Semi');else l=gP('Stock_Feed');const ls=Array.from(new Set(l)).sort(),wl=getHistoryDeep('weight');let wo='<option value="">–ö–≥</option>';wl.forEach(w=>wo+=`<option value="${w}">${w}</option>`);wo+='<option value="NEW_ENTRY">(+)</option>';let o=`<option value="">–í—ã–±—Ä–∞—Ç—å...</option>`;ls.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW_ENTRY" style="color:blue">(+) –ù–æ–≤—ã–π</option>`;const h=`<div class="dyn-row" id="${p}row_${i}" data-sect="${s}"><div class="smart-wrap"><select id="s_${p}N_${i}" class="smart-sel" onchange="checkSmart('${p}N_${i}')">${o}</select><input type="text" id="i_${p}N_${i}" class="smart-inp"></div><input type="number" id="${p}Q_${i}" class="u-inp" placeholder="0" oninput="calcGen('${p}')"><div class="smart-wrap"><select id="s_${p}W_${i}" class="smart-sel" onchange="checkSmart('${p}W_${i}')">${wo}</select><input type="number" id="i_${p}W_${i}" class="smart-inp" oninput="calcGen('${p}')"></div><input type="number" id="${p}L_${i}" class="u-inp" placeholder="–∫–≥" oninput="calcGen('${p}')"><button class="del-row-btn" onclick="document.getElementById('${p}row_${i}').remove();calcGen('${p}')">‚úï</button></div>`;let c=p+'RowsDV';if(s==='Semi')c=p+'RowsSemi';if(s==='Feed')c=p+'RowsFeed';gID(c).insertAdjacentHTML('beforeend',h)}
function calcGen(p){let t=0;const c=i=>{const r=gID(i).children;for(let w of r){const k=w.id.split('_')[1],q=parseFloat(gID(`${p}Q_${k}`).value)||0;let wg=parseFloat(gID(`i_${p}W_${k}`).value);if(!wg)wg=parseFloat(gID(`s_${p}W_${k}`).value)||0;const l=parseFloat(gID(`${p}L_${k}`).value)||0;t+=(q*wg)+l}};c(p+'RowsDV');c(p+'RowsSemi');c(p+'RowsFeed');const aw=parseFloat(gID(p+'AddW').value)||0,r=t-aw;gID(p+'RawW').value=r>0?r.toFixed(1):0}
async function saveGen(t){const c=WS_CFG[t],p=c.prefix,b=gID('btnS');calcGen(p);const rn=getSmartVal(p+'RawItem'),rw=parseFloat(gID(p+'RawW').value)||0,an=getSmartVal(p+'AddItem'),aw=parseFloat(gID(p+'AddW').value)||0,dv=gID(p+'D').value+"T12:00:00Z",ts=new Date().toISOString(),op=getSmartVal(p+'Op'),as=getSmartVal(p+'As'),tS=getSmartVal(p+'TS'),tE=getSmartVal(p+'TE');if(!rn||rw<=0)return alert('–û—à–∏–±–∫–∞ —Å—ã—Ä—å—è');const its=[];let tp=0;const h=(id,st)=>{const rs=gID(id).children;for(let r of rs){const k=r.id.split('_')[1];let n=getSmartVal(`${p}N_${k}`);if(!n)continue;let q=parseFloat(gID(`${p}Q_${k}`).value)||0,wg=parseFloat(gID(`i_${p}W_${k}`).value);if(!wg)wg=parseFloat(gID(`s_${p}W_${k}`).value)||0;let l=parseFloat(gID(`${p}L_${k}`).value)||0;if(q>0||l>0){its.push({n,q,w:wg,l,type:st});tp+=(q*wg)+l}}};h(p+'RowsDV','DV');h(p+'RowsSemi','Semi');h(p+'RowsFeed','Feed');if(its.length===0)return alert('–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ü–∏—é');let rd=`${rn} (${rw}–∫–≥)`;if(an&&aw>0)rd+=` + ${an} (${aw}–∫–≥)`;if(!confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º–µ–Ω—É?'))return;b.disabled=!0;b.innerText="...";let tb=0,b25=0,lm={};its.forEach(i=>{if(i.w!==40)tb+=i.q;if(i.w===25){let nl=i.n.toLowerCase();if(!nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞ 3')){let ln=null;if(nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞'))ln='–≠—Ç-–∫–∞ –ê—Ä–Ω–∞—É—Ç–∫–∞';else if(nl.includes('—è—á–∫–∞'))ln='–≠—Ç-–∫–∞ –Ø—á–∫–∞';else if(nl.includes('–ø—à–µ–Ω–∏—á–∫–∞'))ln='–≠—Ç-–∫–∞ –ü—à–µ–Ω–∏—á–∫–∞';else if(nl.includes('–ø–µ—Ä–ª–æ–≤–∫–∞'))ln='–≠—Ç-–∫–∞ –ü–µ—Ä–ª–æ–≤–∫–∞';else if(nl.includes('–≥–æ—Ä–æ—Ö'))ln='–≠—Ç-–∫–∞ –ì–æ—Ä–æ—Ö';else if(nl.includes('–ø—à–æ–Ω–æ'))ln='–≠—Ç-–∫–∞ –ü—à–æ–Ω–æ';else if(nl.includes('–∫—É–∫—É—Ä—É–∑–∞'))ln='–≠—Ç-–∫–∞ –ö—É–∫—É—Ä—É–∑–∞';if(ln){b25+=i.q;lm[ln]=(lm[ln]||0)+i.q}}}});let th=tb/1e3;try{const rid=db.child(c.db).push().key,u={},rwh=gID(p+'WH').value;u[`/${rwh}/${db.child(rwh).push().key}`]={name:rn,amount:-rw,date:dv,ts:ts,note:c.note+' –û—Å–Ω–æ–≤–∞',fLink:rid};if(an&&aw>0){let awh=gID(p+'AddWH').value;u[`/${awh}/${db.child(awh).push().key}`]={name:an,amount:-aw,date:dv,ts:ts,note:c.note+' –î–æ–±–∞–≤–∫–∞',fLink:rid}}its.forEach(i=>{let dst='Stock_DV',nt=c.note,fn=i.n;if(i.type==='DV'){dst='Stock_DV';let cn=i.n.replace(/\s\[.*?\]/g,'').trim();fn=(i.q>0?`${cn} [${i.w}–∫–≥]`:cn)}else if(i.type==='Semi'){dst='Stock_Semi';nt=c.note+' –ü/–§'}else if(i.type==='Feed'){dst='Stock_Feed';nt=c.note+' –û—Ç—Ö–æ–¥—ã'}let am=(i.q*i.w)+i.l;u[`/${dst}/${db.child(dst).push().key}`]={name:fn,amount:am,date:dv,ts:ts,note:nt,fLink:rid}});if(b25>0)u['/–ú–µ—à–∫–∏/'+db.child('–ú–µ—à–∫–∏').push().key]={name:'–ú–µ—à–∫–∏',amount:-b25,date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid};if(th>0)u['/–ù–∏—Ç–∫–∏/'+db.child('–ù–∏—Ç–∫–∏').push().key]={name:'–ù–∏—Ç–∫–∏',amount:-th,date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid};Object.keys(lm).forEach(l=>{u['/–≠—Ç–∏–∫–µ—Ç–∫–∞/'+db.child('–≠—Ç–∏–∫–µ—Ç–∫–∞').push().key]={name:l,amount:-lm[l],date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid}});u[`/${c.db}/${rid}`]={date:dv,ts:ts,link:rid,items:its,rawMix:rd,timeStart:tS,timeEnd:tE,operator:op,assistant:as,type:t};await db.update(u);closeModal()}catch(e){alert(e);b.disabled=!1}}
async function sCorr(){const b=gID('btnS'),d=gID('cD').value,a=parseFloat(gID('cA').value),r=gID('cR').value,c=corrCtx.cat,n=corrCtx.name;if(!a||!r)return;b.disabled=!0;try{const k=db.child(c).push().key,u={};u[`/${c}/${k}`]={name:n,amount:a,date:d+"T12:00:00Z",ts:new Date().toISOString(),note:'–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: '+r};await db.update(u);closeModal()}catch(e){alert(e);b.disabled=!1}}
async function sFas(){const b=gID('btnS'),d=gID('fD').value,ri=[],oi=[];let tp=0,tv=0;const rr=gID('fasRows').children;for(let r of rr){const k=r.id.split('_')[1],s=gID('src_'+k).value,n=gID('nm_'+k).value,q=parseFloat(gID('qty_'+k).value);if(n&&q>0){ri.push({name:n,amount:q,source:s});tp+=q}}const ro=gID('fasOutRows').children;for(let r of ro){const k=r.id.split('_')[1],n=gID('outN_'+k).value,s=gID('outS_'+k).value,q=parseFloat(gID('outQ_'+k).value);if(n&&q>0){oi.push({name:n,size:s,count:q});tv+=q}}if(ri.length===0||oi.length===0)return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");const fn=oi[0].name,os=parseFloat(gID('fOs').value)||0,vz=gID('fVz').value,vt=vz.split('+').reduce((acc,v)=>{let n=parseFloat(v.replace(',','.').trim());return acc+(isNaN(n)?0:n)},0);b.disabled=!0;try{const pu=Math.abs(vt-os),su=parseFloat(((tv*.12)/360).toFixed(1)),fid=db.child('–§–∞—Å–æ–≤–∫–∞').push().key,ts=new Date().toISOString(),dv=d+"T12:00:00Z",u={},rs=ri.map(i=>`${i.name}`).join(' + ');u['/–§–∞—Å–æ–≤–∫–∞/'+fid]={date:dv,prihod:tp,items:ri,outputItems:oi,rawItem:rs,vzial:vt,ostatok:os,scotch:su,link:fid,ts:ts,filmName:fn};ri.forEach(i=>{u[`/${i.source}/`+db.child(i.source).push().key]={name:i.name,amount:-i.amount,date:dv,note:'–§–∞—Å–æ–≤–∫–∞ (–°—ã—Ä—å–µ)',fLink:fid,ts:ts}});oi.forEach(i=>{u['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:i.name,amount:i.count,date:dv,note:'–§–∞—Å–æ–≤–∫–∞',fLink:fid,ts:ts};const k=(i.name==="–ö—É—Ç—è")?19.8:9.9,sp=-Math.round(i.count/k);u['/–ü–∞–∫–µ—Ç—ã/'+db.child('–ü–∞–∫–µ—Ç—ã').push().key]={name:i.size,amount:sp,date:dv,note:`(–∞–≤—Ç–æ) ${i.name}`,fLink:fid,ts:ts}});u['/–ü–ª–µ–Ω–∫–∞/'+db.child('–ü–ª–µ–Ω–∫–∞').push().key]={name:fn,amount:-pu,date:dv,note:'(–∞–≤—Ç–æ) –§–∞—Å–æ–≤–∫–∞',fLink:fid,ts:ts};u['/–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º/'+db.child('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º').push().key]={name:'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º',amount:-su,date:dv,note:'(–∞–≤—Ç–æ) –§–∞—Å–æ–≤–∫–∞',fLink:fid,ts:ts};await db.update(u);closeModal()}catch(e){alert(e);b.disabled=!1}}
function loadBulk(c){document.querySelectorAll('.bulk-q').forEach(i=>{const n=i.getAttribute('data-n'),ct=i.getAttribute('data-cat'),v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const bs=document.querySelectorAll('#shipBtns button');bs.forEach(b=>{let t=b.innerText,a=!1;if(c==='–ì–æ—Ç–æ–≤–∞—è'&&t.includes('–§–ê–°–û–í–ö–ê'))a=!0;if(c==='WeightStock'&&t.includes('–ü–û–ö–£–ü–ù–ê–Ø'))a=!0;if(c==='Stock_DV'&&t.includes('–î–í'))a=!0;if(c==='Stock_Feed'&&t.includes('–ö–û–†–ú–ê'))a=!0;if(a){b.style.background='#eef2ff';b.style.borderColor='var(--p)'}else{b.style.background='#fff';b.style.borderColor='#ccc'}});const s={};Object.values(data[c]||{}).forEach(v=>{if(v)s[v.name]=(s[v.name]||0)+v.amount});let h=`<div class="item-grid" style="grid-template-columns:repeat(3,1fr)">`;Object.keys(s).sort().forEach(n=>{const v=s[n];if(v>0){const k=n+'::'+c,sv=shipBasket[k]?shipBasket[k].w:'';h+=`<div class="item-card" style="padding:5px"><div class="item-title" style="height:20px">${n}</div><div style="font-size:10px;color:#888;margin-bottom:2px">–û—Å—Ç: ${Math.round(v)}</div><input type="number" class="bulk-q" data-n="${n}" data-cat="${c}" placeholder="0" style="width:100%" value="${sv}"></div>`}});gID('shpR').innerHTML=h+`</div>`}
async function sShip(){const sc=gID('s_hC'),c=(sc&&sc.value==='NEW')?gID('i_hC').value:(sc?sc.value:''),nm=gID('hNum').value,d=gID('hD').value,dv=d+"T12:00:00Z";if(!c)return alert('–ö–ª–∏–µ–Ω—Ç?');document.querySelectorAll('.bulk-q').forEach(i=>{const n=i.getAttribute('data-n'),ct=i.getAttribute('data-cat'),v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const it=[];let tw=0;Object.values(shipBasket).forEach(v=>{it.push({n:v.n,w:v.w,c:v.c});tw+=v.w});if(!it.length)return alert('–ü—É—Å—Ç–æ');if(!confirm('–û—Ç–≥—Ä—É–∑–∏—Ç—å?'))return;const b=gID('btnS');b.disabled=!0;try{const lk=db.child('ArchInvoices').push().key,u={};u['/ArchInvoices/'+lk]={date:dv,client:c,num:nm,items:it.map(x=>x.n+"|"+x.w+"|"+(x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥')+"|"+x.c),ts:new Date().toISOString()};it.forEach(i=>{u[`/${i.c}/${db.child(i.c).push().key}`]={name:i.n,amount:-i.w,date:dv,note:`–û—Ç–≥—Ä: ${c} ‚Ññ${nm}`,fLink:lk,ts:new Date().toISOString()}});if(useStretch){const q=parseFloat((tw*.000165).toFixed(2));if(q>0)u['/–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞/'+db.child('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞').push().key]={name:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',amount:-q,date:dv,note:`(–∞–≤—Ç–æ) –û—Ç–≥—Ä—É–∑–∫–∞ ${c}`,fLink:lk,ts:new Date().toISOString()}}await db.update(u);closeModal()}catch(e){alert(e);b.disabled=!1}}
async function sInc(){const ss=gID('s_iS'),s=(ss.value==='NEW')?gID('i_iS').value:ss.value,sn=gID('s_iN'),n=(sn.value==='NEW')?gID('i_iN').value:sn.value,a=parseFloat(gID('iA').value),nm=gID('iNum').value;if(!a)return;if(!confirm('–ü—Ä–∏–Ω—è—Ç—å –ü–û–ö–£–ü–ù–ê–Ø?'))return;const d=gID('iD').value+"T12:00:00Z",l=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+l]={date:d,supplier:s,name:n,amount:a,num:nm,ts:new Date().toISOString(),type:'GOODS'};u['/WeightStock/'+db.child('WeightStock').push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥ '+s+(nm?' ‚Ññ'+nm:''),fLink:l,ts:new Date().toISOString()};await db.update(u);closeModal()}
async function sPack(){const ss=gID('s_pS'),s=(ss.value==='NEW')?gID('i_pS').value:ss.value,sn=gID('s_pN'),si=gID('i_pN');let n='';if(sn&&sn.style.display!=='none')n=sn.value;else if(si&&si.style.display!=='none')n=si.value;if(n==='NEW'||n==='NEW_ENTRY')n=si.value;const a=parseFloat(gID('pA').value),nm=gID('pNum').value;if(!n||!a)return;if(!confirm('–ü—Ä–∏–Ω—è—Ç—å —É–ø–∞–∫–æ–≤–∫—É?'))return;const d=gID('pD').value+"T12:00:00Z",c=gID('pCat').value,l=db.child('ArchPackIn').push().key,u={};u['/ArchPackIn/'+l]={date:d,supplier:s,name:n,amount:a,num:nm,category:c,ts:new Date().toISOString()};u[`/${c}/`+db.child(c).push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥ '+s,fLink:l,ts:new Date().toISOString()};await db.update(u);closeModal()}
async function sRawInc(){const ss=gID('s_rSupp'),s=(ss.value==='NEW')?gID('i_rSupp').value:ss.value,sn=gID('s_rN'),n=(sn.value==='NEW')?gID('i_rN').value:sn.value,a=parseFloat(gID('rA').value);if(!a)return;if(!confirm('–ü—Ä–∏–Ω—è—Ç—å —Å—ã—Ä—å–µ?'))return;const d=gID('rD').value+"T12:00:00Z",ts=new Date().toISOString(),l=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+l]={date:d,supplier:s,name:n,amount:a,ts:ts,type:'RAW'};u['/Stock_Raw/'+db.child('Stock_Raw').push().key]={name:`${n} [${s}]`,amount:a,date:d,note:'–í—Ö '+s,fLink:l,ts:ts};await db.update(u);closeModal()}
async function delItemBatch(n,c){if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ –∏—Å—Ç–æ—Ä–∏—é?'))return;const u={};if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.name===n)u[`/${c}/${k}`]=null});await db.update(u);closeModal()}
async function renameItem(o,c){const n=prompt('–ù–æ–≤–æ–µ –∏–º—è:',o);if(!n||n===o)return;const u={};if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.name===o)u[`/${c}/${k}/name`]=n});await db.update(u);closeModal()}
</script></body></html>
