<!DOCTYPE html><html lang="uk" translate="no"><head><meta charset="UTF-8"><meta name="google" content="notranslate"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>–°–∫–ª–∞–¥ v760 "Commander"</title><script>window.onerror=function(m,u,l){alert("–ü–û–ú–ò–õ–ö–ê:\n"+m+"\n–†—è–¥–æ–∫: "+l);return false;};</script><link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png"><style>*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:0}:root{--bg:#f8fafc;--p:#4338ca;--d:#dc2626;--s:#059669;--t:#0f172a;--w:#fff;--blue:#2563eb;--red:#e11d48}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:5px;padding-bottom:80px;color:var(--t);overflow-x:hidden;width:100vw}#lockScreen{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:opacity .3s}.lock-hidden{opacity:0;pointer-events:none}.lock-logo{width:100px;margin-bottom:20px}.lock-title{font-size:16px;font-weight:900;color:#475569;letter-spacing:2px;margin-bottom:30px;text-transform:uppercase}.lock-inp{width:100%;max-width:250px;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e1;border-radius:12px;margin-bottom:10px;color:#000;font-weight:700}.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:100%;margin:0 auto}.dash-item{background:var(--w);border-radius:16px;padding:8px;text-align:center;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);color:var(--p);font-weight:800;text-transform:uppercase;font-size:12px;letter-spacing:.5px;border:1px solid #cbd5e1;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80px;position:relative;overflow:hidden}.dash-item:active{transform:scale(.97);background:#eef2ff;border-color:var(--p)}.dash-item span{font-size:12px;margin-bottom:2px;display:block;color:var(--p);font-weight:900;z-index:2}.card{background:var(--w);border-radius:16px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px -1px rgba(0,0,0,.08);border:1px solid #e2e8f0;position:relative;width:100%}.btn-main{background:var(--p);color:#fff;border:none;width:100%;padding:14px;font-size:13px;font-weight:800;border-radius:12px;margin:5px 0;text-transform:uppercase;box-shadow:0 4px 10px rgba(67,56,202,.2);transition:.2s;cursor:pointer}.btn-main:active{transform:translateY(1px);box-shadow:none}.btn-main:disabled{background:#94a3b8;cursor:not-allowed}.bottom-nav{display:none;position:fixed;bottom:10px;left:10px;right:10px;background:#fff;border-radius:20px;box-shadow:0 10px 40px -5px rgba(0,0,0,.2);padding:5px;z-index:900;grid-template-columns:1fr 1fr;gap:5px;border:1px solid #cbd5e1}.bottom-nav button{background:0 0;border:none;padding:12px;border-radius:14px;color:#64748b;font-weight:900;font-size:11px;text-transform:uppercase;letter-spacing:1px;transition:.2s}.bottom-nav button.nav-btn-active{background:#e0e7ff;color:var(--p);box-shadow:0 2px 5px rgba(0,0,0,.05)}body.nav-active .bottom-nav{display:grid}
input,select{width:100%;padding:0 5px;margin:2px 0;border:1px solid #94a3b8;border-radius:8px;font-size:12px;height:35px;background:#fff;font-weight:700;color:#0f172a}
input:focus,select:focus{border-color:var(--p);background:#f8fafc;outline:2px solid #e0e7ff}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}.g2{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.item-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}.item-card{background:#fff;border-radius:12px;padding:10px 2px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.08);border:1px solid #cbd5e1;position:relative}.item-title{font-size:10px;font-weight:900;text-transform:uppercase;color:#1e293b;margin-bottom:4px;height:24px;overflow:hidden;line-height:1.1;word-break:break-word}.item-qty{font-size:15px;font-weight:900;color:#000;margin-bottom:4px}.alarm-blink{background:#fef2f2!important;border:1px solid var(--d)!important;animation:blink 1s infinite alternate}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}.modal-box{background:#fff;width:96%;max-width:400px;border-radius:20px;max-height:94vh;display:flex;flex-direction:column;box-shadow:0 20px 40px -10px rgba(0,0,0,.3)}.modal-body{overflow-y:auto;padding:15px}.report-line{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px dashed #cbd5e1;color:#000;font-weight:600}.history-btn{border:none;background:#e0e7ff;color:var(--p);border-radius:8px;padding:8px;font-weight:800;font-size:12px;width:45%}.corr-btn{display:none;border:none;background:#fef3c7;color:#d97706;border-radius:8px;padding:8px;font-weight:800;font-size:12px;width:45%;margin-top:4px}.show-corr .corr-btn{display:inline-block}.hist-pos,.val-pos{color:#2563eb!important;font-weight:900}.hist-neg,.val-neg{color:#dc2626!important;font-weight:900}.arch-y-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;width:100%}.arch-tile-y{background:#3b82f6;color:#fff;padding:25px 5px;border-radius:16px;text-align:center;font-weight:900;font-size:20px;cursor:pointer;box-shadow:0 8px 15px -3px rgba(59,130,246,.4)}.arch-m-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;width:100%}.arch-tile-m{background:#fff;border:1px solid #cbd5e1;border-radius:12px;padding:15px 2px;text-align:center;font-size:11px;font-weight:800;color:#334155;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.05);text-transform:uppercase}.arch-content{display:none;margin-bottom:15px;width:100%}.arch-inv{background:#fff;border-left:4px solid var(--p);border-radius:12px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px rgba(0,0,0,.06);display:flex;justify-content:space-between;align-items:center;font-size:13px;cursor:pointer;border:1px solid #e2e8f0;width:100%;font-weight:600;color:#000}.arch-tile-c{background:#fff;padding:12px;border-radius:10px;border:1px solid #cbd5e1;display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:13px;margin-bottom:5px;cursor:pointer;color:#1e293b}.arch-badge{background:#eef2ff;color:var(--p);padding:2px 6px;border-radius:6px;font-size:10px}.j-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:8px;box-shadow:0 2px 4px -1px rgba(0,0,0,.08);border:1px solid #e2e8f0;position:relative}.j-head{font-weight:900;font-size:14px;text-transform:uppercase;color:var(--p);margin-bottom:4px}.j-sub{font-size:12px;font-weight:700;color:#64748b;margin-bottom:12px;border-bottom:1px solid #f1f5f9;padding-bottom:6px}.j-title{font-size:16px;font-weight:900;color:#1e293b;margin-bottom:10px}.j-body{font-size:13px;color:#334155}.j-row{display:flex;justify-content:space-between;padding:4px 0;align-items:end;margin-bottom:2px}.j-dots{flex-grow:1;border-bottom:2px dotted #cbd5e1;margin:0 6px;position:relative;top:-5px;color:#1e293b;font-weight:700;font-size:13px}.j-val{font-weight:900;color:#000;white-space:nowrap}.bulk-q,.bulk-p{border:2px solid #cbd5e1!important;text-align:center;color:var(--p);font-weight:700;padding:0 5px!important;font-size:16px!important}.bulk-q:focus,.bulk-p:focus{border-color:var(--p)!important;background:#eef2ff}.ts-row{display:grid;grid-template-columns:30px 1fr 55px 45px 45px 30px;gap:2px;margin-bottom:2px;align-items:center;border-bottom:1px solid #f1f5f9;padding-bottom:2px}.btn-mini{width:100%;height:30px;border-radius:6px;border:1px solid #ccc;background:#f1f5f9;font-weight:900;font-size:14px;color:#64748b;padding:0;display:flex;align-items:center;justify-content:center}.btn-mini.red{color:red;background:#fee2e2;border-color:#fca5a5}.btn-mini.absent-active{background:#f43f5e;color:#fff;border-color:#e11d48}.ts-name-inp{width:100%;border:none;background:0 0;font-weight:700;font-size:14px;color:#1e293b;padding:5px 2px;outline:0;border-bottom:1px dashed #cbd5e1}.ts-rate-inp{width:100%;border:1px solid #cbd5e1;border-radius:4px;font-size:11px;text-align:center;padding:0;height:28px;font-weight:700;color:#059669}.ts-time-inp{width:100%;border:1px solid #e2e8f0;background:#fff;font-size:11px;text-align:center;padding:0;height:28px;border-radius:4px;font-weight:600;color:#334155}.ts-del-tile{position:absolute;top:2px;right:2px;width:24px;height:24px;background:#fee2e2;color:red;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;font-weight:700;z-index:5}.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}.cal-head{text-align:center;font-size:10px;font-weight:900;color:#64748b;padding-bottom:5px;text-transform:uppercase}.cal-cell{aspect-ratio:1;border:1px solid #e2e8f0;border-radius:8px;background:#fff;position:relative;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,.05);cursor:pointer}.cal-cell:active{background:#eef2ff;transform:scale(0.95)}.cal-date{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:900;color:#cbd5e1;z-index:1;opacity:.4}.cal-date.weekend{color:#fca5a5;opacity:.5}.cal-date.today{color:var(--p);opacity:.8;text-decoration:underline}.cal-overlay{position:absolute;inset:0;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;font-weight:900;line-height:1.2;text-shadow:0 1px 2px rgba(255,255,255,.8)}@keyframes pearl-green{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.pearl-green-text{background:linear-gradient(90deg,#166534,#22c55e,#15803d,#4ade80);background-size:300% 300%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:pearl-green 3s ease infinite;text-shadow:0 0 1px rgba(255,255,255,.5)}@keyframes pearl-pink{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.pearl-pink-text{background:linear-gradient(90deg,#be123c,#f43f5e,#9f1239,#fb7185);background-size:300% 300%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:pearl-pink 3s ease infinite;text-shadow:0 0 1px rgba(255,255,255,.5)}.logo-box{text-align:center;margin-bottom:20px;margin-top:5px}.logo-img{max-width:220px;height:auto;object-fit:contain}.l-t{font-size:10px;font-weight:900;color:#475569;margin-bottom:3px;display:block;text-transform:uppercase;letter-spacing:.5px}.smart-wrap{width:100%;height:35px;position:relative}.smart-sel,.smart-inp,.u-inp{width:100%;height:100%;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;background:#fff;padding:0 5px;margin:0;box-sizing:border-box;font-weight:700;color:#1e293b}.smart-inp{display:none;border:1px solid var(--p)}.u-inp{text-align:center}.del-row-btn{width:100%;height:30px;background:#fee2e2;border:1px solid #fca5a5;color:red;border-radius:6px;font-weight:900;display:flex;align-items:center;justify-content:center}.dyn-row{display:grid;grid-template-columns:32% 16% 16% 16% 8%;gap:4px;align-items:center;margin-bottom:5px}.z-head{font-size:11px;color:#047857;font-weight:900;text-align:center;margin:15px 0 5px;letter-spacing:1px;background:#ecfdf5;padding:5px;border-radius:4px;text-transform:uppercase;border:1px solid #a7f3d0}.z-col-h{display:grid;grid-template-columns:32% 16% 16% 16% 8%;gap:4px;text-align:center;font-size:10px;color:#475569;font-weight:800;margin-bottom:4px}.del-rep-btn{background:#fff;color:red;border:1px solid #fee2e2;width:30px;height:30px;border-radius:50%;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0.6;transition:.2s}.del-rep-btn:active{opacity:1;transform:scale(1.1)}.day-rep-box{background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #cbd5e1;font-family:monospace;font-size:12px;color:#000;white-space:pre-wrap;margin-bottom:10px;font-weight:600}.dr-h{font-weight:900;border-bottom:1px dashed #94a3b8;margin:10px 0 2px;color:#000;text-transform:uppercase;font-size:13px}.dr-hint{font-size:9px;color:#64748b;font-style:italic;margin-bottom:5px;display:block}.fas-row{display:grid;grid-template-columns:25% 45% 20% 10%;gap:3px;align-items:center;margin-bottom:5px;background:#f8fafc;padding:3px;border-radius:6px;border:1px solid #cbd5e1}.fas-out-row{display:grid;grid-template-columns:45% 25% 20% 10%;gap:3px;align-items:center;margin-bottom:5px;background:#eef2ff;padding:3px;border-radius:6px;border:1px solid #c7d2fe}.pay-alert{background:#dc2626;color:#fff;text-align:center;padding:15px;font-weight:900;font-size:18px;margin-bottom:10px;border-radius:12px;animation:blink 1s infinite;box-shadow:0 5px 15px rgba(220,38,38,.4);text-transform:uppercase}
.rep-card{background:#fff;border-radius:16px;padding:8px 12px;margin-bottom:8px;box-shadow:0 2px 5px rgba(0,0,0,.05);border:1px solid #e2e8f0;position:relative}
.rep-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.rep-title{font-weight:900;font-size:14px;color:#1e293b;letter-spacing:-0.3px}
.rep-meta{font-size:10px;color:#64748b;margin-bottom:8px;border-bottom:1px solid #f1f5f9;padding-bottom:4px;line-height:1.3}
.rep-raw{font-weight:600;color:#334155;margin-top:2px}
.rep-row{display:flex;justify-content:space-between;border-bottom:1px dashed #cbd5e1;padding:4px 0;font-size:11px;align-items:center}
.rep-row:last-child{border-bottom:none}
.rep-name{font-weight:700;color:#1e293b}
.rep-val{font-weight:900;font-size:12px}
.val-blue{color:#2563eb}
.val-red{color:#dc2626}
.rep-sep{border-bottom:1px dashed #cbd5e1;margin:4px 0}
.rep-sec-title{font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;margin:4px 0 2px}
#print-view {display:none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 10px; color: #000; padding: 0px; line-height: 1.05;}
#print-view h3 {margin: 0 0 5px 0; font-size: 14px; border-bottom: 2px solid #000; padding-bottom: 3px; width: 100%; text-align: center;}
#print-cols {display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start; width: 100%;}
#print-view .p-cat {margin-bottom: 5px; page-break-inside: avoid;}
#print-view .p-head {font-weight: 900; font-size: 12px; margin-bottom: 2px; text-transform: uppercase; border-bottom: 1px solid #000; padding-top: 3px;}
#print-view .p-row {margin-bottom: 1px; white-space: nowrap; font-size: 16px; display: flex; justify-content: flex-start; gap: 5px;}
#print-view .p-row b {margin-left: 0;}
#print-table {width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 12px;}
#print-table th {background: #f1f5f9; border: 1px solid #000; padding: 1px 2px; text-transform: uppercase; font-weight: 900; font-size: 10px;}
#print-table td {border: 1px solid #000; padding: 0 2px; text-align: center; height:14px; font-weight:700;}
#print-table td:first-child {text-align: left; font-weight: 700;}
#inv-table {width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 5px;}
#inv-table th {border: 1px solid #000; padding: 1px 2px; background: #eee; font-size: 11px;}
#inv-table td {border: 1px solid #000; padding: 0 2px; text-align: center; height: 16px; font-weight: 700; font-size: 13px;}
#inv-table td.l {text-align: left;}
#inv-table td.r {text-align: right;}
#confMdl {display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;align-items:center;justify-content:center}
#confBox {background:#fff;width:90%;max-width:350px;border-radius:20px;padding:20px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.5)}
#confContent {margin:15px 0;background:#f8fafc;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:13px;color:#334155;text-align:left;max-height:60vh;overflow-y:auto;white-space:pre-wrap}
.compact-row {padding:1px 4px!important; min-height:24px!important; font-size:10px!important; border-bottom:1px solid #f1f5f9;}
.compact-row input {padding:0 4px!important; height:20px!important; font-size:11px!important; border:1px solid #cbd5e1;}
@media (min-width: 800px) {
body { max-width: 500px; margin: 0 auto; box-shadow: 0 0 30px rgba(0,0,0,0.15); border-left: 1px solid #cbd5e1; border-right: 1px solid #cbd5e1; min-height: 100vh; background: #fff; }
.bottom-nav { max-width: 500px; left: 50%; transform: translateX(-50%); border-radius: 20px 20px 0 0; border: 1px solid #cbd5e1; border-bottom: none; width: 100%; }
#lockScreen { max-width: 500px; left: 50%; transform: translateX(-50%); box-shadow: 0 0 30px rgba(0,0,0,0.15); }
.modal { align-items: center; padding-top: 20px; }
#confMdl { align-items: center; }
}
@media print{@page{margin:5mm;size:A4;}
body{background:#fff;padding:0;color:#000;height:auto;overflow:visible;max-width:none!important;margin:0!important;border:none!important;box-shadow:none!important;}
#lockScreen,.bottom-nav,.dash-item,.btn-main,.logo-box,#corrCtls,.history-btn,.corr-btn,#navM,#navB,.del-rep-btn,.close-modal-btn,.smart-wrap,input,select,.z-head,.item-grid,#act,#cnt,#mdl,#confMdl{display:none!important}
#print-view {display: block !important; position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; margin: 0; padding: 0; background: white; z-index: 9999;}
.page-break { page-break-before: always; }
}
@keyframes blink{from{opacity:1}to{opacity:.7}}</style></head><body><div id="lockScreen"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo"><div class="lock-title">–û–ë–õ–Ü–ö–û–í–ê –°–ò–°–¢–ï–ú–ê</div><input type="email" id="appEmail" class="lock-inp" placeholder="Email"><input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-main" style="max-width:250px" onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button><div id="loginStatus" style="margin-top:10px;color:#64748b;font-weight:700;font-size:12px"></div></div><div id="act"></div><div id="cnt"></div><div class="bottom-nav"><button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button><button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button></div><div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:15px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0;font-size:16px;font-weight:900;color:#1e293b"></h4><button class="close-modal-btn" onclick="closeModal()" style="border:none;background:0 0;font-size:24px;color:#999">‚úï</button></div><div id="mB" class="modal-body"></div></div></div><div id="confMdl"><div id="confBox"><h3 style="margin:0 0 10px;color:#1e293b;text-transform:uppercase">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3><div style="font-size:12px;color:#64748b">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º:</div><div id="confContent"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="closeConf()" style="background:#f1f5f9;color:#333;border:1px solid #cbd5e1">–°–ö–ê–°–£–í–ê–¢–ò</button><button class="btn-main" onclick="doConfirm()" style="background:#16a34a;border:1px solid #15803d">–¢–ê–ö</button></div></div></div><div id="print-view"></div><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
const WS_CFG={'VIBRO':{title:'–í—ñ–±—Ä–æ—Å—Ç—ñ–ª',db:'Vibro_Report',prefix:'v',note:'–í—ñ–±—Ä–æ'},'KRUP':{title:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞',db:'Krup_Report',prefix:'k',note:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞'},'ZSHM':{title:'–ó–®–ú –ó–º—ñ–Ω–∞',db:'ZSHM_Report',prefix:'z',note:'–ó–®–ú'}};
const D=document,gID=i=>D.getElementById(i);
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();
let cur='Home',data={},aId=null,archSub='',corrMode=!1,isLogged=!1,isAdmin=!1,corrCtx={},useStretch=!1,shipBasket={},calCurMonth=new Date(),pendingAction=null;
const stockCatsAll=['Stock_DV','Stock_Semi','Stock_Feed','Stock_Raw','WeightStock','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','Timesheet','Timesheet_Notes','PriceList','Suppliers'];
auth.onAuthStateChanged(user=>{if(user){gID('lockScreen').classList.add('lock-hidden');D.body.classList.add('nav-active');isLogged=!0;if(localStorage.getItem('admT')==='1')isAdmin=!0;renderHome()}else{gID('lockScreen').classList.remove('lock-hidden');D.body.classList.remove('nav-active');isLogged=!1;isAdmin=!1;gID('cnt').innerHTML=''}});
function tryLogin(){const e=gID('appEmail').value,p=gID('appPass').value,s=gID('loginStatus');if(!e||!p){alert('–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å');return}s.innerText='–í—Ö—ñ–¥...';auth.signInWithEmailAndPassword(e,p).catch(err=>{alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: "+err.message);s.innerText='–ü–æ–º–∏–ª–∫–∞'})}
function tryAdmin(){if(isAdmin){isAdmin=!1;localStorage.removeItem('admT');corrMode=!1;renderHome();alert('–í–∏—Ö—ñ–¥ –∑ —Ä–µ–∂–∏–º—É –ê–¥–º—ñ–Ω–∞');return}const p=prompt('–ü–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');if(p==='3011'){isAdmin=!0;localStorage.setItem('admT','1');renderHome();alert('–†–µ–∂–∏–º –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –í–ö–õ–Æ–ß–ï–ù–û')}else if(p)alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å')}
function askConfirm(h,a){gID('confContent').innerHTML=h;pendingAction=a;gID('confMdl').style.display='flex'}
function closeConf(){gID('confMdl').style.display='none';pendingAction=null}
function doConfirm(){if(pendingAction)pendingAction();closeConf()}
window.delRec=async(c,i)=>{askConfirm(`–í–ò–î–ê–õ–ò–¢–ò –ó–ê–ü–ò–°?\n–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${c}\nID: ${i}`,async()=>{await db.child(c).child(i).remove();closeModal()})};
window.delInvoiceFull=async(c,i)=>{askConfirm(`–í–ò–î–ê–õ–ò–¢–ò –ù–ê–ö–õ–ê–î–ù–£?\n–¢–∏–ø: ${c}\n–£–í–ê–ì–ê: –í—Å—ñ —Ä—É—Ö–∏ —Ç–æ–≤–∞—Ä—ñ–≤ –±—É–¥—É—Ç—å —Å–∫–∞—Å–æ–≤–∞–Ω—ñ!`,async()=>{const u={};u[`/${c}/${i}`]=null;stockCatsAll.forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([k,v])=>{if(v.fLink===i)u[`/${s}/${k}`]=null})});try{await db.update(u)}catch(e){alert("Err:"+e)}})};
window.delWorkshopReportFull=async(n,i)=>{askConfirm(`–í–ò–î–ê–õ–ò–¢–ò –ó–í–Ü–¢ –í–ò–†–û–ë–ù–ò–¶–¢–í–ê?\n–¶–µ—Ö: ${n}\n–£–í–ê–ì–ê: –í—Å—ñ —Ä—É—Ö–∏ (—Å–∏—Ä–æ–≤–∏–Ω–∞, –ø—Ä–æ–¥—É–∫—Ü—ñ—è, –º—ñ—à–∫–∏) –±—É–¥—É—Ç—å —Å–∫–∞—Å–æ–≤–∞–Ω—ñ!`,async()=>{const u={};u[`/${n}/${i}`]=null;stockCatsAll.forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([k,v])=>{if(v.fLink===i)u[`/${s}/${k}`]=null})});try{await db.update(u);alert("–í–∏–¥–∞–ª–µ–Ω–æ")}catch(e){alert("Err:"+e)}})};
window.delFasFull=async(i)=>{askConfirm(`–í–ò–î–ê–õ–ò–¢–ò –ó–í–Ü–¢ –§–ê–°–£–í–ê–ù–ù–Ø?\n–£–í–ê–ì–ê: –í—Å—ñ —Ä—É—Ö–∏ (—Å–∏—Ä–æ–≤–∏–Ω–∞, –ø–∞—á–∫–∏, –ø–ª—ñ–≤–∫–∞) –±—É–¥—É—Ç—å —Å–∫–∞—Å–æ–≤–∞–Ω—ñ!`,async()=>{const u={};u['/–§–∞—Å–æ–≤–∫–∞/'+i]=null;stockCatsAll.forEach(c=>{if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.fLink===i)u[`/${c}/${k}`]=null})});try{await db.update(u);alert("–°–∫–∞—Å–æ–≤–∞–Ω–æ")}catch(e){alert("Err:"+e)}})};
window.delFas=i=>window.delRec('–§–∞—Å–æ–≤–∫–∞',i);window.delKrup=i=>window.delRec('Krup_Report',i);window.delVibro=i=>window.delRec('Vibro_Report',i);window.delZSHM=i=>window.delRec('ZSHM_Report',i);window.delArchRec=(c,i)=>window.delRec(c,i);
const bP_RAW=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1 —Ñ—Ä","–ê—Ä–Ω–∞—É—Ç–∫–∞ 2 —Ñ—Ä","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"];
const bP_FAS=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 1","–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 2","–ê—Ä—Ç–µ–∫ 1/0.9","–ë–∞—Å–º–∞—Ç–∏ –≥–æ–ª–¥ 1/0.8","–ë–∞—Å–º–∞—Ç–∏ 1/0.8","–ë—É–ª–≥—É—Ä 1/0.4","–ì–æ—Ä–æ—Ö 1/0.9","–ì—Ä–µ—á–∫–∞ 1/0.9","–ö—É–∫—É—Ä—É–∑–∞ 1/0.9","–ö—É–∫.–º—É–∫–∞ 1/0.5","–ö—É—Å –∫—É—Å 1/0.4","–ö—É—Ç—è 1/0.5","–ú–∞–Ω–∫–∞ 1/0.8","–ù—É—Ç 1/0.4","–ü–µ—Ä–ª–æ–≤–∫–∞ 1/0.9","–ü—à–µ–Ω–∏—á–∫–∞ 1/0.9","–ü—à–æ–Ω–æ 1/0.9","–†–∏—Å –¥–ª 1/0.9","–†–∏—Å –∫—Ä 1/0.9","–†–∏—Å –ø—Ä 1/0.9","–•–ª–æ–ø—å—è 1/0.5","–ß–µ—á–µ–≤–∏—Ü–∞ 1/0.4","–Ø—á–∫–∞ 1/0.9"];
const szs=["300√ó400","370√ó500","400√ó500","420√ó550"],mths=["–°–Ü–ß","–õ–Æ–¢","–ë–ï–†","–ö–í–Ü","–¢–†–ê","–ß–ï–†","–õ–ò–ü","–°–ï–†","–í–ï–†","–ñ–û–í","–õ–ò–°","–ì–†–£"];
const fd=i=>{if(!i)return'';const p=i.split('T')[0].split('-');return `${p[2]}.${p[1]}.${p[0]} ${p[1]}:${p[2]}`},fd2=i=>{if(!i)return'';const p=i.split('T')[0].split('-');return `${p[2]}.${p[1]}.${p[0]}`};
function closeModal(){gID('mdl').style.display='none';aId=null}
function toggleF(i){const e=gID(i);e.style.display=e.style.display==='block'?'none':'block'}
function toggleC(i,b){const e=gID(i);if(e.style.display==='block'){e.style.display='none';b.style.background='#fff';b.style.borderColor='#e2e8f0'}else{e.style.display='block';b.style.background='#eef2ff';b.style.borderColor='var(--p)'}}
const gP=c=>{let i=[];if(c==='WeightStock'||c==='Stock_DV')i=bP_RAW;else if(c==='–ì–æ—Ç–æ–≤–∞—è')i=bP_FAS;else i=[];const s=new Set(i);const k=(c==='WeightStock')?'WeightStock':(c==='Stock_DV'?'Stock_DV':(c==='Stock_Feed'?'Stock_Feed':(c==='Stock_Raw'?'Stock_Raw':(c==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è'))));if(data[k])Object.values(data[k]).forEach(v=>s.add(v.name));return Array.from(s).filter(x=>x).sort()};
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort()};
const gPack=c=>{const s=new Set();if(c==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));if(c==='–°–∫–æ—Ç—á')s.add('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º');if(c==='–ü–ª–µ–Ω–∫–∞')bP_RAW.forEach(x=>s.add(x));const k=c==='–°–∫–æ—Ç—á'?'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':c;if(data[k])Object.values(data[k]).forEach(v=>{if(v.name)s.add(v.name)});return Array.from(s).filter(x=>x).sort()};
const gPackS=()=>{const s=new Set();if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.supplier)s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const gBuyS=()=>{const s=new Set();if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.supplier&&v.type==='GOODS')s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const gRawActive=()=>{const s=new Set();if(data.Stock_Raw){const m={};Object.values(data.Stock_Raw).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});Object.keys(m).forEach(n=>{if(m[n]>.01){const r=n.match(/\[(.*?)\]/);if(r&&r[1])s.add(r[1])}})}return Array.from(s).filter(x=>x).sort()};
const getPayMsg=()=>{const t=new Date(),y=t.getFullYear(),m=t.getMonth(),d=t.getDate(),g=(k)=>{let n=new Date(y,m,k),w=n.getDay();if(w===0)return k-2;if(w===6)return k-1;return k};if(d===g(5))return "üí∞ –°–¨–û–ì–û–î–ù–Ü –ó–ê–†–ü–õ–ê–¢–ê";if(d===g(15))return "üí∏ –°–¨–û–ì–û–î–ù–Ü –ê–í–ê–ù–°";return null};
function renderHome(){if(!isLogged)return;cur='Home';D.body.classList.remove('nav-active');gID('act').innerHTML='';const m=getPayMsg(),a=m?`<div class="pay-alert">${m}</div>`:'';const lBtn=`<button onclick="firebase.auth().signOut()" style="position:absolute;top:10px;right:10px;background:#fee2e2;color:red;border:1px solid #fca5a5;border-radius:8px;padding:5px 10px;font-weight:900;z-index:90">–í–ò–ô–¢–ò</button>`;
let ab=isAdmin?`<button onclick="tryAdmin()" style="position:absolute;top:10px;left:10px;background:#fee2e2;color:red;border:1px solid #fca5a5;border-radius:8px;padding:5px 10px;font-weight:900;z-index:90;font-size:10px">–ê–î–ú–Ü–ù (–í–ö–õ)</button>`:`<button onclick="tryAdmin()" style="position:absolute;top:10px;left:10px;background:#f1f5f9;color:#64748b;border:1px solid #cbd5e1;border-radius:8px;padding:5px 10px;font-weight:900;z-index:90;font-size:10px">–ê–î–ú–Ü–ù</button>`;
gID('cnt').innerHTML=lBtn+ab+a+`<div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div><div class="dash-grid"><div class="dash-item home-folder" onclick="setCat('StockRoot')"><span>üìÇ –°–ö–õ–ê–î</span></div><div class="dash-item home-folder" onclick="setCat('ProdSub')"><span>üõ†Ô∏è –í–ò–†–û–ë–ù–ò–¶–¢–í–û</span></div><div class="dash-item home-folder" onclick="setCat('Timesheet')"><span>üìÖ –¢–ê–ë–ï–õ–¨</span></div><div class="dash-item home-folder" onclick="setCat('Consolidated')"><span>üìä –ó–í–ï–î–ï–ù–ò–ô –ó–í–Ü–¢</span></div><div class="dash-item home-folder" onclick="setCat('PriceList')"><span>üí∞ –ü–†–ê–ô–°</span></div></div>`;updNav()}
function goBack(){const m={'TsCal':'Timesheet','Timesheet':'Home','StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','PackSub':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'PackSub','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'PackSub','ArchPackIn':'PackSub','Consolidated':'Home','PriceList':'Home'};let n=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')n=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(n)}
function updNav(){gID('navM').className=cur==='Home'?'nav-btn-active':'';gID('navB').className=cur!=='Home'?'nav-btn-active':''}
function setCat(c){cur=c;D.body.classList.add('nav-active');const a=gID('act'),ct=gID('cnt');a.innerHTML='';if(c==='Home'){renderHome();return}if(c==='Timesheet'){const td=new Date().toISOString().split('T')[0];
if(isAdmin){ct.innerHTML=`<div class="card" style="margin-top:10px"><div style="font-size:14px;font-weight:900;color:var(--p);text-align:center;margin-bottom:10px;text-transform:uppercase">–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞–±–µ–ª—è</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="gTD" value="${td}" style="height:35px"></div><div><label class="l-t">–ó–ê–ì–ê–õ–¨–ù–ò–ô –ß–ê–°</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px"><input type="time" id="gTS" value="08:00" style="height:35px;font-size:11px"><input type="time" id="gTE" value="17:00" style="height:35px;font-size:11px"></div></div></div><div class="l-t" style="margin-bottom:5px">–°–ü–Ü–í–†–û–ë–Ü–¢–ù–ò–ö–ò [–¢–∞—Ä–∏—Ñ]</div><div id="tsRows"></div><button class="btn-main" onclick="addTimeRow()" style="background:#fff;color:var(--p);border:1px solid #ccc;margin-top:10px">+ –î–û–î–ê–¢–ò –õ–Æ–î–ò–ù–£</button><button class="btn-main" onclick="saveTimesheetBatch()" style="margin-top:10px">–ó–ë–ï–†–ï–ì–¢–ò –¢–ê–ë–ï–õ–¨</button></div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);margin-top:10px;border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–† –ó–ú–Ü–ù</button>`;setTimeout(()=>{const s=localStorage.getItem('activeCrew');if(s){const n=JSON.parse(s);if(n.length>0)n.forEach(x=>{if(typeof x==='object')addTimeRow(x.name,x.rate);else addTimeRow(x)});else addTimeRow()}else addTimeRow()},50)}else{ct.innerHTML=`<div class="z-head">–ü–ï–†–ï–ì–õ–Ø–î –¢–ê–ë–ï–õ–Ø</div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);margin-top:10px;border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–† –ó–ú–Ü–ù</button>`}}else if(c==='TsCal'){ct.innerHTML=`<div class="z-head">–û–ë–ï–†–Ü–¢–¨ –°–ü–Ü–í–†–û–ë–Ü–¢–ù–ò–ö–ê</div><div id="tsList" class="item-grid" style="grid-template-columns:repeat(3,1fr)"></div>`;loadData()}else if(c==='StockRoot'){
let btns=isAdmin?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><button class="btn-main" style="background:var(--s);margin:0" onclick="openModal('inc')">üì• –ü–†–ò–•–Ü–î</button><button class="btn-main" style="background:var(--d);margin:0" onclick="openModal('ship')">üöö –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</button></div><button class="btn-main" id="corrTile" onclick="toggleCorr()" style="background:#fff;color:var(--p);border:1px solid var(--p);margin-bottom:15px">üîß –ö–û–†–ï–ö–¶–Ü–Ø</button>`:'';
ct.innerHTML=`${btns}<div class="dash-grid"><div class="dash-item" onclick="setCat('StockList')">–§–ê–°–û–í–ê–ù–ê –ü–†–û–î–£–ö–¶–Ü–Ø (–§–ê–°–û–í–ö–ê)</div><div class="dash-item" onclick="setCat('WeightStock')">–ö–£–ü–û–í–ê–ù–ê –ü–†–û–î–£–ö–¶–Ü–Ø –í–ê–ì–û–í–ê (–ö–£–ü–û–í–ê–ù–ê)</div><div class="dash-item" onclick="setCat('Stock_DV')">–°–ö–õ–ê–î –ì–û–¢–û–í–û–á –í–ê–ì–û–í–û–á –ü–†–û–î–£–ö–¶–Ü–á –ó –í–ò–†–û–ë–ù–ò–¶–¢–í–ê (–î–í)</div><div class="dash-item" onclick="setCat('Stock_Feed')">–í–Ü–î–•–û–î–ò –ó –í–ò–†–û–ë–ù–ò–¶–¢–í–ê (–ö–û–†–ú–ê)</div><div class="dash-item" onclick="setCat('Stock_Raw')">–°–ò–†–û–í–ò–ù–ê (–ó–ï–†–ù–û) –°–ò–†–û–í–ò–ù–ù–Ü –°–ö–õ–ê–î–ò</div><div class="dash-item" onclick="setCat('Stock_Semi')">–ù–ê–ü–Ü–í–§–ê–ë–†–ò–ö–ê–¢</div><div class="dash-item" onclick="setCat('PackSub')">–ü–ê–ö–£–í. –ú–ê–¢.</div><div class="dash-item" onclick="setCat('Invoices')">–ê–†–•–Ü–í –ù–ê–ö–õ–ê–î–ù–ò–•</div></div><div id="corrCtls" style="margin-top:15px;display:flex;gap:5px;justify-content:center"></div>`}else if(c==='PackSub'){
if(isAdmin)a.innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü—Ä–∏—Ö—ñ–¥ –ø–∞–∫—É–≤–∞–Ω–Ω—è</button>`;
ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–õ–Ü–í–ö–ê</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–ê–ö–ï–¢–ò</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–ö–û–¢–ß</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–Ü–®–ö–ò</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–ò–¢–ö–ò</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–ï–¢–ò–ö–ï–¢–ö–ê</div><div class="dash-item" onclick="setCat('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')">–°–¢–†–ï–ô–ß –ü–õ–Ü–í–ö–ê</div><div class="dash-item" onclick="setCat('–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')">–¢–ï–†–ú–û –°–¢–†–Ü–ß–ö–ê</div></div>`}else if(c==='ProdSub'){ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–¶–µ—Ö —Ñ–∞—Å—É–≤–∞–Ω–Ω—è</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö—Ä—É–ø–æ—Ä—É—à–∫–∞</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í—ñ–±—Ä–æ—Å—Ç—ñ–ª</div></div>`;if(isAdmin)ct.innerHTML+=`<button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–Ü–î –°–ò–†–û–í–ò–ù–ò</button>`}else if(c==='–§–∞—Å–æ–≤–∫–∞'){if(isAdmin)a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('fas')">–ù–û–í–ò–ô –ó–ê–ü–ò–°</button>`}else if(c==='Kruporushka'){if(isAdmin)a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('KRUP')">–ù–û–í–ò–ô –ó–ê–ü–ò–°</button>`}else if(c==='Vibro'){if(isAdmin)a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('VIBRO')">–ù–û–í–ò–ô –ó–ê–ü–ò–°</button>`}else if(c==='ZSHM'){if(isAdmin)a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('ZSHM')">–ù–û–í–ê –ó–ú–Ü–ù–ê</button>`}else if(c==='PriceList'){ct.innerHTML='<div class="z-head">üí∞ –ü–†–ê–ô–°-–õ–ò–°–¢ (–ì–†–ù)</div><div id="priceListCont">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';rPriceList(gID('priceListCont'))}else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü—Ä–∏—Ö–æ–¥–∏</div><div class="dash-item" onclick="setCat('ArchSubOut')">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div></div>`;else if(c==='ArchSubIn'||c==='ArchSubOut'){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ó–∞ –¥–∞—Ç–∞–º–∏</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ó–∞ —ñ–º–µ–Ω–∞–º–∏</div></div>`}else if(c==='Consolidated'){ct.innerHTML='<div style="text-align:center;padding:20px;color:#666">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';loadData()}loadData();updCorrBtn();updNav()}
function toggleCorr(){if(!isAdmin)return;corrMode=!corrMode;updCorrBtn();loadData()}
function updCorrBtn(){const t=gID('corrTile');if(t){t.innerText=corrMode?'–ö–û–†–ï–ö–¶–Ü–Ø: –í–ö–õ':'üîß –ö–û–†–ï–ö–¶–Ü–Ø';t.style.background=corrMode?'#fef3c7':'#fff';t.style.color=corrMode?'#d97706':'var(--p)'}const c=gID('corrCtls');if(c)c.innerHTML=''}
function loadData(){db.on('value',s=>{data=s.val()||{};checkAutoClose();const c=gID('cnt');if(!c||['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub','Timesheet'].includes(cur))return;if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(cur==='Kruporushka')rKrup(c);else if(cur==='Vibro')rVibro(c);else if(cur==='ZSHM')rZSHM(c);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Stock_Raw')rRaw(c);else if(cur==='Consolidated')rConsolidated(c);else if(cur==='TsCal')renderTsList(c);else if(cur==='PriceList')rPriceList(gID('priceListCont'));else rGen(c)})}
function toggleInput(i){const s=gID('s_'+i),n=gID('i_'+i);if(s.value==='NEW'){s.style.display='none';n.style.display='block';n.focus()}else n.style.display='none'}
function drawShipItem(s){let p=s.split('|');if(p.length<2&&s.includes(':'))p=s.split(':');let n=p[0],a=p[1],u=p[2],c=p[3],l='';if(c==='–ì–æ—Ç–æ–≤–∞—è')l='(—Ñ–∞—Å)';else if(c==='WeightStock')l='(–∫—É–ø)';else if(c==='Stock_DV')l='(–¥–≤)';else if(c==='Stock_Feed')l='(–∫–æ—Ä–º)';let lh=l?`<span style="color:var(--blue);font-size:10px;margin-left:4px">${l}</span>`:'';if(!u)u=bP_RAW.includes(n)?'—à—Ç':'–∫–≥';return `<div class="j-row"><span class="j-dots">${n}${lh}</span><span class="j-val">${a}${u}</span></div>`}
function rConsolidated(c){
const sumCat=x=>{let r={};x.forEach(n=>{if(data[n])Object.values(data[n]).forEach(v=>r[v.name]=(r[v.name]||0)+v.amount)});return r};
const drawSec=(t,o,u,cl)=>{let i=Object.keys(o).filter(k=>Math.abs(o[k])>.1).sort();if(i.length===0)return'';let h=`<div class="z-head" style="background:${cl};color:#1e293b;border:1px solid #cbd5e1">${t}</div><div class="item-grid" style="grid-template-columns:1fr 1fr;">`;i.forEach(k=>{let v=o[k],d=Math.round(v);if(t.includes('–ü–õ–Ü–í–ö–ê'))d=v.toFixed(2);h+=`<div class="item-card" style="text-align:left;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:11px;font-weight:700;color:#475569">${k}</span><span style="font-size:14px;font-weight:900;color:#0f172a">${d}<small style="font-size:9px;color:#94a3b8;margin-left:2px">${u}</small></span></div>`});return h+`</div>`};
const drawP=(t,o,u)=>{let i=Object.keys(o).filter(k=>Math.abs(o[k])>.1).sort();if(i.length===0)return'';let h=`<div class="p-cat"><div class="p-head">${t}:</div>`;i.forEach(k=>{let v=o[k],d=Math.round(v);if(t.includes('–ü–õ–Ü–í–ö–ê'))d=v.toFixed(2);h+=`<div class="p-row"><span>${k} <b>${d}${u}</b></span></div>`});return h+`</div>`};
let h='<div id="print-area" style="padding-bottom:20px">';
h+=`<div style="margin-bottom:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="openModal('dayRep')" style="background:#4f46e5;border:1px solid #4338ca;font-size:10px">üìÖ –î–ï–ù–¨</button><button class="btn-main" onclick="printPage('cons')" style="background:#0f172a;color:#fff;border:1px solid #000;font-size:10px">üñ®Ô∏è –î–†–£–ö</button></div>`;
h+=drawSec('üì¶ –§–ê–°–û–í–ö–ê',sumCat(['–ì–æ—Ç–æ–≤–∞—è']),'—à—Ç','#dbeafe');h+=drawSec('‚öñÔ∏è –ö–£–ü–û–í–ê–ù–ê',sumCat(['WeightStock']),'–∫–≥','#dcfce7');h+=drawSec('üè≠ –°–ö–õ–ê–î –î–í',sumCat(['Stock_DV']),'–∫–≥','#bfdbfe');h+=drawSec('üçÇ –ö–û–†–ú–ê',sumCat(['Stock_Feed']),'–∫–≥','#fef3c7');h+=drawSec('üöú –°–ò–†–û–í–ò–ù–ê',sumCat(['Stock_Raw']),'–∫–≥','#bbf7d0');h+=drawSec('‚öôÔ∏è –ù–ê–ü–Ü–í–§–ê–ë–†–ò–ö–ê–¢',sumCat(['Stock_Semi']),'–∫–≥','#ffedd5');h+=drawSec('ü•° –ü–ê–ö–ï–¢–ò',sumCat(['–ü–∞–∫–µ—Ç—ã']),'—à—Ç','#f1f5f9');h+=drawSec('üéûÔ∏è –ü–õ–Ü–í–ö–ê',sumCat(['–ü–ª–µ–Ω–∫–∞']),'–∫–≥','#f1f5f9');h+=drawSec('üß¥ –°–ö–û–¢–ß',sumCat(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º']),'—à—Ç','#f1f5f9');h+=drawSec('üí∞ –ú–Ü–®–ö–ò',sumCat(['–ú–µ—à–∫–∏']),'—à—Ç','#f1f5f9');h+=drawSec('üßµ –ù–ò–¢–ö–ò',sumCat(['–ù–∏—Ç–∫–∏']),'—à—Ç','#f1f5f9');h+=drawSec('üè∑Ô∏è –ï–¢–ò–ö–ï–¢–ö–ê',sumCat(['–≠—Ç–∏–∫–µ—Ç–∫–∞']),'—à—Ç','#f1f5f9');h+=drawSec('üåÄ –°–¢–†–ï–ô–ß',sumCat(['–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞']),'—à—Ç','#f1f5f9');h+=drawSec('üî• –¢–ï–†–ú–û –°–¢–†–Ü–ß–ö–ê',sumCat(['–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞']),'—à—Ç','#f1f5f9');
if(isAdmin)h+=`</div><div style="margin-top:15px;border-top:1px dashed #ccc;padding-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" onclick="openModal('fixBal')" style="background:#f59e0b;color:#fff;border:1px solid #d97706;font-size:10px">üîí –ó–ê–§–Ü–ö–°–£–í–ê–¢–ò</button><button class="btn-main" onclick="openModal('closeMonth')" style="background:#7c3aed;color:#fff;border:1px solid #6d28d9;font-size:10px">üóìÔ∏è –ó–ê–ö–†–ò–¢–ò –ú–Ü–°–Ø–¶–¨</button><button class="btn-main" onclick="openModal('monthRep')" style="background:#4338ca;color:#fff;border:1px solid #3730a3;font-size:10px">üìÖ –ú–Ü–°–Ø–ß–ù–ò–ô –ó–í–Ü–¢</button><button class="btn-main" onclick="openModal('archiveOld')" style="background:#dc2626;color:#fff;border:1px solid #b91c1c;font-size:10px">üßπ –ó–ì–û–†–¢–ê–ù–ù–Ø –ë–ê–ó–ò (–ê–†–•–Ü–í)</button></div>`;
c.innerHTML=h||'<div style="text-align:center;padding:20px;color:#999">–°–∫–ª–∞–¥–∏ –ø–æ—Ä–æ–∂–Ω—ñ</div>';
let ph=`<h3>üìä –ó–í–ï–î–ï–ù–ò–ô –ó–í–Ü–¢ [${new Date().toLocaleDateString()}]</h3><div id="print-cols"><div id="p-col-1">`;
ph+=drawP('üì¶ –§–ê–°–û–í–ö–ê',sumCat(['–ì–æ—Ç–æ–≤–∞—è']),'—à—Ç');ph+=drawP('‚öñÔ∏è –ö–£–ü–û–í–ê–ù–ê',sumCat(['WeightStock']),'–∫–≥');ph+=drawP('üè≠ –°–ö–õ–ê–î –î–í',sumCat(['Stock_DV']),'–∫–≥');ph+=drawP('üçÇ –ö–û–†–ú–ê',sumCat(['Stock_Feed']),'–∫–≥');
ph+=`</div><div id="p-col-2">`;
ph+=drawP('üöú –°–ò–†–û–í–ò–ù–ê',sumCat(['Stock_Raw']),'–∫–≥');ph+=drawP('‚öôÔ∏è –ù–ê–ü–Ü–í–§–ê–ë–†–ò–ö–ê–¢',sumCat(['Stock_Semi']),'–∫–≥');ph+=drawP('ü•° –ü–ê–ö–ï–¢–ò',sumCat(['–ü–∞–∫–µ—Ç—ã']),'—à—Ç');ph+=drawP('üéûÔ∏è –ü–õ–Ü–í–ö–ê',sumCat(['–ü–ª–µ–Ω–∫–∞']),'–∫–≥');ph+=drawP('üß¥ –°–ö–û–¢–ß',sumCat(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º']),'—à—Ç');ph+=drawP('üí∞ –ú–Ü–®–ö–ò',sumCat(['–ú–µ—à–∫–∏']),'—à—Ç');ph+=drawP('üßµ –ù–ò–¢–ö–ò',sumCat(['–ù–∏—Ç–∫–∏']),'—à—Ç');ph+=drawP('üè∑Ô∏è –ï–¢–ò–ö–ï–¢–ö–ê',sumCat(['–≠—Ç–∏–∫–µ—Ç–∫–∞']),'—à—Ç');ph+=drawP('üåÄ –°–¢–†–ï–ô–ß',sumCat(['–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞']),'—à—Ç');ph+=drawP('üî• –¢–ï–†–ú–û –°–¢–†–Ü–ß–ö–ê',sumCat(['–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞']),'—à—Ç');
ph+=`</div></div>`;
gID('print-view').innerHTML=ph}
function rPriceList(c){const s=new Set();['WeightStock','Stock_DV','Stock_Feed','Stock_Raw','–ì–æ—Ç–æ–≤–∞—è'].forEach(cat=>{if(data[cat])Object.values(data[cat]).forEach(v=>{if(v.name)s.add(v.name)})});const items=Array.from(s).sort();const prices={};if(data.PriceList)Object.values(data.PriceList).forEach(v=>prices[v.name]=v.price);let h=`<div class="item-grid" style="grid-template-columns:1fr">`;items.forEach(n=>{const p=prices[n]||'';h+=`<div class="item-card compact-row" style="display:grid;grid-template-columns:2fr 1fr;align-items:center;text-align:left"><div style="font-weight:700;font-size:13px;color:#1e293b">${n}</div><input type="number" placeholder="–ì—Ä–Ω" value="${p}" onchange="savePrice('${n}',this.value)" style="width:100%;font-weight:900;color:var(--p);border:1px solid #cbd5e1;border-radius:8px"></div>`});c.innerHTML=h+`</div>`}
async function savePrice(n,p){const v=parseFloat(p);if(isNaN(v))return;let id=null;if(data.PriceList)Object.entries(data.PriceList).forEach(([k,val])=>{if(val.name===n)id=k});const u={};if(id)u[`/PriceList/${id}/price`]=v;else u[`/PriceList/${db.child('PriceList').push().key}`]={name:n,price:v};await db.update(u)}
function addTimeRow(p="",r=""){const i=Date.now()+Math.random(),s=gID('gTS')?gID('gTS').value:'08:00',e=gID('gTE')?gID('gTE').value:'17:00';gID('tsRows').insertAdjacentHTML('beforeend',`<div class="ts-row" id="tr_${i}"><button class="btn-mini" onclick="this.classList.toggle('absent-active');this.classList.toggle('red')">(-)</button><input type="text" id="tn_${i}" class="ts-name-inp" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" value="${p}"><input type="number" id="rate_${i}" class="ts-rate-inp" placeholder="–≥—Ä–Ω" value="${r}"><input type="time" id="ts_${i}" value="${s}" class="ts-time-inp"><input type="time" id="te_${i}" value="${e}" class="ts-time-inp"><button class="btn-mini red" onclick="removeTimeRow('${i}')">√ó</button></div>`)}
function removeTimeRow(i){gID('tr_'+i).remove();saveCurrentCrewToLocal()}
function saveCurrentCrewToLocal(){const r=gID('tsRows').children,c=[];for(let w of r){const i=w.id.split('_')[1],n=gID('tn_'+i).value.trim(),ra=gID('rate_'+i).value.trim();if(n)c.push({name:n,rate:ra})}localStorage.setItem('activeCrew',JSON.stringify(c))}
async function saveTimesheetBatch(){const d=gID('gTD').value,r=gID('tsRows').children,u={},dv=d+"T12:00:00Z",ts=new Date().toISOString(),c=[];let k=0;for(let w of r){const i=w.id.split('_')[1],n=gID('tn_'+i).value.trim(),rt=parseFloat(gID('rate_'+i).value)||0;if(!n)continue;c.push({name:n,rate:gID('rate_'+i).value});const a=w.querySelector('.btn-mini').classList.contains('absent-active'),s=gID('ts_'+i).value,e=gID('te_'+i).value;let pay=0;if(!a&&s&&e&&rt>0){const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);let dr=(eh*60+em)-(sh*60+sm);if(dr<0)dr+=24*60;pay=Math.round((dr/60)*rt)}const key=db.child('Timesheet').push().key;u['/Timesheet/'+key]={date:dv,name:n,s:s,e:e,absent:a,ts:ts,rate:rt,pay:pay};k++}if(k===0)return alert("–ü–æ—Ä–æ–∂–Ω—å–æ");if(confirm(`–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞–±–µ–ª—å –∑–∞ ${d}?`)){try{await db.update(u);localStorage.setItem('activeCrew',JSON.stringify(c));alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ!")}catch(e){alert("Err:"+e)}}}
function renderTsList(c){const r=data.Timesheet,n=new Set();if(r)Object.values(r).forEach(v=>n.add(v.name));let h='';Array.from(n).sort().forEach(x=>{h+=`<div class="item-card" onclick="openPersCal('${x}')" style="cursor:pointer;position:relative"><div class="item-title" style="font-size:12px;margin-bottom:0;height:auto;padding:10px 0">${x}</div><div class="ts-del-tile" onclick="event.stopPropagation();delPersonHistory('${x}')" style="display:${isAdmin?'flex':'none'}">√ó</div></div>`});const t=c||gID('tsList');if(t)t.innerHTML=h||'<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>'}
async function delPersonHistory(n){if(confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é: ${n}?`)){const u={};if(data.Timesheet)Object.entries(data.Timesheet).forEach(([k,v])=>{if(v.name===n)u['/Timesheet/'+k]=null});await db.update(u)}}
function openPersCal(n){calCurMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);renderPersCalGrid(n)}
function changeCalMonth(d,n){calCurMonth.setMonth(calCurMonth.getMonth()+d);renderPersCalGrid(n)}
function renderPersCalGrid(n){const y=calCurMonth.getFullYear(),m=calCurMonth.getMonth(),mn=mths[m],td=new Date(),dim=new Date(y,m+1,0).getDate(),fd=new Date(y,m,1).getDay()||7,sh={},nts=[];let tPay=0;if(data.Timesheet)Object.entries(data.Timesheet).forEach(([k,v])=>{if(v.name===n&&v.date){const d=new Date(v.date);if(d.getFullYear()===y&&d.getMonth()===m){sh[d.getDate()]={...v,id:k};tPay+=(v.pay||0)}}});if(data.Timesheet_Notes)Object.entries(data.Timesheet_Notes).forEach(([id,v])=>{if(v.name===n&&v.date){const d=new Date(v.date);if(d.getFullYear()===y&&d.getMonth()===m)nts.push({...v,day:d.getDate(),id:id})}});nts.sort((a,b)=>a.day-b.day);let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0"><button onclick="changeCalMonth(-1, '${n}')" style="border:none;background:0 0;font-size:20px;color:#334155">‚óÄ</button><div style="font-weight:900;color:#0f172a">${mn} ${y}</div><button onclick="changeCalMonth(1, '${n}')" style="border:none;background:0 0;font-size:20px;color:#334155">‚ñ∂</button></div><div class="cal-grid"><div class="cal-head">–ü–ù</div><div class="cal-head">–í–¢</div><div class="cal-head">–°–†</div><div class="cal-head">–ß–¢</div><div class="cal-head">–ü–¢</div><div class="cal-head" style="color:#ef4444">–°–ë</div><div class="cal-head" style="color:#ef4444">–ù–î</div>`;for(let i=1;i<fd;i++)h+=`<div></div>`;for(let d=1;d<=dim;d++){let cur=new Date(y,m,d),dow=cur.getDay(),isW=(dow===0||dow===6),cl=isW?"cal-date weekend":"cal-date";if(y===td.getFullYear()&&m===td.getMonth()&&d===td.getDate())cl+=" today";let o='',sid=sh[d]?sh[d].id:'';if(sh[d]){const s=sh[d];if(s.absent)o=`<div class="cal-overlay pearl-pink-text">–í–Ü–î–ì–£–õ</div>`;else o=`<div class="cal-overlay pearl-green-text"><div>${s.s||''}</div><div>${s.e||''}</div></div>`}h+=`<div class="cal-cell" onclick="openDayModal('${n}','${y}-${m+1}-${d}','${sid}')"><div class="${cl}">${d}</div>${o}</div>`}h+=`</div><div style="margin-top:10px;background:#ecfdf5;padding:10px;border-radius:10px;border:1px solid #a7f3d0;text-align:center;font-weight:900;color:#065f46">–ó–ê–†–ü–õ–ê–¢–ê –ó–ê ${mn}: ${tPay} –≥—Ä–Ω</div><div style="margin-top:15px;background:#fff;border-radius:10px;border:1px solid #e2e8f0;padding:10px"><div style="font-size:12px;font-weight:900;color:#64748b;margin-bottom:5px;text-transform:uppercase">–ó–∞–ø–∏—Å–∏</div>`;if(nts.length===0)h+=`<div style="font-size:12px;color:#999;text-align:center">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</div>`;else nts.forEach(x=>{h+=`<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #eee;padding:5px 0;font-size:13px"><div style="color:#333"><b style="color:var(--p)">${x.day}.</b> ${x.note}</div><button onclick="delTsNote('${x.id}','${n}')" style="display:${isAdmin?'block':'none'};border:none;background:none;color:red;font-weight:bold">√ó</button></div>`});h+=`</div><button class="btn-main" onclick="closeModal()" style="margin-top:15px;background:#64748b">–ó–ê–ö–†–ò–¢–ò</button>`;gID('mT').innerText=n;gID('mB').innerHTML=h;gID('mdl').style.display='flex'}
function openDayModal(n,d,sid){if(!isAdmin)return;let h=`<div style="text-align:center;font-weight:900;color:#333;margin-bottom:10px;font-size:16px">${d}</div>`;if(sid){const s=data.Timesheet[sid];h+=`<div style="background:#f8fafc;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:15px"><div style="font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px">–†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ó–ú–Ü–ù–ò</div><div style="display:flex;gap:5px;align-items:center;justify-content:center;margin-bottom:10px"><input type="time" id="edS" value="${s.s}" class="ts-time-inp" style="width:80px"><span style="font-weight:bold">-</span><input type="time" id="edE" value="${s.e}" class="ts-time-inp" style="width:80px"></div><div style="text-align:center;font-size:12px;margin-bottom:10px">–¢–∞—Ä–∏—Ñ: <b>${s.rate}</b> –≥—Ä–Ω/–≥–æ–¥</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" onclick="saveShiftEdit('${sid}','${n}')" style="margin:0">–ü–ï–†–ï–†–ê–•–£–í–ê–¢–ò</button><button class="btn-main" onclick="delShift('${sid}','${n}')" style="margin:0;background:#fee2e2;color:red;border:1px solid #fca5a5">–í–ò–î–ê–õ–ò–¢–ò</button></div></div>`}h+=`<div style="border-top:1px dashed #ccc;padding-top:10px"><label class="l-t">–î–û–î–ê–¢–ò –ù–û–¢–ê–¢–ö–£ (–ê–í–ê–ù–°)</label><input type="text" id="newNote" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ê–≤–∞–Ω—Å 500"><button class="btn-main" onclick="addTsNoteDirect('${n}','${d}')" style="background:#e0e7ff;color:var(--p)">–î–û–î–ê–¢–ò –ó–ê–ü–ò–°</button></div>`;gID('mB').innerHTML=h;gID('mT').innerText=n;gID('mdl').style.display='flex'}
async function saveShiftEdit(id,n){const s=gID('edS').value,e=gID('edE').value,rec=data.Timesheet[id],rt=rec.rate||0;let pay=0;if(s&&e&&rt>0){const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);let dr=(eh*60+em)-(sh*60+sm);if(dr<0)dr+=24*60;pay=Math.round((dr/60)*rt)}await db.child('Timesheet').child(id).update({s:s,e:e,pay:pay});openPersCal(n)}
async function delShift(id,n){if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–º—ñ–Ω—É?'))return;await db.child('Timesheet').child(id).remove();openPersCal(n)}
async function addTsNoteDirect(n,d){const t=gID('newNote').value;if(!t)return;const u={};u['/Timesheet_Notes/'+db.child('Timesheet_Notes').push().key]={name:n,date:d,note:t};await db.update(u);openPersCal(n)}
async function delTsNote(id,n){if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?'))return;await db.child('Timesheet_Notes').child(id).remove();openPersCal(n)}
window.prepareHistPrint=(c,k,mKey,title)=>{const l=[];if(data[c])Object.entries(data[c]).filter(([i,v])=>v.name===k).forEach(([i,v])=>{let n=v.note||'–ó–∞–ø–∏—Å';if(v.supplier)n='–ü—Ä–∏—Ö—ñ–¥: '+v.supplier;if(v.client)n='–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: '+v.client;if(v.date.startsWith(mKey))l.push({d:v.date,ts:v.ts||'',n:n,a:v.amount,id:i,isFix:v.isFix})});l.sort((a,b)=>(a.d+a.ts).localeCompare(b.d+b.ts));let ph=`<h3>üìú ${k}: ${title}</h3><div id="print-cols" style="display:block">`;const drawR=(v)=>{let vShow=v.a;if(c==='–ü–ª–µ–Ω–∫–∞'||c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')vShow=v.a.toFixed(2);else if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')vShow=v.a.toFixed(1);let u=(c==='–ü–ª–µ–Ω–∫–∞')?'–∫–≥':'—à—Ç';return`<div class="p-row"><span>${fd2(v.d)} ${v.n}</span><b>${vShow}${u}</b></div>`};l.forEach(v=>ph+=drawR(v));ph+=`</div>`;gID('print-view').innerHTML=ph;printPage('modal')};
function showH(c,k){const t=gID('mT'),b=gID('mB');t.innerText=k;const l=[];if(data[c])Object.entries(data[c]).filter(([i,v])=>v.name===k).forEach(([i,v])=>{let n=v.note||'–ó–∞–ø–∏—Å';if(v.supplier)n='–ü—Ä–∏—Ö—ñ–¥: '+v.supplier;if(v.client)n='–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: '+v.client;l.push({d:v.date,ts:v.ts||'',n:n,a:v.amount,id:i,isFix:v.isFix})});const cm=new Date().toISOString().slice(0,7),ar={},cl=[];l.forEach(v=>{const m=v.d.slice(0,7);if(m===cm)cl.push(v);else{if(!ar[m])ar[m]=[];ar[m].push(v)}});cl.sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts));let h='<div style="margin-top:10px">';const sm=Object.keys(ar).sort().reverse();if(cl.length>0){let sumP=0,sumM=0;cl.forEach(x=>{if(x.a>0)sumP+=x.a;else sumM+=Math.abs(x.a)});let sP=Math.round(sumP),sM=Math.round(sumM);if(c==='–ü–ª–µ–Ω–∫–∞'||c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'){sP=sumP.toFixed(2);sM=sumM.toFixed(2)}else if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'){sP=sumP.toFixed(1);sM=sumM.toFixed(1)}h+=`<div style="font-size:10px;color:#94a3b8;font-weight:800;margin-bottom:5px;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center"><span>–ü–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å (${mths[new Date().getMonth()]})</span><div><span style="margin-right:10px"><span style="color:#16a34a">+${sP}</span> / <span style="color:#dc2626">-${sM}</span></span><button class="btn-main" style="width:auto;padding:4px 8px;font-size:10px;display:inline-block;margin:0" onclick="prepareHistPrint('${c}','${k}','${cm}','${mths[new Date().getMonth()]}')">üñ®Ô∏è</button></div></div><div style="display:flex;flex-direction:column;gap:0;">`;cl.forEach(v=>{h+=renderHistRow(c,v)});h+='</div>'}else h+=`<div style="text-align:center;padding:20px;color:#94a3b8;font-size:12px">–ü–æ—Ä–æ–∂–Ω—å–æ</div>`;if(sm.length>0){h+=`<div class="arch-y-grid" style="margin-top:20px;margin-bottom:15px;border-top:2px dashed #e2e8f0;padding-top:15px"><div style="grid-column:1/-1;font-size:10px;font-weight:900;color:#94a3b8;text-align:center;text-transform:uppercase;margin-bottom:5px">–ê—Ä—Ö—ñ–≤ –º–∏–Ω—É–ª–∏—Ö –º—ñ—Å—è—Ü—ñ–≤</div>`;sm.forEach(k=>{const[y,m]=k.split('-'),nm=mths[parseInt(m)-1];let sumP=0,sumM=0;ar[k].forEach(x=>{if(x.a>0)sumP+=x.a;else sumM+=Math.abs(x.a)});let sP=Math.round(sumP),sM=Math.round(sumM);if(c==='–ü–ª–µ–Ω–∫–∞'||c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'){sP=sumP.toFixed(2);sM=sumM.toFixed(2)}else if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'){sP=sumP.toFixed(1);sM=sumM.toFixed(1)}h+=`<div class="arch-tile-y" style="font-size:12px;padding:10px 5px;background:#f1f5f9;color:#64748b;box-shadow:none;border:1px solid #cbd5e1;display:flex;justify-content:space-between;align-items:center;cursor:default"><div onclick="toggleF('h_${k}')" style="flex-grow:1;text-align:left;cursor:pointer">üìÅ ${nm} ${y} <span style="font-size:10px;margin-left:5px"><span style="color:#16a34a">+${sP}</span> / <span style="color:#dc2626">-${sM}</span></span></div><button class="btn-main" style="width:auto;padding:4px 8px;font-size:10px;margin:0" onclick="prepareHistPrint('${c}','${t.innerText}','${k}','${nm} ${y}')">üñ®Ô∏è</button></div>`});h+=`</div>`;sm.forEach(k=>{h+=`<div id="h_${k}" class="arch-content" style="border-left:2px solid #ccc;padding-left:10px;margin-bottom:10px">`;ar[k].sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts)).forEach(v=>{h+=renderHistRow(c,v)});h+=`</div>`})}b.innerHTML=h;gID('mdl').style.display='flex'}
function renderHistRow(c,v){if(v.a===0&&(v.n.includes('–û—Å—Ç–∞—Ç–æ–∫')||v.n.includes('–ó–∞–∫—Ä—ã—Ç–∏–µ')||v.n.includes('–ù–∞—á–∞–ª–æ')||v.n.includes('–ö–æ–Ω–µ—Ü'))){const isStart=v.n.toLowerCase().includes('–Ω–∞—á–∞–ª–æ'),color=isStart?'#15803d':'#be123c',bg=isStart?'#dcfce7':'#fee2e2',icon=isStart?'üöÄ':'üèÅ';return `<div style="background:${bg};padding:8px;border-radius:8px;margin:4px 0;font-size:12px;color:${color};border:1px solid ${color};font-weight:900;text-align:center;"><div style="font-size:10px;opacity:0.8;margin-bottom:2px">${fd2(v.d)}</div>${icon} ${v.n}${corrMode?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;font-size:14px;color:red;float:right">üóëÔ∏è</button>`:''}</div>`}if(v.isFix)return `<div style="background:#fffbeb;padding:10px;border-radius:8px;margin:5px 0;font-size:12px;color:#92400e;display:flex;justify-content:space-between;align-items:center;border:1px solid #fcd34d;"><span style="font-weight:700">üìå ${v.n}</span><span style="font-size:10px;color:#b45309">${fd2(v.d)}</span>${corrMode?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;font-size:14px;margin-left:5px">üóëÔ∏è</button>`:''}</div>`;const p=v.a>0?'+':'',vd=(c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')?v.a.toFixed(2):(c==='–ü–∞–∫–µ—Ç—ã'||c==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'?Math.round(v.a):v.a.toFixed(1));const valClass=v.a>=0?'val-blue':'val-red';return `<div style="display:flex;align-items:center;border-bottom:1px solid #f1f5f9;justify-content:space-between;padding:2px 0"><div style="padding:8px 0;width:60%"><div style="font-weight:600;color:#1e293b;font-size:13px">${v.n}</div><div style="font-size:10px;color:#94a3b8">${fd2(v.d)}</div></div><div style="text-align:right;font-weight:800;font-size:14px;width:30%" class="${valClass}">${p}${vd}</div><div style="width:30px;text-align:center">${corrMode?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;font-size:16px;color:red">üóëÔ∏è</button>`:''}</div></div>`}
async function sFixBal(){const d=gID('fixDate').value;if(!d)return alert('–î–∞—Ç—É!');const ds=d+"T00:00:00.000Z",u={},b=gID('btnFix');b.disabled=!0;b.innerText="...";let k=0;stockCatsAll.forEach(c=>{if(!data[c])return;const s={};Object.values(data[c]).forEach(v=>s[v.name]=(s[v.name]||0)+v.amount);Object.keys(s).forEach(n=>{const a=s[n];if(Math.abs(a)>.01){u[`/${c}/${db.child(c).push().key}`]={name:n,amount:0,date:ds,ts:ds,note:`üü¢ –û–°–¢–ê–¢–û–ö: ${Math.round(a)}`,isFix:!0};k++}})});try{await db.update(u);alert("–ì–æ—Ç–æ–≤–æ");closeModal()}catch(e){alert(e);b.disabled=!1;b.innerText="–°–û–•–†–ê–ù–ò–¢–¨"}}
async function runArchive(){const d=gID('archDate').value;if(!d||!confirm(`–°–í–ï–†–¢–ö–ê –ë–ê–ó–´ (–û–ü–ê–°–ù–û)\n–£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –æ—Å—Ç–∞—Ç–∫–∏.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`))return;const b=gID('btnArch'),cd=d+"T00:00:00.000Z",u={};b.disabled=!0;b.innerText="...";let f=0,l=0;stockCatsAll.forEach(c=>{if(!data[c])return;const s={};Object.entries(data[c]).forEach(([k,v])=>{if(v.date<cd){s[v.name]=(s[v.name]||0)+v.amount;u[`/${c}/${k}`]=null;l++}});Object.keys(s).forEach(n=>{const a=s[n];if(Math.abs(a)>.01){u[`/${c}/${db.child(c).push().key}`]={name:n,amount:a,date:cd,ts:new Date().toISOString(),note:`üü¢ –°–í–ï–†–¢–ö–ê –ë–ê–ó–´`,isFix:!0};f++}})});['–§–∞—Å–æ–≤–∫–∞','Krup_Report','Vibro_Report','ZSHM_Report','ArchInvoices','ArchIncoming','ArchPackIn'].forEach(c=>{if(!data[c])return;Object.entries(data[c]).forEach(([k,v])=>{if(v.date<cd){u[`/${c}/${k}`]=null;l++}})});try{await db.update(u);alert("–ì–æ—Ç–æ–≤–æ");closeModal()}catch(e){alert(e);b.disabled=!1;b.innerText="–°–í–ï–†–ù–£–¢–¨ –ë–ê–ó–£"}}
function rInvD(c){const k=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[k]||{},t={};Object.entries(d).forEach(([i,v])=>{if(!v.date)return;const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth();if(!t[y])t[y]={m:{}};if(!t[y].m[m])t[y].m[m]=[];t[y].m[m].push({...v,id:i})});let h='';Object.keys(t).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}')">${y}</div></div><div id="y${y}" class="arch-content"><div class="arch-m-grid">`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="m${y}${m}" class="arch-content" style="grid-column:1/-1;">`;t[y].m[m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{if(k==='ArchIncoming'){h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–Ü–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`);else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`;h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}</div>`}else{h+=`<div class="j-card"><div class="j-head">–í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=drawShipItem(i));h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}</div>`}});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ü–æ—Ä–æ–∂–Ω—å–æ'}
function rInvC(c){const k=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[k]||{},t={};Object.entries(d).forEach(([i,v])=>{if(!v.date)return;const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth(),cl=v.client||v.supplier||'–ë–µ–∑ —ñ–º–µ–Ω—ñ';if(!t[y])t[y]={m:{}};if(!t[y].m[m])t[y].m[m]={cl:{}};if(!t[y].m[m].cl[cl])t[y].m[m].cl[cl]=[];t[y].m[m].cl[cl].push({...v,id:i})});let h='';Object.keys(t).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('cy${y}')">${y}</div></div><div id="cy${y}" class="arch-content"><div class="arch-m-grid">`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="arch-tile-m" onclick="toggleF('cm${y}${m}')">${mths[m]}</div>`});h+=`</div>`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div id="cm${y}${m}" class="arch-content" style="grid-column:1/-1;">`;Object.keys(t[y].m[m].cl).sort().forEach(n=>{const id=`c${y}${m}${n.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/g,'')}`,cnt=t[y].m[m].cl[n].length;h+=`<div class="arch-tile-c" style="margin-bottom:2px" onclick="toggleF('${id}')">${n}<div class="arch-badge">${cnt}</div></div><div id="${id}" class="arch-content" style="margin-bottom:10px;border-left:2px solid var(--p);padding-left:5px;">`;t[y].m[m].cl[n].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{if(k==='ArchIncoming'){h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–Ü–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`);else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`;h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}</div>`}else{h+=`<div class="j-card"><div class="j-head">–í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`;if(v.items)v.items.forEach(i=>h+=drawShipItem(i));h+=`</div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${k}','${v.id}')">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}</div>`}});h+=`</div>`});h+=`</div>`});h+=`</div>`});c.innerHTML=h||'–ü–æ—Ä–æ–∂–Ω—å–æ'}
const CAT_MAP={'–ì–æ—Ç–æ–≤–∞—è':'1. üì¶ –§–ê–°–û–í–ö–ê (–ì–û–¢–û–í–ê)','WeightStock':'2. ‚öñÔ∏è –ö–£–ü–û–í–ê–ù–ê –ü–†–û–î–£–ö–¶–Ü–Ø','Stock_DV':'3. üè≠ –°–ö–õ–ê–î –î–í (–í–ê–ì–û–í–ê)','Stock_Feed':'4. üçÇ –í–Ü–î–•–û–î–ò (–ö–û–†–ú–ê)','Stock_Semi':'5. ‚öôÔ∏è –ù–ê–ü–Ü–í–§–ê–ë–†–ò–ö–ê–¢','Stock_Raw':'6. üöú –°–ò–†–û–í–ò–ù–ê (–ó–ï–†–ù–û)','–ü–ª–µ–Ω–∫–∞':'7. üéûÔ∏è –ü–õ–Ü–í–ö–ê','–ü–∞–∫–µ—Ç—ã':'8. ü•° –ü–ê–ö–ï–¢–ò','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'9. üß¥ –°–ö–û–¢–ß','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'10. üåÄ –°–¢–†–ï–ô–ß –ü–õ–Ü–í–ö–ê','–ù–∏—Ç–∫–∏':'11. üßµ –ù–ò–¢–ö–ò','–ú–µ—à–∫–∏':'12. üí∞ –ú–Ü–®–ö–ò','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'13. üî• –¢–ï–†–ú–û –°–¢–†–Ü–ß–ö–ê','–≠—Ç–∏–∫–µ—Ç–∫–∞':'14. üè∑Ô∏è –ï–¢–ò–ö–ï–¢–ö–ê'};
const REPORT_ORDER=['–ì–æ—Ç–æ–≤–∞—è','WeightStock','Stock_DV','Stock_Feed','Stock_Semi','Stock_Raw','–ü–ª–µ–Ω–∫–∞','–ü–∞–∫–µ—Ç—ã','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–ù–∏—Ç–∫–∏','–ú–µ—à–∫–∏','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','–≠—Ç–∏–∫–µ—Ç–∫–∞'];
function makeSelect(i,c,p,so,nl){let o=`<option value="">${p}...</option>`,l=[];if(so)l=so;else{if(c==='Stock_Raw'||c==='Stock_Feed'||c==='Stock_Semi'){const s=new Set();if(data[c])Object.values(data[c]).forEach(v=>s.add(v.name));l=Array.from(s).sort()}else if(c==='Stock_DV'){const r=new Set();gP(c).forEach(f=>r.add(f.split(' [')[0]));l=Array.from(r).sort()}else if(c==='Suppliers'){const s=new Set();if(data.Suppliers)Object.values(data.Suppliers).forEach(v=>s.add(v.name));l=Array.from(s).sort()}else l=gP(c)}l.forEach(n=>o+=`<option value="${n}">${n}</option>`);o+=`<option value="NEW" style="font-weight:bold;color:var(--p)">${nl||'+ –ù–û–í–ò–ô –í–ò–î'}</option>`;return `<select id="s_${i}" onchange="toggleInput('${i}')" style="width:100%">${o}</select><input type="text" id="i_${i}" class="new-input" placeholder="–ù–∞–∑–≤–∞" style="display:none;width:100%">`}
function makeSmart(i,l,p){let o=`<option value="">${p}</option>`;if(l)l.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW_ENTRY" style="font-weight:900;color:blue">(+) –í–í–ï–°–¢–ò...</option>`;return `<div class="smart-wrap"><select id="s_${i}" class="smart-sel" onchange="checkSmart('${i}')">${o}</select><input type="text" id="i_${i}" class="smart-inp" placeholder="${p}"></div>`}
function checkSmart(i){const s=gID('s_'+i);if(s.value==='NEW_ENTRY'){s.style.display='none';const n=gID('i_'+i);n.style.display='block';n.focus()}}
function getSmartVal(i){const n=gID('i_'+i);if(n&&n.style.display==='block')return n.value;const s=gID('s_'+i);return s?s.value:''}
function getHistoryDeep(k){const s=new Set(),scan=n=>{if(data[n])Object.values(data[n]).forEach(v=>{if(v[k])s.add(v[k]);if(v.items)v.items.forEach(i=>{if(k==='weight'&&i.w)s.add(i.w);if(k==='name'&&i.n)s.add(i.n)})})};scan('Vibro_Report');scan('Krup_Report');scan('ZSHM_Report');return Array.from(s).sort()}
function openModal(t,a1,a2){if(['inc','ship','corr','addRaw','addMatPack'].includes(t)&&!isAdmin)return;
const ti=gID('mT'),b=gID('mB'),td=new Date().toISOString().split('T')[0];aId=null;if(WS_CFG[t]){renderWorkshopModal(t,ti,b,td);gID('mdl').style.display='flex';return}if(arguments.length===2&&(t!=='corr'))aId=a1;if(t==='corr'){const c=a1,n=a2;corrCtx={cat:c,name:n};ti.innerText='–ö–æ—Ä–µ–∫—Ü—ñ—è: '+n;b.innerHTML=`<div style="margin-bottom:15px;background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0"><div style="font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px">–£–ü–†–ê–í–õ–Ü–ù–ù–Ø</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #cbd5e1;padding:8px;font-size:11px" onclick="renameItem('${n}','${c}')">‚úèÔ∏è –Ü–ú'–Ø</button><button class="btn-main" style="background:#fee2e2;color:red;border:1px solid #fca5a5;padding:8px;font-size:11px" onclick="delItemBatch('${n}','${c}')">üóëÔ∏è –í–ò–î–ê–õ–ò–¢–ò</button></div></div><hr style="border:none;border-top:1px dashed #cbd5e1;margin:10px 0"><label class="l-t">–î–ê–¢–ê</label><input type="date" id="cD" value="${td}"><label class="l-t">–ó–ú–Ü–ù–ò–¢–ò –ó–ê–õ–ò–®–û–ö (+/-)</label><div style="display:flex;gap:5px"><input type="number" id="cA" placeholder="0"><button onclick="gID('cA').value *= -1" style="width:50px;font-weight:900;background:#eef2ff;border:1px solid #cbd5e1;border-radius:10px">+/-</button></div><label class="l-t">–ü–†–ò–ß–ò–ù–ê</label><input type="text" id="cR" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ø–µ—Ä–µ–æ–±–ª—ñ–∫"><button class="btn-main" id="btnS" onclick="sCorr()" style="margin-top:10px">–ó–ë–ï–†–ï–ì–¢–ò</button>`}else if(t==='fas'){ti.innerText='–§–∞—Å—É–≤–∞–Ω–Ω—è (–ú—É–ª—å—Ç–∏)';b.innerHTML=`<label class="l-t">–î–ê–¢–ê</label><input type="date" id="fD" value="${td}"><div class="z-head" style="margin-top:10px">–°–ò–†–û–í–ò–ù–ê (–í–•–Ü–î)</div><div class="z-col-h" style="grid-template-columns:25% 45% 20% 10%"><div>–ó–í–Ü–î–ö–ò</div><div>–©–û</div><div>–ö–ì</div><div></div></div><div id="fasRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px solid #e2e8f0;padding:8px;font-size:11px" onclick="addFasRow()">+ –î–û–î–ê–¢–ò –°–ò–†–û–í–ò–ù–£</button><div class="z-head" style="margin-top:15px;background:#eef2ff;color:var(--p)">–ì–û–¢–û–í–ê –ü–†–û–î–£–ö–¶–Ü–Ø (–í–ò–•–Ü–î)</div><div class="z-col-h" style="grid-template-columns:45% 25% 20% 10%"><div>–ù–ê–ó–í–ê</div><div>–ü–ê–ö–ï–¢</div><div>–®–¢</div><div></div></div><div id="fasOutRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px solid #e2e8f0;padding:8px;font-size:11px" onclick="addFasOutRow()">+ –î–û–î–ê–¢–ò –ü–†–û–î–£–ö–¶–Ü–Æ</button><div style="margin-top:15px;border-top:1px dashed #e2e8f0;padding-top:10px"><label class="l-t">–í–ó–Ø–í –ü–õ–Ü–í–ö–ò (—á–µ—Ä–µ–∑ +)</label><input type="text" id="fVz" placeholder="5+2.5"><label class="l-t">–ó–ê–õ–ò–®–û–ö –ü–õ–Ü–í–ö–ò</label><input type="number" id="fOs" placeholder="–ó–∞–ª–∏—à–æ–∫"></div><button class="btn-main" id="btnS" onclick="sFas()">–ó–ë–ï–†–ï–ì–¢–ò</button>`;setTimeout(()=>{addFasRow();addFasOutRow()},100)}else if(t==='addRaw'){ti.innerText='–ü—Ä–∏—Ö—ñ–¥ –°–∏—Ä–æ–≤–∏–Ω–∏';b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="rD" value="${td}">–ù–∞–∑–≤–∞:${makeSelect('rN','Stock_Raw','–ù–∞–∑–≤–∞')}–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:${makeSelect('rSupp','','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',gRawActive(),'+ –ù–û–í–ò–ô')}–í–∞–≥–∞ (–∫–≥):<input type="number" id="rA"><button class="btn-main" id="btnS" onclick="sRawInc()">–ü–†–ò–ô–ù–Ø–¢–ò</button>`}else if(t==='inc'){ti.innerText='–ü–†–ò–•–Ü–î –ù–ê –°–ö–õ–ê–î';b.innerHTML=`<div class="g2"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="iD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="iNum" placeholder="‚Ññ"></div></div><div style="margin-bottom:5px"><label class="l-t">–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö</label>${makeSelect('iS','ArchIncoming','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',gBuyS(),'+ –ù–û–í–ò–ô')}</div><div style="margin-bottom:5px"><label class="l-t">–ù–ê–ô–ú–ï–ù–£–í–ê–ù–ù–Ø</label>${makeSelect('iN','WeightStock','–¢–æ–≤–∞—Ä',gP('WeightStock'),'+ –ù–û–í–ò–ô')}</div><div style="margin-bottom:15px"><label class="l-t">–í–ê–ì–ê (–ö–ì)</label><input type="number" id="iA" placeholder="0"></div><button class="btn-main" style="background:var(--s)" onclick="sInc()">–ü–†–ò–ô–ù–Ø–¢–ò –ù–ê –°–ö–õ–ê–î –ö–£–ü–û–í–ê–ù–ê</button>`}else if(t==='addMatPack'){ti.innerText='–ü–†–ò–•–Ü–î –ü–ê–ö–£–í–ê–ù–ù–Ø';b.innerHTML=`<div class="g2"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="pD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="pNum" placeholder="‚Ññ"></div></div><div style="margin-bottom:5px"><label class="l-t">–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö</label>${makeSelect('pS','ArchPackIn','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',gPackS(),'+ –ù–û–í–ò–ô')}</div><div style="margin-bottom:5px"><label class="l-t">–°–ö–õ–ê–î –ü–†–ò–ô–û–ú–£</label><select id="pCat" onchange="updPackList()"><option value="–ü–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç–∏</option><option value="–ü–ª–µ–Ω–∫–∞">–ü–ª—ñ–≤–∫–∞</option><option value="–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º">–°–∫–æ—Ç—á</option><option value="–ú–µ—à–∫–∏">–ú—ñ—à–∫–∏</option><option value="–ù–∏—Ç–∫–∏">–ù–∏—Ç–∫–∏</option><option value="–≠—Ç–∏–∫–µ—Ç–∫–∞">–ï—Ç–∏–∫–µ—Ç–∫–∞</option><option value="–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞">–°—Ç—Ä–µ–π—á –ø–ª—ñ–≤–∫–∞</option><option value="–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞">–¢–µ—Ä–º–æ —Å—Ç—Ä—ñ—á–∫–∞</option></select></div><div style="margin-bottom:5px"><label class="l-t">–ü–†–û–î–£–ö–¶–Ü–Ø</label><div id="pProdCont"></div></div><div style="margin-bottom:15px"><label class="l-t" id="pALbl">–ö–Ü–õ–¨–ö–Ü–°–¢–¨ (–®–¢)</label><input type="number" id="pA" placeholder="0"></div><button class="btn-main" style="margin-top:10px;background:var(--s)" onclick="sPack()">–ü–†–ò–ô–ù–Ø–¢–ò</button>`;setTimeout(updPackList,100)}else if(t==='ship'){
useStretch=!1;shipBasket={};ti.innerText='–í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó–Ü –°–ö–õ–ê–î–£';
b.innerHTML=`<div class="g3"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="hD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="hNum" placeholder="‚Ññ"></div><div><label class="l-t">–£–ì–û–î–ê</label><input type="text" id="hAg" placeholder="‚Ññ"></div></div><div class="g2" style="margin:5px 0"><div><label class="l-t">–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö</label>${makeSelect('hMyFop','Suppliers','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',null,'+ –ù–û–í–ò–ô')}</div><div><label class="l-t">–û–¢–†–ò–ú–£–í–ê–ß</label>${makeSelect('hC','ArchInvoices','–û—Ç—Ä–∏–º—É–≤–∞—á',gCl(),'+ –ù–û–í–ò–ô')}</div></div><div class="z-head">–ó–í–Ü–î–ö–ò –í–ê–ù–¢–ê–ñ–ò–ú–û:</div><div id="shipBtns" class="dash-grid" style="margin-bottom:10px;grid-template-columns:1fr 1fr"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('–ì–æ—Ç–æ–≤–∞—è')">–§–ê–°–û–í–ö–ê</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('WeightStock')">–ö–£–ü–û–í–ê–ù–ê</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_DV')">–î–í</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_Feed')">–ö–û–†–ú–ê</button></div><div id="shpR"></div><div style="margin-top:10px;border-top:1px dashed #cbd5e1;padding-top:10px"><button id="btnStr" class="btn-main" onclick="toggleStr(this)" style="background:#f1f5f9;color:#333;border:1px solid #cbd5e1">–°–¢–†–ï–ô–ß: –ù–Ü</button></div><button class="btn-main" id="btnS" onclick="sShip()" style="margin-top:15px;background:var(--d)">–í–Ü–î–í–ê–ù–¢–ê–ñ–ò–¢–ò</button>`}else if(t==='fixBal'){ti.innerText='–§—ñ–∫—Å–∞—Ü—ñ—è –∑–∞–ª–∏—à–∫—ñ–≤';b.innerHTML=`<p style="font-size:12px;color:#666">–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –∑–∞–ª–∏—à–∫–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –¥–Ω—è?</p><input type="date" id="fixDate" value="${td}"><button class="btn-main" id="btnFix" onclick="sFixBal()" style="background:#f59e0b">–ó–ë–ï–†–ï–ì–¢–ò –ú–Ü–¢–ö–£</button>`}else if(t==='dayRep'){ti.innerText='–î–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç';b.innerHTML=`<label class="l-t">–î–ê–¢–ê</label><input type="date" id="repDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" onclick="genDayReport()">–°–§–û–†–ú–£–í–ê–¢–ò</button>`}else if(t==='monthRep'){ti.innerText='–ú–Ü–°–Ø–ß–ù–ò–ô –ó–í–Ü–¢';b.innerHTML=`<label class="l-t">–û–ë–ï–†–Ü–¢–¨ –ú–Ü–°–Ø–¶–¨</label><input type="month" id="repMth" value="${td.slice(0,7)}" style="margin-bottom:15px"><button class="btn-main" onclick="genMonthReport()" style="background:#4338ca">üìä –ü–û–ö–ê–ó–ê–¢–ò –ó–í–Ü–¢</button>`}else if(t==='closeMonth'){ti.innerText='–ó–ê–ö–†–ò–¢–¢–Ø –ú–Ü–°–Ø–¶–Ø';b.innerHTML=`<div style="background:#f5f3ff;padding:15px;border-radius:10px;border:1px solid #ddd6fe;color:#5b21b6;font-size:13px;margin-bottom:15px;line-height:1.4"><b>–©–æ —Ü–µ —Ä–æ–±–∏—Ç—å?</b><br>–°—Ç–≤–æ—Ä—é—î "–∑–∞—Å—ñ—á–∫–∏" –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è <b>–í–°–Ü–•</b> —Ç–æ–≤–∞—Ä—ñ–≤.<br><br>1. –ó–∞–ø–∏—Å "–ö—ñ–Ω–µ—Ü—å –º—ñ—Å—è—Ü—è" (–Ω–∞ –æ–±—Ä–∞–Ω—É –¥–∞—Ç—É).<br>2. –ó–∞–ø–∏—Å "–ü–æ—á–∞—Ç–æ–∫ –º—ñ—Å—è—Ü—è" (–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å).<br><br>–¶–µ –Ω–µ –∑–º—ñ–Ω—é—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ –≥–∞—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç —ñ–∑ –∑–∞–ª–∏—à–∫–æ–º.</div><label class="l-t">–î–ê–¢–ê –ó–ê–ö–†–ò–¢–¢–Ø (–û–°–¢–ê–ù–ù–Ü–ô –î–ï–ù–¨)</label><input type="date" id="cmDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" id="btnCM" onclick="runCloseMonth()" style="background:#7c3aed;border:none">‚úÖ –ó–ê–ü–ò–°–ê–¢–ò –ó–ê–õ–ò–®–ö–ò</button>`}else if(t==='archiveOld'){ti.innerText='–ó–ì–û–†–¢–ê–ù–ù–Ø –ë–ê–ó–ò (–ù–ï–ë–ï–ó–ü–ï–ß–ù–û)';b.innerHTML=`<div style="background:#fee2e2;padding:10px;border-radius:10px;border:1px solid #f87171;color:#b91c1c;font-size:12px;margin-bottom:15px"><b>–£–í–ê–ì–ê!</b> –í–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏, –∞–ª–µ –∑–±–µ—Ä–µ–∂–µ –∑–∞–ª–∏—à–∫–∏.</div><label class="l-t">–ó–ì–û–†–ù–£–¢–ò –î–û:</label><input type="date" id="archDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" id="btnArch" onclick="runArchive()" style="background:#dc2626;border:none">–ü–û–ß–ê–¢–ò –ó–ì–û–†–¢–ê–ù–ù–Ø</button>`}gID('mdl').style.display='flex'}
function toggleStr(b){useStretch=!useStretch;if(useStretch){b.style.background='var(--p)';b.style.color='#fff';b.innerText='–°–¢–†–ï–ô–ß: –¢–ê–ö (–ê–í–¢–û)'}else{b.style.background='#f1f5f9';b.style.color='#333';b.innerText='–°–¢–†–ï–ô–ß: –ù–Ü'}}
window.updPackList=()=>{const c=gID('pCat').value;gID('pALbl').innerText=(c==='–ü–ª–µ–Ω–∫–∞')?'–ö–Ü–õ–¨–ö–Ü–°–¢–¨ (–ö–ì)':'–ö–Ü–õ–¨–ö–Ü–°–¢–¨ (–®–¢)';const s=new Set();if(data[c])Object.values(data[c]).forEach(v=>s.add(v.name));if(c==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));gID('pProdCont').innerHTML=makeSelect('pN','','–û–±–µ—Ä—ñ—Ç—å...',Array.from(s).sort(),'+ –ù–û–í–´–ô')}
function addFasRow(){const i=Date.now()+Math.random();gID('fasRows').insertAdjacentHTML('beforeend',`<div class="fas-row" id="fr_${i}"><select class="smart-sel" id="src_${i}" onchange="updFasRawList('${i}')" style="font-size:10px;padding:0"><option value="WeightStock">–ö—É–ø–æ–≤–∞–Ω–∞</option><option value="Stock_DV">–î–í</option></select><div id="cont_${i}"></div><input type="number" id="qty_${i}" class="u-inp" placeholder="–ö–≥"><button class="del-row-btn" onclick="document.getElementById('fr_${i}').remove()">‚úï</button></div>`);updFasRawList(i)}
function updFasRawList(i){const s=gID('src_'+i).value,m={};if(data[s])Object.values(data[s]).forEach(v=>m[v.name]=(m[v.name]||0)+v.amount);let l=Object.keys(m).filter(k=>m[k]>0).sort(),o='<option value="">–û–±—Ä–∞—Ç–∏...</option>';l.forEach(k=>o+=`<option value="${k}">${k} [–ó–∞–ª: ${Math.round(m[k])}–∫–≥]</option>`);gID('cont_'+i).innerHTML=`<select id="nm_${i}" class="smart-sel" style="font-size:11px">${o}</select>`}
function addFasOutRow(){const i=Date.now()+Math.random(),o1=gP('–ì–æ—Ç–æ–≤–∞—è').map(p=>`<option>${p}</option>`).join(''),o2=szs.map(s=>`<option>${s}</option>`).join('');gID('fasOutRows').insertAdjacentHTML('beforeend',`<div class="fas-out-row" id="fo_${i}"><select id="outN_${i}" class="smart-sel" style="font-size:11px">${o1}</select><select id="outS_${i}" class="smart-sel" style="font-size:11px">${o2}</select><input type="number" id="outQ_${i}" class="u-inp" placeholder="–®—Ç"><button class="del-row-btn" onclick="document.getElementById('fo_${i}').remove()">‚úï</button></div>`)}
function genDayReport(){const d=gID('repDate').value;if(!d)return;const ds=d.split('-').reverse().join('.'),r={inc:[],out:[],used:[],prod:[],pack:{}};
const S_MAP={'WeightStock':'–ö—É–ø–æ–≤–∞–Ω–∞','Stock_DV':'–î–í','Stock_Raw':'–°–∏—Ä–æ–≤–∏–Ω–∞','Stock_Semi':'–ü/–§','Stock_Feed':'–ö–æ—Ä–º–∞','VIBRO':'–í—ñ–±—Ä–æ—Å—Ç—ñ–ª','KRUP':'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞','ZSHM':'–ó–®–ú'};
const addU=(n,v,u,s,dt)=>{let k=`${n}::${s}::${dt}`;let ex=r.used.find(x=>x.k===k);if(ex)ex.v+=v;else r.used.push({n:n,v:v,u:u,s:s,d:dt,k:k})};
const addP=(n,v,u,s,dt)=>{let k=`${n}::${s}::${dt}`;let ex=r.prod.find(x=>x.k===k);if(ex)ex.v+=v;else r.prod.push({n:n,v:v,u:u,s:s,d:dt,k:k})};
if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.date&&v.date.startsWith(d))r.inc.push(`${v.name} (${v.supplier}) ${v.amount}–∫–≥`)});
if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.date&&v.date.startsWith(d))r.inc.push(`${v.name} (${v.supplier}) ${v.amount}—à—Ç`)});
if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>{if(v.date&&v.date.startsWith(d))v.items.forEach(i=>{let p=i.split('|');if(p.length<2&&i.includes(':'))p=i.split(':');let n=p[0],a=parseFloat(p[1])||0,u=p[2]||'–∫–≥';let k=n;let ex=r.out.find(x=>x.k===k);if(ex)ex.v+=a;else r.out.push({n:n,v:a,u:u,k:k})})});
if(data.–§–∞—Å–æ–≤–∫–∞)Object.values(data.–§–∞—Å–æ–≤–∫–∞).forEach(v=>{if(v.date&&v.date.startsWith(d)){if(v.items)v.items.forEach(i=>{addU(i.name,parseFloat(i.amount),'–∫–≥',S_MAP[i.source]||i.source,'–§–∞—Å–æ–≤–∫–∞')});else addU(v.rawItem,parseFloat(v.prihod),'–∫–≥','–°–∏—Ä–æ–≤–∏–Ω–∞','–§–∞—Å–æ–≤–∫–∞');if(v.outputItems)v.outputItems.forEach(o=>addP(o.name,parseFloat(o.count),'—à—Ç','–§–∞—Å–æ–≤–∫–∞','–ì–æ—Ç–æ–≤–∞—è'));else addP(v.name,parseFloat(v.vyhod),'—à—Ç','–§–∞—Å–æ–≤–∫–∞','–ì–æ—Ç–æ–≤–∞—è')}});
['Vibro_Report','Krup_Report','ZSHM_Report'].forEach(db=>{if(data[db])Object.values(data[db]).forEach(v=>{if(v.date&&v.date.startsWith(d)){let wN=WS_CFG[v.type]?.title||v.type;if(v.rawMix){let m=v.rawMix.match(/^(.*)\s\((\d+(\.\d+)?)–∫–≥\)$/);if(m)addU(m[1],parseFloat(m[2]),'–∫–≥','–°–∏—Ä–æ–≤–∏–Ω–∞/–ü–§',wN);else addU(v.rawMix,0,'','',wN)}if(v.items)v.items.forEach(i=>{let dst='–î–í';if(i.type==='Semi')dst='–ü/–§';if(i.type==='Feed')dst='–ö–æ—Ä–º–∞';addP(i.n,(i.q*i.w)+i.l,'–∫–≥',wN,dst)})}})});
['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].forEach(c=>{if(data[c])Object.values(data[c]).forEach(v=>{if(v.date&&v.date.startsWith(d)&&v.amount<0){let n=v.name,u=(c==='–ü–ª–µ–Ω–∫–∞')?'–∫–≥':'—à—Ç';if(!r.pack[c])r.pack[c]=[];let ex=r.pack[c].find(x=>x.n===n);if(ex)ex.v+=Math.abs(v.amount);else r.pack[c].push({n:n,v:Math.abs(v.amount),u:u})}})});
const rd=t=>`<span style="color:var(--red)">${t}</span>`,bl=t=>`<span style="color:var(--blue)">${t}</span>`;
let h=`<div class="day-rep-box">–ó–≤—ñ—Ç –∑–∞ ${ds}<div class="dr-h">üì• –ü–†–ò–•–Ü–î (–ó–ê–ö–£–ü–Ü–í–õ–Ø)</div>`;
if(r.inc.length)r.inc.forEach(l=>h+=bl(`+ ${l}`)+`\n`);else h+=`-\n`;
h+=`<div class="dr-h">üöö –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø (–ü–†–û–î–ê–ñ)</div>`;
if(r.out.length)r.out.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>h+=rd(`- ${x.n} ${parseFloat(x.v.toFixed(1))}${x.u}`)+`\n`);else h+=`-\n`;
h+=`<div class="dr-h">üìâ –°–ü–ò–°–ê–ù–û –í –ü–ï–†–ï–†–û–ë–ö–£</div>`;
if(r.used.length)r.used.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>h+=rd(`- ${x.n} ${parseFloat(x.v.toFixed(1))}${x.u} <small style="color:#666">(${x.s}‚Üí${x.d})</small>`)+`\n`);else h+=`-\n`;
h+=`<div class="dr-h">üì¶ –í–ò–¢–†–ê–¢–ò –ú–ê–¢–ï–†–Ü–ê–õ–Ü–í</div>`;
let pk=Object.keys(r.pack).sort();if(pk.length)pk.forEach(k=>{h+=`<b>${k}:</b>\n`;r.pack[k].forEach(x=>h+=rd(`  ‚Ä¢ ${x.n} ${parseFloat(x.v.toFixed(1))}${x.u}`)+`\n`)});else h+=`-\n`;
h+=`<div class="dr-h">üìà –û–¢–†–ò–ú–ê–ù–û –ü–†–û–î–£–ö–¶–Ü–á</div>`;
if(r.prod.length)r.prod.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>h+=bl(`+ ${x.n} ${parseFloat(x.v.toFixed(1))}${x.u} <small style="color:#666">(${x.s}‚Üí${x.d})</small>`)+`\n`);else h+=`-\n`;
h+=`</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="btn-main" onclick="copyDayRep()" style="background:#334155">–ö–û–ü–Ü–Æ–í–ê–¢–ò</button><button class="btn-main" onclick="printPage('modal')" style="background:#0f172a">üñ®Ô∏è –î–†–£–ö</button></div>`;gID('mB').innerHTML=h;
let ph=`<h3>üìä –î–ï–ù–ù–ò–ô –ó–í–Ü–¢ [${ds}]</h3><div id="print-cols"><div id="p-col-1"><div class="p-cat"><div class="p-head">üì• –ü–†–ò–•–Ü–î</div>`;
if(r.inc.length)r.inc.forEach(l=>ph+=`<div class="p-row">+ ${l}</div>`);else ph+=`<div class="p-row">-</div>`;
ph+=`</div><div class="p-cat"><div class="p-head">üöö –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</div>`;
if(r.out.length)r.out.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>ph+=`<div class="p-row"><span>${x.n}</span><b>${parseFloat(x.v.toFixed(1))}${x.u}</b></div>`);else ph+=`<div class="p-row">-</div>`;
ph+=`</div></div><div id="p-col-2"><div class="p-cat"><div class="p-head">üìâ –°–ü–ò–°–ê–ù–û</div>`;
if(r.used.length)r.used.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>ph+=`<div class="p-row"><span>${x.n} <small style="color:#666;font-size:8px">(${x.s}‚Üí${x.d})</small></span><b>${parseFloat(x.v.toFixed(1))}${x.u}</b></div>`);else ph+=`<div class="p-row">-</div>`;
ph+=`</div><div class="p-cat"><div class="p-head">üì¶ –ú–ê–¢–ï–†–Ü–ê–õ–ò</div>`;
if(pk.length)pk.forEach(k=>{ph+=`<div style="font-weight:700;margin-top:2px;font-size:9px">${k}:</div>`;r.pack[k].forEach(x=>ph+=`<div class="p-row"><span>- ${x.n}</span><b>${parseFloat(x.v.toFixed(1))}${x.u}</b></div>`)});else ph+=`<div class="p-row">-</div>`;
ph+=`</div><div class="p-cat"><div class="p-head">üìà –ü–†–û–î–£–ö–¶–Ü–Ø</div>`;
if(r.prod.length)r.prod.sort((a,b)=>a.n.localeCompare(b.n)).forEach(x=>ph+=`<div class="p-row"><span>${x.n} <small style="color:#666;font-size:8px">(${x.s}‚Üí${x.d})</small></span><b>${parseFloat(x.v.toFixed(1))}${x.u}</b></div>`);else ph+=`<div class="p-row">-</div>`;
ph+=`</div></div></div>`;gID('print-view').innerHTML=ph}
function copyDayRep(){const e=document.querySelector('.day-rep-box');if(e)navigator.clipboard.writeText(e.innerText).then(()=>alert('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ')).catch(e=>alert('–ü–æ–º–∏–ª–∫–∞'))}
function renderWorkshopModal(t,te,be,td){const c=WS_CFG[t],p=c.prefix;te.innerText=c.title;const o=getHistoryDeep('operator'),a=getHistoryDeep('assistant'),ts=getHistoryDeep('timeStart');if(ts.length===0)ts.push('07:00');const tE=getHistoryDeep('timeEnd');if(tE.length===0)tE.push('17:00');be.innerHTML=`<div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px"><div style="display:grid;grid-template-columns:1.5fr 1fr 1fr;gap:8px;margin-bottom:10px"><div><label class="l-t">–î–ê–¢–ê</label><div class="smart-wrap"><input type="date" id="${p}D" value="${td}" class="smart-sel"></div></div><div><label class="l-t">–ó</label>${makeSmart(p+'TS',ts,'07:00')}</div><div><label class="l-t">–î–û</label>${makeSmart(p+'TE',tE,'17:00')}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart(p+'Op',o,'–ü—Ä—ñ–∑–≤–∏—â–µ')}</div><div><label class="l-t">–ü–û–ú–Ü–ß–ù–ò–ö</label>${makeSmart(p+'As',a,'–ü—Ä—ñ–∑–≤–∏—â–µ')}</div></div></div><div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee"><div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–ê –°–ò–†–û–í–ò–ù–ê</div><div style="display:grid;grid-template-columns:1fr 1.5fr 0.8fr;gap:5px;margin-bottom:5px"><select id="${p}WH" class="smart-sel" onchange="updGenRaw('${p}')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw" ${t!=='VIBRO'?'selected':''}>–°–∏—Ä–æ–≤–∏–Ω–∞</option><option value="Stock_DV">–î–í</option><option value="WeightStock">–ö—É–ø–æ–≤–∞–Ω–∞</option></select><div id="${p}RawCont"></div><input type="number" id="${p}RawW" placeholder="–ö–≥" class="smart-sel" readonly style="background:#eef2ff;font-weight:900;color:#333"></div><div style="font-size:10px;color:#888;font-weight:700;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px">–î–û–ë–ê–í–ö–ê</div><div style="display:grid;grid-template-columns:1fr 1.5fr 0.8fr;gap:5px;margin-bottom:5px"><select id="${p}AddWH" class="smart-sel" onchange="updGenAdd('${p}')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw">–°–∏—Ä–æ–≤–∏–Ω–∞</option><option value="Stock_DV">–î–í</option><option value="WeightStock">–ö—É–ø–æ–≤–∞–Ω–∞</option></select><div id="${p}AddNameCont"></div><input type="number" id="${p}AddW" placeholder="–ö–≥" class="smart-sel" oninput="calcGen('${p}')"></div></div><div class="z-head">–ì–û–¢–û–í–ê –ü–†–û–î–£–ö–¶–Ü–Ø (–°–ö–õ–ê–î –î–í)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê</div><div>–ú–Ü–®</div><div>–í–ê–ì–ê</div><div>–ó–ê–õ</div></div><div id="${p}RowsDV"></div><button class="btn-main" style="background:#fff;color:#3b82f6;border:1px solid #3b82f6;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','DV')">+ –î–û–î–ê–¢–ò –†–Ø–î</button><div class="z-head" style="color:#d97706;background:#fef3c7;">–ù–ê–ü–Ü–í–§–ê–ë–†–ò–ö–ê–¢ (–°–ö–õ–ê–î –ü/–§)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê</div><div>–ú–Ü–®</div><div>–í–ê–ì–ê</div><div>–ó–ê–õ</div></div><div id="${p}RowsSemi"></div><button class="btn-main" style="background:#fff;color:#d97706;border:1px solid #d97706;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','Semi')">+ –î–û–î–ê–¢–ò –†–Ø–î</button><div class="z-head" style="color:#b45309;background:#fff7ed;">–í–Ü–î–•–û–î–ò (–°–ö–õ–ê–î –ö–û–†–ú–ê)</div><div class="z-col-h"><div>–ù–ê–ó–í–ê</div><div>–ú–Ü–®</div><div>–í–ê–ì–ê</div><div>–ó–ê–õ</div></div><div id="${p}RowsFeed"></div><button class="btn-main" style="background:#fff;color:#b45309;border:1px solid #b45309;margin-bottom:15px;font-size:10px" onclick="addGenRow('${p}','Feed')">+ –î–û–î–ê–¢–ò –†–Ø–î</button><button class="btn-main" id="btnS" onclick="saveGen('${t}')">–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–£</button>`;setTimeout(()=>{updGenRaw(p);updGenAdd(p);addGenRow(p,'DV');addGenRow(p,'Semi');addGenRow(p,'Feed')},50)}
function updGenRaw(p){const w=gID(p+'WH').value,m={};if(data[w])Object.values(data[w]).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});let l=Object.keys(m).filter(k=>m[k]>0.01).sort(),o='<option value="">–û–±—Ä–∞—Ç–∏...</option>';l.forEach(k=>{o+=`<option value="${k}">${k} [${Math.round(m[k])}–∫–≥]</option>`});o+=`<option value="NEW_ENTRY" style="color:blue">(+) –í–≤–µ—Å—Ç–∏...</option>`;gID(p+'RawCont').innerHTML=`<div class="smart-wrap"><select id="s_${p}RawItem" class="smart-sel" onchange="checkSmart('${p}RawItem')">${o}</select><input type="text" id="i_${p}RawItem" class="smart-inp" placeholder="–ù–∞–∑–≤–∞"></div>`}
function updGenAdd(p){const w=gID(p+'AddWH').value,m={};if(data[w])Object.values(data[w]).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});let l=Object.keys(m).filter(k=>m[k]>0.01).sort(),o='<option value="">–û–±—Ä–∞—Ç–∏...</option>';l.forEach(k=>{o+=`<option value="${k}">${k} [${Math.round(m[k])}–∫–≥]</option>`});o+=`<option value="NEW_ENTRY" style="color:blue">(+) –í–≤–µ—Å—Ç–∏...</option>`;gID(p+'AddNameCont').innerHTML=`<div class="smart-wrap"><select id="s_${p}AddItem" class="smart-sel" onchange="checkSmart('${p}AddItem')">${o}</select><input type="text" id="i_${p}AddItem" class="smart-inp" placeholder="–î–æ–±–∞–≤–∫–∞"></div>`}
function addGenRow(p,s){const i=Date.now()+Math.floor(Math.random()*1e3);let target='';if(s==='DV')target='Stock_DV';else if(s==='Semi')target='Stock_Semi';else target='Stock_Feed';const sSet=new Set();if(data[target])Object.values(data[target]).forEach(v=>{if(v.name)sSet.add(v.name)});let ls=Array.from(sSet).sort();const wl=getHistoryDeep('weight');let wo='<option value="">–ö–≥</option>';wl.forEach(w=>wo+=`<option value="${w}">${w}</option>`);wo+='<option value="NEW_ENTRY">(+)</option>';let o=`<option value="">–û–±—Ä–∞—Ç–∏...</option>`;ls.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW_ENTRY" style="color:blue">(+) –ù–æ–≤–∏–π</option>`;const h=`<div class="dyn-row" id="${p}row_${i}" data-sect="${s}"><div class="smart-wrap"><select id="s_${p}N_${i}" class="smart-sel" onchange="checkSmart('${p}N_${i}')">${o}</select><input type="text" id="i_${p}N_${i}" class="smart-inp"></div><input type="number" id="${p}Q_${i}" class="u-inp" placeholder="0" oninput="calcGen('${p}')"><div class="smart-wrap"><select id="s_${p}W_${i}" class="smart-sel" onchange="checkSmart('${p}W_${i}')">${wo}</select><input type="number" id="i_${p}W_${i}" class="smart-inp" oninput="calcGen('${p}')"></div><input type="number" id="${p}L_${i}" class="u-inp" placeholder="–∫–≥" oninput="calcGen('${p}')"><button class="del-row-btn" onclick="document.getElementById('${p}row_${i}').remove();calcGen('${p}')">‚úï</button></div>`;let c=p+'RowsDV';if(s==='Semi')c=p+'RowsSemi';if(s==='Feed')c=p+'RowsFeed';gID(c).insertAdjacentHTML('beforeend',h)}
function calcGen(p){let t=0;const c=i=>{const r=gID(i).children;for(let w of r){const k=w.id.split('_')[1],q=parseFloat(gID(`${p}Q_${k}`).value)||0;let wg=parseFloat(gID(`i_${p}W_${k}`).value);if(!wg)wg=parseFloat(gID(`s_${p}W_${k}`).value)||0;const l=parseFloat(gID(`${p}L_${k}`).value)||0;t+=(q*wg)+l}};c(p+'RowsDV');c(p+'RowsSemi');c(p+'RowsFeed');const aw=parseFloat(gID(p+'AddW').value)||0,r=t-aw;gID(p+'RawW').value=r>0?r.toFixed(1):0}
async function saveGen(t){const c=WS_CFG[t],p=c.prefix,b=gID('btnS');calcGen(p);const rn=getSmartVal(p+'RawItem'),rw=parseFloat(gID(p+'RawW').value)||0,an=getSmartVal(p+'AddItem'),aw=parseFloat(gID(p+'AddW').value)||0,dv=gID(p+'D').value+"T12:00:00Z",ts=new Date().toISOString(),op=getSmartVal(p+'Op'),as=getSmartVal(p+'As'),tS=getSmartVal(p+'TS'),tE=getSmartVal(p+'TE');if(!rn||rw<=0)return alert('–ü–æ–º–∏–ª–∫–∞ —Å–∏—Ä–æ–≤–∏–Ω–∏');const its=[];let tp=0;
const h=(id,st)=>{const rs=gID(id).children;for(let r of rs){const k=r.id.split('_')[1];let n=getSmartVal(`${p}N_${k}`);if(!n)continue;let q=parseFloat(gID(`${p}Q_${k}`).value)||0,wg=parseFloat(gID(`i_${p}W_${k}`).value);if(!wg)wg=parseFloat(gID(`s_${p}W_${k}`).value)||0;let l=parseFloat(gID(`${p}L_${k}`).value)||0;if(q>0||l>0){its.push({n,q,w:wg,l,type:st});tp+=(q*wg)+l}}};h(p+'RowsDV','DV');h(p+'RowsSemi','Semi');h(p+'RowsFeed','Feed');if(its.length===0)return alert('–î–æ–¥–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ü—ñ—é');let rd=`${rn} (${rw}–∫–≥)`;if(an&&aw>0)rd+=` + ${an} (${aw}–∫–≥)`;
let confirmHtml=`<div style="font-weight:bold;margin-bottom:5px">${c.title} (${fd2(dv)})</div><div><b>–°–∏—Ä–æ–≤–∏–Ω–∞:</b> ${rd}</div><div style="margin:5px 0;border-bottom:1px dashed #ccc"></div><b>–ü—Ä–æ–¥—É–∫—Ü—ñ—è:</b><br>`;its.forEach(i=>confirmHtml+=`- ${i.n} (${i.q}–º √ó ${i.w}–∫–≥) ${i.l?'+ '+i.l+'–∫–≥':''}<br>`);
askConfirm(confirmHtml,async()=>{
let tb=0,b25=0,lm={};its.forEach(i=>{if(i.w!==40)tb+=i.q;if(i.w===25){let nl=i.n.toLowerCase();if(!nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞ 3')){let ln=null;if(nl.includes('–∞—Ä–Ω–∞—É—Ç–∫–∞'))ln='–ï—Ç-–∫–∞ –ê—Ä–Ω–∞—É—Ç–∫–∞';else if(nl.includes('—è—á–∫–∞'))ln='–ï—Ç-–∫–∞ –Ø—á–∫–∞';else if(nl.includes('–ø—à–µ–Ω–∏—á–∫–∞'))ln='–ï—Ç-–∫–∞ –ü—à–µ–Ω–∏—á–∫–∞';else if(nl.includes('–ø–µ—Ä–ª–æ–≤–∫–∞'))ln='–ï—Ç-–∫–∞ –ü–µ—Ä–ª–æ–≤–∫–∞';else if(nl.includes('–≥–æ—Ä–æ—Ö'))ln='–ï—Ç-–∫–∞ –ì–æ—Ä–æ—Ö';else if(nl.includes('–ø—à–æ–Ω–æ'))ln='–ï—Ç-–∫–∞ –ü—à–æ–Ω–æ';else if(nl.includes('–∫—É–∫—É—Ä—É–∑–∞'))ln='–ï—Ç-–∫–∞ –ö—É–∫—É—Ä—É–∑–∞';if(ln){b25+=i.q;lm[ln]=(lm[ln]||0)+i.q}}}});let th=tb/600;
const consumed = [];
if(b25>0) consumed.push({n: '–ú–µ—à–∫–∏', q: b25});
if(th>0) consumed.push({n: '–ù–∏—Ç–∫–∏', q: parseFloat(th.toFixed(1))});
Object.keys(lm).forEach(l => consumed.push({n: l, q: lm[l]}));
try{const rid=db.child(c.db).push().key,u={},rwh=gID(p+'WH').value;u[`/${rwh}/${db.child(rwh).push().key}`]={name:rn,amount:-rw,date:dv,ts:ts,note:c.note+' –û—Å–Ω–æ–≤–∞',fLink:rid};if(an&&aw>0){let awh=gID(p+'AddWH').value;u[`/${awh}/${db.child(awh).push().key}`]={name:an,amount:-aw,date:dv,ts:ts,note:c.note+' –î–æ–±–∞–≤–∫–∞',fLink:rid}}its.forEach(i=>{let dst='Stock_DV',nt=c.note,fn=i.n;if(i.type==='DV'){dst='Stock_DV';let cn=i.n.replace(/\s\[.*?\]/g,'').trim();fn=(i.q>0?`${cn} [${i.w}–∫–≥]`:cn)}else if(i.type==='Semi'){dst='Stock_Semi';nt=c.note+' –ü/–§'}else if(i.type==='Feed'){dst='Stock_Feed';nt=c.note+' –í—ñ–¥—Ö–æ–¥–∏'}let am=(i.q*i.w)+i.l;u[`/${dst}/${db.child(dst).push().key}`]={name:fn,amount:am,date:dv,ts:ts,note:nt,fLink:rid}});if(b25>0)u['/–ú–µ—à–∫–∏/'+db.child('–ú–µ—à–∫–∏').push().key]={name:'–ú–µ—à–∫–∏',amount:-b25,date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid};if(th>0)u['/–ù–∏—Ç–∫–∏/'+db.child('–ù–∏—Ç–∫–∏').push().key]={name:'–ù–∏—Ç–∫–∏',amount:-th,date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid};Object.keys(lm).forEach(l=>{u['/–≠—Ç–∏–∫–µ—Ç–∫–∞/'+db.child('–≠—Ç–∏–∫–µ—Ç–∫–∞').push().key]={name:l,amount:-lm[l],date:dv,ts:ts,note:`(–∞–≤—Ç–æ) ${c.title}`,fLink:rid}});u[`/${c.db}/${rid}`]={date:dv,ts:ts,link:rid,items:its,rawMix:rd,timeStart:tS,timeEnd:tE,operator:op,assistant:as,type:t,consumed:consumed};await db.update(u);closeModal()}catch(e){alert(e);b.disabled=!1}})}
async function sCorr(){const b=gID('btnS'),d=gID('cD').value,a=parseFloat(gID('cA').value),r=gID('cR').value,c=corrCtx.cat,n=corrCtx.name;if(!a||!r)return;
askConfirm(`–ö–û–†–ï–ö–¶–Ü–Ø –ó–ê–õ–ò–®–ö–£\n–¢–æ–≤–∞—Ä: ${n}\n–ó–º—ñ–Ω–∞: ${a}–∫–≥/—à—Ç\n–ü—Ä–∏—á–∏–Ω–∞: ${r}`,async()=>{
try{const k=db.child(c).push().key,u={};u[`/${c}/${k}`]={name:n,amount:a,date:d+"T12:00:00Z",ts:new Date().toISOString(),note:'–ö–æ—Ä–µ–∫—Ü—ñ—è: '+r};await db.update(u);closeModal()}catch(e){alert(e)}})}
async function sFas(){const b=gID('btnS'),d=gID('fD').value,ri=[],oi=[];let tp=0,tv=0;const rr=gID('fasRows').children;for(let r of rr){const k=r.id.split('_')[1],s=gID('src_'+k).value,n=gID('nm_'+k).value,q=parseFloat(gID('qty_'+k).value);if(n&&q>0){ri.push({name:n,amount:q,source:s});tp+=q}}const ro=gID('fasOutRows').children;for(let r of ro){const k=r.id.split('_')[1],n=gID('outN_'+k).value,s=gID('outS_'+k).value,q=parseFloat(gID('outQ_'+k).value);if(n&&q>0){oi.push({name:n,size:s,count:q});tv+=q}}if(ri.length===0||oi.length===0)return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è");let fn=oi[0].name;if(fn==="–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 1"||fn==="–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 2")fn="–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9";const os=parseFloat(gID('fOs').value)||0,vz=gID('fVz').value,vt=vz.split('+').reduce((acc,v)=>{let n=parseFloat(v.replace(',','.').trim());return acc+(isNaN(n)?0:n)},0);
let h=`<div style="font-weight:bold">–§–ê–°–£–í–ê–ù–ù–Ø (${fd2(d)})</div><b>–°–∏—Ä–æ–≤–∏–Ω–∞:</b><br>`;ri.forEach(i=>h+=`- ${i.name}: ${i.amount}–∫–≥<br>`);h+=`<b>–í–∏—Ö—ñ–¥:</b><br>`;oi.forEach(i=>h+=`- ${i.name} (${i.size}): ${i.count}—à—Ç<br>`);h+=`<b>–ü–ª—ñ–≤–∫–∞:</b> ${vt}–∫–≥ (–ó–∞–ª: ${os})`;
askConfirm(h,async()=>{
try{const pu=Math.abs(vt-os),su=parseFloat(((tv*.12)/360).toFixed(1)),fid=db.child('–§–∞—Å–æ–≤–∫–∞').push().key,ts=new Date().toISOString(),dv=d+"T12:00:00Z",u={},rs=ri.map(i=>`${i.name}`).join(' + ');u['/–§–∞—Å–æ–≤–∫–∞/'+fid]={date:dv,prihod:tp,items:ri,outputItems:oi,rawItem:rs,vzial:vt,ostatok:os,scotch:su,link:fid,ts:ts,filmName:fn};ri.forEach(i=>{u[`/${i.source}/`+db.child(i.source).push().key]={name:i.name,amount:-i.amount,date:dv,note:'–§–∞—Å—É–≤–∞–Ω–Ω—è (–°–∏—Ä–æ–≤–∏–Ω–∞)',fLink:fid,ts:ts}});oi.forEach(i=>{u['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:i.name,amount:i.count,date:dv,note:'–§–∞—Å—É–≤–∞–Ω–Ω—è',fLink:fid,ts:ts};const k=(i.name==="–ö—É—Ç—è")?19.8:9.9,sp=-Math.round(i.count/k);u['/–ü–∞–∫–µ—Ç—ã/'+db.child('–ü–∞–∫–µ—Ç—ã').push().key]={name:i.size,amount:sp,date:dv,note:`(–∞–≤—Ç–æ) ${i.name}`,fLink:fid,ts:ts}});u['/–ü–ª–µ–Ω–∫–∞/'+db.child('–ü–ª–µ–Ω–∫–∞').push().key]={name:fn,amount:-pu,date:dv,note:'(–∞–≤—Ç–æ) –§–∞—Å—É–≤–∞–Ω–Ω—è',fLink:fid,ts:ts};u['/–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º/'+db.child('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º').push().key]={name:'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º',amount:-su,date:dv,note:'(–∞–≤—Ç–æ) –§–∞—Å—É–≤–∞–Ω–Ω—è',fLink:fid,ts:ts};const tr=parseFloat((tv/34000).toFixed(2));if(tr>0)u['/–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞/'+db.child('–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞').push().key]={name:'–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞',amount:-tr,date:dv,note:'(–∞–≤—Ç–æ) –§–∞—Å—É–≤–∞–Ω–Ω—è',fLink:fid,ts:ts};await db.update(u);closeModal()}catch(e){alert(e)}})}
function loadBulk(c){document.querySelectorAll('.bulk-q').forEach(i=>{const n=i.getAttribute('data-n'),ct=i.getAttribute('data-cat'),v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const bs=document.querySelectorAll('#shipBtns button');bs.forEach(b=>{let t=b.innerText,a=!1;if(c==='–ì–æ—Ç–æ–≤–∞—è'&&t.includes('–§–ê–°–û–í–ö–ê'))a=!0;if(c==='WeightStock'&&t.includes('–ö–£–ü–û–í–ê–ù–ê'))a=!0;if(c==='Stock_DV'&&t.includes('–î–í'))a=!0;if(c==='Stock_Feed'&&t.includes('–ö–û–†–ú–ê'))a=!0;if(a){b.style.background='#eef2ff';b.style.borderColor='var(--p)'}else{b.style.background='#fff';b.style.borderColor='#ccc'}});const s={};Object.values(data[c]||{}).forEach(v=>{if(v)s[v.name]=(s[v.name]||0)+v.amount});let h=`<div class="item-grid" style="grid-template-columns:repeat(3,1fr)">`;Object.keys(s).sort().forEach(n=>{const v=s[n];if(v>0){const k=n+'::'+c,sv=shipBasket[k]?shipBasket[k].w:'';h+=`<div class="item-card" style="padding:5px"><div class="item-title" style="height:20px">${n}</div><div style="font-size:10px;color:#888;margin-bottom:2px">–ó–∞–ª: ${Math.round(v)}</div><input type="number" class="bulk-q" data-n="${n}" data-cat="${c}" placeholder="0" style="width:100%" value="${sv}"></div>`}});gID('shpR').innerHTML=h+`</div>`}
async function sShip(){
  const d=gID('hD').value, nm=gID('hNum').value, ag=gID('hAg').value, dv=d+"T12:00:00Z";
  const sc=gID('s_hC'), c=(sc&&sc.value==='NEW')?gID('i_hC').value:(sc?sc.value:'');
  const sf=gID('s_hMyFop'), myFop=(sf&&sf.value==='NEW')?gID('i_hMyFop').value:(sf?sf.value:'');
  if(!c)return alert('–û–±–µ—Ä—ñ—Ç—å –æ—Ç—Ä–∏–º—É–≤–∞—á–∞!');
  document.querySelectorAll('.bulk-q').forEach(i=>{const n=i.getAttribute('data-n'),ct=i.getAttribute('data-cat'),v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});
  const it=[];let tw=0;Object.values(shipBasket).forEach(v=>{it.push({n:v.n,w:v.w,c:v.c});tw+=v.w});if(!it.length)return alert('–ü–æ—Ä–æ–∂–Ω—å–æ');
  let h=`<div id="shipPrev"><div style="font-weight:bold;text-transform:uppercase;margin-bottom:5px;text-align:center;font-size:14px">–í–ò–î–ê–¢–ö–û–í–ê –ù–ê–ö–õ–ê–î–ù–ê ‚Ññ ${nm||'___'}</div><div style="margin-bottom:10px;font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px"><div style="background:#f8fafc;padding:5px;border:1px solid #eee"><b>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:</b><br>${myFop||'-'}</div><div style="background:#f8fafc;padding:5px;border:1px solid #eee"><b>–û—Ç—Ä–∏–º—É–≤–∞—á:</b><br>${c}</div></div>`;
  if(ag)h+=`<div style="font-size:12px;margin-bottom:10px;text-align:center"><b>–£–≥–æ–¥–∞:</b> ${ag}</div>`;
  h+=`<table style="width:100%;font-size:11px;border-collapse:collapse;margin-bottom:10px;border:1px solid #ccc"><tr style="background:#eee;font-weight:bold;text-align:center"><td style="border:1px solid #ccc;padding:2px">‚Ññ</td><td style="border:1px solid #ccc;padding:2px">–¢–æ–≤–∞—Ä</td><td style="border:1px solid #ccc;padding:2px">–ö-—Ç—å</td><td style="border:1px solid #ccc;padding:2px">–û–¥</td></tr>`;
  it.forEach((x,idx)=>{h+=`<tr><td style="border:1px solid #ccc;padding:2px;text-align:center">${idx+1}</td><td style="border:1px solid #ccc;padding:2px">${x.n}</td><td style="border:1px solid #ccc;padding:2px;text-align:center;font-weight:bold">${x.w}</td><td style="border:1px solid #ccc;padding:2px;text-align:center">${x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'}</td></tr>`});
  h+=`</tbody></table><div style="margin-top:10px;text-align:right;font-weight:900;font-size:14px">–í—Å—å–æ–≥–æ: ${d.tw}</div><div style="margin-top:30px;display:flex;justify-content:space-between;font-size:12px"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: ________________</div><div>–û—Ç—Ä–∏–º–∞–≤: ________________</div></div>`;
  gID('print-view').innerHTML=h; 
  printPage('invoice');
}
async function execShip(doPrint){
  const dObj=window.tempShipData; if(!dObj)return; const{it,c,nm,dv,myFop,tw,ag}=dObj;
  const btns=document.querySelectorAll('#shipPrev button'); btns.forEach(b=>{b.disabled=!0;b.innerText='...'});
  try{
    const lk=db.child('ArchInvoices').push().key,u={};
    u['/ArchInvoices/'+lk]={date:dv,client:c,num:nm,agreement:ag,items:it.map(x=>x.n+"|"+x.w+"|"+(x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥')+"|"+x.c),supplierName:myFop,ts:new Date().toISOString()};
    it.forEach(i=>{u[`/${i.c}/${db.child(i.c).push().key}`]={name:i.n,amount:-i.w,date:dv,note:`–û—Ç–≥—Ä: ${c} ‚Ññ${nm}`,fLink:lk,ts:new Date().toISOString()}});
    if(useStretch){const q=parseFloat((tw/5000).toFixed(2));if(q>0)u['/–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞/'+db.child('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞').push().key]={name:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',amount:-q,date:dv,note:`(–∞–≤—Ç–æ) –í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ${c}`,fLink:lk,ts:new Date().toISOString()}}
    if(myFop&&myFop!=='–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö'){let fopExists=!1;if(data.Suppliers)Object.values(data.Suppliers).forEach(v=>{if(v.name===myFop)fopExists=!0});if(!fopExists)u['/Suppliers/'+db.child('Suppliers').push().key]={name:myFop}}
    await db.update(u);
    if(doPrint){
      printShipInvoice(dObj,lk);
    } else {
      closeModal();
      alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
    }
    document.querySelectorAll('.bulk-q').forEach(i=>i.value=''); window.shipBasket={};
  }catch(e){alert("–ü–æ–º–∏–ª–∫–∞: "+e);btns.forEach(b=>b.disabled=!1)}
}
function printShipInvoice(d,id){
  const ms=['–°—ñ—á–Ω—è','–õ—é—Ç–æ–≥–æ','–ë–µ—Ä–µ–∑–Ω—è','–ö–≤—ñ—Ç–Ω—è','–¢—Ä–∞–≤–Ω—è','–ß–µ—Ä–≤–Ω—è','–õ–∏–ø–Ω—è','–°–µ—Ä–ø–Ω—è','–í–µ—Ä–µ—Å–Ω—è','–ñ–æ–≤—Ç–Ω—è','–õ–∏—Å—Ç–æ–ø–∞–¥–∞','–ì—Ä—É–¥–Ω—è'],dt=new Date(d.dv),day=dt.getDate(),m=ms[dt.getMonth()],y=dt.getFullYear();
  let h=`<div style="font-weight:900;text-align:center;font-size:16px;margin-bottom:5px">–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ ${d.nm||'___'} –≤—ñ–¥ ${day} ${m} ${y} —Ä</div>`;
  if(d.ag)h+=`<div style="text-align:center;font-size:12px;margin-bottom:5px">–£–≥–æ–¥–∞: ${d.ag}</div>`;
  h+=`<div style="border-bottom:1px dashed #000;margin-bottom:10px"></div><div style="margin-bottom:10px;font-size:12px;line-height:1.4;display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><b>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:</b><br>${d.myFop||'-'}</div><div><b>–û—Ç—Ä–∏–º—É–≤–∞—á:</b><br>${d.c}</div></div><table id="inv-table"><thead><tr><th style="width:20px">‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th style="width:50px">–ö-—Ç—å</th><th style="width:30px">–û–¥</th></tr></thead><tbody>`;
  d.it.forEach((x,idx)=>{h+=`<tr><td>${idx+1}</td><td class="l">${x.n}</td><td>${x.w}</td><td>${x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'}</td></tr>`});
  h+=`</tbody></table><div style="margin-top:10px;text-align:right;font-weight:900;font-size:14px">–í—Å—å–æ–≥–æ: ${d.tw}</div><div style="margin-top:30px;display:flex;justify-content:space-between;font-size:12px"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: ________________</div><div>–û—Ç—Ä–∏–º–∞–≤: ________________</div></div>`;
  gID('print-view').innerHTML=h; 
  printPage('invoice');
}
async function sInc(){const ss=gID('s_iS'),s=(ss.value==='NEW')?gID('i_iS').value:ss.value,sn=gID('s_iN'),n=(sn.value==='NEW')?gID('i_iN').value:sn.value,a=parseFloat(gID('iA').value),nm=gID('iNum').value;if(!a)return;
askConfirm(`–ü–†–ò–•–Ü–î –¢–û–í–ê–†–£ (–ö–£–ü–û–í–ê–ù–ê)\n–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: ${s}\n–¢–æ–≤–∞—Ä: ${n}\n–í–∞–≥–∞: ${a} –∫–≥\n–ù–∞–∫–ª: ${nm}`,async()=>{
const d=gID('iD').value+"T12:00:00Z",l=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+l]={date:d,supplier:s,name:n,amount:a,num:nm,ts:new Date().toISOString(),type:'GOODS'};u['/WeightStock/'+db.child('WeightStock').push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö—ñ–¥ '+s+(nm?' ‚Ññ'+nm:''),fLink:l,ts:new Date().toISOString()};await db.update(u);closeModal()})}
async function sPack(){const ss=gID('s_pS'),s=(ss.value==='NEW')?gID('i_pS').value:ss.value,sn=gID('s_pN'),si=gID('i_pN');let n='';if(sn&&sn.style.display!=='none')n=sn.value;else if(si&&si.style.display!=='none')n=si.value;if(n==='NEW'||n==='NEW_ENTRY')n=si.value;const a=parseFloat(gID('pA').value),nm=gID('pNum').value;if(!n||!a)return;const c=gID('pCat').value;
askConfirm(`–ü–†–ò–•–Ü–î –ü–ê–ö–£–í–ê–ù–ù–Ø\n–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${c}\n–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: ${s}\n–¢–æ–≤–∞—Ä: ${n}\n–ö—ñ–ª-—Å—Ç—å: ${a}\n–ù–∞–∫–ª: ${nm}`,async()=>{
const d=gID('pD').value+"T12:00:00Z",l=db.child('ArchPackIn').push().key,u={};u['/ArchPackIn/'+l]={date:d,supplier:s,name:n,amount:a,num:nm,category:c,ts:new Date().toISOString()};u[`/${c}/`+db.child(c).push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö—ñ–¥ '+s,fLink:l,ts:new Date().toISOString()};await db.update(u);closeModal()})}
async function sRawInc(){const ss=gID('s_rSupp'),s=(ss.value==='NEW')?gID('i_rSupp').value:ss.value,sn=gID('s_rN'),n=(sn.value==='NEW')?gID('i_rN').value:sn.value,a=parseFloat(gID('rA').value);if(!a)return;
askConfirm(`–ü–†–ò–•–Ü–î –°–ò–†–û–í–ò–ù–ò\n–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: ${s}\n–°–∏—Ä–æ–≤–∏–Ω–∞: ${n}\n–í–∞–≥–∞: ${a} –∫–≥`,async()=>{
const d=gID('rD').value+"T12:00:00Z",ts=new Date().toISOString(),l=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+l]={date:d,supplier:s,name:n,amount:a,ts:ts,type:'RAW'};u['/Stock_Raw/'+db.child('Stock_Raw').push().key]={name:`${n} [${s}]`,amount:a,date:d,note:'–í—Ö '+s,fLink:l,ts:ts};await db.update(u);closeModal()})}
async function delItemBatch(n,c){askConfirm(`–í–ò–î–ê–õ–ò–¢–ò –ö–ê–†–¢–ö–£ –¢–û–í–ê–†–£?\n–¢–æ–≤–∞—Ä: ${n}\n–°–∫–ª–∞–¥: ${c}\n–£–í–ê–ì–ê: –í–∏–¥–∞–ª–∏—Ç—å—Å—è –≤—Å—è —ñ—Å—Ç–æ—Ä—ñ—è —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É!`,async()=>{const u={};if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.name===n)u[`/${c}/${k}`]=null});await db.update(u);closeModal()})}
async function renameItem(o,c){const n=prompt('–ù–æ–≤–µ —ñ–º\'—è:',o);if(!n||n===o)return;const u={};if(data[c])Object.entries(data[c]).forEach(([k,v])=>{if(v.name===o)u[`/${c}/${k}/name`]=n});await db.update(u);closeModal()}
async function runCloseMonth(){const d=gID('cmDate').value;if(!d)return alert('–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É!');if(!confirm(`–ó–ê–ö–†–ò–¢–ò –ú–Ü–°–Ø–¶–¨ ${d}?\n\n–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—à–µ –∑–∞–ª–∏—à–æ–∫ –Ω–∞ —Ü–µ–π –¥–µ–Ω—å (—ñ–≥–Ω–æ—Ä—É—é—á–∏ –º–∞–π–±—É—Ç–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó).\n\n–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?`))return;const b=gID('btnCM');b.disabled=!0;b.innerText="‚è≥ –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø...";const tsEnd=d+"T23:59:59.000Z";let nd=new Date(d);nd.setDate(nd.getDate()+1);const y=nd.getFullYear(),m=String(nd.getMonth()+1).padStart(2,'0'),day=String(nd.getDate()).padStart(2,'0'),tsStart=`${y}-${m}-${day}T09:00:00.000Z`;const u={};let count=0;stockCatsAll.forEach(c=>{if(!data[c])return;const stock={};Object.values(data[c]).forEach(v=>{if(v.name&&v.date<tsStart)stock[v.name]=(stock[v.name]||0)+v.amount});Object.keys(stock).forEach(n=>{const bal=stock[n];let valText=Math.round(bal),unit='–∫–≥';if(['–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ì–æ—Ç–æ–≤–∞—è'].includes(c))unit='—à—Ç';if(c==='–ü–ª–µ–Ω–∫–∞')valText=bal.toFixed(2);if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')valText=bal.toFixed(1);if(Math.abs(bal)>0.01){const k1=db.child(c).push().key;u[`/${c}/${k1}`]={name:n,amount:0,date:tsEnd,ts:tsEnd,note:`üèÅ –ó–∞–ª–∏—à–æ–∫ –Ω–∞ –∫—ñ–Ω–µ—Ü—å –º—ñ—Å—è—Ü—è: ${valText} ${unit}`,isFix:!1};const k2=db.child(c).push().key;u[`/${c}/${k2}`]={name:n,amount:0,date:tsStart,ts:tsStart,note:`üöÄ –ó–∞–ª–∏—à–æ–∫ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –º—ñ—Å—è—Ü—è: ${valText} ${unit}`,isFix:!1};count++}})});try{await db.update(u);alert(`–ì–æ—Ç–æ–≤–æ! –°—Ç–≤–æ—Ä–µ–Ω–æ ${count*2} –∑–∞–ø–∏—Å—ñ–≤.`);closeModal()}catch(e){alert("–ü–æ–º–∏–ª–∫–∞: "+e);b.disabled=!1;b.innerText="‚úÖ –ó–ê–ü–ò–°–ê–¢–ò –ó–ê–õ–ò–®–ö–ò"}}
async function checkAutoClose(){const now=new Date(),currentMonthKey=now.getFullYear()+"-"+(now.getMonth()+1);if(data.System_Settings&&data.System_Settings.lastClosedMonth===currentMonthKey)return;const u={};let count=0;const lastDayOfPrevMonth=new Date(now.getFullYear(),now.getMonth(),0);const tsEnd=lastDayOfPrevMonth.getFullYear()+'-'+String(lastDayOfPrevMonth.getMonth()+1).padStart(2,'0')+'-'+String(lastDayOfPrevMonth.getDate()).padStart(2,'0')+'T23:59:59.000Z';const tsStart=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-01T09:00:00.000Z';stockCatsAll.forEach(c=>{if(!data[c])return;const stock={};Object.values(data[c]).forEach(v=>{if(v.name&&v.date<tsStart)stock[v.name]=(stock[v.name]||0)+v.amount});Object.keys(stock).forEach(n=>{const bal=stock[n];if(Math.abs(bal)>0.01){let valText=Math.round(bal),unit='–∫–≥';if(['–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ì–æ—Ç–æ–≤–∞—è'].includes(c))unit='—à—Ç';if(c==='–ü–ª–µ–Ω–∫–∞')valText=bal.toFixed(2);if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')valText=bal.toFixed(1);const k1=db.child(c).push().key;u[`/${c}/${k1}`]={name:n,amount:0,date:tsEnd,ts:tsEnd,note:`üèÅ –ó–∞–ª–∏—à–æ–∫ –Ω–∞ –∫—ñ–Ω–µ—Ü—å –º—ñ—Å—è—Ü—è: ${valText} ${unit}`,isFix:!1};const k2=db.child(c).push().key;u[`/${c}/${k2}`]={name:n,amount:0,date:tsStart,ts:tsStart,note:`üöÄ –ó–∞–ª–∏—à–æ–∫ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –º—ñ—Å—è—Ü—è: ${valText} ${unit}`,isFix:!1};count++}})});u['/System_Settings/lastClosedMonth']=currentMonthKey;if(count>0){try{await db.update(u);console.log("–ú—ñ—Å—è—Ü—å –∑–∞–∫—Ä–∏—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°—Ç–≤–æ—Ä–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: "+count*2)}catch(e){console.error("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è: "+e)}}else{db.child('System_Settings').update({lastClosedMonth:currentMonthKey})}}
window.genMonthReport=function(){const btn=document.querySelector('button[onclick="genMonthReport()"]');if(btn)btn.innerText="‚è≥ –†–ê–•–£–Æ...";setTimeout(()=>{try{const m=gID('repMth').value;if(!m){if(btn)btn.innerText="üìä –ü–û–ö–ê–ó–ê–¢–ò –ó–í–Ü–¢";return alert('–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å!')}const[y,mt]=m.split('-');const startDate=`${y}-${mt}-01T00:00:00`;const endDate=new Date(y,mt,0).toISOString().split('T')[0]+'T23:59:59';const reportData={};stockCatsAll.forEach(c=>{if(!data[c])return;Object.values(data[c]).forEach(v=>{if(!v||!v.name)return;if(!reportData[c])reportData[c]={};if(!reportData[c][v.name]){reportData[c][v.name]={s:0,i:0,o:0,u:'–∫–≥',d:0};if(['–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ì–æ—Ç–æ–≤–∞—è'].includes(c)){reportData[c][v.name].u='—à—Ç';reportData[c][v.name].d=0}if(c==='–ü–ª–µ–Ω–∫–∞')reportData[c][v.name].d=2;if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')reportData[c][v.name].d=1}const amt=parseFloat(v.amount)||0;const date=v.date||'';if(date<startDate)reportData[c][v.name].s+=amt;else if(date<=endDate){if(amt>0)reportData[c][v.name].i+=amt;else reportData[c][v.name].o+=Math.abs(amt)}})});let monthName=mths[parseInt(mt)-1]||mt;
const buildTable=(cats)=>{let t=`<table style="width:100%;border-collapse:collapse;font-size:10px;color:#000;margin-bottom:20px"><thead style="background:#f1f5f9;"><tr><th style="border:1px solid #000;padding:2px;width:40%">–ù–ê–ô–ú–ï–ù–£–í–ê–ù–ù–Ø</th><th style="border:1px solid #000;padding:2px;">–ü–û–ß</th><th style="border:1px solid #000;padding:2px;">–ü–†–ò–•</th><th style="border:1px solid #000;padding:2px;">–í–ò–¢–†</th><th style="border:1px solid #000;padding:2px;">–ö–Ü–ù</th></tr></thead><tbody>`;cats.forEach(cat=>{if(reportData[cat]){const items=reportData[cat];const itemKeys=Object.keys(items).sort();let catHasData=!1;itemKeys.forEach(n=>{const i=items[n];if(Math.abs(i.s)>0.01||i.i>0.01||i.o>0.01)catHasData=!0});if(catHasData){const catTitle=CAT_MAP[cat]||cat.toUpperCase();t+=`<tr><td colspan="5" style="background:#eef2ff;font-weight:900;text-align:center;border:1px solid #000;padding:2px;font-size:10px">${catTitle}</td></tr>`;itemKeys.forEach(n=>{const i=items[n];const end=i.s+i.i-i.o;if(Math.abs(i.s)>0.01||i.i>0.01||i.o>0.01){t+=`<tr><td style="border:1px solid #000;padding:1px 3px;font-weight:700;text-align:left;white-space:nowrap;overflow:hidden">${n}</td><td style="border:1px solid #000;padding:1px 3px;text-align:center;white-space:nowrap">${i.s.toFixed(i.d)}</td><td style="border:1px solid #000;padding:1px 3px;text-align:center;white-space:nowrap">${i.i>0?i.i.toFixed(i.d):'-'}</td><td style="border:1px solid #000;padding:1px 3px;text-align:center;white-space:nowrap">${i.o>0?i.o.toFixed(i.d):'-'}</td><td style="border:1px solid #000;padding:1px 3px;text-align:center;font-weight:900;background:#f8fafc;white-space:nowrap">${end.toFixed(i.d)}</td></tr>`}})}}});return t+`</tbody></table>`};
let h=`<div style="font-weight:900;text-align:center;font-size:14px;margin-bottom:5px;text-transform:uppercase;color:#000">–ó–í–Ü–¢: ${monthName} ${y} (–ê—Ä–∫—É—à 1)</div>`;h+=buildTable(['–ì–æ—Ç–æ–≤–∞—è','WeightStock','Stock_DV','Stock_Feed','Stock_Semi','Stock_Raw']);h+=`<div class="page-break"></div><div style="font-weight:900;text-align:center;font-size:14px;margin-bottom:5px;text-transform:uppercase;color:#000">–ó–í–Ü–¢: ${monthName} ${y} (–ê—Ä–∫—É—à 2)</div>`;h+=buildTable(['–ü–ª–µ–Ω–∫–∞','–ü–∞–∫–µ—Ç—ã','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–ù–∏—Ç–∫–∏','–ú–µ—à–∫–∏','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','–≠—Ç–∏–∫–µ—Ç–∫–∞']);
let btns=`<div style="margin-top:15px;text-align:center;display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="closeModal()" style="background:#fff;color:#333;border:1px solid #ccc">–ó–ê–ö–†–ò–¢–ò</button><button class="btn-main" onclick="printPage('modal')" style="background:#0f172a;">üñ®Ô∏è –î–†–£–ö</button></div>`;gID('mB').innerHTML=h+btns;gID('print-view').innerHTML=h;gID('mT').innerText='–†–ï–ó–£–õ–¨–¢–ê–¢'}catch(e){alert("–ü–û–ú–ò–õ–ö–ê –†–û–ó–†–ê–•–£–ù–ö–£: "+e.message)}finally{if(btn)btn.innerText="üìä –ü–û–ö–ê–ó–ê–¢–ò –ó–í–Ü–¢"}},50)};
function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('–ì–æ—Ç–æ–≤–∞—è','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','–ì–æ—Ç–æ–≤–∞—è','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('WeightStock','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','WeightStock','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rRaw(c){const t={};if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty ${t[n]>=0?'val-pos':'val-neg'}">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('Stock_Raw','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','Stock_Raw','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rGen(c){const d=data[cur]||{},t={};Object.values(d).forEach(v=>{let k=v.name;if(k)t[k]=(t[k]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const val=t[k];let alarm=val<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&val<50)alarm=!0;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&val<30)alarm=!0;if(cur==='–ü–∞–∫–µ—Ç—ã'&&val<3000)alarm=!0;if(cur==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'&&val<5)alarm=!0;if(cur==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'&&val<5)alarm=!0;let u='–∫–≥',dv=Math.round(val);if(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(cur))u='—à—Ç';if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')dv=val.toFixed(1);if(cur==='–ü–ª–µ–Ω–∫–∞'){dv=val.toFixed(2);u='–∫–≥'}if(cur==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞'){dv=val.toFixed(2);u='—à—Ç'}h+=`<div class="item-card ${alarm?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty ${val>=0?'val-pos':'val-neg'}">${dv} <small style="font-size:10px">${u}</small></div><button class="history-btn" onclick="showH('${cur}','${k}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}','${k}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rFas(c){const d=data.–§–∞—Å–æ–≤–∫–∞||{};let h='';Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date)).forEach(([k,v])=>{
let filmUsed=(parseFloat(v.vzial)||0)-(parseFloat(v.ostatok)||0),packsUsed=0,packName="–ü–∞–∫–µ—Ç–∏";
if(v.outputItems)v.outputItems.forEach(i=>{let k_val=(i.name==="–ö—É—Ç—è")?19.8:9.9;packsUsed+=Math.round(i.count/k_val);if(i.size)packName="–ü–∞–∫–µ—Ç–∏: "+i.size});
h+=`<div class="rep-card"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div style="font-weight:900;font-size:14px;color:#000;">${fd2(v.date)}</div><div style="font-weight:900;font-size:14px;color:#000;text-transform:uppercase">${v.filmName||'–§–ê–°–£–í–ê–ù–ù–Ø'}</div></div>${corrMode?`<button onclick="delFasFull('${k}')" style="border:none;background:none;color:red;font-size:16px;cursor:pointer">üóëÔ∏è</button>`:''}</div><div class="rep-sep"></div><div class="rep-sec-title">—Å–∏—Ä–æ–≤–∏–Ω–∞:</div>`;if(v.items)v.items.forEach(i=>{h+=`<div class="rep-row"><span class="rep-name">${i.name}</span><span class="val-red">-${i.amount}–∫–≥</span></div>`});else h+=`<div class="rep-row"><span class="rep-name">${v.rawItem}</span><span class="val-red">-${v.prihod}–∫–≥</span></div>`;h+=`<div class="rep-sep"></div><div class="rep-sec-title">–≥–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü—ñ—è:</div>`;if(v.outputItems)v.outputItems.forEach(i=>{h+=`<div class="rep-row"><span class="rep-name">${i.name}</span><span class="val-blue">+${i.count}—à—Ç</span></div>`});else h+=`<div class="rep-row"><span class="rep-name">${v.name}</span><span class="val-blue">+${v.vyhod}—à—Ç</span></div>`;
h+=`<div class="rep-sep"></div><div class="rep-sec-title">–≤–∏—Ç—Ä–∞—Ç–∞ –ø–∞–∫—É–≤–∞–Ω–Ω—è:</div><div class="rep-row"><span class="rep-name">${packName}</span><span class="val-red">-${packsUsed}—à—Ç</span></div><div class="rep-row"><span class="rep-name">–ü–ª—ñ–≤–∫–∞</span><span class="val-red">-${filmUsed.toFixed(2)}–∫–≥</span></div></div>`});c.innerHTML=h||'<div style="text-align:center;padding:20px;color:#999">–ü–æ—Ä–æ–∂–Ω—å–æ</div>'}
function rKrup(c){rWork(c,'Krup_Report','–ö—Ä—É–ø–æ—Ä—É—à–∫–∞')}
function rVibro(c){rWork(c,'Vibro_Report','–í—ñ–±—Ä–æ—Å—Ç—ñ–ª')}
function rZSHM(c){rWork(c,'ZSHM_Report','–ó–®–ú')}
function rWork(c,db,t){const d=data[db]||{};let h='';Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date)).forEach(([k,v])=>{let ts=v.timeStart||'??:??',te=v.timeEnd||'??:??',op=v.operator||'?',as=v.assistant||'-';h+=`<div class="rep-card"><div style="display:flex;justify-content:space-between"><div><div style="font-weight:900;font-size:14px;color:#000;">${t} [${fd2(v.date)}]</div><div style="font-size:10px;color:#666">üïí ${ts} ‚Äî ${te}</div><div style="font-size:10px;color:#666">üë§ ${op} / ${as}</div></div>${corrMode?`<button onclick="delWorkshopReportFull('${db}','${k}')" style="border:none;background:none;color:red;font-size:16px">üóëÔ∏è</button>`:''}</div><div class="rep-raw" style="font-size:11px;color:#444;margin-bottom:2px">${v.rawMix||'-'}</div><div class="rep-sep"></div>`;if(v.items)v.items.forEach(i=>{let add=i.l>0?` <span style="color:#f59e0b">+${i.l}–∫–≥</span>`:'';h+=`<div class="rep-row"><span class="rep-name">${i.n}</span><span class="val-blue">+${i.q}–º √ó ${i.w}–∫–≥${add}</span></div>`});if(v.consumed){h+=`<div class="rep-sep"></div>`;v.consumed.forEach(i=>{h+=`<div class="rep-row"><span class="rep-name">${i.n}</span><span style="font-weight:900;color:#000">${i.q}—à—Ç</span></div>`})}h+=`</div>`});c.innerHTML=h||'<div style="text-align:center;padding:20px;color:#999">–ü–æ—Ä–æ–∂–Ω—å–æ</div>'}
function rArchPack(c){const d=data.ArchPackIn||{};let h='';Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date)).forEach(([k,v])=>{h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–Ü–î –ü–ê–ö–£–í–ê–ù–ù–Ø</div><div class="j-sub">${fd2(v.date)}</div><div class="j-title">${v.supplier}</div><div class="j-body"><div>${v.name} ‚Äî <b>${v.amount}</b></div><div style="font-size:10px;color:#666">${v.category}</div></div>${corrMode?`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="delInvoiceFull('ArchPackIn','${k}')">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}</div>`});c.innerHTML=h||'<div style="text-align:center;padding:20px;color:#999">–ü–æ—Ä–æ–∂–Ω—å–æ</div>'}
function printPage(t){window.print()}
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ì–†–£–ó–ö–ò ---
async function sShip(){
  // 1. –°—á–∏—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
  const d=gID('hD').value, nm=gID('hNum').value, ag=gID('hAg').value, dv=d+"T12:00:00Z";
  const sc=gID('s_hC'), c=(sc&&sc.value==='NEW')?gID('i_hC').value:(sc?sc.value:'');
  const sf=gID('s_hMyFop'), myFop=(sf&&sf.value==='NEW')?gID('i_hMyFop').value:(sf?sf.value:'');
  
  if(!c)return alert('–û–±–µ—Ä—ñ—Ç—å –æ—Ç—Ä–∏–º—É–≤–∞—á–∞!');

  // 2. –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  document.querySelectorAll('.bulk-q').forEach(i=>{
      const n=i.getAttribute('data-n'),ct=i.getAttribute('data-cat'),v=parseFloat(i.value),k=n+'::'+ct;
      if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]
  });
  
  const it=[];let tw=0;
  Object.values(shipBasket).forEach(v=>{it.push({n:v.n,w:v.w,c:v.c});tw+=v.w});
  
  if(it.length===0)return alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π! –í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä–∏.');

  // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–∫–Ω–æ –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ì–û –ü–†–û–°–ú–û–¢–†–ê (–ü–ï–†–ï–í–Ü–†–ö–ê)
  let h=`<div id="shipPrev">
    <div style="font-weight:bold;text-transform:uppercase;margin-bottom:5px;text-align:center;font-size:14px;color:#000">–í–ò–î–ê–¢–ö–û–í–ê –ù–ê–ö–õ–ê–î–ù–ê ‚Ññ ${nm||'___'}</div>
    <div style="margin-bottom:10px;font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="background:#f8fafc;padding:5px;border:1px solid #eee"><b>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:</b><br>${myFop||'-'}</div>
        <div style="background:#f8fafc;padding:5px;border:1px solid #eee"><b>–û—Ç—Ä–∏–º—É–≤–∞—á:</b><br>${c}</div>
    </div>`;
  
  if(ag)h+=`<div style="font-size:12px;margin-bottom:10px;text-align:center"><b>–£–≥–æ–¥–∞:</b> ${ag}</div>`;
  
  h+=`<table style="width:100%;font-size:11px;border-collapse:collapse;margin-bottom:10px;border:1px solid #ccc">
    <tr style="background:#eee;font-weight:bold;text-align:center">
        <td style="border:1px solid #ccc;padding:2px">‚Ññ</td>
        <td style="border:1px solid #ccc;padding:2px">–¢–æ–≤–∞—Ä</td>
        <td style="border:1px solid #ccc;padding:2px">–ö-—Ç—å</td>
        <td style="border:1px solid #ccc;padding:2px">–û–¥</td>
    </tr>`;
  
  it.forEach((x,idx)=>{
      h+=`<tr>
        <td style="border:1px solid #ccc;padding:2px;text-align:center">${idx+1}</td>
        <td style="border:1px solid #ccc;padding:2px">${x.n}</td>
        <td style="border:1px solid #ccc;padding:2px;text-align:center;font-weight:bold">${x.w}</td>
        <td style="border:1px solid #ccc;padding:2px;text-align:center">${x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'}</td>
      </tr>`
  });
  
  h+=`</table>
  <div style="text-align:right;font-weight:900;font-size:14px;margin-top:10px">–í–°–¨–û–ì–û: ${tw}</div>
  
  <div style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <button class="btn-main" onclick="execShip(false)" style="background:#059669;border:1px solid #047857">üíæ –ü–†–û–°–¢–û –°–ü–ò–°–ê–¢–ò</button>
    <button class="btn-main" onclick="execShip(true)" style="background:#4338ca;border:1px solid #3730a3">üñ®Ô∏è –î–†–£–ö + –°–ü–ò–°–ê–¢–ò</button>
  </div>
  <button class="btn-main" onclick="openModal('ship')" style="background:#fff;color:#333;border:1px solid #ccc;margin-top:10px">üîô –ü–û–í–ï–†–ù–£–¢–ò–°–Ø</button>
  </div>`;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ execShip
  window.tempShipData={it,c,nm,dv,myFop,tw,ag}; 
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  gID('mB').innerHTML=h; 
  gID('mT').innerText='–ü–ï–†–ï–í–Ü–†–ö–ê'; 
  gID('mdl').style.display='flex';
}

async function execShip(doPrint){
  const dObj=window.tempShipData; if(!dObj)return; const{it,c,nm,dv,myFop,tw,ag}=dObj;
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
  const btns=document.querySelectorAll('#shipPrev button'); btns.forEach(b=>{b.disabled=!0;b.innerText='...'});

  try{
    const lk=db.child('ArchInvoices').push().key,u={};
    
    // –ó–∞–ø–∏—Å—å –≤ –∞—Ä—Ö–∏–≤ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö
    u['/ArchInvoices/'+lk]={date:dv,client:c,num:nm,agreement:ag,items:it.map(x=>x.n+"|"+x.w+"|"+(x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥')+"|"+x.c),supplierName:myFop,ts:new Date().toISOString()};
    
    // –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
    it.forEach(i=>{
        u[`/${i.c}/${db.child(i.c).push().key}`]={name:i.n,amount:-i.w,date:dv,note:`–û—Ç–≥—Ä: ${c} ‚Ññ${nm}`,fLink:lk,ts:new Date().toISOString()}
    });

    // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä–µ–π—á–∞ (–∞–≤—Ç–æ)
    if(useStretch){
        const q=parseFloat((tw/5000).toFixed(2));
        if(q>0)u['/–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞/'+db.child('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞').push().key]={name:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',amount:-q,date:dv,note:`(–∞–≤—Ç–æ) –í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ${c}`,fLink:lk,ts:new Date().toISOString()}
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    if(myFop&&myFop!=='–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö'){
        let fopExists=!1;
        if(data.Suppliers)Object.values(data.Suppliers).forEach(v=>{if(v.name===myFop)fopExists=!0});
        if(!fopExists)u['/Suppliers/'+db.child('Suppliers').push().key]={name:myFop}
    }

    await db.update(u);

    if(doPrint){
      printShipInvoice(dObj,lk); // –ü–µ—á–∞—Ç—å
    } else {
      closeModal(); // –ó–∞–∫—Ä—ã—Ç—å
      alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
    }
    
    // –û—á–∏—Å—Ç–∫–∞
    document.querySelectorAll('.bulk-q').forEach(i=>i.value=''); window.shipBasket={};

  }catch(e){
      alert("–ü–æ–º–∏–ª–∫–∞: "+e);
      btns.forEach(b=>b.disabled=!1);
  }
}

</script></body></html>
