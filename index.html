<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>–°–∫–ª–∞–¥ v381 INSTANT CLOSE</title>
<link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png">
<link rel="shortcut icon" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png">
<link rel="apple-touch-icon" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png">
<style>
/* GLOBAL & RESET */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
:root { --bg: #f1f5f9; --p: #4f46e5; --d: #ef4444; --s: #10b981; --t: #1e293b; --w: #fff; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 5px; padding-bottom: 80px; color: var(--t); overflow-x: hidden; width: 100vw; }

/* LOCK SCREEN */
#lockScreen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: opacity 0.3s; }
.lock-hidden { opacity: 0; pointer-events: none; }
.lock-logo { width: 100px; margin-bottom: 20px; }
.lock-title { font-size: 14px; font-weight: 900; color: #94a3b8; letter-spacing: 2px; margin-bottom: 30px; text-transform: uppercase; }
.lock-inp { width: 100%; max-width: 250px; padding: 15px; font-size: 18px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; }

/* DASHBOARD */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-width: 100%; margin: 0 auto; }
.dash-item { background: var(--w); border-radius: 16px; padding: 15px 5px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); color: var(--p); font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; border: 1px solid #e2e8f0; transition: 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
.dash-item:active { transform: scale(0.97); background: #eef2ff; }
.dash-item span { font-size: 24px; margin-bottom: 8px; display: block; }

/* CARD */
.card { background: var(--w); border-radius: 16px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; position: relative; width: 100%; }
.btn-main { background: var(--p); color: #fff; border: none; width: 100%; padding: 14px; font-size: 13px; font-weight: 700; border-radius: 12px; margin: 5px 0; text-transform: uppercase; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); transition: 0.2s; cursor: pointer; }
.btn-main:active { transform: translateY(1px); box-shadow: none; }

/* NAV */
.bottom-nav { display: none; position: fixed; bottom: 10px; left: 10px; right: 10px; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); padding: 5px; z-index: 900; grid-template-columns: 1fr 1fr; gap: 5px; border: 1px solid #e2e8f0; }
.bottom-nav button { background: transparent; border: none; padding: 12px; border-radius: 14px; color: #94a3b8; font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
.bottom-nav button.nav-btn-active { background: #eef2ff; color: var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
body.nav-active .bottom-nav { display: grid; }

input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; font-weight: 600; color: #0f172a; }
input:focus, select:focus { border-color: var(--p); background: #f8fafc; }

/* ITEMS GRID */
.item-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
.item-card { background: #fff; border-radius: 12px; padding: 10px 2px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; }
.item-title { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 4px; height: 22px; overflow: hidden; line-height: 1.1; word-break: break-word; }
.item-qty { font-size: 14px; font-weight: 900; color: #0f172a; margin-bottom: 4px; }
.alarm-blink { background: #fef2f2 !important; border: 1px solid var(--d) !important; animation: blink 1s infinite alternate; }

/* MODAL */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal-box { background: #fff; width: 96%; max-width: 400px; border-radius: 20px; max-height: 94vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2); }
.modal-body { overflow-y: auto; padding: 15px; }

/* UTILS */
.report-line { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed #e2e8f0; }
.history-btn { border: none; background: #e0e7ff; color: var(--p); border-radius: 8px; padding: 8px; font-weight: 700; font-size: 12px; width: 45%; }
.corr-btn { display: none; border: none; background: #fef3c7; color: #d97706; border-radius: 8px; padding: 8px; font-weight: 700; font-size: 12px; width: 45%; margin-top: 4px; }
.show-corr .corr-btn { display: inline-block; }
.hist-pos { color: var(--p) !important; font-weight: 700; } .hist-neg { color: var(--d) !important; font-weight: 700; }

.krup-row { display:grid; grid-template-columns: 2fr 1fr 1fr; gap:4px; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:8px; margin-bottom:8px; }
.krup-sec { font-size:11px; font-weight:900; color:#64748b; margin-top:12px; text-transform:uppercase; letter-spacing: 1px; }
.tab-group { display: flex; gap: 4px; margin-bottom: 10px; padding: 4px; background: #f1f5f9; border-radius: 12px; }
.tab-btn { flex: 1; padding: 10px 4px; background: transparent; border: none; border-radius: 10px; color: #64748b; font-weight: 700; font-size: 10px; text-transform: uppercase; transition:0.2s }
.tab-btn.active { background: #fff; color: var(--p); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.ship-sect { display: none; }
.ship-sect.active { display: grid; }
.new-input { display:none; border:2px solid var(--s) !important; }
.clean-cat { font-size:10px; font-weight:900; color:#94a3b8; margin:15px 0 5px; border-bottom:1px solid #eee; padding-bottom:2px; letter-spacing:1px; }
.del-rep-btn { position: absolute; top: 10px; right: 10px; background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index:10; }
.logo-box { text-align: center; margin-bottom: 20px; margin-top: 5px; }
.logo-img { max-width: 220px; height: auto; object-fit: contain; }
.l-t { font-size:9px; font-weight:800; color:#64748b; margin-bottom:2px; display:block; text-transform:uppercase; }

/* SMART INPUTS & GRID */
.z-grid { display: grid; grid-template-columns: 35% 20% 20% 20%; gap:4px; align-items: center; border-bottom:1px solid #f1f5f9; padding-bottom:5px; margin-bottom:5px; }
.z-head { font-size:10px; color:#047857; font-weight:900; text-align:center; margin:15px 0 5px; letter-spacing:1px; background:#ecfdf5; padding:4px; border-radius:4px; text-transform: uppercase; }
.z-col-h { display:grid; grid-template-columns: 32% 16% 16% 16% 8%; gap:4px; text-align:center; font-size:9px; color:#64748b; font-weight:700; margin-bottom:4px; }
.dyn-row { display: grid; grid-template-columns: 32% 16% 16% 16% 8%; gap:4px; align-items: center; margin-bottom:5px; }

/* UNIFIED INPUT STYLE */
.smart-wrap { width:100%; height:30px; position:relative; }
.smart-sel, .smart-inp, .u-inp { 
    width:100%; height:100%; 
    border:1px solid #cbd5e1; border-radius:6px; 
    font-size:13px; background:#fff; 
    padding:0 5px; margin:0; 
    box-sizing:border-box; 
    font-weight:600; color:#1e293b;
}
.smart-inp { display:none; border:1px solid var(--p); }
.u-inp { text-align:center; } /* For numbers */
.del-row-btn { width:100%; height:30px; background:#fee2e2; border:1px solid #fca5a5; color:red; border-radius:6px; font-weight:900; display:flex; align-items:center; justify-content:center; }

/* VIBRO LIST STYLES */
.v-list-item { background:#fff; border:1px solid #e2e8f0; padding:8px; margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
.v-badge { font-size:9px; padding:2px 6px; border-radius:4px; font-weight:800; text-transform:uppercase; margin-right:5px; }
.v-bdg-dv { background:#dbeafe; color:#1e40af; }
.v-bdg-semi { background:#fef3c7; color:#92400e; }
.v-bdg-feed { background:#ffedd5; color:#9a3412; }

/* JOURNAL CARDS */
.log-entry { margin-bottom: 15px; width: 100%; }
.j-card { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; position: relative; }
.j-head { font-weight: 900; font-size: 14px; text-transform: uppercase; color: var(--p); margin-bottom: 4px; }
.j-sub { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px; border-bottom:1px solid #f1f5f9; padding-bottom:4px; }
.j-title { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
.j-body { font-size: 13px; color: #334155; }
.j-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #e2e8f0; align-items:center; }
.j-row:last-child { border-bottom: none; }
.j-dots { flex-grow: 1; border-bottom: 1px dotted #cbd5e1; margin: 0 5px; position: relative; top: -4px; }

/* ARCHIVE TILES */
.arch-y-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; width: 100%; }
.arch-tile-y { background: #3b82f6; color: #fff; padding: 25px 5px; border-radius: 16px; text-align: center; font-weight: 900; font-size: 20px; cursor: pointer; box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4); }
.arch-m-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; width: 100%; }
.arch-tile-m { background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; padding: 15px 2px; text-align: center; font-size: 10px; font-weight: 700; color: #334155; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-transform:uppercase; }
.arch-d-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; width: 100%; }
.arch-tile-d { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 0; text-align: center; font-size: 13px; font-weight: 700; position: relative; color: #0f172a; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.arch-badge { position: absolute; top: -5px; right: -5px; background: var(--d); color: #fff; font-size: 9px; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; border:2px solid #fff; }
.arch-c-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top:10px; width: 100%; }
.arch-tile-c { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px 2px; text-align: center; font-size: 11px; font-weight: 700; color: #1e293b; position: relative; cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:50px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-break: break-word; }
.arch-tile-c:active { background: #eef2ff; border-color: var(--p); }
.arch-content { display: none; margin-bottom: 15px; width: 100%; }
.arch-inv { background: #fff; border-left: 4px solid var(--p); border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; font-size: 13px; cursor: pointer; border: 1px solid #f1f5f9; width: 100%; }
.arch-del { width: 36px; height: 36px; background: #fee2e2; color: #ef4444; border: none; border-radius: 50%; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; }

/* BASKET STYLES */
.basket-list { margin-top: 10px; border-top: 2px solid #eee; padding-top: 10px; }
.basket-item { display: flex; justify-content: space-between; background: #f8fafc; padding: 8px; margin-bottom: 4px; border-radius: 8px; font-size: 13px; align-items: center; }
.basket-del { color: red; font-weight: bold; cursor: pointer; padding: 0 5px; }

@keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }
</style>
</head>
<body>
<div id="lockScreen">
    <img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo">
    <div class="lock-title">–°–ò–°–¢–ï–ú–ê –£–ß–ï–¢–ê</div>
    <input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn-main" style="max-width:250px" onclick="tryLogin()">–û–¢–ö–†–´–¢–¨</button>
</div>

<div id="act"></div>
<div id="cnt"></div>
<div class="bottom-nav">
<button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button>
<button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button>
</div>
<div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:15px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0;font-size:16px"></h4><button onclick="closeModal()" style="border:none;background:none;font-size:24px;color:#999">‚úï</button></div><div id="mB" class="modal-body"></div></div></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
// ============================================
// –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ê–†–û–õ–¨
// ============================================
const APP_PIN = "1111"; // <--- –ú–ï–ù–Ø–ô –ü–ê–†–û–õ–¨ –¢–£–¢
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();
let cur='Home',data={},aId=null,archSub='',corrMode=false,isLogged=false,incItems=[],vibroItems=[],krupItems=[];
let corrCtx = {}; // Context for correction

const bP=["–ê—Ä–Ω–∞—É—Ç–∫–∞","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"],szs=["300√ó400","370√ó500","400√ó500","420√ó550"],mths=["–Ø–ù–í","–§–ï–í","–ú–ê–†–¢","–ê–ü–†","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì","–°–ï–ù–¢","–û–ö–¢","–ù–û–Ø–ë","–î–ï–ö"];
const fd=i=>{if(!i)return'';const parts=i.split('T')[0].split('-');return `${parts[2]}.${parts[1]}.${parts[0]} ${parts[1]}:${parts[2]}`};const fd2=i=>{if(!i)return'';const parts=i.split('T')[0].split('-');return `${parts[2]}.${parts[1]}.${parts[0]}`};
const closeModal=()=>{document.getElementById('mdl').style.display='none';aId=null;incItems=[];vibroItems=[];krupItems=[];};const toggleF=id=>{const e=document.getElementById(id);e.style.display=e.style.display==='block'?'none':'block'};
const toggleC=(id, btn)=>{ 
    const e=document.getElementById(id);
    if(e.style.display==='block'){ e.style.display='none'; btn.style.background='#fff'; btn.style.borderColor='#e2e8f0'; }
    else { e.style.display='block'; btn.style.background='#eef2ff'; btn.style.borderColor='var(--p)'; }
};
const gP=(cat)=>{
    let init=[];
    if(cat==='WeightStock'||cat==='–ì–æ—Ç–æ–≤–∞—è') init=bP;
    const s=new Set(init);
    const dbK=(cat==='WeightStock')?'WeightStock':(cat==='Stock_DV'?'Stock_DV':(cat==='Stock_Feed'?'Stock_Feed':(cat==='Stock_Raw'?'Stock_Raw':(cat==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è'))));
    if(data[dbK])Object.values(data[dbK]).forEach(v=>s.add(v.name));
    return Array.from(s).filter(x=>x).sort();
};
const gRaw=()=>{const s=new Set();if(data.Krup_Report)Object.values(data.Krup_Report).forEach(v=>{if(v.raw)s.add(v.raw)});return Array.from(s).sort();}
const gS=()=>{const s=new Set();['ArchIncoming','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞'].forEach(k=>{if(data[k])Object.values(data[k]).forEach(v=>{if(v.supplier)s.add(v.supplier)})});return Array.from(s).filter(x=>x).sort();};
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort();};
const gPack=(cat)=>{const s=new Set();if(cat==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));if(cat==='–°–∫–æ—Ç—á')s.add('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º');if(cat==='–ü–ª–µ–Ω–∫–∞')bP.forEach(x=>s.add(x));const dbK=cat==='–°–∫–æ—Ç—á'?'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':cat;if(data[dbK])Object.values(data[dbK]).forEach(v=>{if(v.name)s.add(v.name)});return Array.from(s).filter(x=>x).sort();};

// ============================================
// –í–•–û–î
// ============================================
async function tryLogin() {
    const p = document.getElementById('appPass').value;
    if(p === APP_PIN) {
        document.getElementById('lockScreen').classList.add('lock-hidden');
        document.body.classList.add('nav-active');
        isLogged = true;
        renderHome();
        try { await auth.signInWithEmailAndPassword('nukonor@gmail.com', '123456'); } catch(e){}
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
}

function renderHome(){
    if(!isLogged) return;
    cur='Home';
    document.body.classList.remove('nav-active');
    document.getElementById('act').innerHTML='';
    const logo=`<div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div>`;
    document.getElementById('cnt').innerHTML=`${logo}<div class="dash-grid"><div class="dash-item" onclick="setCat('StockRoot')"><span>üì¶</span>–°–∫–ª–∞–¥</div><div class="dash-item" onclick="setCat('ProdSub')"><span>‚öôÔ∏è</span>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</div><div class="dash-item" onclick="setCat('PackSub')"><span>ü•°</span>–£–ø–∞–∫–æ–≤–∫–∞</div><div class="dash-item" onclick="openModal('log')" style="color:#64748b"><span>üìã</span>–ñ–£–†–ù–ê–õ</div></div>`;
    updNav();
}
function goBack(){const m={'StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','ArchPackIn':'PackSub'};let next=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')next=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(next);}
function setCat(c){cur=c;document.body.classList.add('nav-active');const a=document.getElementById('act'),ct=document.getElementById('cnt');a.innerHTML='';if(c==='Home'){renderHome();return}
if(c==='StockRoot'){
    a.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px"><button class="btn-main" style="background:var(--s)" onclick="openModal('inc')">–ü—Ä–∏—Ö–æ–¥</button><button class="btn-main" style="background:var(--d)" onclick="openModal('ship')">–û—Ç–≥—Ä—É–∑–∫–∞</button></div>`;
    ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('StockList')">–§–∞—Å–æ–≤–∫–∞</div><div class="dash-item" onclick="setCat('Stock_Raw')">–°—ã—Ä—å—ë</div><div class="dash-item" onclick="setCat('WeightStock')">–ü–æ–∫—É–ø–Ω–∞—è</div><div class="dash-item" onclick="setCat('Stock_DV')">–°–∫–ª–∞–¥ –î–í</div><div class="dash-item" onclick="setCat('Stock_Feed')">–°–∫–ª–∞–¥ –ö–æ—Ä–º–∞</div><div class="dash-item" onclick="setCat('Stock_Semi')">–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç</div><div class="dash-item" onclick="setCat('Invoices')">–ê—Ä—Ö–∏–≤</div></div><div id="corrCtls" style="margin-top:15px;display:flex;gap:5px"><button id="corrTgl" class="btn-main" style="background:#fff;border:1px solid #d1d5db;color:#333;margin:0" onclick="toggleCorr()">–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: –í–´–ö–õ</button></div>`;
}else if(c==='ProdSub')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–¶–µ—Ö —Ñ–∞—Å–æ–≤–∫–∏</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö—Ä—É–ø–æ—Ä—É—à–∫–∞</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í–∏–±—Ä–æ—Å—Ç–æ–ª</div></div><button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–û–î –°–´–†–¨–Ø</button>`;else if(c==='PackSub'){
    a.innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü—Ä–∏—Ö–æ–¥ —É–ø–∞–∫–æ–≤–∫–∏</button><button id="corrTgl" class="btn-main" style="background:#fff;border:1px solid #d1d5db;color:#333;margin-top:5px" onclick="toggleCorr()">–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: –í–´–ö–õ</button>`;
    ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–ª–µ–Ω–∫–∞</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–∞–∫–µ—Ç—ã</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–∫–æ—Ç—á</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–µ—à–∫–∏</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–∏—Ç–∫–∏</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–≠—Ç–∏–∫–µ—Ç–∫–∞</div><div class="dash-item" onclick="setCat('ArchPackIn')" style="grid-column:1/-1;background:#f0f9ff;color:#333">–ê—Ä—Ö–∏–≤ –ü—Ä–∏—Ö–æ–¥–æ–≤</div></div>`;
}else if(c==='–§–∞—Å–æ–≤–∫–∞')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('fas')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='Kruporushka')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('addKrup')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='Vibro')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('addVibro')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;else if(c==='ZSHM')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('addZSHM')">–ù–û–í–ê–Ø –°–ú–ï–ù–ê</button>`;else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü—Ä–∏—Ö–æ–¥—ã</div><div class="dash-item" onclick="setCat('ArchSubOut')">–û—Ç–≥—Ä—É–∑–∫–∏</div></div>`;else if(c==='ArchSubIn'||c==='ArchSubOut'){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ü–æ –¥–∞—Ç–∞–º</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ü–æ –∏–º–µ–Ω–∞–º</div></div>`;}loadData();updCorrBtn();updNav();}
function toggleCorr(){corrMode=!corrMode;updCorrBtn();loadData();}
function updCorrBtn(){const b=document.getElementById('corrTgl'),c=document.getElementById('corrCtls');if(b){b.innerText=corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–´–ö–õ';b.style.background=corrMode?'#f59e0b':'#fff';b.style.color=corrMode?'#fff':'#333';if(corrMode&&cur==='StockRoot'&&!document.getElementById('cleanBtn')){const btn=document.createElement('button');btn.id='cleanBtn';btn.className='btn-main';btn.innerText='–ß–ò–°–¢–ö–ê –°–ü–ò–°–ö–û–í';btn.style.background='#ef4444';btn.style.margin='0';btn.onclick=()=>openModal('clean');c.appendChild(btn);}if(!corrMode){const cb=document.getElementById('cleanBtn');if(cb)cb.remove();}}}
function updNav(){document.getElementById('navM').className=`${cur==='Home'?'nav-btn-active':''}`;document.getElementById('navB').className=`${cur!=='Home'?'nav-btn-active':''}`;}
function switchShipTab(id){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tb_'+id).classList.add('active');document.querySelectorAll('.ship-sect').forEach(s=>s.classList.remove('active'));document.getElementById('sc_'+id).classList.add('active');}
function loadData(){db.on('value',s=>{data=s.val()||{};const c=document.getElementById('cnt');if(!c||['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub'].includes(cur))return;if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(cur==='Kruporushka')rKrup(c);else if(cur==='Vibro')rVibro(c);else if(cur==='ZSHM')rZSHM(c);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Stock_Raw')rRaw(c);else rGen(c);});}
function calcKrup(){let t=0;['kQ1','kQ2','kQ3','kMQ','kOQ'].forEach((q,i)=>{const kgId=q.replace('Q','W');const w=parseFloat(document.getElementById(kgId).value)||0,qty=parseFloat(document.getElementById(q).value)||0;t+=w*qty;});const sec=parseFloat(document.getElementById('kSecW').value)||0;document.getElementById('kMainW').value=(t-sec).toFixed(1);}
function calcVibro(){let t=0;for(let i=1;i<=3;i++){const q=parseFloat(document.getElementById(`vQ${i}`).value)||0,w=parseFloat(document.getElementById(`vW${i}`).value)||0;t+=q*w;}const sec=parseFloat(document.getElementById('vSecW').value)||0;document.getElementById('vRawW').value=(t-sec).toFixed(1);}
function calcZSHM(){
    let prodTotal = 0;
    // 1. Finished Products (3 rows)
    for(let i=1; i<=3; i++){
        const q = parseFloat(document.getElementById(`zQ${i}`).value)||0;
        const w = parseFloat(document.getElementById(`zW${i}`).value)||0;
        const l = parseFloat(document.getElementById(`zL${i}`).value)||0;
        prodTotal += (q * w) + l;
    }
    // 2. Semi Products (2 rows)
    for(let i=1; i<=2; i++){
        const q = parseFloat(document.getElementById(`zS_Q${i}`).value)||0;
        const w = parseFloat(document.getElementById(`zS_W${i}`).value)||0;
        const l = parseFloat(document.getElementById(`zS_L${i}`).value)||0;
        prodTotal += (q * w) + l;
    }
    // 3. Waste/Feed (3 rows)
    for(let i=1; i<=3; i++){
        const q = parseFloat(document.getElementById(`zF_Q${i}`).value)||0;
        const w = parseFloat(document.getElementById(`zF_W${i}`).value)||0;
        const l = parseFloat(document.getElementById(`zF_L${i}`).value)||0;
        prodTotal += (q * w) + l;
    }
    
    const sec=parseFloat(document.getElementById('zSecW').value)||0;
    document.getElementById('zRawW').value=(prodTotal - sec).toFixed(1);
}
function toggleInput(id){const sel=document.getElementById('s_'+id),inp=document.getElementById('i_'+id);if(sel.value==='NEW'){sel.style.display='none';inp.style.display='block';inp.focus();}else{inp.style.display='none';}}
    </script>
    <script>
function renderByTiles(c, rawD, type) {
    const gr = {};
    if(rawD) Object.entries(rawD).forEach(([id,v])=>{
        if(!v.date) return;
        const dObj = new Date(v.date);
        const y = dObj.getFullYear(), m = dObj.getMonth(); // Only Year and Month
        if(!gr[y]) gr[y] = {};
        if(!gr[y][m]) gr[y][m] = [];
        gr[y][m].push({...v, id});
    });

    let h = '';
    // YEAR GRID
    Object.keys(gr).sort((a,b)=>b-a).forEach(y => {
        h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}${type}')">${y}</div></div><div id="y${y}${type}" class="arch-content">`;
        
        // MONTH GRID
        h+=`<div class="arch-m-grid">`;
        Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{
            h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}${type}')">${mths[m]}</div>`;
        });
        h+=`</div>`; 

        // MONTH CONTENT (DIRECT LIST - NO DAY TILES)
        Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{
             h+=`<div id="m${y}${m}${type}" class="arch-content" style="grid-column:1/-1;">`;
             
             // SORT ITEMS NEWEST FIRST
             gr[y][m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v => {
                const s = JSON.stringify(v).replace(/"/g, "&quot;");
                if(type==='LOG') {
                     if(v.type==='FAS') h+=`<div class="card"><b>–§–ê–°–û–í–ö–ê: ${v.name.toUpperCase()}</b> [${fd2(v.date)}]<div class="report-line"><span>–°—ã—Ä—å–µ:</span><b>${v.prihod}–∫–≥ [${v.rawItem}]</b></div><div class="report-line"><span>–í—ã—Ö–æ–¥:</span><b>${v.vyhod}—à—Ç</b></div><div class="report-line"><span>–ü–∞–∫–µ—Ç—ã:</span><b>${v.size} [${pk(v.vyhod, v.name)}—à—Ç]</b></div><div class="report-line"><span>–ü–ª–µ–Ω–∫–∞:</span><b>${pl(v.vzial, v.ostatok)}–∫–≥</b></div></div>`;
                     else if(v.type==='KRUP') {
                         let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                         h+=`<div class="card"><b>–ö–†–£–ü–û–†–£–®–ö–ê${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                     }
                     else if(v.type==='VIBRO') {
                         let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                         h+=`<div class="card"><b>–í–ò–ë–†–û–°–¢–û–õ${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                     }
                     else if(v.type==='ZSHM') {
                         let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                         h+=`<div class="card"><b>–ó–®–ú –°–ú–ï–ù–ê${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                     }
                     else if(v.type==='INC_RAW') h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î –°–´–†–¨–Ø</div><div class="j-sub">${fd2(v.date)}</div><div class="j-title">${v.supplier}</div><div class="j-body"><div class="j-row"><span class="j-dots">${v.name}</span><b>${v.amount}–∫–≥</b></div></div></div>`;
                     else if(v.type==='INC') h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`+v.items.map(i=>`<div class="j-row"><span class="j-dots">${i.n}</span><b>${i.w}–∫–≥</b></div>`).join('')+`</div></div>`;
                     else if(v.type==='SHIP') h+=`<div class="j-card"><div class="j-head">–û–¢–ì–†–£–ó–ö–ê</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`+v.items.map(i=>`<div class="j-row"><span class="j-dots">${i.split(':')[0]}</span><b>${i.split(':')[1]}</b></div>`).join('')+`</div></div>`;
                     else if(v.type==='PACK') h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î –£–ü–ê–ö–û–í–ö–ò</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body"><div class="j-row"><span class="j-dots">${v.name}</span><b>${v.amount}</b></div></div></div>`;
                }
                else if(type==='FAS') h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delFas('${v.id}')">üóëÔ∏è</button><b>${v.name.toUpperCase()}</b> [${fd2(v.date)}]<div class="report-line"><span>–°—ã—Ä—å–µ:</span><b>${v.prihod}–∫–≥ [${v.rawItem}]</b></div><div class="report-line"><span>–í—ã—Ö–æ–¥:</span><b>${v.vyhod}—à—Ç</b></div><div class="report-line"><span>–ü–∞–∫–µ—Ç—ã:</span><b>${v.size} [${pk(v.vyhod, v.name)}—à—Ç]</b></div><div class="report-line"><span>–ü–ª–µ–Ω–∫–∞:</span><b>${pl(v.vzial, v.ostatok)}–∫–≥</b></div></div>`;
                else if(type==='KRUP') {
                    let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                    h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delKrup('${v.id}')">üóëÔ∏è</button><b>–ö–†–£–ü–û–†–£–®–ö–ê${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                }
                else if(type==='VIBRO') {
                    let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                    h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delVibro('${v.id}')">üóëÔ∏è</button><b>–í–ò–ë–†–û–°–¢–û–õ${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                }
                else if(type==='ZSHM') {
                    let ts = v.timeStart ? ` (${v.timeStart}-${v.timeEnd})` : '';
                    h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delZSHM('${v.id}')">üóëÔ∏è</button><b>–ó–®–ú –°–ú–ï–ù–ê${ts}</b> [${fd2(v.date)}]` + (v.operator ? `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator} / ${v.assistant}</div>` : '') + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]${i.l>0?' + '+i.l+'–∫–≥':''}</b></div>`).join('') + `</div>`;
                }
             });
             h+=`</div>`;
        });
        h+=`</div>`;
    });
    c.innerHTML = h || '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π';
}

const pk = (v,n) => Math.round(Math.abs(v/((n==="–ö—É—Ç—è")?19.8:9.9)));
const pl = (v,o) => Math.abs((v||0)-(o||0)).toFixed(1);

function rFas(c) { renderByTiles(c, data.–§–∞—Å–æ–≤–∫–∞, 'FAS'); }
function rKrup(c) { renderByTiles(c, data.Krup_Report, 'KRUP'); }
function rVibro(c) { renderByTiles(c, data.Vibro_Report, 'VIBRO'); }
function rZSHM(c) { renderByTiles(c, data.ZSHM_Report, 'ZSHM'); }
function rGlobalLog(c) { renderByTiles(c, data.GlobalLog, 'LOG'); }

function rArchPack(c){
    const d = data.ArchPackIn || {};
    const gr = {};
    if(d) Object.entries(d).forEach(([id,v])=>{ const dObj = new Date(v.date); const y = dObj.getFullYear(), m = dObj.getMonth(), dy = dObj.getDate(); if(!gr[y]) gr[y] = {}; if(!gr[y][m]) gr[y][m] = {}; if(!gr[y][m][dy]) gr[y][m][dy] = []; gr[y][m][dy].push({...v, id}); });
    let h='';
    Object.keys(gr).sort((a,b)=>b-a).forEach(y=>{
        h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('py${y}')">${y}</div></div><div id="py${y}" class="arch-content">`;
        h+=`<div class="arch-m-grid">`;Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{ h+=`<div class="arch-tile-m" onclick="toggleF('pm${y}${m}')">${mths[m]}</div>`; }); h+=`</div>`;
        Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{
            h+=`<div id="pm${y}${m}" class="arch-content">`;
             h+=`<div class="arch-d-grid">`;Object.keys(gr[y][m]).sort((a,b)=>b-a).forEach(dy=>{ h+=`<div class="arch-tile-d" onclick="toggleF('pd${y}${m}${dy}')">${dy}<div class="arch-badge">${gr[y][m][dy].length}</div></div>`; }); h+=`</div>`;
             Object.keys(gr[y][m]).sort((a,b)=>b-a).forEach(dy=>{
                 h+=`<div id="pd${y}${m}${dy}" class="arch-content">`;
                 gr[y][m][dy].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{
                    h+=`<div class="arch-inv"><div><b>${(v.num||'–ë/–ù')}</b>${v.name} (${v.amount}–∫–≥)</div><div style="font-size:10px;color:#888">${v.supplier||'-'}</div></div>`;
                 });
                 h+=`</div>`;
             });
            h+=`</div>`;
        });
        h+=`</div>`;
    });
    c.innerHTML=h||'–ü—É—Å—Ç–æ';
}

function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('–ì–æ—Ç–æ–≤–∞—è','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','–ì–æ—Ç–æ–≤–∞—è|${n}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('WeightStock','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','WeightStock|${n}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rRaw(c){
    // RENDER NEW RAW MATERIALS
    const t={};gP('Stock_Raw').forEach(p=>t[p]=0);
    if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]+=v.amount);
    let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;
    Object.keys(t).sort().forEach(n=>{
        h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('Stock_Raw','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','Stock_Raw|${n}')">¬±</button></div>`;
    });
    c.innerHTML=h+'</div>';
}
function rGen(c){const d=data[cur]||{},t={},u='–∫–≥';Object.values(d).forEach(v=>{let k=v.name;if(k)t[k]=(t[k]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const val=t[k];let alarm=val<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&val<50)alarm=true;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&val<30)alarm=true;if(cur==='–ü–∞–∫–µ—Ç—ã'&&val<3000)alarm=true;h+=`<div class="item-card ${alarm?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty">${cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'?val.toFixed(1):Math.round(val)} <small style="font-size:10px">${u}</small></div><button class="history-btn" onclick="showH('${cur}','${k}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}|${k}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rCleanList(c){let h='<div style="font-size:11px;color:#666;margin-bottom:10px">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–º—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:</div>';
const mkR = (s,t) => Array.from(s).sort().forEach(n=>{h+=`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><b>${n}</b><div><button onclick="renameItem('${n}','${t}')" style="margin-right:10px;border:none;background:none;font-size:16px">‚úèÔ∏è</button><button onclick="delItemBatch('${n}','${t}')" style="border:none;background:none;font-size:16px;color:red">üóëÔ∏è</button></div></div>`});
h+='<div class="clean-cat">üì¶ –¢–û–í–ê–†–´</div>';mkR(new Set([...gP('WeightStock'),...gP('Stock_DV'),...gP('Stock_Feed'),...gP('Stock_Semi'),...gP('Stock_Raw'),...gP('–ì–æ—Ç–æ–≤–∞—è')]),'name');
h+='<div class="clean-cat">üöõ –ü–û–°–¢–ê–í–©–ò–ö–ò</div>';mkR(new Set(gS()),'supplier');
h+='<div class="clean-cat">ü§ù –ö–õ–ò–ï–ù–¢–´</div>';mkR(new Set(gCl()),'client');c.innerHTML=h;}

function showH(c, k) {
    const ti = document.getElementById('mT'), b = document.getElementById('mB');
    ti.innerText = k;
    const hist = [];
    if(data[c]) Object.entries(data[c]).filter(([id,v]) => v.name === k).forEach(([id,v]) => {
        let n = v.note || '–ó–∞–ø–∏—Å—å';
        if(v.supplier) n = '–ü—Ä–∏—Ö–æ–¥: ' + v.supplier;
        if(v.client) n = '–û—Ç–≥—Ä—É–∑–∫–∞: ' + v.client;
        hist.push({ d: v.date, ts: v.ts || '', n: n, a: v.amount, id: id });
    });
    // FLAT LIST FOR HISTORY
    let h = '<table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:10px">';
    hist.sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts)).forEach(v => {
        const s = JSON.stringify({name:k, amount:v.a, date:v.d, note:v.n}).replace(/"/g, "&quot;");
        h += `<tr style="border-bottom:1px solid #eee"><td style="padding:8px 0;width:60%"><div style="font-weight:600;color:#1e293b">${v.n}</div><div style="font-size:11px;color:#94a3b8">${fd2(v.d)}</div></td><td style="text-align:right;font-weight:800;font-size:14px" class="${v.a>=0?'hist-pos':'hist-neg'}">${c==='–ü–∞–∫–µ—Ç—ã'?Math.round(v.a):v.a.toFixed(1)}</td><td style="width:30px;text-align:center">${corrMode?`<button onclick="delRec('${c}','${v.id}','${s}',0)" style="border:none;background:none;font-size:16px;color:red">üóëÔ∏è</button>`:''}</td></tr>`;
    });
    h += '</table>';
    b.innerHTML = h || '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π';
    document.getElementById('mdl').style.display = 'flex';
}

function makeSelect(id, cat, ph, sourceOverride, newLabel) {
    let opts = `<option value="">${ph}...</option>`;
    let list = [];
    if(sourceOverride) list = sourceOverride;
    else {
        if(cat === 'Stock_DV') {
            const rawSet = new Set();
            gP(cat).forEach(full => rawSet.add(full.split(' [')[0]));
            list = Array.from(rawSet).sort();
        } else {
            list = gP(cat);
        }
    }
    list.forEach(n => opts += `<option value="${n}">${n}</option>`);
    opts += `<option value="NEW" style="font-weight:bold;color:var(--p)">${newLabel || '+ –ù–û–í–´–ô –í–ò–î'}</option>`;
    return `<select id="s_${id}" onchange="toggleInput('${id}')" style="width:100%">${opts}</select><input type="text" id="i_${id}" class="new-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="display:none;width:100%">`;
}

// SMART SELECT GENERATOR
function makeSmart(id, list, ph) {
    let opts = `<option value="">${ph}</option>`;
    if(list) list.forEach(x => opts += `<option value="${x}">${x}</option>`);
    opts += `<option value="NEW_ENTRY" style="font-weight:900;color:blue">(+) –í–í–ï–°–¢–ò...</option>`;
    return `<div class="smart-wrap">
        <select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${opts}</select>
        <input type="text" id="i_${id}" class="smart-inp" placeholder="${ph}">
    </div>`;
}

// SMART SELECT HANDLER
function checkSmart(id) {
    const sel = document.getElementById('s_' + id);
    if(sel.value === 'NEW_ENTRY') {
        sel.style.display = 'none';
        const inp = document.getElementById('i_' + id);
        inp.style.display = 'block';
        inp.focus();
    }
}

// SMART VALUE GETTER
function getSmartVal(id) {
    const i = document.getElementById('i_' + id);
    if(i && i.style.display === 'block') return i.value;
    const s = document.getElementById('s_' + id);
    return s ? s.value : '';
}

// DEEP HISTORY LEARNER
function getHistoryDeep(key) {
    const s = new Set();
    const scan = (node) => {
        if(data[node]) Object.values(data[node]).forEach(v => {
            if(v[key]) s.add(v[key]);
            if(v.items && Array.isArray(v.items)) {
                v.items.forEach(i => {
                    if(key === 'weight' && i.w) s.add(i.w);
                    if(key === 'name' && i.n) s.add(i.n);
                });
            }
        });
    };
    scan('Vibro_Report');
    scan('Krup_Report');
    scan('ZSHM_Report');
    return Array.from(s).sort();
}

function openModal(t,id){
    const ti=document.getElementById('mT'),b=document.getElementById('mB');
    aId = id ? id : null; 

    // INIT ARRAYS
    vibroItems = [];
    krupItems = [];
    
    // LEARNED DATA
    const ops = getHistoryDeep('operator');
    const asts = getHistoryDeep('assistant');
    const timesS = getHistoryDeep('timeStart');
    const timesE = getHistoryDeep('timeEnd');
    if(timesS.length===0) timesS.push('08:00');
    if(timesE.length===0) timesE.push('20:00');

    if(t==='auth'){
        ti.innerText='–í—Ö–æ–¥ / –°–±—Ä–æ—Å';
        b.innerHTML=`<input type="email" id="lE" value="nukonor@gmail.com"><input type="password" id="lP"><button class="btn-main" onclick="login()">–í–•–û–î</button><hr><button class="btn-main" style="background:var(--d)" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É?')){db.set(null);location.reload()}">–û–ë–ù–£–õ–ò–¢–¨ –ë–ê–ó–£</button>`;
    }
    else if(t==='clean'){
        rCleanList(b);
        ti.innerText='–ß–ò–°–¢–ö–ê (–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞)';
    }
    else if(t==='addMatPack'){
        ti.innerText='–ü—Ä–∏—Ö–æ–¥ –£–ø–∞–∫–æ–≤–∫–∏';
        b.innerHTML=`–†–∞–∑–¥–µ–ª:<select id="mCat" onchange="const s=document.getElementById('mS');const list=gPack(this.value);s.innerHTML='<option value=>–í—ã–±—Ä–∞—Ç—å...</option>'+list.map(x=>'<option value=\\''+x+'\\'>'+x+'</option>').join('')+'<option value=NEW>+ –ù–û–í–´–ô</option>'"><option value="">–í—ã–±—Ä–∞—Ç—å...</option><option value="–ü–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option><option value="–ü–ª–µ–Ω–∫–∞">–ü–ª–µ–Ω–∫–∞</option><option value="–°–∫–æ—Ç—á">–°–∫–æ—Ç—á</option><option value="–ú–µ—à–∫–∏">–ú–µ—à–∫–∏</option><option value="–ù–∏—Ç–∫–∏">–ù–∏—Ç–∫–∏</option><option value="–≠—Ç–∏–∫–µ—Ç–∫–∞">–≠—Ç–∏–∫–µ—Ç–∫–∞</option></select>–¢–∏–ø:<select id="mS" onchange="document.getElementById('mSn').style.display=this.value==='NEW'?'block':'none'"><option value="">–í—ã–±—Ä–∞—Ç—å...</option></select><input type="text" id="mSn" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="display:none">–ü–æ—Å—Ç–∞–≤—â–∏–∫:<select id="mSuppS" onchange="document.getElementById('mSuppN').style.display=this.value==='NEW'?'block':'none'"><option value=>–í—ã–±—Ä–∞—Ç—å...</option>${gS().map(s=>`<option value="${s}">${s}</option>`).join('')}<option value="NEW">+ –ù–û–í–´–ô –ü–û–°–¢–ê–í–©–ò–ö</option></select><input type="text" id="mSuppN" placeholder="–ò–º—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" style="display:none">–ö–æ–ª-–≤–æ:<input type="number" id="mA">‚Ññ –ù–∞–∫–ª:<input type="text" id="mNum">–î–∞—Ç–∞:<input type="date" id="mDate" value="${new Date().toISOString().split('T')[0]}"><button class="btn-main" id="btnS" onclick="if(confirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å?'))sMatP()">–ó–ê–ü–ò–°–ê–¢–¨</button>`;
    }
    else if(t==='inc'){
        ti.innerText='–ü—Ä–∏—Ö–æ–¥ (–ü–æ–∫—É–ø–Ω–∞—è)';
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="iD" value="${new Date().toISOString().split('T')[0]}">‚Ññ –ù–∞–∫–ª:<input type="text" id="iNum">–ü–æ—Å—Ç–∞–≤—â–∏–∫:${makeSelect('iSupp','','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gS(),'+ –ù–û–í–´–ô –ü–û–°–¢–ê–í–©–ò–ö')}<div style="background:#f1f5f9;padding:10px;border-radius:10px;margin-top:10px;border:1px solid #e2e8f0"><div style="font-size:11px;font-weight:700;color:#64748b;margin-bottom:5px">–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</div>–¢–æ–≤–∞—Ä:${makeSelect('iN','WeightStock','–í—ã–±—Ä–∞—Ç—å...',null,'+ –ù–û–í–´–ô –í–ò–î')}–í–µ—Å (–∫–≥):<input type="number" id="iA"><button class="btn-main" style="background:var(--s);padding:8px" onclick="addIncItem()">+ –î–û–ë–ê–í–ò–¢–¨ –í –°–ü–ò–°–û–ö</button></div><div id="incList" class="basket-list"><div style="text-align:center;color:#999;font-size:12px;padding:10px">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div></div><button class="btn-main" id="btnS" onclick="if(confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é?'))sInc()">–°–û–•–†–ê–ù–ò–¢–¨ –ü–†–ò–•–û–î</button>`;
    }
    else if(t==='ship'){
        ti.innerText='–û—Ç–≥—Ä—É–∑–∫–∞';
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="sD" value="${new Date().toISOString().split('T')[0]}">–ö–ª–∏–µ–Ω—Ç:${makeSelect('sC','','–ö–ª–∏–µ–Ω—Ç',gCl(),'+ –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢')}‚Ññ –ù–∞–∫–ª–∞–¥–Ω–æ–π:<input type="text" id="sNum">
        <div class="tab-group"><button id="tb_Got" class="tab-btn active" onclick="switchShipTab('Got')">–§–ê–°–û–í–ö–ê</button><button id="tb_Wgh" class="tab-btn" onclick="switchShipTab('Wgh')">–ü–û–ö–£–ü–ù–ê–Ø</button><button id="tb_DV" class="tab-btn" onclick="switchShipTab('DV')">–î–í</button><button id="tb_Fd" class="tab-btn" onclick="switchShipTab('Fd')">–ö–û–†–ú–ê</button></div>
        <div id="shipGridF" class="item-body" style="max-height:300px;overflow-y:auto;margin-top:5px">
        <div id="sc_Got" class="ship-sect active item-grid">${gP('–ì–æ—Ç–æ–≤–∞—è').map(p=>`<div class="item-card"><div class="item-title">${p}</div><input type="number" class="s-in" data-cat="–ì–æ—Ç–æ–≤–∞—è" data-p="${p}" style="width:100%;box-sizing:border-box;border:1px solid #eee;border-radius:4px;padding:4px;text-align:center" placeholder="—à—Ç"></div>`).join('')}</div>
        <div id="sc_Wgh" class="ship-sect item-grid">${gP('WeightStock').map(p=>`<div class="item-card"><div class="item-title">${p}</div><input type="number" class="s-in" data-cat="WeightStock" data-p="${p}" style="width:100%;box-sizing:border-box;border:1px solid #eee;border-radius:4px;padding:4px;text-align:center" placeholder="–∫–≥"></div>`).join('')}</div>
        <div id="sc_DV" class="ship-sect item-grid">${gP('Stock_DV').map(p=>`<div class="item-card"><div class="item-title">${p}</div><input type="number" class="s-in" data-cat="Stock_DV" data-p="${p}" style="width:100%;box-sizing:border-box;border:1px solid #eee;border-radius:4px;padding:4px;text-align:center" placeholder="–∫–≥"></div>`).join('')}</div>
        <div id="sc_Fd" class="ship-sect item-grid">${gP('Stock_Feed').map(p=>`<div class="item-card"><div class="item-title">${p}</div><input type="number" class="s-in" data-cat="Stock_Feed" data-p="${p}" style="width:100%;box-sizing:border-box;border:1px solid #eee;border-radius:4px;padding:4px;text-align:center" placeholder="–∫–≥"></div>`).join('')}</div>
        </div><button class="btn-main" id="btnS" onclick="if(confirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å?'))sShip()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
    }
    else if(t==='fas'){
        let rL = [];
        gP('WeightStock').forEach(x => rL.push(`${x} (–ü–æ–∫—É–ø–Ω–∞—è)`));
        gP('Stock_DV').forEach(x => rL.push(`${x} (–°–∫–ª–∞–¥ –î–í)`));
        rL.sort();
        ti.innerText='–§–∞—Å–æ–≤–∫–∞';
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="fD" value="${new Date().toISOString().split('T')[0]}">–ö—Ä—É–ø–∞:<select id="fN">${gP('–ì–æ—Ç–æ–≤–∞—è').map(p=>`<option>${p}</option>`).join('')}</select>–°–ø–∏—Å–∞—Ç—å:<select id="fRaw">${rL.map(p=>`<option>${p}</option>`).join('')}</select>–ü–∞–∫–µ—Ç:<select id="fS">${szs.map(s=>`<option>${s}</option>`).join('')}</select><input type="number" id="fP" placeholder="–°—ã—Ä—å–µ –∫–≥"><input type="number" id="fV" placeholder="–í—ã—Ö–æ–¥ —à—Ç"><input type="text" id="fVz" placeholder="–í–∑—è–ª –ø–ª–µ–Ω–∫–∏ (—á–µ—Ä–µ–∑ +)"><input type="number" id="fOs" placeholder="–û—Å—Ç–∞—Ç–æ–∫ –ø–ª–µ–Ω–∫–∏"><button class="btn-main" id="btnS" onclick="if(confirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å?'))sFas()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
    }
    else if(t==='addKrup'){
        ti.innerText='–ö—Ä—É–ø–æ—Ä—É—à–∫–∞ –û—Ç—á–µ—Ç';
        // --- NEW KRUP CONSTRUCTOR ---
        const getHist=(k)=>{ const s=new Set(); if(data.Krup_Report) Object.values(data.Krup_Report).forEach(v=>{if(v[k]) s.add(v[k])}); return Array.from(s).sort(); };
        
        b.innerHTML=`
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <div style="display:grid; grid-template-columns:1.5fr 1fr 1fr; gap:8px; margin-bottom:10px;">
                <div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="kD" value="${new Date().toISOString().split('T')[0]}" class="smart-sel"></div>
                <div><label class="l-t">–°</label>${makeSmart('kTS', ['08:00','08:30'], '08:00')}</div>
                <div><label class="l-t">–î–û</label>${makeSmart('kTE', ['20:00','17:00'], '20:00')}</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart('kOp', getHist('operator'), '–§–∞–º–∏–ª–∏—è')}</div>
                <div><label class="l-t">–ü–û–ú–û–©–ù–ò–ö</label>${makeSmart('kAs', getHist('assistant'), '–§–∞–º–∏–ª–∏—è')}</div>
            </div>
        </div>

        <div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee">
            <div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div>
            <div style="display:grid; grid-template-columns:1fr 1.5fr 0.8fr; gap:5px; margin-bottom:5px;">
                <select id="kWH" class="smart-sel" onchange="updKrupRaw()">
                    <option value="Stock_Raw">–°—ã—Ä—å—ë</option>
                    <option value="Stock_Semi">–ü/–§</option>
                    <option value="Stock_DV">–î–í</option>
                    <option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option>
                </select>
                <div id="kRawCont"></div> 
                <input type="number" id="kRawW" placeholder="–ö–≥" class="smart-sel" readonly style="background:#eef2ff;font-weight:900;color:#333">
            </div>
            
            <div style="font-size:10px;color:#888;font-weight:700;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px">–î–û–ë–ê–í–ö–ê</div>
            <div style="display:grid; grid-template-columns:1fr 1.5fr 0.8fr; gap:5px; margin-bottom:5px;">
                <select id="kAddWH" class="smart-sel" onchange="updKrupAdd()">
                    <option value="Stock_Semi">–ü/–§</option>
                    <option value="Stock_Raw">–°—ã—Ä—å—ë</option>
                    <option value="Stock_DV">–î–í</option>
                    <option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option>
                </select>
                <div id="kAddNameCont"></div> 
                <input type="number" id="kAddW" placeholder="–ö–≥" class="smart-sel" oninput="recalcKrup()">
            </div>
        </div>

        <div class="z-head">–°–î–ï–õ–ê–ù–û –ó–ê –°–ú–ï–ù–£</div>
        <div style="background:#f0f9ff; padding:8px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:10px">
            <select id="kDest" class="smart-sel" style="margin-bottom:5px; font-weight:700" onchange="updKrupOutList()">
                <option value="DV">–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (-> –î–í)</option>
                <option value="Feed">–û—Ç—Ö–æ–¥—ã (-> –ö–æ—Ä–º–∞)</option>
                <option value="Semi">–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç (-> –ü/–§)</option>
            </select>
            <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
            <div class="z-grid" style="border:none">
                <div id="kOutNameCont"></div>
                <input type="number" id="kOutQ" placeholder="0" class="u-inp">
                
                <div class="smart-wrap">
                     <select id="s_kW" class="smart-sel" onchange="checkSmart('kW')"><option value="">–ö–≥</option>${getHistoryDeep('weight').map(x=>`<option value="${x}">${x}</option>`).join('')}<option value="NEW_ENTRY">(+)</option></select>
                     <input type="number" id="i_kW" class="smart-inp">
                </div>

                <input type="number" id="kOutL" placeholder="–∫–≥" class="u-inp">
            </div>
            <button class="btn-main" style="background:#3b82f6; padding:8px; font-size:11px" onclick="addKrupRow()">+ –î–û–ë–ê–í–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
        </div>

        <div id="kList" style="margin-bottom:15px"></div>

        <button class="btn-main" id="btnS" onclick="sKrup()">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>
        `;
        // Delay to allow DOM render
        setTimeout(()=>{ updKrupRaw(); updKrupAdd(); updKrupOutList(); }, 50);
    }
    else if(t==='addRaw'){
        ti.innerText='–ü—Ä–∏—Ö–æ–¥ –°—ã—Ä—å—è';
        b.innerHTML=`–ù–∞–∑–≤–∞–Ω–∏–µ:${makeSelect('rN','Stock_Raw','–ù–∞–∑–≤–∞–Ω–∏–µ')}–ü–æ—Å—Ç–∞–≤—â–∏–∫:${makeSelect('rSupp','','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gS(),'+ –ù–û–í–´–ô –ü–û–°–¢–ê–í–©–ò–ö')}–í–µ—Å (–∫–≥):<input type="number" id="rA"><button class="btn-main" id="btnS" onclick="sRawInc()">–ü–†–ò–ù–Ø–¢–¨</button>`;
    }
    else if(t==='addVibro'){
        ti.innerText='–í–∏–±—Ä–æ—Å—Ç–æ–ª';
        const getHist=(k)=>{ const s=new Set(); if(data.Vibro_Report) Object.values(data.Vibro_Report).forEach(v=>{if(v[k]) s.add(v[k])}); return Array.from(s).sort(); };
        b.innerHTML=`
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <div style="display:grid; grid-template-columns:1.5fr 1fr 1fr; gap:8px; margin-bottom:10px;">
                <div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="vD" value="${new Date().toISOString().split('T')[0]}" class="smart-sel"></div>
                <div><label class="l-t">–°</label>${makeSmart('vTS', ['08:00','08:30'], '08:00')}</div>
                <div><label class="l-t">–î–û</label>${makeSmart('vTE', ['20:00','17:00'], '20:00')}</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart('vOp', getHist('operator'), '–§–∞–º–∏–ª–∏—è')}</div>
                <div><label class="l-t">–ü–û–ú–û–©–ù–ò–ö</label>${makeSmart('vAs', getHist('assistant'), '–§–∞–º–∏–ª–∏—è')}</div>
            </div>
        </div>

        <div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee">
            <div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:5px; margin-bottom:5px;">
                <div id="vRawCont"></div> 
                <input type="number" id="vRawW" placeholder="–ö–≥" class="smart-sel" readonly style="background:#eef2ff;font-weight:900;color:#333">
            </div>
            
            <div style="font-size:10px;color:#888;font-weight:700;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px">–î–û–ë–ê–í–ö–ê</div>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:5px; margin-bottom:5px;">
                <div id="vAddNameCont"></div> 
                <input type="number" id="vAddW" placeholder="–ö–≥" class="smart-sel" oninput="recalcVibro()">
            </div>
        </div>

        <div class="z-head">–ì–û–¢–û–í–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø (–°–ö–õ–ê–î –î–í)</div>
        <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
        <div id="vRowsDV"></div>
        <button class="btn-main" style="background:#fff; color:#3b82f6; border:1px solid #3b82f6; margin-bottom:15px; font-size:10px" onclick="addVibroRowVisual('DV')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>

        <div class="z-head" style="color:#d97706;background:#fef3c7;">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢ (–°–ö–õ–ê–î –ü/–§)</div>
        <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
        <div id="vRowsSemi"></div>
        <button class="btn-main" style="background:#fff; color:#d97706; border:1px solid #d97706; margin-bottom:15px; font-size:10px" onclick="addVibroRowVisual('Semi')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>

        <div class="z-head" style="color:#b45309;background:#fff7ed;">–û–¢–•–û–î–´ (–°–ö–õ–ê–î –ö–û–†–ú–ê)</div>
        <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
        <div id="vRowsFeed"></div>
        <button class="btn-main" style="background:#fff; color:#b45309; border:1px solid #b45309; margin-bottom:15px; font-size:10px" onclick="addVibroRowVisual('Feed')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>

        <button class="btn-main" id="btnS" onclick="sVibro()">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>
        `;
        // Init logic
        setTimeout(()=>{ 
            updVibroRaw(); 
            updVibroAdd(); 
            addVibroRowVisual('DV'); 
            addVibroRowVisual('Semi');
            addVibroRowVisual('Feed');
        }, 50);
    }
    else if(t==='addZSHM'){
        ti.innerText='–ó–®–ú –°–º–µ–Ω–∞';
        const getHist=(k)=>{ const s=new Set(); if(data.ZSHM_Report) Object.values(data.ZSHM_Report).forEach(v=>{if(v[k]) s.add(v[k])}); return Array.from(s).sort(); };
        const getList=(src)=>Array.from(new Set(gP(src))).sort();

        b.innerHTML=`
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <div style="display:grid; grid-template-columns:1.5fr 1fr 1fr; gap:8px; margin-bottom:10px;">
                <div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="zD" value="${new Date().toISOString().split('T')[0]}" class="smart-sel"></div>
                <div><label class="l-t">–°</label>${makeSmart('zTS', ['08:00','08:30'], '08:00')}</div>
                <div><label class="l-t">–î–û</label>${makeSmart('zTE', ['20:00','17:00'], '20:00')}</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart('zOp', getHist('operator'), '–§–∞–º–∏–ª–∏—è')}</div>
                <div><label class="l-t">–ü–û–ú–û–©–ù–ò–ö</label>${makeSmart('zAs', getHist('assistant'), '–§–∞–º–∏–ª–∏—è')}</div>
            </div>
        </div>

        <div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee">
            <div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div>
            <select id="zMain" onchange="calcZSHM()" class="smart-sel">
                <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                ${[...gP('Stock_Raw'), ...gP('Stock_Semi')].sort().map(s=>`<option value="${s}">${s}</option>`).join('')}
            </select>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px; margin-top:5px;">
                <div><div style="font-size:10px;color:#888;font-weight:700;">–î–û–ë–ê–í–ö–ê</div><select id="zSecName" onchange="calcZSHM()" class="smart-sel"><option value="">–ù–µ—Ç</option>${gP('Stock_Semi').map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
                <div><div style="font-size:10px;color:#888;font-weight:700;">–í–ï–° (–ö–ì)</div><input type="number" id="zSecW" placeholder="0" class="smart-sel" oninput="calcZSHM()"></div>
            </div>
        </div>

        <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>

        <div class="z-head">–ì–û–¢–û–í–´–ô –ü–†–û–î–£–ö–¢ - –°–ö–õ–ê–î –î–í</div>
        <div class="z-grid">${makeSmart('zN1', getList('Stock_DV'), '–í–∏–¥')}<input type="number" id="zQ1" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zW1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zL1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        <div class="z-grid">${makeSmart('zN2', getList('Stock_DV'), '–í–∏–¥')}<input type="number" id="zQ2" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zW2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zL2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        <div class="z-grid">${makeSmart('zN3', getList('Stock_DV'), '–í–∏–¥')}<input type="number" id="zQ3" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zW3" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zL3" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>

        <div class="z-head" style="color:#d97706;background:#fef3c7;">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢ - –°–ö–õ–ê–î –ü/–§</div>
        <div class="z-grid">${makeSmart('zS_N1', getList('Stock_Semi'), '–í–∏–¥')}<input type="number" id="zS_Q1" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zS_W1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zS_L1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        <div class="z-grid">${makeSmart('zS_N2', getList('Stock_Semi'), '–í–∏–¥')}<input type="number" id="zS_Q2" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zS_W2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zS_L2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>

        <div class="z-head" style="color:#b45309;background:#fff7ed;">–û–¢–•–û–î–´ - –°–ö–õ–ê–î –ö–û–†–ú–ê</div>
        <div class="z-grid">${makeSmart('zF_N1', getList('Stock_Feed'), '–í–∏–¥')}<input type="number" id="zF_Q1" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_W1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_L1" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        <div class="z-grid">${makeSmart('zF_N2', getList('Stock_Feed'), '–í–∏–¥')}<input type="number" id="zF_Q2" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_W2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_L2" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        <div class="z-grid">${makeSmart('zF_N3', getList('Stock_Feed'), '–í–∏–¥')}<input type="number" id="zF_Q3" placeholder="0" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_W3" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"><input type="number" id="zF_L3" placeholder="–∫–≥" class="u-inp" oninput="calcZSHM()"></div>
        
        <div style="margin-top:10px;padding:10px;background:#ecfdf5;border:1px solid #10b981;border-radius:8px;text-align:center">
            <div style="font-size:10px;color:#047857;font-weight:700">–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–û –û–°–ù–û–í–´:</div>
            <input id="zRawW" readonly style="background:transparent;border:none;font-size:20px;font-weight:900;color:#047857;text-align:center;width:100%" value="0">
        </div>
        <button class="btn-main" id="btnS" onclick="sZSHM()">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>`;
    }
    else if(t==='corr'){
        const [cat,name]=id.split('|');
        corrCtx = {cat, name}; // SAVE CONTEXT
        ti.innerText='–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: '+name;
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="cD" value="${new Date().toISOString().split('T')[0]}">–ö–æ–ª-–≤–æ:<div style="display:flex;gap:5px"><input type="number" id="cA"><button onclick="document.getElementById('cA').value *= -1" style="width:50px;font-weight:900">+/-</button></div>–ü—Ä–∏—á–∏–Ω–∞:<input type="text" id="cR"><button class="btn-main" id="btnS" onclick="if(confirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å?'))sCorr()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
    }
    else if(t==='vInv'){
        const [rid,key]=id.split('|');const rec = data[key] ? data[key][rid] : null; if(!rec) return alert('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');const items = rec.items; let h = ''; if(items && Array.isArray(items)) { h = '<div style="background:#f8fafc;padding:10px;border-radius:8px;border:1px solid #e2e8f0"><div style="font-weight:700;margin-bottom:5px;font-size:11px;color:#64748b">–°–û–°–¢–ê–í –ù–ê–ö–õ–ê–î–ù–û–ô:</div>'; items.forEach(i => { h += `<div style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0;font-size:13px"><span>${i.n || i.split(':')[0]}</span><b>${i.w || i.split(':')[1]}${i.w ? '–∫–≥' : ''}</b></div>`; }); h += '</div>'; } 
        let mainInfo = '';
        if(key === 'ArchIncoming') {
            mainInfo = `<div style="background:#ecfdf5;padding:15px;border-radius:10px;border:1px solid #a7f3d0;text-align:center;margin-bottom:15px"><div style="font-size:12px;color:#047857;font-weight:700;text-transform:uppercase">–ü–û–°–¢–ê–í–©–ò–ö</div><div style="font-size:20px;color:#064e3b;font-weight:900;margin-top:5px">${rec.supplier}</div></div>`;
        }
        ti.innerText='–ù–∞–∫–ª–∞–¥–Ω–∞—è';b.innerHTML=`<div style="font-size:18px;margin-bottom:10px"><b>‚Ññ ${rec.num||'–ë/–ù'}</b></div><div style="color:#64748b;margin-bottom:15px;font-weight:600">${rec.client||rec.supplier} | ${fd2(rec.date)}</div>${mainInfo}${h}<button class="btn-main" style="background:var(--d);margin-top:20px" onclick="delArchRec('${key}','${rid}')">–£–î–ê–õ–ò–¢–¨ –° –í–û–ó–í–†–ê–¢–û–ú</button>`;
    }
    else if(t==='log'){
        rGlobalLog(b);ti.innerText='–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π';
    }
    document.getElementById('mdl').style.display='flex';
}

// === NEW VIBRO LOGIC (DYNAMIC) ===
function getAllRaw() {
    const s = new Set([...gP('Stock_Raw'), ...gP('Stock_Semi')]);
    return Array.from(s).sort();
}
function updVibroRaw() {
    const list = getAllRaw();
    document.getElementById('vRawCont').innerHTML = makeSmart('vRawItem', list, '–°—ã—Ä—å–µ');
}
function updVibroAdd() {
    const list = getAllRaw();
    document.getElementById('vAddNameCont').innerHTML = makeSmart('vAddItem', list, '–î–æ–±–∞–≤–∫–∞');
}

function addVibroRowVisual(section) {
    const rid = Date.now() + Math.floor(Math.random()*1000);
    
    // Choose Source List based on section
    let listSrc;
    if(section === 'DV') listSrc = gP('Stock_DV');
    else if(section === 'Semi') listSrc = gP('Stock_Semi');
    else listSrc = gP('Stock_Feed'); // Feed

    const list = Array.from(new Set(listSrc)).sort();
    
    const makeRowSmart = (id) => {
        let opts = `<option value="">–í—ã–±—Ä–∞—Ç—å...</option>`;
        list.forEach(x => opts += `<option value="${x}">${x}</option>`);
        opts += `<option value="NEW_ENTRY" style="color:blue">(+) –ù–æ–≤—ã–π</option>`;
        return `<div class="smart-wrap"><select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${opts}</select><input type="text" id="i_${id}" class="smart-inp"></div>`;
    };

    // HISTORY WEIGHTS
    const wList = getHistoryDeep('weight');
    let wOpts = '<option value="">–ö–≥</option>';
    wList.forEach(w => wOpts += `<option value="${w}">${w}</option>`);
    wOpts += '<option value="NEW_ENTRY">(+)</option>';

    const rowHTML = `
    <div class="dyn-row" id="vrow_${rid}" data-sect="${section}">
        ${makeRowSmart(`vN_${rid}`)}
        <input type="number" id="vQ_${rid}" class="u-inp" placeholder="0" oninput="calcVibroDynamic()">
        
        <div class="smart-wrap">
             <select id="s_vW_${rid}" class="smart-sel" onchange="checkSmart('vW_${rid}')">${wOpts}</select>
             <input type="number" id="i_vW_${rid}" class="smart-inp" oninput="calcVibroDynamic()">
        </div>
        
        <input type="number" id="vL_${rid}" class="u-inp" placeholder="–∫–≥" oninput="calcVibroDynamic()">
        <button class="del-row-btn" onclick="document.getElementById('vrow_${rid}').remove(); calcVibroDynamic()">‚úï</button>
    </div>`;
    
    // Append to correct container
    let contId;
    if(section === 'DV') contId = 'vRowsDV';
    else if(section === 'Semi') contId = 'vRowsSemi';
    else contId = 'vRowsFeed';

    document.getElementById(contId).insertAdjacentHTML('beforeend', rowHTML);
}

function calcVibroDynamic() {
    let total = 0;
    // Helper to calc one container
    const calcContainer = (contId) => {
        const rows = document.getElementById(contId).children;
        for (let row of rows) {
            const rid = row.id.split('_')[1];
            const q = parseFloat(document.getElementById(`vQ_${rid}`).value) || 0;
            
            let w = parseFloat(document.getElementById(`i_vW_${rid}`).value);
            if(!w) w = parseFloat(document.getElementById(`s_vW_${rid}`).value) || 0;
            
            const l = parseFloat(document.getElementById(`vL_${rid}`).value) || 0;
            total += (q * w) + l;
        }
    };

    calcContainer('vRowsDV');
    calcContainer('vRowsSemi');
    calcContainer('vRowsFeed');
    
    const addW = parseFloat(document.getElementById('vAddW').value) || 0;
    const res = total - addW;
    document.getElementById('vRawW').value = res > 0 ? res.toFixed(1) : 0;
}

// Helper to find Source for arbitrary item
function findSourceWH(name) {
    const rawSet = new Set(gP('Stock_Raw'));
    return rawSet.has(name) ? 'Stock_Raw' : 'Stock_Semi';
}

async function sVibro() {
    const btn = document.getElementById('btnS');
    const rawName = getSmartVal('vRawItem');
    const rawW = parseFloat(document.getElementById('vRawW').value)||0;
    
    const addName = getSmartVal('vAddItem');
    const addW = parseFloat(document.getElementById('vAddW').value)||0;
    
    // Header
    const dV = document.getElementById('vD').value + "T12:00:00Z";
    const ts = new Date().toISOString();
    const op = getSmartVal('vOp');
    const as = getSmartVal('vAs');
    const tS = getSmartVal('vTS');
    const tE = getSmartVal('vTE');

    if(!rawName || rawW <= 0) return alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—ã—Ä—å—è');

    const items = [];
    let totalProd = 0;

    // Harvest Data
    const harvest = (contId, type) => {
        const rows = document.getElementById(contId).children;
        for (let row of rows) {
            const rid = row.id.split('_')[1];
            let n = getSmartVal(`vN_${rid}`); 
            if(!n) continue;
            
            let q = parseFloat(document.getElementById(`vQ_${rid}`).value) || 0;
            
            let w = parseFloat(document.getElementById(`i_vW_${rid}`).value);
            if(!w) w = parseFloat(document.getElementById(`s_vW_${rid}`).value) || 0;
            
            let l = parseFloat(document.getElementById(`vL_${rid}`).value) || 0;

            if (q > 0 || l > 0) {
                items.push({n, q, w, l, type});
                totalProd += (q * w) + l;
            }
        }
    };

    harvest('vRowsDV', 'DV');
    harvest('vRowsSemi', 'Semi');
    harvest('vRowsFeed', 'Feed');

    if(items.length === 0) return alert('–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ü–∏—é');

    let rawDesc = `${rawName} (${rawW}–∫–≥)`;
    if(addName && addW > 0) rawDesc += ` + ${addName} (${addW}–∫–≥)`;

    const msg = `–°–ú–ï–ù–ê –í–ò–ë–†–û–°–¢–û–õ:\n\nüë§ ${op} / ${as}\nüïí ${tS} - ${tE}\n\nüìâ –í–•–û–î: ${rawDesc}\nüìà –í–´–•–û–î: ${totalProd.toFixed(1)} –∫–≥\n\n–°–æ—Ö—Ä–∞–Ω–∏—Ç—å?`;
    if(!confirm(msg)) return;

    if(btn) btn.disabled = true;
    
    // CLOSE IMMEDIATELY
    closeModal();
    
    const vId = db.child('Vibro_Report').push().key;
    const updates = {};

    // 1. Deduct Raw
    const rWH = findSourceWH(rawName);
    updates[`/${rWH}/${db.child(rWH).push().key}`] = {
        name: rawName, amount: -rawW, date: dV, ts: ts, note: '–í–∏–±—Ä–æ—Å—Ç–æ–ª –û—Å–Ω–æ–≤–∞', fLink: vId
    };

    // 2. Deduct Additive
    if(addName && addW > 0) {
        const aWH = findSourceWH(addName);
        updates[`/${aWH}/${db.child(aWH).push().key}`] = {
            name: addName, amount: -addW, date: dV, ts: ts, note: '–í–∏–±—Ä–æ—Å—Ç–æ–ª –î–æ–±–∞–≤–∫–∞', fLink: vId
        };
    }

    // 3. Add Products - UPDATED LOGIC (GROUPING)
    items.forEach(i => {
        let dest = 'Stock_DV';
        let note = '–í–∏–±—Ä–æ—Å—Ç–æ–ª';
        let finalName = i.n; 

        if(i.type === 'DV') { 
            dest = 'Stock_DV'; 
            // DV keeps specific naming with weight: Name [50kg]
            finalName = (i.q > 0 ? `${i.n} [${i.w}–∫–≥]` : i.n);
        } else if(i.type === 'Semi') { 
            dest = 'Stock_Semi'; note = '–í–∏–±—Ä–æ –ü/–§'; 
            // Semi/Feed are grouped by name only, no weight suffix
        } else if(i.type === 'Feed') { 
            dest = 'Stock_Feed'; note = '–í–∏–±—Ä–æ –û—Ç—Ö–æ–¥—ã'; 
        }
        
        let amount = (i.q * i.w) + i.l;
        updates[`/${dest}/${db.child(dest).push().key}`] = {
            name: finalName,
            amount: amount, date: dV, ts: ts, note: note, fLink: vId
        };
    });

    // 4. Report
    updates[`/Vibro_Report/${vId}`] = {
        date: dV, ts: ts, link: vId,
        items: items, rawMix: rawDesc,
        timeStart: tS, timeEnd: tE, operator: op, assistant: as
    };

    await db.update(updates);
    logAction({type:'VIBRO', date:dV, items:items, rawMix:rawDesc, timeStart:tS, timeEnd:tE, operator:op, assistant:as});
    
    // REDIRECT TO HISTORY
    openModal('log');
}

// === NEW KRUP LOGIC (CONSTRUCTOR) ===
function updKrupRaw() {
    const wh = document.getElementById('kWH').value;
    let list = Array.from(new Set(gP(wh))).sort();
    document.getElementById('kRawCont').innerHTML = makeSmart('kRawItem', list, '–°—ã—Ä—å–µ');
}
function updKrupAdd() {
    const wh = document.getElementById('kAddWH').value;
    let list = Array.from(new Set(gP(wh))).sort();
    document.getElementById('kAddNameCont').innerHTML = makeSmart('kAddItem', list, '–î–æ–±–∞–≤–∫–∞');
}
function updKrupOutList() {
    const dest = document.getElementById('kDest').value;
    let wh = 'Stock_DV';
    if(dest === 'Semi') wh = 'Stock_Semi';
    if(dest === 'Feed') wh = 'Stock_Feed';
    let list = Array.from(new Set(gP(wh))).sort();
    document.getElementById('kOutNameCont').innerHTML = makeSmart('kOutN', list, '–ù–∞–∑–≤–∞–Ω–∏–µ');
}
function addKrupRow() {
    const n = getSmartVal('kOutN');
    const q = parseFloat(document.getElementById('kOutQ').value)||0;
    // ... Krup logic similar to Vibro ...
}

async function sCorr() {
    const btn = document.getElementById('btnS');
    const d = document.getElementById('cD').value;
    const a = parseFloat(document.getElementById('cA').value);
    const r = document.getElementById('cR').value;
    
    // USE CONTEXT
    const targetCat = corrCtx.cat;
    const targetName = corrCtx.name;
    
    if(!a || !r) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–ª-–≤–æ –∏ –ø—Ä–∏—á–∏–Ω—É');
    
    if(btn) btn.disabled = true;
    
    // CLOSE IMMEDIATELY
    closeModal();

    const dV = d + "T12:00:00Z";
    const updates = {};
    const key = db.child(targetCat).push().key;

    updates[`/${targetCat}/${key}`] = {
        name: targetName,
        amount: a,
        date: dV,
        ts: new Date().toISOString(),
        note: '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: ' + r
    };

    await db.update(updates);
    logAction({type:'CORR', date:dV, name:targetName, amount:a, reason:r});
    renderHome();
}

window.onload=renderHome;

// EXPOSE DELETE FUNCTIONS TO WINDOW SCOPE
window.delRec = async function(cat, id, sStr, restore) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
    await db.child(cat).child(id).remove();
    closeModal();
    alert('–£–¥–∞–ª–µ–Ω–æ');
};

window.delFas = (id) => window.delRec('–§–∞—Å–æ–≤–∫–∞', id);
window.delKrup = (id) => window.delRec('Krup_Report', id);
window.delVibro = (id) => window.delRec('Vibro_Report', id);
window.delZSHM = (id) => window.delRec('ZSHM_Report', id);
window.delArchRec = (cat, id) => window.delRec(cat, id);

</script></body></html>
