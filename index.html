<!DOCTYPE html><html lang="ru" translate="no"><head><meta charset="UTF-8"><meta name="google" content="notranslate"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>–°–∫–ª–∞–¥ v776</title><script>window.onerror=function(m,u,l){alert("ERR:"+m+"\nL:"+l);return!1}</script><link rel="icon" type="image/png" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png"><style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:0}
:root{--bg:#f8fafc;--p:#4338ca;--d:#dc2626;--s:#059669;--t:#000;--w:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:2px;padding-bottom:60px;color:var(--t);overflow-x:hidden;width:100vw}
#lockScreen{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:opacity .3s}
.lock-hidden{opacity:0;pointer-events:none}
.lock-logo{max-width:100%;height:auto;margin-bottom:20px}
.lock-title{font-size:16px;font-weight:900;color:#475569;letter-spacing:2px;margin-bottom:30px;text-transform:uppercase}
.lock-inp{width:100%;max-width:250px;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e1;border-radius:12px;margin-bottom:10px;font-weight:700;color:#000}
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;max-width:100%}
.dash-item{background:var(--w);border-radius:16px;padding:5px;text-align:center;box-shadow:0 4px 6px -1px #0000001a;color:var(--p);font-weight:800;text-transform:uppercase;font-size:11px;border:1px solid #cbd5e1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;position:relative}
.dash-item:active{transform:scale(.97);background:#eef2ff}
.card{background:var(--w);border-radius:16px;padding:10px;margin-bottom:6px;box-shadow:0 2px 4px -1px #00000014;border:1px solid #e2e8f0;position:relative;width:100%}
.btn-main{background:var(--p);color:#fff;border:none;width:100%;padding:12px;font-size:12px;font-weight:800;border-radius:12px;margin:4px 0;text-transform:uppercase;box-shadow:0 4px 10px #4338ca33;transition:.2s;cursor:pointer}
.btn-main:active{transform:translateY(1px);box-shadow:none}
.btn-main:disabled{background:#94a3b8;opacity:0.7}
.bottom-nav{display:none;position:fixed;bottom:5px;left:5px;right:5px;background:#fff;border-radius:20px;box-shadow:0 10px 40px -5px #00000033;padding:5px;z-index:900;grid-template-columns:1fr 1fr;gap:5px;border:1px solid #cbd5e1}
.nav-active .bottom-nav{display:grid}
.bottom-nav button{background:0 0;border:none;padding:10px;border-radius:14px;color:#64748b;font-weight:900;font-size:11px;text-transform:uppercase;transition:.2s}
.bottom-nav button.nav-btn-active{background:#e0e7ff;color:var(--p)}
input,select{width:100%;padding:0 5px;margin:2px 0;border:1px solid #94a3b8;border-radius:8px;font-size:12px;height:35px;background:#fff;font-weight:700;color:var(--t)}
input:focus,select:focus{border-color:var(--p);background:#f8fafc;outline:2px solid #e0e7ff}

.item-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px}
.item-card{background:#fff;border-radius:8px;padding:6px 2px;text-align:center;box-shadow:0 2px 5px #00000014;border:1px solid #cbd5e1;position:relative;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:0.2s}
.item-card:active{transform:scale(0.96)}
.item-title{font-size:8px;font-weight:900;text-transform:uppercase;color:var(--t);margin-bottom:2px;min-height:12px;height:auto;line-height:1.1;word-break:break-word}
.item-qty{font-size:12px;font-weight:900;color:var(--t);margin-bottom:2px}
.compact-grid .item-card{padding:3px 2px;min-height:30px}
.compact-grid .item-title{min-height:auto;margin-bottom:2px;font-size:8px;line-height:1}
.compact-grid .item-qty{font-size:11px;margin-bottom:0}

.tile-filled{background-color:#dcfce3!important;border-color:#22c55e!important}
.pulsing-price{display:block;text-align:center;color:#16a34a;font-weight:900;font-size:12px;text-shadow:0px 0px 2px rgba(255,255,255,0.9);animation:pulseP 1.5s infinite alternate;margin:2px 0}
@keyframes pulseP{0%{transform:scale(1);filter:brightness(1)}100%{transform:scale(1.1);filter:brightness(1.2);text-shadow:0px 0px 4px #22c55e}}

.corr-btn{display:none;width:100%;background:#fef3c7;border:1px solid #f59e0b;color:#d97706;border-radius:4px;font-weight:900;font-size:10px;padding:2px;margin-top:2px;cursor:pointer}
.show-corr .corr-btn{display:block}

.alarm-blink{background:#fee2e2!important;border:2px solid #ef4444!important;color:#b91c1c!important;animation:blink .8s infinite alternate}
@keyframes blink{0%{border-color:red;opacity:1}100%{border-color:#fca5a5;opacity:.6}}
.val-pos{color:#2563eb!important}.val-neg{color:#dc2626!important}

.modal{display:none;position:fixed;inset:0;background:#000000b3;z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-box{background:#fff;width:98%;max-width:400px;border-radius:16px;max-height:96vh;display:flex;flex-direction:column;overflow:hidden}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #e2e8f0;background:#fff;z-index:10}
.modal-body{overflow-y:auto;padding:10px;flex:1}
.rep-card{background:#fff;border-radius:16px;padding:8px 12px;margin-bottom:8px;box-shadow:0 2px 5px #0000000d;border:1px solid #e2e8f0}
.j-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px -1px #00000014;border:1px solid #e2e8f0}
.j-head{font-weight:900;font-size:13px;color:var(--p);margin-bottom:4px}
.logo-box{text-align:center;margin:15px 0}
.logo-img{max-width:100%;width:250px;height:auto;object-fit:contain}
.z-head{font-size:11px;color:#047857;font-weight:900;text-align:center;margin:10px 0 5px;background:#ecfdf5;padding:5px;border-radius:4px;border:1px solid #a7f3d0}
.cat-head{font-size:13px;font-weight:900;color:var(--p);margin:15px 0 5px;border-bottom:2px solid var(--p);text-transform:uppercase}
.grid-3{display:grid;grid-template-columns:1fr 1.5fr 1fr;gap:5px;margin-bottom:5px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:5px}
.grid-2x2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:5px}
.btn-sel{background:#f1f5f9;border:1px solid #cbd5e1;padding:8px;border-radius:8px;font-size:10px;font-weight:800;color:#475569;text-transform:uppercase;width:100%;transition:0.2s}
.btn-sel.active{background:#e0e7ff;border-color:var(--p);color:var(--p)}
.lbl-small{font-size:10px;font-weight:900;color:#64748b;margin-bottom:2px;display:block;text-transform:uppercase}
.head-wrap{transition:max-height .3s;overflow:hidden;max-height:500px}
.head-wrap.collapsed{max-height:0;margin:0;border:none}
.btn-top{position:absolute;top:10px;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:900;border:none;box-shadow:0 2px 5px rgba(0,0,0,0.15);z-index:100;cursor:pointer;text-transform:uppercase}
.btn-adm-off{left:10px;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1}
.btn-adm-on{left:10px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5}
.btn-exit{right:10px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5}
.ver-info{position:absolute;top:40px;left:15px;font-size:9px;color:#64748b;font-weight:900;z-index:100}
.mini-inv{width:100%;border-collapse:collapse;font-size:9px;margin-top:8px;cursor:pointer;background:#fafafa}
.mini-inv th,.mini-inv td{border:1px solid #ddd;padding:2px;text-align:center}

.fas-card, .ws-card {background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; margin-bottom: 8px;}
.fas-row {display: grid; grid-template-columns: 1fr 1.5fr 60px 30px; gap: 4px; margin-bottom: 5px; align-items: center;}
.fas-row-out {display: grid; grid-template-columns: 1.5fr 60px 1fr 30px; gap: 4px; margin-bottom: 5px; align-items: center;}
.fas-film-row {display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;}
.fas-inp, .ws-inp {height: 32px; font-size: 11px; padding: 0 4px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%;}
.fas-lbl, .ws-lbl {font-size: 9px; font-weight: 900; color: #64748b; margin-bottom: 2px; text-transform: uppercase; display: block;}
.conf-report {background: #fff; padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.5; border: 1px solid #e2e8f0; text-align: left; font-family: monospace;}
.conf-title {font-weight: 900; text-align: center; font-size: 14px; margin-bottom: 10px;}
.conf-sec {border-top: 1px dashed #cbd5e1; padding-top: 8px; margin-top: 8px;}
.conf-sec b {color: #047857;}

.ws-row-out {display: grid; grid-template-columns: 1.5fr 40px 60px 50px 30px; gap: 2px; margin-bottom: 5px; align-items: center;}

.inv-set-card {background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:10px;}
.inv-set-lbl {font-size:10px; font-weight:900; color:#64748b; margin-bottom:2px; display:block; text-transform:uppercase;}
.inv-preview-box {background:#fff; border:2px dashed #cbd5e1; border-radius:8px; padding:10px; margin-top:10px; overflow-x:auto;}

.month-group {border: 1px solid #cbd5e1; border-radius: 12px; margin-bottom: 8px; overflow: hidden; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.month-head {background: #f8fafc; padding: 12px 15px; font-weight: 900; font-size: 13px; color: var(--p); cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
.month-head:active {background: #f1f5f9;}
.month-body {display: none; padding: 10px; border-top: 1px solid #cbd5e1; background: #fff;}
.month-body.open {display: block;}

.dr-card {background:#fff; border-radius:12px; padding:10px; margin-bottom:10px; border:1px solid #e2e8f0; box-shadow:0 2px 4px rgba(0,0,0,0.05);}
.dr-sec {font-weight:900; font-size:13px; color:var(--p); border-bottom:2px solid #e2e8f0; padding-bottom:5px; margin-bottom:8px; text-transform:uppercase;}
.dr-sub {font-size:11px; font-weight:900; color:#475569; margin:10px 0 4px; background:#f1f5f9; padding:4px; border-radius:4px; text-transform:uppercase;}
.dr-row {font-size:12px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #f1f5f9; padding-bottom:4px; gap:10px;}
.dr-left {display:flex; align-items:baseline; gap:5px; flex-wrap:wrap;}
.dr-name {font-weight:700; color:#0f172a;}
.dr-qty {font-weight:900; color:var(--p);}
.dr-hint {font-size:10px; color:#64748b; font-weight:800; text-align:right;}

#print-view{display:none;background:#fff;width:100%;height:100%;position:fixed;top:0;left:0;z-index:9999;padding:10px;overflow-y:auto;color:#000}

@media print{
  html, body { height: auto !important; overflow: visible !important; margin: 0; padding: 0; }
  body > * { display: none !important; }
  #print-view { display: block !important; position: relative !important; width: 100%; height: auto !important; margin: 0; padding: 0; }
  
  .pr-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:9px;table-layout:fixed}
  .pr-table thead{display:table-header-group!important}
  .pr-table tbody{display:table-row-group!important}
  .pr-table tr{display:table-row!important}
  .pr-table th{padding:1px;text-align:center;vertical-align:middle;line-height:1}
  .pr-table td{padding:0;text-align:center;vertical-align:middle;line-height:1;overflow:hidden;white-space:nowrap}
  .pr-table th:nth-child(1),.pr-table td:nth-child(1){width:5%}
  .pr-table th:nth-child(2),.pr-table td:nth-child(2){width:55%;text-align:left!important;padding-left:2px;white-space:normal;word-wrap:break-word}
  .pr-table th:nth-child(3),.pr-table td:nth-child(3){width:10%}
  .pr-table th:nth-child(4),.pr-table td:nth-child(4){width:5%}
  .pr-table th:nth-child(5),.pr-table td:nth-child(5){width:10%}
  .pr-table th:last-child,.pr-table td:last-child{width:15%}
  .t-row td{border:none!important;padding-top:6px!important;height:auto!important}
  .t-lbl{text-align:right!important;padding-right:4px!important;font-weight:900;font-size:10px}
  .t-box{font-weight:900!important;font-size:10px!important;padding:2px!important}
  
  .dr-print-wrap {display:flex; width:100%; gap:15px; font-size:12px; color:#000; line-height:1.3;}
  .dr-print-col {flex:1; width:50%;}
  .dr-card {box-shadow:none; border:none; margin-bottom:15px; padding:0;}
  .dr-sec {border-bottom:2px solid #000; color:#000; padding-bottom:2px; margin-bottom:6px; font-size:14px;}
  .dr-sub {background:none; border-bottom:1px dashed #000; padding:0; border-radius:0; color:#000; margin-top:8px;}
  .dr-row {border-bottom:1px dashed #ccc; margin-bottom:4px; padding-bottom:3px; display:flex; justify-content:space-between;}
  .dr-hint {color:#555; margin-left:5px;}
  .dr-qty {color:#000;}
}
@media(min-width:800px){body,.bottom-nav,#lockScreen{max-width:500px;margin:0 auto;left:auto;right:auto;transform:none}}
</style></head>
<body>
<div id="lockScreen"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo"><div class="lock-title">–£–ß–ï–¢</div><input type="email" id="appEmail" class="lock-inp" placeholder="Email"><input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-main" style="max-width:250px" onclick="tryLogin()">–í–û–ô–¢–ò</button><div id="loginStatus" style="margin-top:10px;color:#64748b;font-weight:700"></div></div>
<div id="act"></div><div id="cnt"></div>
<div class="bottom-nav"><button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button><button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button></div>
<div id="mdl" class="modal"><div class="modal-box"><div class="modal-header"><h4 id="mT" style="margin:0;font-size:15px;font-weight:900"></h4><button onclick="closeModal()" style="border:none;background:#fee2e2;color:#dc2626;font-size:12px;font-weight:900;padding:8px 14px;border-radius:8px;cursor:pointer">‚úï –ó–ê–ö–†–´–¢–¨</button></div><div id="mB" class="modal-body"></div></div></div>
<div id="confMdl" class="modal"><div id="confBox" class="modal-box" style="text-align:center;padding:20px"><h3 style="margin:0 0 10px">–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï</h3><div id="confContent" class="conf-report" style="max-height:60vh;overflow-y:auto;margin-bottom:15px"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="closeConf()" style="background:#ccc;color:#333">–ù–ï–¢</button><button class="btn-main" onclick="doConfirm()" style="background:green">–î–ê</button></div></div></div>
<div id="print-view"></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
const WS_CFG={'VIBRO':{title:'–í–ò–ë–†–û–°–¢–û–õ',db:'Vibro_Report',prefix:'v',note:'–í—ñ–±—Ä–æ'},'KRUP':{title:'–ö–†–£–ü–û–†–£–®–ö–ê',db:'Krup_Report',prefix:'k',note:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞'},'ZSHM':{title:'–ó–®–ú',db:'ZSHM_Report',prefix:'z',note:'–ó–®–ú'}};
const D=document,gID=i=>D.getElementById(i);
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();
let cur='Home',data={},aId=null,archSub='',corrMode=!1,isLogged=!1,isAdmin=!1,corrCtx={},useStretch=!1,shipBasket={},pendingAction=null,priceMode='opt',priceEdit=!1;

let invSet = { 
  tblBrd: true, vLin: true, hLin: true, fSize: '11px', 
  colW: '5,55,10,5,10,15', rowH: '14px',
  xtraTop: '<b>–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ [–ù–û–ú–ï–†] –≤—ñ–¥ [–î–ê–¢–ê] —Ä.</b>\\n\\n–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: [–ü–û–°–¢–ê–í–©–ò–ö]\\n–ü–æ–∫—É–ø–µ—Ü—å: [–ö–õ–ò–ï–ù–¢]\\n–î–æ–≥–æ–≤—ñ—Ä: [–°–î–ï–õ–ö–ê]', 
  xtraBot: '–í—Å—å–æ–≥–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω—å: [–ö–û–õ_–í–û_–ü–û–ó–ò–¶–ò–ô] –Ω–∞ —Å—É–º—É: [–û–ë–©–ê–Ø_–°–£–ú–ú–ê]\\n<b>–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏: [–°–£–ú–ú–ê_–ü–†–û–ü–ò–°–¨–Æ]</b>\\n\\n–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: __________________          –ü—Ä–∏–π–Ω—è–≤: __________________' 
}; 

const stockCatsAll=['Stock_DV','Stock_Semi','Stock_Feed','Stock_Raw','WeightStock','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','Timesheet','PriceList','Suppliers','ArchInvoices','ArchIncoming','ArchPackIn','InvoiceSettings'];

function closeModal(){gID('mdl').style.display='none';}
function closeConf(){gID('confMdl').style.display='none';pendingAction=null;}
function doConfirm(){if(pendingAction)pendingAction();} 

auth.onAuthStateChanged(u=>{if(u){gID('lockScreen').classList.add('lock-hidden');D.body.classList.add('nav-active');isLogged=!0;if(localStorage.getItem('admT')==='1')isAdmin=!0;initAppData()}else{gID('lockScreen').classList.remove('lock-hidden');D.body.classList.remove('nav-active');isLogged=!1;isAdmin=!1;gID('cnt').innerHTML='';data={}}});

function initAppData(){
  renderHome();
  stockCatsAll.forEach(p=>{
    db.child(p).on('value',s=>{
      data[p]=s.val()||{};
      if(p==='InvoiceSettings' && data[p].xtraTop!==undefined){ invSet=data[p]; }
      if(cur!=='Home') loadData();
    })
  });
  db.child('Timesheet').on('value',s=>{data.Timesheet=s.val()||{}});
}

function tryLogin(){const e=gID('appEmail').value,p=gID('appPass').value;if(!e||!p)return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message))}
function tryAdmin(){if(isAdmin){isAdmin=!1;localStorage.removeItem('admT');corrMode=!1;renderHome();return alert('–ê–¥–º–∏–Ω –≤—ã–∫–ª—é—á–µ–Ω')}const p=prompt('–ü–∞—Ä–æ–ª—å:');if(p==='3011'){isAdmin=!0;localStorage.setItem('admT','1');renderHome();alert('–ê–¥–º–∏–Ω –≤–∫–ª—é—á–µ–Ω')}}
const esc = s => s ? String(s).replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';

function renderHome(){if(!isLogged)return;cur='Home';D.body.classList.remove('nav-active');gID('act').innerHTML='';
 const adm=isAdmin?`<button onclick="tryAdmin()" class="btn-top btn-adm-on">–ê–î–ú–ò–ù –í–ö–õ</button>`:`<button onclick="tryAdmin()" class="btn-top btn-adm-off">–ê–î–ú–ò–ù</button>`;
 const ver=`<div class="ver-info">v 777<br>${document.lastModified}</div>`;
 gID('cnt').innerHTML=adm+ver+`<button onclick="firebase.auth().signOut()" class="btn-top btn-exit">–í–´–•–û–î</button>
 <div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div>
 <div class="dash-grid">
  <div class="dash-item" onclick="setCat('StockRoot')"><span>üìÇ –°–ö–õ–ê–î</span></div>
  <div class="dash-item" onclick="setCat('ProdSub')"><span>üõ†Ô∏è –ü–†–û–ò–ó–í–û–î–°–¢–í–û</span></div>
  <div class="dash-item" onclick="setCat('Timesheet')"><span>üìÖ –¢–ê–ë–ï–õ–¨</span></div>
  <div class="dash-item" onclick="setCat('Consolidated')"><span>üìä –°–í–û–î–ù–´–ô</span></div>
  <div class="dash-item" onclick="setCat('PriceList')"><span>üí∞ –ü–†–ê–ô–°</span></div>
 </div>`;updNav()}

function goBack(){const m={'StockArchive':'Stock_Raw','TsCal':'Timesheet','Timesheet':'Home','StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','PackSub':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'PackSub','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'PackSub','ArchPackIn':'PackSub','Consolidated':'Home','PriceList':'Home','InvSettings':'Invoices'};let n=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')n=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(n)}
function updNav(){gID('navM').className=cur==='Home'?'nav-btn-active':'';gID('navB').className=cur!=='Home'?'nav-btn-active':''}
function ensureData(p){if(!Array.isArray(p))p=[p];p.forEach(x=>{if(!data[x])db.child(x).on('value',s=>{data[x]=s.val()||{};loadData()})})}

function setCat(c){cur=c;D.body.classList.add('nav-active');gID('act').innerHTML='';const ct=gID('cnt');
 if(c==='Home'){renderHome();return}
 if(['Invoices','ArchSubIn','ArchSubOut'].includes(c))ensureData(['ArchIncoming','ArchInvoices']);
 if(['ProdSub','–§–∞—Å–æ–≤–∫–∞','Kruporushka','Vibro','ZSHM'].includes(c))ensureData(['–§–∞—Å–æ–≤–∫–∞','Krup_Report','Vibro_Report','ZSHM_Report']);
 if(c==='StockArchive')ensureData('Stock_Archive');if(['PackSub','ArchPackIn'].includes(c))ensureData('ArchPackIn');
 if(c==='Timesheet'){const td=new Date().toISOString().split('T')[0];
  if(isAdmin){ct.innerHTML=`<div class="card"><div style="text-align:center;font-weight:900;margin-bottom:10px">–¢–ê–ë–ï–õ–¨</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><input type="date" id="gTD" value="${td}"><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px"><input type="time" id="gTS" value="08:00"><input type="time" id="gTE" value="17:00"></div></div><div id="tsRows"></div><button class="btn-main" onclick="addTimeRow()" style="background:#fff;color:var(--p);border:1px solid #ccc">+ –ß–ï–õ–û–í–ï–ö–ê</button><button class="btn-main" onclick="saveTimesheetBatch()">–°–û–•–†–ê–ù–ò–¢–¨</button></div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–†–¨</button>`;setTimeout(()=>{const s=localStorage.getItem('activeCrew');if(s){const n=JSON.parse(s);if(n.length)n.forEach(x=>typeof x==='object'?addTimeRow(x.name,x.rate):addTimeRow(x));else addTimeRow()}else addTimeRow()},50)}
  else ct.innerHTML=`<div class="z-head">–¢–ê–ë–ï–õ–¨</div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–†–¨</button>`
 }
 else if(c==='TsCal'){ct.innerHTML=`<div class="z-head">–í–´–ë–ï–†–ò–¢–ï</div><div id="tsList" class="item-grid"></div>`;loadData()}
 else if(c==='StockRoot'){
  let b=isAdmin?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><button class="btn-main" style="background:var(--s);margin:0" onclick="openModal('inc')">üì• –ü–†–ò–•–û–î</button><button class="btn-main" style="background:var(--d);margin:0" onclick="openModal('ship')">üöö –û–¢–ì–†–£–ó–ö–ê</button></div><button class="btn-main" id="corrTile" onclick="toggleCorr()" style="background:#fff;color:var(--p);border:1px solid var(--p);margin-bottom:15px">üîß –ö–û–†–†–ï–ö–¶–ò–Ø</button>`:'';
  ct.innerHTML=`${b}<div class="dash-grid"><div class="dash-item" onclick="setCat('StockList')">–§–ê–°–û–í–ê–ù–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø</div><div class="dash-item" onclick="setCat('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø</div><div class="dash-item" onclick="setCat('Stock_DV')">–î–í –í–ï–°</div><div class="dash-item" onclick="setCat('Stock_Feed')">–û–¢–•–û–î–´ –ü–†–û–ò–ó–í–û–î–°–¢–í–ê</div><div class="dash-item" onclick="setCat('Stock_Raw')">–°–´–†–¨–ï</div><div class="dash-item" onclick="setCat('Stock_Semi')">–ü/–§</div><div class="dash-item" onclick="setCat('PackSub')">–£–ü–ê–ö–û–í–ö–ê</div><div class="dash-item" onclick="setCat('Invoices')">–ê–†–•–ò–í</div></div><div id="corrCtls" style="margin-top:15px;display:flex;gap:5px;justify-content:center"></div>`
 }
 else if(c==='Stock_Raw'){ct.innerHTML=(isAdmin?`<button class="btn-main" style="background:#e0f2fe;color:#0369a1;margin-bottom:10px" onclick="setCat('StockArchive')">üóÑÔ∏è –ê–†–•–ò–í</button>`:'')+`<div class="z-head">–°–´–†–¨–ï</div><div id="rawList">...</div>`;if(isAdmin&&!corrMode)gID('act').innerHTML=`<button class="btn-main" style="background:var(--s);padding:8px" onclick="openModal('addRaw')">–ü–†–ò–•–û–î</button>`}
 else if(c==='PackSub'){if(isAdmin)gID('act').innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü–†–ò–•–û–î</button>`;ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–õ–ï–ù–ö–ê</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–ê–ö–ï–¢–´</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–ö–û–¢–ß</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–ï–®–ö–ò</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–ò–¢–ö–ò</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–≠–¢–ò–ö–ï–¢–ö–ê</div><div class="dash-item" onclick="setCat('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')">–°–¢–†–ï–ô–ß</div><div class="dash-item" onclick="setCat('–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')">–¢–ï–†–ú–û</div><div class="dash-item" onclick="setCat('ArchPackIn')" style="background:#f1f5f9;color:#64748b">–ê–†–•–ò–í</div></div>`}
 else if(c==='ProdSub'){ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–§–ê–°–û–í–ö–ê</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö–†–£–ü–û–†–£–®–ö–ê</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í–ò–ë–†–û–°–¢–û–õ</div></div>`;if(isAdmin)ct.innerHTML+=`<button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–û–î –°–´–†–¨–Ø</button>`}
 else if(c==='–§–∞—Å–æ–≤–∫–∞'){
  gID('act').innerHTML=`<div style="display:grid;grid-template-columns:${isAdmin?'1fr 1fr':'1fr'};gap:5px;padding:4px"><button class="btn-main" style="background:#475569;margin:0" onclick="setCat('ProdSub')">‚¨Ö –ù–ê–ó–ê–î</button>${isAdmin?`<button class="btn-main" style="background:var(--p);margin:0" onclick="openModal('fas')">–ù–û–í–´–ô</button>`:''}</div>`;
 }
 else if(['Kruporushka','Vibro','ZSHM'].includes(c)){
  const k={'Kruporushka':'KRUP','Vibro':'VIBRO','ZSHM':'ZSHM'}[c];
  gID('act').innerHTML=`<div style="display:grid;grid-template-columns:${isAdmin?'1fr 1fr':'1fr'};gap:5px;padding:4px"><button class="btn-main" style="background:#475569;margin:0" onclick="setCat('ProdSub')">‚¨Ö –ù–ê–ó–ê–î</button>${isAdmin?`<button class="btn-main" style="background:var(--p);margin:0" onclick="openModal('workshop','${k}')">–ù–û–í–´–ô</button>`:''}</div>`;
 }
 else if(c==='PriceList'){ct.innerHTML='<div class="z-head">üí∞ –ü–†–ê–ô–°</div><div id="priceListCont">...</div>';rPriceList(gID('priceListCont'))}
 else if(c==='Invoices'){
  ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü–†–ò–•–û–î–´</div><div class="dash-item" onclick="setCat('ArchSubOut')">–û–¢–ì–†–£–ó–ö–ò</div></div>` + (isAdmin ? `<button class="btn-main" onclick="openModal('invSet')" style="background:#e0f2fe;color:#0369a1;margin-top:15px;border:1px dashed #0369a1">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ü–ï–ß–ê–¢–ò</button>` : ``);
 }
 else if(['ArchSubIn','ArchSubOut'].includes(c)){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ü–û –î–ê–¢–ï</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ü–û –ò–ú–ï–ù–ò</div></div>`}
 else if(c==='Consolidated'){ct.innerHTML='<div style="text-align:center;padding:20px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';loadData()}
 else if(c==='StockArchive'){ct.innerHTML='<div class="z-head">–ê–†–•–ò–í –°–´–†–¨–Ø</div><div id="archRawList">...</div>';loadData()}
 loadData();updCorrBtn();updNav()
}
function loadData(){const c=gID('cnt');if(['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub','Timesheet'].includes(cur))return;
 if(cur==='Stock_Raw')rRaw(gID('rawList'));else if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(['Kruporushka','Vibro','ZSHM'].includes(cur))rWorkshopList(c,{'Kruporushka':'KRUP','Vibro':'VIBRO','ZSHM':'ZSHM'}[cur]);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Consolidated')rConsolidated(c);else if(cur==='TsCal')renderTsList(c);else if(cur==='PriceList')rPriceList(gID('priceListCont'));else if(cur==='StockArchive')rRawArch(gID('archRawList'));else rGen(c)}

const gP=c=>{
 let i=[];
 if(c==='WeightStock')i=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1 —Ñ—Ä","–ê—Ä–Ω–∞—É—Ç–∫–∞ 2 —Ñ—Ä","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"];
 else if(c==='–ì–æ—Ç–æ–≤–∞—è')i=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 1","–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 2","–ê—Ä—Ç–µ–∫ 1/0.9","–ë–∞—Å–º–∞—Ç–∏ –≥–æ–ª–¥ 1/0.8","–ë–∞—Å–º–∞—Ç–∏ 1/0.8","–ë—É–ª–≥—É—Ä 1/0.4","–ì–æ—Ä–æ—Ö 1/0.9","–ì—Ä–µ—á–∫–∞ 1/0.9","–ö—É–∫—É—Ä—É–∑–∞ 1/0.9","–ö—É–∫.–º—É–∫–∞ 1/0.5","–ö—É—Å –∫—É—Å 1/0.4","–ö—É—Ç—è 1/0.5","–ú–∞–Ω–∫–∞ 1/0.8","–ù—É—Ç 1/0.4","–ü–µ—Ä–ª–æ–≤–∫–∞ 1/0.9","–ü—à–µ–Ω–∏—á–∫–∞ 1/0.9","–ü—à–æ–Ω–æ 1/0.9","–†–∏—Å –¥–ª 1/0.9","–†–∏—Å –∫—Ä 1/0.9","–†–∏—Å –ø—Ä 1/0.9","–•–ª–æ–ø—å—è 1/0.5","–ß–µ—á–µ–≤–∏—Ü–∞ 1/0.4","–Ø—á–∫–∞ 1/0.9"];
 const s=new Set(i),k=c==='WeightStock'?'WeightStock':(c==='Stock_DV'?'Stock_DV':(c==='Stock_Feed'?'Stock_Feed':(c==='Stock_Raw'?'Stock_Raw':(c==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è'))));
 if(data[k])Object.values(data[k]).forEach(v=>{if(v.name)s.add(v.name)});
 return Array.from(s).filter(x=>x).sort();
};
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort()},gPackS=()=>{const s=new Set();if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.supplier)s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()},gBuyS=()=>{const s=new Set();if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.supplier&&v.type==='GOODS')s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const toggleCorr=()=>{if(!isAdmin)return;corrMode=!corrMode;updCorrBtn();loadData()},updCorrBtn=()=>{const t=gID('corrTile');if(t){t.innerText=corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'üîß –ö–û–†–†–ï–ö–¶–ò–Ø';t.style.background=corrMode?'#fef3c7':'#fff';t.style.color=corrMode?'#d97706':'var(--p)'}const c=gID('corrCtls');if(c)c.innerHTML=''};

function getPrintName(n){if(data.PriceList){const p=Object.values(data.PriceList).find(x=>x.name===n);if(p&&p.printName)return p.printName}return n}
function rMonthGroup(list, renderRowFn) {
 if(!list.length) return '<div style="text-align:center;color:#999;padding:20px">–ü—É—Å—Ç–æ</div>';
 const groups = {};
 const curM = new Date().toISOString().substring(0,7);
 list.forEach(item => {
  const m = (item._date || item.date || '2000-01').substring(0,7);
  if(!groups[m]) groups[m] = [];
  groups[m].push(item);
 });
 const mN = {'01':'–Ø–Ω–≤–∞—Ä—å','02':'–§–µ–≤—Ä–∞–ª—å','03':'–ú–∞—Ä—Ç','04':'–ê–ø—Ä–µ–ª—å','05':'–ú–∞–π','06':'–ò—é–Ω—å','07':'–ò—é–ª—å','08':'–ê–≤–≥—É—Å—Ç','09':'–°–µ–Ω—Ç—è–±—Ä—å','10':'–û–∫—Ç—è–±—Ä—å','11':'–ù–æ—è–±—Ä—å','12':'–î–µ–∫–∞–±—Ä—å'};
 let h = '';
 Object.keys(groups).sort((a,b)=>b.localeCompare(a)).forEach(m => {
  const [yy, mm] = m.split('-');
  const title = `${mN[mm]} ${yy}`;
  const isOpen = (m === curM) ? 'open' : '';
  h += `<div class="month-group"><div class="month-head" onclick="this.nextElementSibling.classList.toggle('open')"><span>üìÖ ${title}</span><span>‚ñº</span></div><div class="month-body ${isOpen}">${groups[m].map(renderRowFn).join('')}</div></div>`;
 });
 return h;
}

function showH(c,n){
 const d=data[c]||{},r=[];Object.entries(d).forEach(([k,v])=>{if(v.name===n)r.push({...v,id:k,_date:v.date.split('T')[0]})});
 r.sort((a,b)=>{if(a._date!==b._date)return b._date.localeCompare(a._date);return b.id.localeCompare(a.id);});
 let h=`<div style="font-weight:900;text-align:center;margin-bottom:10px">${n}</div>`;
 if(['Stock_Raw','Stock_Archive'].includes(c)){
  const l=r[0]||r.find(x=>x.amount>0);
  let btns = '';
  if(l) btns+=`<button class="btn-main" onclick="genBatchReport('${c}','${esc(n)}','${l.date}',${l.amount})" style="background:#0f172a;font-size:10px;margin:0;width:auto;flex:1">üìÑ –û–¢–ß–ï–¢ –ü–ê–†–¢–ò–ò</button>`;
  if(isAdmin && c==='Stock_Raw') btns+=`<button class="btn-main" onclick="archiveRawBatch('${esc(n)}')" style="background:#e0f2fe;color:#0369a1;font-size:10px;margin:0;width:auto;flex:1;border:1px solid #bae6fd">üì¶ –í –ê–†–•–ò–í</button>`;
  if(btns) h+=`<div style="display:flex;gap:5px;margin-bottom:10px">${btns}</div>`;
 }
 h+=rMonthGroup(r, v=>{const cl=v.amount>=0?'val-pos':'val-neg',s=v.amount>0?'+':'';return `<div class="rep-card"><div style="display:flex;justify-content:space-between"><div><div style="font-weight:900;font-size:12px">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div class="${cl}" style="font-weight:900;font-size:14px">${s}${parseFloat(v.amount.toFixed(2))}</div></div>${(isAdmin||corrMode)?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;color:red">üóëÔ∏è</button>`:''}</div><div style="font-size:11px;color:#666">${v.note||'-'}</div></div>`});
 gID('mT').innerText='–ò–°–¢–û–†–ò–Ø';gID('mB').innerHTML=h;gID('mdl').style.display='flex'
}

function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card" onclick="if(!corrMode)showH('–ì–æ—Ç–æ–≤–∞—è','${esc(n)}')"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><button class="corr-btn" onclick="event.stopPropagation();openModal('corr','–ì–æ—Ç–æ–≤–∞—è','${esc(n)}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card" onclick="if(!corrMode)showH('WeightStock','${esc(n)}')"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><button class="corr-btn" onclick="event.stopPropagation();openModal('corr','WeightStock','${esc(n)}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rRaw(c){const t={};if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card" onclick="if(!corrMode)showH('Stock_Raw','${esc(n)}')"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><button class="corr-btn" onclick="event.stopPropagation();openModal('corr','Stock_Raw','${esc(n)}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rGen(c){const d=data[cur]||{},t={};Object.values(d).forEach(v=>{if(v.name)t[v.name]=(t[v.name]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const v=t[k];let a=v<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&v<50)a=!0;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&v<30)a=!0;if(cur==='–ü–∞–∫–µ—Ç—ã'&&v<3000)a=!0;let u='–∫–≥',dv=Math.round(v);if(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(cur))u='—à—Ç';if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')dv=v.toFixed(1);if(cur==='–ü–ª–µ–Ω–∫–∞'){dv=v.toFixed(2);u='–∫–≥'}h+=`<div class="item-card ${a?'alarm-blink':''}" onclick="if(!corrMode)showH('${cur}','${esc(k)}')"><div class="item-title">${k}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${dv}<small style="font-size:10px">${u}</small></div><button class="corr-btn" onclick="event.stopPropagation();openModal('corr','${cur}','${esc(k)}')">¬±</button></div>`});c.innerHTML=h+'</div>'}

function rFas(c){
 const d=data['–§–∞—Å–æ–≤–∫–∞']||{}, l=Object.entries(d).map(([id,v])=>({...v, id, _date: v.date.split('T')[0]})).sort((a,b)=>{if(a._date!==b._date)return b._date.localeCompare(a._date);return b.id.localeCompare(a.id);});
 c.innerHTML = rMonthGroup(l, v => {
  const dt=v.date.split('T')[0].split('-').reverse().join('.');
  const mName=v.filmName||(v.outputItems&&v.outputItems[0]?v.outputItems[0].name:'-');
  let rRaw=''; if(v.items)v.items.forEach(x=>{rRaw+=`<div style="display:flex;justify-content:space-between"><span>${x.name}</span><span>${x.amount}–∫–≥ <span style="color:#94a3b8;font-size:9px">(${x.source==='WeightStock'?'–ø–æ–∫.–ø—Ä':'–î–í –≤–µ—Å'})</span></span></div>`});
  let rOut=''; let pk=0, sz=''; if(v.outputItems)v.outputItems.forEach(x=>{rOut+=`<div style="display:flex;justify-content:space-between"><span>${x.name}</span><span>${x.count}—à—Ç</span></div>`; pk+=x.count; if(!sz) sz=x.size;});
  let packs=0; if(v.outputItems && v.outputItems.length>0) { const k=v.outputItems[0].name==="–ö—É—Ç—è"?19.8:9.9; packs=Math.round(pk/k); }
  const vt=v.vzial?String(v.vzial).split('+').reduce((a,b)=>a+parseFloat(b)||0,0):0;
  let filmUsed = Math.abs(vt - (v.ostatok||0));
  return `<div class="conf-report" style="margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05)">
   <div style="display:flex;justify-content:space-between;font-weight:900;font-size:14px;border-bottom:2px solid #e2e8f0;padding-bottom:5px;margin-bottom:5px"><span>${dt}</span><span style="color:var(--p)">${mName}</span></div>
   <div class="conf-sec" style="margin-top:0;border:none"><b>—Å—ã—Ä—å–µ:</b></div>${rRaw}
   <div class="conf-sec"><b>–≥–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è:</b></div>${rOut}
   <div class="conf-sec"><b>—Ä–∞—Å—Ö–æ–¥ —É–ø–∞–∫–æ–≤–∫–∏:</b></div>
   <div style="display:flex;justify-content:space-between"><span>–ü–∞–∫–µ—Ç—ã: ${sz||'-'}</span><span>${packs}—à—Ç</span></div>
   <div style="display:flex;justify-content:space-between"><span>–ü–ª–µ–Ω–∫–∞: ${mName}</span><span>${filmUsed.toFixed(2)}–∫–≥</span></div>
   ${isAdmin?`<button onclick="delRec('–§–∞—Å–æ–≤–∫–∞','${v.id}')" style="color:red;border:1px solid #fca5a5;background:#fee2e2;padding:6px;border-radius:8px;margin-top:10px;width:100%;font-weight:900;cursor:pointer">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`;
 });
}

function rWorkshopList(c,k){
 const dbN=WS_CFG[k].db, d=data[dbN]||{};
 const l=Object.entries(d).map(([id,v])=>({...v, id, _date: (v.date||'2000-01-01').split('T')[0]})).sort((a,b)=>{if(a._date!==b._date)return b._date.localeCompare(a._date);return b.id.localeCompare(a.id);});
 
 c.innerHTML = rMonthGroup(l, v => {
  const dt=(v.date||'').split('T')[0].split('-').reverse().join('.');
  const tStart = v.timeStart||'08:00', tEnd = v.timeEnd||'17:00';
  const op = v.operator||'-', as = v.assistant||'-';
  
  let hRaw = ''; let totalRaw = 0;
  if(v.rawBase) { 
   hRaw += `<div>–û—Å–Ω–æ–≤–∞: ${v.rawBase.n} ${v.rawBase.w}–∫–≥</div>`; totalRaw += v.rawBase.w; 
  } else if(v.rawMix) { 
   hRaw += `<div>–û—Å–Ω–æ–≤–∞ (—Å—Ç–∞—Ä–∞—è): ${v.rawMix}</div>`; 
   let matches = String(v.rawMix).match(/\d+(?:\.\d+)?/g);
   if(matches) { matches.forEach(num => totalRaw += parseFloat(num)); }
  }
  
  if(v.rawAdd && v.rawAdd.length) {
   v.rawAdd.forEach(x => { hRaw += `<div>–î–æ–±–∞–≤–∫–∞: ${x.n} ${x.w}–∫–≥</div>`; totalRaw += x.w; });
  }
  
  let hOutDV='', hOutSemi='', hOutFeed=''; let totalDV = 0;
  if(v.items) {
   v.items.forEach(x => {
    let q = x.q || 0, w = x.w || 0, l = x.l || 0;
    let typ = x.type || 'DV';
    let wght = (q * w) + l;
    if(!wght && x.amount) wght = parseFloat(x.amount)||0;
    
    let row = '';
    if(q && w) row = `<div>${x.n||x.name} ${q}–º√ó${w}–∫–≥${l?'+'+l+'–∫–≥':''}</div>`;
    else row = `<div>${x.n||x.name} ${wght}–∫–≥</div>`;
    
    if(typ==='DV') { hOutDV += row; totalDV += wght; }
    else if(typ==='Semi') hOutSemi += row;
    else if(typ==='Feed') hOutFeed += row;
   });
  }
  let outBlock = '';
  if(hOutDV) outBlock += `<div class="conf-sec"><b>–î–í –≤–µ—Å:</b></div>${hOutDV}`;
  if(hOutSemi) outBlock += `<div class="conf-sec"><b>–ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç:</b></div>${hOutSemi}`;
  if(hOutFeed) outBlock += `<div class="conf-sec"><b>–æ—Ç—Ö–æ–¥—ã:</b></div>${hOutFeed}`;
  
  let percent = totalRaw > 0 ? ((totalDV / totalRaw) * 100).toFixed(1) : 0;
  
  return `<div class="conf-report" style="margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05)">
   <div style="text-align:center;font-weight:900;color:var(--p);font-size:14px;margin-bottom:5px">${WS_CFG[k].title}</div>
   <div style="display:flex;justify-content:space-between;border-bottom:2px solid #e2e8f0;padding-bottom:5px;margin-bottom:5px"><span style="font-weight:900">${dt}</span><span>${tStart}-${tEnd}</span></div>
   <div style="text-align:center;margin-bottom:5px">${op} | ${as}</div>
   <div class="conf-sec" style="margin-top:0;border:none"><b>—Å—ã—Ä—å–µ:</b></div>${hRaw}
   ${outBlock}
   <div class="conf-sec" style="font-weight:900;display:flex;justify-content:space-between"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É:</span><span>${totalRaw}–∫–≥</span></div>
   <div style="font-weight:900;display:flex;justify-content:space-between;color:var(--s)"><span>–í—ã—Ö–æ–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏:</span><span>${percent}%</span></div>
   ${isAdmin?`<button onclick="delRec('${dbN}','${v.id}')" style="color:red;border:1px solid #fca5a5;background:#fee2e2;padding:6px;border-radius:8px;margin-top:10px;width:100%;font-weight:900;cursor:pointer">–£–î–ê–õ–ò–¢–¨</button>`:''}
  </div>`;
 });
}

function rArchPack(c){
 const d=data.ArchPackIn||{}; const l=Object.entries(d).map(([id,v])=>({...v, id, _date: v.date.split('T')[0]})).sort((a,b)=>{if(a._date!==b._date)return b._date.localeCompare(a._date);return b.id.localeCompare(a.id);});
 c.innerHTML = rMonthGroup(l, v => `<div class="j-card"><div class="j-head">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div>${v.name} (${v.amount})</div><div>${v.supplier}</div>${isAdmin?`<button onclick="delRec('ArchPackIn','${v.id}')" style="color:red;border:none;background:0 0">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`);
}

function rInvD(c){rInvGen(c,'date')}
function rInvC(c){rInvGen(c,'client')}
function rInvGen(c,key){
 const k=archSub==='In'?'ArchIncoming':'ArchInvoices', d=data[k]||{};
 const l=Object.entries(d).map(([id,v])=>({...v, id, _date: v.date.split('T')[0]})).sort((a,b)=>{if(a._date!==b._date)return b._date.localeCompare(a._date);return b.id.localeCompare(a.id);});
 c.innerHTML = rMonthGroup(l, v => {
  const i = v.id;
  if(k==='ArchInvoices'){
   let rows='';
   if(v.items)v.items.forEach((it,idx)=>{if(idx<4){const p=it.split('|');rows+=`<tr><td>${idx+1}</td><td style="text-align:left">${getPrintName(p[0]).substring(0,12)}..</td><td>${p[1]}</td><td>${parseFloat(p[5]).toFixed(2)}</td></tr>`}});
   if(v.items&&v.items.length>4)rows+=`<tr><td colspan="4">...</td></tr>`;
   return `<div class="j-card" onclick="viewInvoice('${i}')" style="padding:8px">
    <div class="j-head" style="font-size:11px">${v.date.split('T')[0].split('-').reverse().join('.')} | ‚Ññ${v.num||'-'}</div>
    <div style="font-size:11px;font-weight:700;margin-bottom:2px">${v.client||'-'}</div>
    <table class="mini-inv"><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–°—É–º–º–∞</th></tr>${rows}</table>
    <div style="text-align:right;font-size:10px;font-weight:900;margin-top:4px">–í—Å–µ–≥–æ: ${parseFloat(v.totalSum||0).toFixed(2)}</div>
    ${isAdmin?`<button onclick="event.stopPropagation();delRec('${k}','${i}')" style="color:red;border:none;background:0 0;margin-top:5px;width:100%">–£–î–ê–õ–ò–¢–¨</button>`:''}
   </div>`;
  }else{
   let itmsHtml = '';
   if(v.items) {
       v.items.forEach(x => { itmsHtml += `<div style="font-size:12px;display:flex;justify-content:space-between"><span>${x.n}</span><span style="font-weight:bold">${x.a}–∫–≥</span></div>`; });
   } else {
       itmsHtml = `<div style="font-size:12px;display:flex;justify-content:space-between"><span>${v.name}</span><span style="font-weight:bold">${v.amount}–∫–≥</span></div>`;
   }
   return `<div class="j-card">
    <div class="j-head" style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding-bottom:4px"><span>${v.date.split('T')[0].split('-').reverse().join('.')}</span><span>‚Ññ${v.num||'-'}</span></div>
    <div style="font-size:13px;margin:5px 0;color:var(--p);font-weight:900">${v.supplier||'-'}</div>
    ${itmsHtml}
    ${isAdmin?`<button onclick="delRec('${k}','${i}')" style="color:red;border:1px solid #fee2e2;background:#fee2e2;border-radius:6px;padding:4px;margin-top:8px;width:100%;font-weight:900">–£–î–ê–õ–ò–¢–¨ –ù–ê–ö–õ–ê–î–ù–£–Æ</button>`:''}
   </div>`;
  }
 });
}
window.viewInvoice=function(id){
 const v=data.ArchInvoices[id];if(!v)return;
 const dt=new Date(v.date),dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 let h=`<div id="shipPrev"><div style="text-align:center;font-weight:900">–ù–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ ${v.num||'---'} –≤—ñ–¥ ${dStr} —Ä.</div><div style="font-size:12px;margin-top:5px;line-height:1.4"><span class="pr-lbl">–í—ñ–¥:</span> <span class="pr-val">${v.supplierName||'-'}</span><br><span class="pr-lbl">–ö–æ–º—É:</span> <span class="pr-val">${v.client}</span><br><span class="pr-lbl">–£–≥–æ–¥–∞:</span> <span class="pr-val">${v.agreement||'-'}</span></div><table style="width:100%;font-size:11px;border-collapse:collapse;margin-top:5px" border="1"><thead><tr style="background:#eee"><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 if(v.items)v.items.forEach((it,idx)=>{const p=it.split('|'); tw+=parseFloat(p[1])||0; h+=`<tr><td style="text-align:center">${idx+1}</td><td>${getPrintName(p[0])}</td><td style="text-align:center">${p[1]}</td><td style="text-align:center">${p[2]}</td><td style="text-align:center">${parseFloat(p[4]).toFixed(2)}</td><td style="text-align:center">${parseFloat(p[5]).toFixed(2)}</td></tr>`});
 h+=`<tr><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${parseFloat(v.totalSum||0).toFixed(2)}</td></tr></tbody></table><div style="display:flex;justify-content:space-between;margin-top:20px;font-size:12px"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: _____________</div><div>–ü—Ä–∏–π–Ω—è–≤: _____________</div></div><button class="btn-main" onclick="reprintInv('${id}')" style="margin-top:15px;background:#0f172a">üñ®Ô∏è –î–†–£–ö</button></div>`;
 gID('mB').innerHTML=h;gID('mT').innerText='–ù–ê–ö–õ–ê–î–ù–ê (–ê–†–•–Ü–í)';gID('mdl').style.display='flex'
};
window.reprintInv=function(id){
 const v=data.ArchInvoices[id];if(!v)return;
 const dt=new Date(v.date),dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 const bT=invSet.tblBrd?'2px solid #000':'none', bI=invSet.tblBrd?'1px solid #000':'none';
 const bV=invSet.vLin?'1px solid #000':'none', bH=invSet.hLin?'1px solid #000':'none';
 const fS=invSet.fSize||'11px', colW=(invSet.colW||'5,55,10,5,10,15').split(',').map(x=>x.trim()+'%'), rowH=invSet.rowH||'14px';
 
 let dData={num:v.num, dateStr:dStr, sup:v.supplierName, cli:v.client, agr:v.agreement, cnt:(v.items?v.items.length:0), sum:v.totalSum};
 
 let styleBlock=`<style>
  .pr-table {width:100%; border-collapse:collapse; font-size:${fS} !important; border:${bT}; table-layout:fixed; margin-top:5px; margin-bottom:5px;}
  .pr-table th, .pr-table td {border-top:${bH}; border-bottom:${bH}; border-left:${bV}; border-right:${bV}; text-align:center; height:${rowH}; overflow:hidden;}
  .pr-table th {border-top:${bT}; border-bottom:${bI};}
  .pr-table th:first-child, .pr-table td:first-child {border-left:${bT}; width:${colW[0]||'5%'};}
  .pr-table th:nth-child(2), .pr-table td:nth-child(2) {width:${colW[1]||'55%'}; text-align:left; padding-left:2px;}
  .pr-table th:nth-child(3), .pr-table td:nth-child(3) {width:${colW[2]||'10%'};}
  .pr-table th:nth-child(4), .pr-table td:nth-child(4) {width:${colW[3]||'5%'};}
  .pr-table th:nth-child(5), .pr-table td:nth-child(5) {width:${colW[4]||'10%'};}
  .pr-table th:last-child, .pr-table td:last-child {border-right:${bT}; width:${colW[5]||'15%'};}
  .pr-table tr:last-child td {border-bottom:${bT};}
 </style>`;
 
 let h=styleBlock+`<div style="font-size:12px;color:#000;line-height:1.4;white-space:pre-wrap;text-align:left">`+parseTags(invSet.xtraTop, dData)+`</div>`;
 h+=`<table class="pr-table"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 if(v.items)v.items.forEach((it,idx)=>{
  const p=it.split('|'); tw+=parseFloat(p[1])||0; 
  h+=`<tr><td>${idx+1}</td><td style="text-align:left">${getPrintName(p[0])}</td><td>${p[1]}</td><td>${p[2]}</td><td>${parseFloat(p[4]).toFixed(2)}</td><td>${parseFloat(p[5]).toFixed(2)}</td></tr>`;
 });
 h+=`<tr style="border:none"><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${parseFloat(v.totalSum||0).toFixed(2)}</td></tr>`;
 h+=`</tbody></table>`;
 h+=`<div style="font-size:12px;color:#000;line-height:1.4;white-space:pre-wrap;text-align:left">`+parseTags(invSet.xtraBot, dData)+`</div>`;
 
 gID('print-view').innerHTML=h; window.print(); setTimeout(()=>gID('print-view').innerHTML='',800);
};

function numToWords(n){
 const u_m=['','–æ–¥–∏–Ω','–¥–≤–∞','—Ç—Ä–∏','—á–æ—Ç–∏—Ä–∏','–ø\'—è—Ç—å','—à—ñ—Å—Ç—å','—Å—ñ–º','–≤—ñ—Å—ñ–º','–¥–µ–≤\'—è—Ç—å'];
 const u_f=['','–æ–¥–Ω–∞','–¥–≤—ñ','—Ç—Ä–∏','—á–æ—Ç–∏—Ä–∏','–ø\'—è—Ç—å','—à—ñ—Å—Ç—å','—Å—ñ–º','–≤—ñ—Å—ñ–º','–¥–µ–≤\'—è—Ç—å'];
 const t1=['–¥–µ—Å—è—Ç—å','–æ–¥–∏–Ω–∞–¥—Ü—è—Ç—å','–¥–≤–∞–Ω–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–Ω–∞–¥—Ü—è—Ç—å','—á–æ—Ç–∏—Ä–Ω–∞–¥—Ü—è—Ç—å','–ø\'—è—Ç–Ω–∞–¥—Ü—è—Ç—å','—à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç—å','—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å','–≤—ñ—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å','–¥–µ–≤\'—è—Ç–Ω–∞–¥—Ü—è—Ç—å'];
 const t2=['','','–¥–≤–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–¥—Ü—è—Ç—å','—Å–æ—Ä–æ–∫','–ø\'—è—Ç–¥–µ—Å—è—Ç','—à—ñ—Å—Ç–¥–µ—Å—è—Ç','—Å—ñ–º–¥–µ—Å—è—Ç','–≤—ñ—Å—ñ–º–¥–µ—Å—è—Ç','–¥–µ–≤\'—è–Ω–æ—Å—Ç–æ'];
 const h=['','—Å—Ç–æ','–¥–≤—ñ—Å—Ç—ñ','—Ç—Ä–∏—Å—Ç–∞','—á–æ—Ç–∏—Ä–∏—Å—Ç–∞','–ø\'—è—Ç–¥–µ—Å—è—Ç','—à—ñ—Å—Ç–¥–µ—Å—è—Ç','—Å—ñ–º—Å–æ—Ç','–≤—ñ—Å—ñ–º—Å–æ—Ç','–¥–µ–≤\'—è—Ç—Å–æ—Ç'];
 let ip=Math.floor(n),fp=Math.round((n-ip)*100),fs=fp.toString().padStart(2,'0');
 if(ip===0)return `–ù—É–ª—å –≥—Ä–∏–≤–µ–Ω—å ${fs} –∫–æ–ø—ñ–π–æ–∫`;
 function gg(n,isFem){
  let r='',c=Math.floor(n/100),d=Math.floor((n%100)/10),u0=n%10;
  if(c>0)r+=h[c]+' ';
  if(d===1)r+=t1[u0]+' ';
  else{if(d>1)r+=t2[d]+' ';if(u0>0)r+=(isFem&&(u0===1||u0===2)?u_f[u0]:u_m[u0])+' ';}
  return r;
 }
 let w='',m=Math.floor(ip/1000000),th=Math.floor((ip%1000000)/1000),rm=ip%1000;
 if(m>0){w+=gg(m,0);let l=m%10,l2=m%100;if(l2>=11&&l2<=14)w+='–º—ñ–ª—å–π–æ–Ω—ñ–≤ ';else if(l===1)w+='–º—ñ–ª—å–π–æ–Ω ';else if(l>=2&&l<=4)w+='–º—ñ–ª—å–π–æ–Ω–∏ ';else w+='–º—ñ–ª—å–π–æ–Ω—ñ–≤ ';}
 if(th>0){w+=gg(th,1);let l=th%10,l2=th%100;if(l2>=11&&l2<=14)w+='—Ç–∏—Å—è—á ';else if(l===1)w+='—Ç–∏—Å—è—á–∞ ';else if(l>=2&&l<=4)w+='—Ç–∏—Å—è—á—ñ ';else w+='—Ç–∏—Å—è—á ';}
 if(rm>0)w+=gg(rm,0);
 w=w.trim();w=w.charAt(0).toUpperCase()+w.slice(1);
 let l=ip%10,l2=ip%100,cr='–≥—Ä–∏–≤–µ–Ω—å';
 if(l2>=11&&l2<=14)cr='–≥—Ä–∏–≤–µ–Ω—å';else if(l===1)cr='–≥—Ä–∏–≤–Ω—è';else if(l>=2&&l<=4)cr='–≥—Ä–∏–≤–Ω—ñ';
 return `${w} ${cr} ${fs} –∫–æ–ø—ñ–π–æ–∫`;
}

function parseTags(txt, d) {
 if(!txt) return '';
 return txt.replace(/\[–ù–û–ú–ï–†\]/g, d.num || '---')
           .replace(/\[–î–ê–¢–ê\]/g, d.dateStr || '---')
           .replace(/\[–ü–û–°–¢–ê–í–©–ò–ö\]/g, d.sup || '-/-')
           .replace(/\[–ö–õ–ò–ï–ù–¢\]/g, d.cli || '-/-')
           .replace(/\[–°–î–ï–õ–ö–ê\]/g, d.agr || '-/-')
           .replace(/\[–ö–û–õ_–í–û_–ü–û–ó–ò–¶–ò–ô\]/g, d.cnt || '0')
           .replace(/\[–û–ë–©–ê–Ø_–°–£–ú–ú–ê\]/g, parseFloat(d.sum||0).toFixed(2))
           .replace(/\[–°–£–ú–ú–ê_–ü–†–û–ü–ò–°–¨–Æ\]/g, numToWords(d.sum||0));
}

window.addIncRow = function(cat, containerId, prefix){
 const i=Date.now()+Math.random().toString().slice(2,7);
 let opts='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
 gP(cat).forEach(p=>opts+=`<option value="${p}">${p}</option>`);
 gID(containerId).insertAdjacentHTML('beforeend',`<div class="fas-row-out" id="ir_${i}" style="grid-template-columns: 2fr 1fr 30px; margin-bottom:5px;">
  <select id="${prefix}n_${i}" class="fas-inp" onchange="if(this.value==='NEW'){const n=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:');if(n){const o=document.createElement('option');o.value=n;o.text=n;this.add(o,this.options[1]);this.value=n}else this.value=''}">${opts}<option value="NEW" style="color:blue">–ù–û–í–´–ô...</option></select>
  <input type="number" id="${prefix}a_${i}" class="fas-inp" placeholder="–∫–≥">
  <button onclick="this.parentElement.remove()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
};

function openModal(t,a,b){gID('mdl').style.display='flex';const m=gID('mB'),h=gID('mT'),d=new Date().toISOString().split('T')[0];m.innerHTML='';aId=a;
 if(t==='inc'){
  h.innerText='–ü–†–ò–•–û–î (–ü–û–ö–£–ü–ù–ê–Ø)';
  m.innerHTML=`<div class="grid-3" style="margin-bottom:10px;align-items:end"><div><span class="lbl-small">–î–ê–¢–ê</span><input type="date" id="iD" value="${d}"></div><div><span class="lbl-small">–ù–ê–ö–õ ‚Ññ</span><input type="text" id="iNum"></div><div><span class="lbl-small">–ü–û–°–¢–ê–í–©–ò–ö</span>${makeSmart('iS',gBuyS(),'–í—ã–±–µ—Ä–∏—Ç–µ...')}</div></div><div class="z-head">–¢–û–í–ê–†–´</div><div id="incRows"></div><button class="btn-main" onclick="addIncRow('WeightStock','incRows','iN')" style="background:#fff;color:var(--p);border:1px dashed var(--p);margin-bottom:10px">+ –î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</button><button class="btn-main" onclick="sInc()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
  setTimeout(()=>addIncRow('WeightStock','incRows','iN'),50);
 }
 else if(t==='ship'){
  shipBasket={}; h.innerText='–û–¢–ì–†–£–ó–ö–ê';
  m.innerHTML=`<div style="background:#f8fafc;padding:5px;border:1px solid #e2e8f0;border-radius:10px"><div id="shipHead" class="head-wrap"><div class="grid-3"><div><span class="lbl-small">–î–ê–¢–ê</span><input type="date" id="hD" value="${d}"></div><div><span class="lbl-small">–ù–ê–ö–õ ‚Ññ</span><input type="text" id="hNum"></div><div><span class="lbl-small">–°–î–ï–õ–ö–ê</span><input type="text" id="hAg"></div></div><div class="grid-2"><div><span class="lbl-small">–ü–û–°–¢–ê–í–©–ò–ö</span>${makeSmart('hMyFop',data.Suppliers?Object.values(data.Suppliers).map(x=>x.name):[],'–ü–û–°–¢–ê–í–©–ò–ö')}</div><div><span class="lbl-small">–ü–û–õ–£–ß–ê–¢–ï–õ–¨</span>${makeSmart('hC',gCl(),'–ö–ª–∏–µ–Ω—Ç...')}</div></div><div class="grid-3" style="align-items:end;margin-top:5px"><button id="btnOpt" class="btn-sel ${priceMode==='opt'?'active':''}" onclick="setPriceMode('opt')">–û–ü–¢</button><button id="btnRoz" class="btn-sel ${priceMode==='roz'?'active':''}" onclick="setPriceMode('roz')">–†–û–ó–ù–ò–¶–ê</button><button id="btnStr" class="btn-sel" onclick="toggleStr(this)">–°–¢–†–ï–ô–ß: –ù–ï–¢</button></div></div><button class="btn-main" style="background:#e2e8f0;color:#334155;margin-top:5px;padding:8px" onclick="gID('shipHead').classList.toggle('collapsed')">üîΩ –°–í–ï–†–ù–£–¢–¨ / –†–ê–ó–í–ï–†–ù–£–¢–¨ –®–ê–ü–ö–£</button></div><div id="shipBtns" class="grid-2x2" style="margin-top:5px"><button class="btn-sel active" onclick="loadBulk('–ì–æ—Ç–æ–≤–∞—è')">–§–ê–°–û–í–ê–ù–ù–ê–Ø</button><button class="btn-sel" onclick="loadBulk('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø</button><button class="btn-sel" onclick="loadBulk('Stock_DV')">–î–í –í–ï–°</button><button class="btn-sel" onclick="loadBulk('Stock_Feed')">–û–¢–•–û–î–´</button></div><div id="shpR" style="max-height:50vh;overflow-y:auto;border:1px solid #eee;margin-bottom:5px;border-radius:8px;padding:5px"></div><button class="btn-main" onclick="sShip()">–î–ê–õ–ï–ï</button>`;
  loadBulk(cur==='StockRoot'?'–ì–æ—Ç–æ–≤–∞—è':cur);
 }
 else if(t==='addRaw'){
  h.innerText='–ü–†–ò–•–û–î –°–´–†–¨–Ø';
  m.innerHTML=`<div class="grid-3" style="margin-bottom:10px;align-items:end"><div><span class="lbl-small">–î–ê–¢–ê</span><input type="date" id="rD" value="${d}"></div><div><span class="lbl-small">–ù–ê–ö–õ ‚Ññ</span><input type="text" id="rNum"></div><div><span class="lbl-small">–ü–û–°–¢–ê–í–©–ò–ö</span>${makeSmart('rSupp',gBuyS(),'–í—ã–±–µ—Ä–∏—Ç–µ...')}</div></div><div class="z-head">–°–´–†–¨–ï</div><div id="rawRows"></div><button class="btn-main" onclick="addIncRow('Stock_Raw','rawRows','rN')" style="background:#fff;color:var(--p);border:1px dashed var(--p);margin-bottom:10px">+ –î–û–ë–ê–í–ò–¢–¨ –°–´–†–¨–ï</button><button class="btn-main" onclick="sRawInc()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
  setTimeout(()=>addIncRow('Stock_Raw','rawRows','rN'),50);
 }
 else if(t==='addMatPack'){h.innerText='–ü–†–ò–•–û–î –ú–ê–¢–ï–†–ò–ê–õ–û–í';m.innerHTML=`<div>–ö–ê–¢–ï–ì–û–†–ò–Ø <select id="pCat" class="smart-sel" onchange="updPackList()"><option value="–ü–ª–µ–Ω–∫–∞">–ü–ª–µ–Ω–∫–∞</option><option value="–ü–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option><option value="–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º">–°–∫–æ—Ç—á</option><option value="–ú–µ—à–∫–∏">–ú–µ—à–∫–∏</option><option value="–ù–∏—Ç–∫–∏">–ù–∏—Ç–∫–∏</option><option value="–≠—Ç–∏–∫–µ—Ç–∫–∞">–≠—Ç–∏–∫–µ—Ç–∫–∞</option><option value="–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞">–°—Ç—Ä–µ–π—á</option><option value="–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞">–¢–µ—Ä–º–æ</option></select></div><div>–î–ê–¢–ê <input type="date" id="pD" value="${d}"></div><div>–ü–û–°–¢–ê–í–©–ò–ö ${makeSmart('pS',gPackS(),'–í—ã–±–µ—Ä–∏—Ç–µ')}</div><div>–¢–û–í–ê–† <div id="pProdCont"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div>–ö–û–õ–ò–ß–ï–°–¢–í–û <input type="number" id="pA"></div><div>–ù–ê–ö–õ ‚Ññ <input type="text" id="pNum"></div></div><button class="btn-main" onclick="sPack()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;setTimeout(updPackList,100)}
 else if(t==='fas'){
  h.innerText='–§–ê–°–û–í–ö–ê –°–ú–ï–ù–ê';
  m.innerHTML=`<div class="fas-card"><span class="fas-lbl">–î–ê–¢–ê</span><input type="date" id="fD" class="fas-inp" value="${d}"></div><div class="z-head">–°–´–†–¨–ï</div><div id="fasRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px dashed var(--p);margin-bottom:10px" onclick="addFasRow()">+ –î–û–ë–ê–í–ò–¢–¨ –°–´–†–¨–ï</button><div class="z-head">–ì–û–¢–û–í–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø</div><div id="fasOutRows"></div><button class="btn-main" style="background:#fff;color:var(--p);border:1px dashed var(--p)" onclick="addFasOutRow()">+ –î–û–ë–ê–í–ò–¢–¨ –ü–†–û–î–£–ö–¶–ò–Æ</button><div class="z-head">–ü–õ–ï–ù–ö–ê</div><div class="fas-card fas-film-row"><div><span class="fas-lbl">–í–ó–Ø–õ–ò (5+5)</span><input type="text" id="fVz" class="fas-inp" placeholder="–∫–≥" oninput="calcFilm()"></div><div><span class="fas-lbl">–û–°–¢–ê–¢–û–ö</span><input type="number" id="fOs" class="fas-inp" placeholder="–∫–≥" oninput="calcFilm()"></div><div><span class="fas-lbl">–†–ê–°–•–û–î</span><input type="text" id="fUsed" class="fas-inp" placeholder="0 –∫–≥" readonly style="background:#e2e8f0;font-weight:900;color:var(--p)"></div></div><button class="btn-main" onclick="previewFas()">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>`;
  setTimeout(()=>{addFasRow();addFasOutRow()},100);
 }
 else if(t==='workshop'){
  const c=WS_CFG[a]; h.innerText=c.title;
  m.innerHTML=`<div class="ws-card"><div class="grid-3"><div><span class="ws-lbl">–î–ê–¢–ê</span><input type="date" id="wsD" class="ws-inp" value="${d}"></div><div><span class="ws-lbl">–ù–ê–ß–ê–õ–û</span><input type="time" id="wsTS" class="ws-inp" value="08:00"></div><div><span class="ws-lbl">–ö–û–ù–ï–¶</span><input type="time" id="wsTE" class="ws-inp" value="17:00"></div></div><div class="grid-2" style="margin-top:5px"><div><span class="ws-lbl">–û–ü–ï–†–ê–¢–û–†</span>${makeSmart('wsOp',getHistoryDeep('operator'),'–§–∞–º–∏–ª–∏—è')}</div><div><span class="ws-lbl">–ü–û–ú–û–©–ù–ò–ö</span>${makeSmart('wsAs',getHistoryDeep('assistant'),'–§–∞–º–∏–ª–∏—è')}</div></div></div><div class="z-head">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div><div id="wsMainRows"></div><button class="btn-main" style="background:#fff;color:#0369a1;border:1px dashed #0369a1;margin-bottom:10px" onclick="addWsMainRow()">+ –î–û–ë–ê–í–ò–¢–¨ –û–°–ù–û–í–£</button><div class="z-head">–î–û–ë–ê–í–ö–ê</div><div id="wsAddRows"></div><button class="btn-main" style="background:#fff;color:#d97706;border:1px dashed #d97706;margin-bottom:10px" onclick="addWsAddRow()">+ –î–û–ë–ê–í–ò–¢–¨ –î–û–ë–ê–í–ö–£</button><div class="z-head">–í–´–•–û–î: –î–í –í–ï–°</div><div id="wsOutDV"></div><button class="btn-main" style="background:#fff;color:var(--s);border:1px dashed var(--s);margin-bottom:10px" onclick="addWsOutRow('DV')">+ –î–û–ë–ê–í–ò–¢–¨ –î–í –í–ï–°</button><div class="z-head">–í–´–•–û–î: –ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢</div><div id="wsOutSemi"></div><button class="btn-main" style="background:#fff;color:var(--s);border:1px dashed var(--s);margin-bottom:10px" onclick="addWsOutRow('Semi')">+ –î–û–ë–ê–í–ò–¢–¨ –ü/–§</button><div class="z-head">–í–´–•–û–î: –û–¢–•–û–î–´</div><div id="wsOutFeed"></div><button class="btn-main" style="background:#fff;color:var(--s);border:1px dashed var(--s);margin-bottom:10px" onclick="addWsOutRow('Feed')">+ –î–û–ë–ê–í–ò–¢–¨ –û–¢–•–û–î–´</button><button class="btn-main" onclick="previewWorkshop('${a}')">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>`;
  setTimeout(()=>{addWsMainRow();addWsOutRow('DV');},50);
 }
 else if(t==='corr'){h.innerText='–ö–û–†–†–ï–ö–¶–ò–Ø';corrCtx={cat:a,name:b};m.innerHTML=`<div style="text-align:center;font-weight:900">${b}</div><div>–î–ê–¢–ê <input type="date" id="cD" value="${d}"></div><div>–ù–û–í–´–ô –û–°–¢–ê–¢–û–ö <input type="number" id="cA"></div><div>–ü–†–ò–ß–ò–ù–ê <input type="text" id="cR"></div><button class="btn-main" onclick="sCorr()">–°–û–•–†–ê–ù–ò–¢–¨</button><div style="margin-top:10px;border-top:1px dashed #ccc"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc" onclick="renameItem('${esc(b)}','${a}')">–ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–¢–¨</button><button class="btn-main" style="background:#fee2e2;color:red" onclick="delItemBatch('${esc(b)}','${a}')">–£–î–ê–õ–ò–¢–¨ –ö–ê–†–¢–û–ß–ö–£</button></div>`}
 else if(t==='dayRep'){h.innerText='–î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="repDate" value="${d}"></div><button class="btn-main" onclick="genDayReport()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨</button>`}
 else if(t==='monthRep'){h.innerText='–ú–ï–°–Ø–ß–ù–´–ô –û–¢–ß–ï–¢';m.innerHTML=`<div>–ú–ï–°–Ø–¶ <input type="month" id="repMth"></div><button class="btn-main" onclick="genMonthReport()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨</button>`}
 else if(t==='fix'){h.innerText='–§–ò–ö–°–ê–¶–ò–Ø';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="fixDate" value="${d}"></div><button class="btn-main" id="btnFix" onclick="sFixBal()">OK</button>`}
 else if(t==='arch'){h.innerText='–°–í–ï–†–¢–´–í–ê–ù–ò–ï';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="archDate"></div><button class="btn-main" id="btnArch" onclick="runArchive()" style="background:red">OK</button>`}
 else if(t==='closeMonth'){h.innerText='–ó–ê–ö–†–´–¢–ò–ï –ú–ï–°–Ø–¶–ê';m.innerHTML=`<div>–ö–û–ù–ï–¶ –ú–ï–°–Ø–¶–ê <input type="date" id="cmDate"></div><button class="btn-main" id="btnCM" onclick="runCloseMonth()">OK</button>`}
 else if(t==='invSet'){
  h.innerText='–ù–ê–°–¢–†–û–ô–ö–ò –ü–ï–ß–ê–¢–ò';
  m.innerHTML=`<div class="inv-set-card">
   <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px">
    <label class="checkbox-wrap"><input type="checkbox" id="isBrd" ${invSet.tblBrd?'checked':''} onchange="updatePreview()"> –í–Ω–µ—à–Ω—è—è —Ä–∞–º–∫–∞</label>
    <label class="checkbox-wrap"><input type="checkbox" id="isV" ${invSet.vLin?'checked':''} onchange="updatePreview()"> –í–µ—Ä—Ç. –ª–∏–Ω–∏–∏</label>
    <label class="checkbox-wrap"><input type="checkbox" id="isH" ${invSet.hLin?'checked':''} onchange="updatePreview()"> –ì–æ—Ä–∏–∑. –ª–∏–Ω–∏–∏</label>
    <div><span class="inv-set-lbl">–®—Ä–∏—Ñ—Ç</span><select id="isF" class="smart-sel" onchange="updatePreview()"><option value="9px" ${invSet.fSize==='9px'?'selected':''}>9px</option><option value="11px" ${invSet.fSize==='11px'?'selected':''}>11px</option><option value="14px" ${invSet.fSize==='14px'?'selected':''}>14px</option></select></div>
   </div>
   <div class="grid-2" style="margin-bottom:10px">
    <div><span class="inv-set-lbl">–®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ (%)</span><input type="text" id="isColW" value="${invSet.colW}" placeholder="5,55,10,5,10,15" oninput="updatePreview()" style="font-size:11px"></div>
    <div><span class="inv-set-lbl">–í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫</span><input type="text" id="isRowH" value="${invSet.rowH}" placeholder="14px" oninput="updatePreview()" style="font-size:11px"></div>
   </div>
   <div style="margin-bottom:5px"><span class="inv-set-lbl">–®–ê–ü–ö–ê (–í–ï–†–•–ù–ò–ô –¢–ï–ö–°–¢)</span><textarea id="isTop" style="width:100%;height:100px;border-radius:6px;border:1px solid #ccc;padding:5px;font-size:11px" oninput="updatePreview()">${invSet.xtraTop||''}</textarea></div>
   <div><span class="inv-set-lbl">–ü–û–î–í–ê–õ (–ù–ò–ñ–ù–ò–ô –¢–ï–ö–°–¢)</span><textarea id="isBot" style="width:100%;height:100px;border-radius:6px;border:1px solid #ccc;padding:5px;font-size:11px" oninput="updatePreview()">${invSet.xtraBot||''}</textarea></div>
   <div style="margin-top:5px;font-size:10px;color:#0369a1;font-weight:700">–£–º–Ω—ã–µ —Ç–µ–≥–∏: [–ù–û–ú–ï–†], [–î–ê–¢–ê], [–ü–û–°–¢–ê–í–©–ò–ö], [–ö–õ–ò–ï–ù–¢], [–°–î–ï–õ–ö–ê], [–ö–û–õ_–í–û_–ü–û–ó–ò–¶–ò–ô], [–û–ë–©–ê–Ø_–°–£–ú–ú–ê], [–°–£–ú–ú–ê_–ü–†–û–ü–ò–°–¨–Æ].</div>
  </div>
  <div style="text-align:center;font-weight:900;color:var(--p);margin-top:10px">–ñ–ò–í–û–ô –ü–†–ï–î–ü–†–û–°–ú–û–¢–†:</div>
  <div id="invPreview" class="inv-preview-box"></div>
  <button class="btn-main" onclick="saveInvSet()">–°–û–•–†–ê–ù–ò–¢–¨ –®–ê–ë–õ–û–ù</button>`;
  setTimeout(updatePreview, 100);
 }
}

window.updatePreview = function() {
 const bT=gID('isBrd').checked?'2px solid #000':'none', bI=gID('isBrd').checked?'1px solid #000':'none';
 const bV=gID('isV').checked?'1px solid #000':'none', bH=gID('isH').checked?'1px solid #000':'none';
 const fS=gID('isF').value, colW=gID('isColW').value.split(',').map(x=>x.trim()+'%'), rowH=gID('isRowH').value;
 let dDummy={num:'999', dateStr:new Date().toLocaleDateString('ru-RU'), sup:'–§–û–ü –ü–µ—Ç—Ä–µ–Ω–∫–æ', cli:'–¢–û–í "–°–ò–°–¢–ï–ú–ê"', agr:'‚Ññ1 –≤—ñ–¥ 01.01', cnt:2, sum:12500};
 let style=`<style>
  .prev-tbl {width:100%; border-collapse:collapse; font-size:${fS}; border:${bT}; table-layout:fixed; margin-top:5px; margin-bottom:5px;}
  .prev-tbl th, .prev-tbl td {border-top:${bH}; border-bottom:${bH}; border-left:${bV}; border-right:${bV}; text-align:center; height:${rowH}; overflow:hidden;}
  .prev-tbl th {border-top:${bT}; border-bottom:${bI};}
  .prev-tbl th:first-child, .prev-tbl td:first-child {border-left:${bT}; width:${colW[0]||'5%'};}
  .prev-tbl th:nth-child(2), .prev-tbl td:nth-child(2) {width:${colW[1]||'55%'}; text-align:left; padding-left:2px;}
  .prev-tbl th:nth-child(3), .prev-tbl td:nth-child(3) {width:${colW[2]||'10%'};}
  .pr-table th:nth-child(4), .prev-tbl td:nth-child(4) {width:${colW[3]||'5%'};}
  .prev-tbl th:nth-child(5), .prev-tbl td:nth-child(5) {width:${colW[4]||'10%'};}
  .prev-tbl th:last-child, .prev-tbl td:last-child {border-right:${bT}; width:${colW[5]||'15%'};}
  .prev-tbl tr:last-child td {border-bottom:${bT};}
 </style>`;
 let tbl=`<table class="prev-tbl"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody><tr><td>1</td><td style="text-align:left">–¢–µ—Å—Ç–æ–≤–∏–π —Ç–æ–≤–∞—Ä 1</td><td>10</td><td>—à—Ç</td><td>500.00</td><td>5000.00</td></tr><tr><td>2</td><td style="text-align:left">–¢–µ—Å—Ç–æ–≤–∏–π —Ç–æ–≤–∞—Ä 2</td><td>15</td><td>–∫–≥</td><td>500.00</td><td>7500.00</td></tr><tr style="border:none"><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">25</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">12500.00</td></tr></tbody></table>`;
 gID('invPreview').innerHTML=style+`<div style="font-size:12px;color:#000;line-height:1.4;text-align:left;white-space:pre-wrap">`+parseTags(gID('isTop').value, dDummy)+`</div>`+tbl+`<div style="font-size:12px;color:#000;line-height:1.4;text-align:left;white-space:pre-wrap">`+parseTags(gID('isBot').value, dDummy)+`</div>`;
};

window.saveInvSet=async function(){
 const u={tblBrd:gID('isBrd').checked, vLin:gID('isV').checked, hLin:gID('isH').checked, fSize:gID('isF').value, colW:gID('isColW').value, rowH:gID('isRowH').value, xtraTop:gID('isTop').value, xtraBot:gID('isBot').value};
 try{await db.child('InvoiceSettings').set(u); invSet=u; closeModal(); alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω');}catch(e){alert(e);}
};

function loadBulk(c){
 D.querySelectorAll('.bulk-q').forEach(i=>{const n=i.dataset.n,ct=i.dataset.cat,v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});
 const bs=D.querySelectorAll('#shipBtns button');
 bs.forEach(b=>{let t=b.innerText,a=!1;if(c==='–ì–æ—Ç–æ–≤–∞—è'&&t.includes('–§–ê–°–û–í–ê–ù–ù–ê–Ø'))a=!0;if(c==='WeightStock'&&t.includes('–ü–û–ö–£–ü–ù–ê–Ø'))a=!0;if(c==='Stock_DV'&&t.includes('–î–í –í–ï–°'))a=!0;if(c==='Stock_Feed'&&t.includes('–û–¢–•–û–î–´'))a=!0;b.className='btn-sel '+(a?'active':'')});
 const s={};if(data[c])Object.values(data[c]).forEach(v=>{if(v.name)s[v.name]=(s[v.name]||0)+v.amount});
 let h=`<div class="item-grid">`;
 Object.keys(s).sort().forEach(n=>{
  const v=s[n];
  if(v>0){
   const k=n+'::'+c, sv=shipBasket[k]?shipBasket[k].w:'';
   const isFilled = sv>0?'tile-filled':'';
   let prcHtml = '';
   if(data.PriceList){
    const pObj = Object.values(data.PriceList).find(x=>x.name===n);
    if(pObj) {
     let prVal = priceMode==='opt' ? (pObj.priceOpt!==undefined?pObj.priceOpt:(pObj.price||0)) : (pObj.priceRoz!==undefined?pObj.priceRoz:0);
     if(prVal > 0) prcHtml = `<div class="pulsing-price">${prVal}</div>`;
    }
   }
   h+=`<div class="item-card ${isFilled}"><div class="item-title">${n}</div>${prcHtml}<div style="font-size:10px;color:#888;margin-bottom:2px">–û—Å—Ç:${Math.round(v)}</div><input type="number" class="bulk-q" data-n="${n}" data-cat="${c}" style="width:100%;height:25px;text-align:center;font-weight:900" value="${sv}" oninput="if(this.value>0)this.parentElement.classList.add('tile-filled');else this.parentElement.classList.remove('tile-filled')"></div>`
  }
 });
 gID('shpR').innerHTML=h+`</div>`
}

window.setPriceMode=function(m){
 priceMode=m; gID('btnOpt').className='btn-sel '+(m==='opt'?'active':''); gID('btnRoz').className='btn-sel '+(m==='roz'?'active':'');
 const ab = Array.from(D.querySelectorAll('#shipBtns button')).find(b=>b.classList.contains('active'));
 let ac = '–ì–æ—Ç–æ–≤–∞—è';
 if(ab){
  if(ab.innerText.includes('–ü–û–ö–£–ü–ù–ê–Ø')) ac='WeightStock';
  if(ab.innerText.includes('–î–í –í–ï–°')) ac='Stock_DV';
  if(ab.innerText.includes('–û–¢–•–û–î–´')) ac='Stock_Feed';
 }
 loadBulk(ac);
};

function toggleStr(b){useStretch=!useStretch;b.className='btn-sel '+(useStretch?'active':'');b.innerText=useStretch?'–°–¢–†–ï–ô–ß: –î–ê':'–°–¢–†–ï–ô–ß: –ù–ï–¢'}

async function sShip(){const d=gID('hD').value,nm=gID('hNum').value,ag=gID('hAg').value,dv=d+"T12:00:00Z",c=getSmartVal('hC'),mf=getSmartVal('hMyFop'),pm=priceMode;if(!c)return alert('–ü–æ–ª—É—á–∞—Ç–µ–ª—å?');D.querySelectorAll('.bulk-q').forEach(i=>{const n=i.dataset.n,ct=i.dataset.cat,v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const it=[];let tw=0,tm=0,pdb={};if(data.PriceList)Object.values(data.PriceList).forEach(v=>pdb[v.name]=v);Object.values(shipBasket).forEach(v=>{let po=pdb[v.n]||{},pr=pm==='opt'?(po.priceOpt!==undefined?po.priceOpt:(po.price||0)):(po.priceRoz!==undefined?po.priceRoz:0),sm=pr*v.w;it.push({n:v.n,w:v.w,c:v.c,p:pr,s:sm});tw+=v.w;tm+=sm});if(!it.length)return alert('–ü—É—Å—Ç–æ');let h=`<div id="shipPrev"><div style="text-align:center"><b>–ù–ê–ö–õ–ê–î–ù–ê–Ø ‚Ññ ${nm||'---'}</b> (${pm==='opt'?'–û–ü–¢':'–†–û–ó–ù–ò–¶–ê'})</div><div style="font-size:12px;margin-top:5px"><b>–û—Ç:</b> ${mf||'-'}<br><b>–ö–æ–º—É:</b> ${c}<br><b>–°–¥–µ–ª–∫–∞:</b> ${ag||'-'}</div><table style="width:100%;font-size:11px;border-collapse:collapse;margin-top:5px"><tr style="background:#eee"><td>–¢–û–í–ê–†</td><td>–ö–û–õ-–í–û</td><td>–¶–ï–ù–ê</td><td>–°–£–ú–ú–ê</td></tr>`;it.forEach(x=>{h+=`<tr><td>${getPrintName(x.n)}</td><td>${x.w}</td><td>${x.p}</td><td>${x.s.toFixed(2)}</td></tr>`});h+=`<tr><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–ò—Ç–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å–µ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tm.toFixed(2)}</td></tr></table><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:10px"><button class="btn-main" onclick="execShip()">–°–ü–ò–°–ê–¢–¨</button><button class="btn-main" onclick="printAndConfirm()" style="background:#0f172a">–ü–ï–ß–ê–¢–¨</button></div></div>`;window.tempShipData={it,c,nm,dv,mf,tw,ag,tm,mode:pm};gID('mB').innerHTML=h;gID('mT').innerText='–ü–†–û–í–ï–†–ö–ê';gID('mdl').style.display='flex'}

window.printShipInvoice=function(d){
 if(!d)return;
 const dt=new Date(d.dv), dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 const bT=invSet.tblBrd?'2px solid #000':'none', bI=invSet.tblBrd?'1px solid #000':'none';
 const bV=invSet.vLin?'1px solid #000':'none', bH=invSet.hLin?'1px solid #000':'none';
 const fS=invSet.fSize||'11px', colW=(invSet.colW||'5,55,10,5,10,15').split(',').map(x=>x.trim()+'%'), rowH=invSet.rowH||'14px';
 
 let dData={num:d.nm, dateStr:dStr, sup:d.mf, cli:d.c, agr:d.ag, cnt:d.it.length, sum:d.tm};
 
 let styleBlock=`<style>
  .pr-table {width:100%; border-collapse:collapse; font-size:${fS} !important; border:${bT}; table-layout:fixed; margin-top:5px; margin-bottom:5px;}
  .pr-table th, .pr-table td {border-top:${bH}; border-bottom:${bH}; border-left:${bV}; border-right:${bV}; text-align:center; height:${rowH}; overflow:hidden;}
  .pr-table th {border-top:${bT}; border-bottom:${bI};}
  .pr-table th:first-child, .pr-table td:first-child {border-left:${bT}; width:${colW[0]||'5%'};}
  .pr-table th:nth-child(2), .pr-table td:nth-child(2) {width:${colW[1]||'55%'}; text-align:left; padding-left:2px;}
  .pr-table th:nth-child(3), .pr-table td:nth-child(3) {width:${colW[2]||'10%'};}
  .pr-table th:nth-child(4), .pr-table td:nth-child(4) {width:${colW[3]||'5%'};}
  .pr-table th:nth-child(5), .pr-table td:nth-child(5) {width:${colW[4]||'10%'};}
  .pr-table th:last-child, .pr-table td:last-child {border-right:${bT}; width:${colW[5]||'15%'};}
  .pr-table tr:last-child td {border-bottom:${bT};}
 </style>`;
 
 let h=styleBlock+`<div style="font-size:12px;color:#000;line-height:1.4;white-space:pre-wrap;text-align:left">`+parseTags(invSet.xtraTop, dData)+`</div>`;
 h+=`<table class="pr-table"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 d.it.forEach((x,idx)=>{
  h+=`<tr><td>${idx+1}</td><td style="text-align:left">${getPrintName(x.n)}</td><td>${x.w}</td><td>${x.c==='–ì–æ—Ç–æ–≤–∞—è'||['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(x.c)?'—à—Ç':'–∫–≥'}</td><td>${parseFloat(x.p).toFixed(2)}</td><td>${parseFloat(x.s).toFixed(2)}</td></tr>`;
  tw+=x.w;
 });
 h+=`<tr style="border:none"><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${parseFloat(d.tm||0).toFixed(2)}</td></tr>`;
 h+=`</tbody></table>`;
 h+=`<div style="font-size:12px;color:#000;line-height:1.4;white-space:pre-wrap;text-align:left">`+parseTags(invSet.xtraBot, dData)+`</div>`;
 
 gID('print-view').innerHTML=h; window.print(); setTimeout(()=>gID('print-view').innerHTML='',800);
};

window.printAndConfirm=function(){printShipInvoice(window.tempShipData);setTimeout(()=>{if(confirm("–ù–∞–∫–ª–∞–¥–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç—å. –°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞?"))execShip()},800)};
async function execShip(){const d=window.tempShipData;if(!d)return;try{const lk=db.child('ArchInvoices').push().key,u={},is=d.it.map(x=>`${x.n}|${x.w}|${x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'}|${x.c}|${x.p}|${x.s}`);u['/ArchInvoices/'+lk]={date:d.dv,client:d.c,num:d.nm,agreement:d.ag,items:is,supplierName:d.mf,ts:new Date().toISOString(),totalSum:d.tm,priceMode:d.mode};d.it.forEach(i=>{u[`/${i.c}/${db.child(i.c).push().key}`]={name:i.n,amount:-i.w,date:d.dv,note:`–û—Ç–≥—Ä: ${d.c}`,fLink:lk,ts:new Date().toISOString()}});if(useStretch){const q=parseFloat((d.tw/5000).toFixed(2));if(q>0)u['/–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞/'+db.child('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞').push().key]={name:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',amount:-q,date:d.dv,note:'–ê–≤—Ç–æ',fLink:lk,ts:new Date().toISOString()}}if(d.mf&&d.mf!=='–ü–û–°–¢–ê–í–©–ò–ö'){let fe=!1;if(data.Suppliers)Object.values(data.Suppliers).forEach(v=>{if(v.name===d.mf)fe=!0});if(!fe)u['/Suppliers/'+db.child('Suppliers').push().key]={name:d.mf}}await db.update(u);closeModal();alert('–°–ø–∏—Å–∞–Ω–æ —Å–æ —Å–∫–ª–∞–¥–∞');D.querySelectorAll('.bulk-q').forEach(i=>i.value='');window.shipBasket={}}catch(e){alert(e)}}

async function sInc(){
 const d=gID('iD').value+"T12:00:00Z",s=getSmartVal('iS'),nm=gID('iNum').value;
 if(!s||!nm) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –Ω–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π');
 const itms=[];
 for(let x of gID('incRows').children){
  const i=x.id.split('_')[1], n=gID('iNn_'+i).value, a=parseFloat(gID('iNa_'+i).value);
  if(n&&a>0) itms.push({n,a});
 }
 if(!itms.length) return alert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä —Å –≤–µ—Å–æ–º');
 try{
  const k=db.child('ArchIncoming').push().key, u={}, ts=new Date().toISOString();
  u['/ArchIncoming/'+k]={date:d,supplier:s,num:nm,type:'GOODS',ts:ts,items:itms.map(x=>({n:x.n, a:x.a}))};
  itms.forEach(x=>{u['/WeightStock/'+db.child('WeightStock').push().key]={name:x.n,amount:x.a,date:d,note:'–ü—Ä–∏—Ö–æ–¥',fLink:k,ts:ts}});
  await db.update(u); closeModal();
 }catch(e){alert(e)}
}

async function sRawInc(){
 const d=gID('rD').value+"T12:00:00Z",s=getSmartVal('rSupp'),nm=gID('rNum').value;
 if(!s||!nm) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –Ω–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π');
 const itms=[];
 for(let x of gID('rawRows').children){
  const i=x.id.split('_')[1], n=gID('rNn_'+i).value, a=parseFloat(gID('rNa_'+i).value);
  if(n&&a>0) itms.push({n,a});
 }
 if(!itms.length) return alert('–î–æ–±–∞–≤—å—Ç–µ —Å—ã—Ä—å–µ —Å –≤–µ—Å–æ–º');
 try{
  const k=db.child('ArchIncoming').push().key, u={}, ts=new Date().toISOString();
  u['/ArchIncoming/'+k]={date:d,supplier:s,num:nm,type:'RAW',ts:ts,items:itms.map(x=>({n:x.n, a:x.a}))};
  itms.forEach(x=>{u['/Stock_Raw/'+db.child('Stock_Raw').push().key]={name:x.n,amount:x.a,date:d,note:'–ü—Ä–∏—Ö–æ–¥ —Å—ã—Ä—å—è',fLink:k,ts:ts}});
  await db.update(u); closeModal();
 }catch(e){alert(e)}
}

async function sPack(){const cat=gID('pCat').value,d=gID('pD').value+"T12:00:00Z",s=getSmartVal('pS'),n=getSmartVal('pProd'),a=parseFloat(gID('pA').value),nm=gID('pNum').value;if(!s||!n||!a)return alert('–î–∞–Ω–Ω—ã–µ?');try{const k=db.child('ArchPackIn').push().key,u={};u['/ArchPackIn/'+k]={date:d,supplier:s,name:n,amount:a,category:cat,num:nm,ts:new Date().toISOString()};u['/'+cat+'/'+db.child(cat).push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥',fLink:k,ts:new Date().toISOString()};await db.update(u);closeModal()}catch(e){alert(e)}}
function updPackList(){const c=gID('pCat').value;let l=[];if(c==='–ü–ª–µ–Ω–∫–∞')l=["–ü–ª–µ–Ω–∫–∞ 300—Ö400","–ü–ª–µ–Ω–∫–∞ 370—Ö500","–ü–ª–µ–Ω–∫–∞ 400—Ö500","–ü–ª–µ–Ω–∫–∞ 420—Ö550"];else if(c==='–ü–∞–∫–µ—Ç—ã')l=["300x400","370x500","400x500","420x550"];else if(c==='–ú–µ—à–∫–∏')l=["–ú–µ—à–æ–∫ 25–∫–≥","–ú–µ—à–æ–∫ 50–∫–≥","–ú–µ—à–æ–∫ –±–µ–ª—ã–π"];else if(c==='–ù–∏—Ç–∫–∏')l=["–ù–∏—Ç–∫–∏"];else if(c==='–≠—Ç–∏–∫–µ—Ç–∫–∞')l=["–≠—Ç–∏–∫–µ—Ç–∫–∞"];else if(c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')l=["–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞"];else if(c==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')l=["–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞"];else if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')l=["–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º"];const s=new Set(l);if(data[c])Object.values(data[c]).forEach(v=>{if(v.name)s.add(v.name.replace(/—Ö/gi, 'x'))});gID('pProdCont').innerHTML=makeSmart('pProd',Array.from(s).sort(),'–¢–æ–≤–∞—Ä')}
async function sCorr(){const c=corrCtx.cat,n=corrCtx.name,d=gID('cD').value+"T12:00:00Z",na=parseFloat(gID('cA').value),r=gID('cR').value;if(isNaN(na))return alert('–ß–∏—Å–ª–æ?');let cur=0;if(data[c])Object.values(data[c]).forEach(v=>{if(v.name===n)cur+=v.amount});const diff=na-cur;if(Math.abs(diff)<0.001)return alert('–ù–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å');try{await db.child(c).push({name:n,amount:diff,date:d,note:`–ö–æ—Ä: ${r}`,ts:new Date().toISOString()});closeModal()}catch(e){alert(e)}}
async function renameItem(oldN,cat){const newN=prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",oldN);if(!newN||newN===oldN)return;if(!confirm(`–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å "${oldN}" -> "${newN}"?`))return;const u={},d=data[cat]||{};Object.entries(d).forEach(([k,v])=>{if(v.name===oldN)u[`/${cat}/${k}/name`]=newN});if(Object.keys(u).length){await db.update(u);closeModal();alert('–û–ö')}else alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ')}
async function delItemBatch(nm,cat){if(!confirm(`–£–î–ê–õ–ò–¢–¨ –í–°–Æ –ò–°–¢–û–†–ò–Æ "${nm}"? –≠–¢–û –ù–ï–û–ë–†–ê–¢–ò–ú–û!`))return;if(prompt('–í–≤–µ–¥–∏—Ç–µ DELETE')!=='DELETE')return;const u={},d=data[cat]||{};Object.entries(d).forEach(([k,v])=>{if(v.name===nm)u[`/${cat}/${k}`]=null});if(Object.keys(u).length){await db.update(u);closeModal();alert('–£–¥–∞–ª–µ–Ω–æ')}else alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ')}

window.calcFilm=function(){
 const vz=gID('fVz').value.split('+').reduce((a,b)=>a+parseFloat(b)||0,0);
 const os=parseFloat(gID('fOs').value)||0;
 const u=Math.max(0, vz-os);
 gID('fUsed').value=u.toFixed(2)+' –∫–≥';
};

window.addFasRow=function(){
 const i=Date.now()+Math.random().toString().slice(2,7);
 gID('fasRows').insertAdjacentHTML('beforeend',`<div class="fas-row" id="fr_${i}">
  <select id="fs_${i}" class="fas-inp" onchange="updFasRawList('${i}')"><option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option><option value="Stock_DV">–î–í –≤–µ—Å</option></select>
  <select id="fn_${i}" class="fas-inp"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option></select>
  <input type="number" id="fq_${i}" class="fas-inp" placeholder="–∫–≥">
  <button onclick="this.parentElement.remove()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
 setTimeout(()=>updFasRawList(i),50);
};

window.updFasRawList=function(i){
 const src=gID('fs_'+i).value, sel=gID('fn_'+i), m={};
 if(data[src])Object.values(data[src]).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});
 let h='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
 Object.keys(m).sort().forEach(k=>{
  if(Math.round(m[k])>0) h+=`<option value="${k}">${k} [${Math.round(m[k])} –∫–≥]</option>`;
 });
 sel.innerHTML=h;
};

window.addFasOutRow=function(){
 const i=Date.now()+Math.random().toString().slice(2,7);
 let opts='<option value="">–ü—Ä–æ–¥—É–∫—Ç...</option>';
 gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>opts+=`<option value="${p}">${p}</option>`);
 let pkOpts='<option value="">–ü–∞–∫–µ—Ç...</option>';
 const pkSet=new Set(["300x400","370x500","400x500","420x550"]);
 if(data['–ü–∞–∫–µ—Ç—ã'])Object.values(data['–ü–∞–∫–µ—Ç—ã']).forEach(v=>{if(v.name)pkSet.add(v.name.replace(/—Ö/gi, 'x'))});
 Array.from(pkSet).sort().forEach(p=>pkOpts+=`<option value="${p}">${p}</option>`);
 gID('fasOutRows').insertAdjacentHTML('beforeend',`<div class="fas-row-out" id="fo_${i}">
  <select id="on_${i}" class="fas-inp">${opts}</select>
  <input type="number" id="oq_${i}" class="fas-inp" placeholder="—à—Ç">
  <select id="os_${i}" class="fas-inp">${pkOpts}</select>
  <button onclick="this.parentElement.remove()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
};

window.previewFas=function(){
 const d=gID('fD').value, ds=d.split('-').reverse().join('.');
 const ri=[], oi=[];
 for(let x of gID('fasRows').children){
  const k=x.id.split('_')[1], n=gID('fn_'+k).value, q=parseFloat(gID('fq_'+k).value), s=gID('fs_'+k).value;
  if(n&&q)ri.push({n,q,s});
 }
 for(let x of gID('fasOutRows').children){
  const k=x.id.split('_')[1], n=gID('on_'+k).value, q=parseFloat(gID('oq_'+k).value), sz=gID('os_'+k).value;
  if(n&&q&&sz)oi.push({n,q,sz});
 }
 if(!ri.length||!oi.length) return alert('–í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å—ã—Ä—å–µ –∏ –≥–æ—Ç–æ–≤—É—é –ø—Ä–æ–¥—É–∫—Ü–∏—é!');
 
 const vz=gID('fVz').value, os=parseFloat(gID('fOs').value)||0, vt=vz.split('+').reduce((a,b)=>a+parseFloat(b)||0,0), fU=Math.max(0,vt-os);
 
 let mN = oi[0].n;
 if(mN === '–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 1' || mN === '–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 2') mN = '–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9';
 
 let hRaw='', hOut='', pk={};
 ri.forEach(x=>{
  hRaw+=`<div>${x.n} ${x.q}–∫–≥ <span style="color:#64748b;font-size:10px">(${x.s==='WeightStock'?'–ø–æ–∫.–ø—Ä':'–î–í –≤–µ—Å'})</span></div>`;
 });
 oi.forEach(x=>{
  hOut+=`<div style="display:flex;justify-content:space-between"><span>${x.n}</span><span>${x.q}—à—Ç</span></div>`;
  const coeff = x.n==="–ö—É—Ç—è" ? 19.8 : 9.9;
  pk[x.sz] = (pk[x.sz]||0) + Math.round(x.q/coeff);
 });
 let hPk='';
 Object.keys(pk).forEach(sz=>{hPk+=`<div style="display:flex;justify-content:space-between"><span>–ü–∞–∫–µ—Ç—ã: ${sz}</span><span>${pk[sz]}—à—Ç</span></div>`});
 
 const html=`
  <div class="conf-title">${ds} <span style="color:var(--p);margin-left:15px">${mN}</span></div>
  <div class="conf-sec"><b>—Å—ã—Ä—å–µ:</b></div>${hRaw}
  <div class="conf-sec"><b>–≥–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è:</b></div>${hOut}
  <div class="conf-sec"><b>—Ä–∞—Å—Ö–æ–¥ —É–ø–∞–∫–æ–≤–∫–∏:</b></div>${hPk}
  <div style="display:flex;justify-content:space-between"><span>–ü–ª–µ–Ω–∫–∞: ${mN}</span><span>${fU.toFixed(2)}–∫–≥</span></div>
 `;
 
 gID('confContent').innerHTML=html; gID('confMdl').style.display='flex';
 
 pendingAction=async function(){
  const btn = document.querySelector('#confBox .btn-main[style*="green"]');
  if(btn) { btn.innerText = '‚è≥...'; btn.disabled = true; }
  try{
   const id=db.child('–§–∞—Å–æ–≤–∫–∞').push().key, u={}, ts=new Date().toISOString();
   const dbRi=ri.map(x=>({name:x.n,amount:x.q,source:x.s})), dbOi=oi.map(x=>({name:x.n,size:x.sz,count:x.q}));
   u['/–§–∞—Å–æ–≤–∫–∞/'+id]={date:d+"T12:00:00Z",items:dbRi,outputItems:dbOi,vzial:vt,ostatok:os,filmName:mN};
   
   dbRi.forEach(i=>{u[`/${i.source}/${db.child(i.source).push().key}`]={name:i.name,amount:-i.amount,date:d+"T12:00:00Z",note:'–§–∞—Å',fLink:id,ts:ts}});
   dbOi.forEach(i=>{u['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:i.name,amount:i.count,date:d+"T12:00:00Z",note:'–§–∞—Å',fLink:id,ts:ts}});
   Object.keys(pk).forEach(sz=>{u['/–ü–∞–∫–µ—Ç—ã/'+db.child('–ü–∞–∫–µ—Ç—ã').push().key]={name:sz,amount:-pk[sz],date:d+"T12:00:00Z",note:'–ê–≤—Ç–æ',fLink:id,ts:ts}});
   
   if(fU>0)u['/–ü–ª–µ–Ω–∫–∞/'+db.child('–ü–ª–µ–Ω–∫–∞').push().key]={name:mN,amount:-fU,date:d+"T12:00:00Z",note:'–ê–≤—Ç–æ',fLink:id,ts:ts};
   
   await db.update(u); 
   closeConf(); 
   closeModal(); 
   setCat('–§–∞—Å–æ–≤–∫–∞'); 
  }catch(e){
   alert(e)
  }finally{
   if(btn) { btn.innerText = '–î–ê'; btn.disabled = false; }
  }
 };
};

window.updWsRawList = function(i, pfx){
 const src = gID(pfx+'s_'+i).value, sel = gID(pfx+'n_'+i), m = {};
 if(data[src]) Object.values(data[src]).forEach(v=>{ if(v.name) m[v.name] = (m[v.name]||0) + v.amount; });
 let h = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
 Object.keys(m).sort().forEach(k => {
  if(Math.round(m[k])>0) h+=`<option value="${k}">${k} [${Math.round(m[k])} –∫–≥]</option>`;
 });
 sel.innerHTML = h;
};

window.calcWsMain = function() {
 let tOut = 0;
 ['DV','Semi','Feed'].forEach(t => {
  for(let r of gID('wsOut'+t).children) {
   const i = r.id.split('_')[1];
   const b = parseFloat(gID('wob_'+i).value) || 0;
   const w = parseFloat(gID('wow_'+i).value) || 0;
   const rem = parseFloat(gID('wor_'+i).value) || 0;
   tOut += (b * w) + rem;
  }
 });
 let tAdd = 0;
 for(let r of gID('wsAddRows').children) {
  const i = r.id.split('_')[1];
  tAdd += parseFloat(gID('waq_'+i).value) || 0;
 }
 const mainW = Math.max(0, tOut - tAdd);
 const mRows = gID('wsMainRows').querySelectorAll('.main-raw-q');
 if(mRows.length > 0) mRows[0].value = mainW.toFixed(1);
};

window.addWsMainRow = function() {
 const i = Date.now() + Math.random().toString().slice(2,7);
 const isFirst = gID('wsMainRows').children.length === 0;
 gID('wsMainRows').insertAdjacentHTML('beforeend', `<div class="fas-row" id="wm_${i}">
  <select id="wms_${i}" class="ws-inp" onchange="updWsRawList('${i}','wm')"><option value="Stock_Raw">–°—ã—Ä—å–µ</option><option value="Stock_Semi">–ü/–§</option><option value="Stock_DV">–î–í –≤–µ—Å</option><option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option></select>
  <select id="wmn_${i}" class="ws-inp"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option></select>
  <input type="number" id="wmq_${i}" class="ws-inp main-raw-q" placeholder="–∫–≥" ${isFirst ? 'readonly style="background:#e2e8f0;font-weight:bold;color:var(--p)"' : 'oninput="calcWsMain()"'} >
  <button onclick="this.parentElement.remove(); calcWsMain()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
 setTimeout(()=>updWsRawList(i, 'wm'), 50);
};

window.addWsAddRow = function() {
 const i = Date.now() + Math.random().toString().slice(2,7);
 gID('wsAddRows').insertAdjacentHTML('beforeend', `<div class="fas-row" id="wa_${i}">
  <select id="was_${i}" class="ws-inp" onchange="updWsRawList('${i}','wa')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw">–°—ã—Ä—å–µ</option><option value="Stock_DV">–î–í –≤–µ—Å</option><option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option></select>
  <select id="wan_${i}" class="ws-inp"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option></select>
  <input type="number" id="waq_${i}" class="ws-inp" placeholder="–∫–≥" oninput="calcWsMain()">
  <button onclick="this.parentElement.remove(); calcWsMain()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
 setTimeout(()=>updWsRawList(i, 'wa'), 50);
};

window.addWsOutRow = function(t) {
 const i = Date.now() + Math.random().toString().slice(2,7);
 const cat = t==='DV'?'Stock_DV':(t==='Semi'?'Stock_Semi':'Stock_Feed');
 let opts = '<option value="">–ù–∞–∑–≤–∞–Ω–∏–µ...</option>';
 gP(cat).forEach(p => opts += `<option value="${p}">${p}</option>`);
 gID('wsOut'+t).insertAdjacentHTML('beforeend', `<div class="ws-row-out" id="wo_${i}" data-t="${t}">
  <select id="won_${i}" class="ws-inp" onchange="if(this.value==='NEW'){const n=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:');if(n){const o=document.createElement('option');o.value=n;o.text=n;this.add(o,this.options[1]);this.value=n}else this.value=''}">${opts}<option value="NEW" style="color:blue">–ù–û–í–´–ô...</option></select>
  <input type="number" id="wob_${i}" class="ws-inp" placeholder="–º–µ—à" oninput="calcWsMain()">
  <select id="wow_${i}" class="ws-inp" onchange="if(this.value==='NEW'){const n=prompt('–í–µ—Å –º–µ—à–∫–∞ (–∫–≥):');if(n){const o=document.createElement('option');o.value=n;o.text=n;this.add(o,this.options[1]);this.value=n}else this.value=''} calcWsMain()"><option value="">–∫–≥...</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="NEW" style="color:blue">–ù–û–í–´–ô...</option></select>
  <input type="number" id="wor_${i}" class="ws-inp" placeholder="–æ—Å—Ç" oninput="calcWsMain()">
  <button onclick="this.parentElement.remove(); calcWsMain()" style="background:red;color:white;border:none;border-radius:6px;height:32px;font-weight:900">‚úï</button>
 </div>`);
};
window.previewWorkshop = function(k){
 const c=WS_CFG[k], d=gID('wsD').value, ds=d.split('-').reverse().join('.');
 const ts=gID('wsTS').value, te=gID('wsTE').value, op=getSmartVal('wsOp')||'-', as=getSmartVal('wsAs')||'-';
 const main=[], add=[], out=[]; let tMain=0, tAdd=0, tDV=0;

 for(let x of gID('wsMainRows').children){
  const i=x.id.split('_')[1], s=gID('wms_'+i).value, n=gID('wmn_'+i).value, q=parseFloat(gID('wmq_'+i).value);
  if(n&&q>0) { main.push({s,n,q}); tMain+=q; }
 }
 for(let x of gID('wsAddRows').children){
  const i=x.id.split('_')[1], s=gID('was_'+i).value, n=gID('wan_'+i).value, q=parseFloat(gID('waq_'+i).value);
  if(n&&q>0) { add.push({s,n,q}); tAdd+=q; }
 }
 ['DV','Semi','Feed'].forEach(type=>{
  for(let x of gID('wsOut'+type).children){
   const i=x.id.split('_')[1], n=gID('won_'+i).value, b=parseFloat(gID('wob_'+i).value)||0, w=parseFloat(gID('wow_'+i).value)||0, r=parseFloat(gID('wor_'+i).value)||0;
   if(n && (b>0 || r>0)) { const wght=(b*w)+r; out.push({type, n, b, w, r, wght}); if(type==='DV') tDV+=wght; }
  }
 });

 if(!main.length || !out.length) return alert('–í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤—É –∏ –≤—ã—Ö–æ–¥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏!');

 const tRaw = tMain + tAdd;
 const pct = tRaw > 0 ? ((tDV/tRaw)*100).toFixed(1) : 0;
 const lS = {'Stock_Raw':'—Å—ã—Ä—å–µ','Stock_Semi':'–ø/—Ñ','WeightStock':'–ø–æ–∫.–ø—Ä','Stock_DV':'–î–í –≤–µ—Å'};

 let hRaw='';
 main.forEach(x=> hRaw+=`<div>–û—Å–Ω–æ–≤–∞: ${x.n} <span style="color:#64748b;font-size:10px">(${lS[x.s]})</span> ${x.q}–∫–≥</div>`);
 add.forEach(x=> hRaw+=`<div>–î–æ–±–∞–≤–∫–∞: ${x.n} <span style="color:#64748b;font-size:10px">(${lS[x.s]})</span> ${x.q}–∫–≥</div>`);

 let hDV='', hSemi='', hFeed='';
 out.forEach(x=> {
  const str = `<div style="display:flex;justify-content:space-between"><span>${x.n}</span><span>${x.b}–º√ó${x.w}–∫–≥${x.r>0?'+'+x.r+'–∫–≥':''}</span></div>`;
  if(x.type==='DV') hDV+=str; else if(x.type==='Semi') hSemi+=str; else hFeed+=str;
 });

 const html=`
  <div style="text-align:center;font-weight:900;color:var(--p);font-size:14px;margin-bottom:5px">${c.title}</div>
  <div style="display:flex;justify-content:space-between;border-bottom:2px solid #e2e8f0;padding-bottom:5px;margin-bottom:5px"><span style="font-weight:900">${ds}</span><span>${ts}-${te}</span></div>
  <div style="text-align:center;margin-bottom:5px">${op} | ${as}</div>
  <div class="conf-sec" style="margin-top:0;border:none"><b>—Å—ã—Ä—å–µ:</b></div>${hRaw}
  ${hDV?`<div class="conf-sec"><b>–î–í –≤–µ—Å:</b></div>${hDV}`:''}
  ${hSemi?`<div class="conf-sec"><b>–ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç:</b></div>${hSemi}`:''}
  ${hFeed?`<div class="conf-sec"><b>–æ—Ç—Ö–æ–¥—ã:</b></div>${hFeed}`:''}
  <div class="conf-sec" style="font-weight:900;display:flex;justify-content:space-between"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É:</span><span>${tRaw}–∫–≥</span></div>
  <div style="font-weight:900;display:flex;justify-content:space-between;color:var(--s)"><span>–í—ã—Ö–æ–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏:</span><span>${pct}%</span></div>
 `;

 gID('confContent').innerHTML=html; gID('confMdl').style.display='flex';

 pendingAction=async function(){
  const btn = document.querySelector('#confBox .btn-main[style*="green"]');
  if(btn) { btn.innerText = '‚è≥...'; btn.disabled = true; }
  try{
   const id=db.child(c.db).push().key, u={}, tsStr=new Date().toISOString();
   const itemsDb = out.map(x=> ({type:x.type, n:x.n, q:x.b, w:x.w, l:x.r}));
   const rawBase = main[0] ? {n:main[0].n, w:main[0].q, s:main[0].s} : null;
   const rawAdd = add.map(x=> ({n:x.n, w:x.q, s:x.s}));

   u['/'+c.db+'/'+id]={ date: d+"T12:00:00Z", timeStart: ts, timeEnd: te, operator: op, assistant: as, items: itemsDb, rawBase: rawBase, rawAdd: rawAdd };

   main.forEach(x=> { u[`/${x.s}/${db.child(x.s).push().key}`]={name:x.n,amount:-x.q,date:d+"T12:00:00Z",note:c.note + ' –û—Å–Ω–æ–≤–∞',fLink:id,ts:tsStr} });
   add.forEach(x=> { u[`/${x.s}/${db.child(x.s).push().key}`]={name:x.n,amount:-x.q,date:d+"T12:00:00Z",note:c.note + ' –î–æ–±–∞–≤–∫–∞',fLink:id,ts:tsStr} });

   out.forEach(x=> {
    const cat = x.type==='DV'?'Stock_DV':(x.type==='Semi'?'Stock_Semi':'Stock_Feed');
    u[`/${cat}/${db.child(cat).push().key}`]={name:x.n,amount:x.wght,date:d+"T12:00:00Z",note:c.note,fLink:id,ts:tsStr}
   });

   await db.update(u); 
   closeConf(); 
   closeModal(); 
   setCat(cur); 
  }catch(e){
   alert(e)
  }finally{
   if(btn) { btn.innerText = '–î–ê'; btn.disabled = false; }
  }
 };
};

function genDayReport(){
  const d=gID('repDate').value;if(!d)return;
  const ds=d.split('-').reverse().join('.');
  
  const rOutFas={}, rOutVes={}, rOutFeed={}, rInc={}, rToProd={}, rFromProd={}, rAuto={};
  
  const addV = (obj, key, val, unit, name='', src='', dest='') => {
     if(!obj[key]) obj[key] = {v:0, u:unit, n:name||key, src, dest};
     obj[key].v += Math.abs(val);
  };

  const catLabels = {'Stock_DV':'–î–í –≤–µ—Å','Stock_Semi':'–ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç','Stock_Feed':'–æ—Ç—Ö–æ–¥—ã','Stock_Raw':'—Å—ã—Ä—å–µ','WeightStock':'–ø–æ–∫—É–ø–Ω–∞—è','–ì–æ—Ç–æ–≤–∞—è':'—Ñ–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è'};

  if(data.ArchIncoming) Object.values(data.ArchIncoming).forEach(v => {
     if(v.date && v.date.startsWith(d)) { 
         if(v.items) {
             v.items.forEach(it => addV(rInc, it.n, it.a, '–∫–≥', it.n));
         } else if(v.name) {
             addV(rInc, v.name, v.amount, '–∫–≥', v.name); 
         }
     }
  });
  if(data.ArchPackIn) Object.values(data.ArchPackIn).forEach(v => {
     if(v.date && v.date.startsWith(d)) {
        let n = v.name;
        let u = v.category==='–ü–ª–µ–Ω–∫–∞' ? '–∫–≥' : '—à—Ç';
        addV(rInc, n, v.amount, u, n);
     }
  });

  const catsToCheck = ['Stock_DV','Stock_Semi','Stock_Feed','Stock_Raw','WeightStock','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'];
  catsToCheck.forEach(cat => {
     if(!data[cat]) return;
     let isPack = ['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(cat);
     let defUnit = (isPack && cat!=='–ü–ª–µ–Ω–∫–∞') || cat==='–ì–æ—Ç–æ–≤–∞—è' ? '—à—Ç' : '–∫–≥';
     
     Object.values(data[cat]).forEach(v => {
        if(!v.date || !v.date.startsWith(d) || !v.name) return;
        let amt = v.amount, note = v.note || '', n = v.name;
        
        if(amt < 0) {
           if(note.startsWith('–û—Ç–≥—Ä:') && cat !== '–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞') {
              if(cat==='–ì–æ—Ç–æ–≤–∞—è') addV(rOutFas, n, amt, defUnit, n);
              else if(cat==='WeightStock') addV(rOutVes, n+'::–ø–æ–∫—É–ø–Ω–∞—è', amt, defUnit, n, '–ø–æ–∫—É–ø–Ω–∞—è');
              else if(cat==='Stock_DV') addV(rOutVes, n+'::–î–í –≤–µ—Å', amt, defUnit, n, '–î–í –≤–µ—Å');
              else if(cat==='Stock_Feed') addV(rOutFeed, n, amt, defUnit, n);
           } 
           else if(isPack) {
              addV(rAuto, n, amt, defUnit, n); 
           }
           else {
              addV(rToProd, n+'::'+cat+'::'+note, amt, defUnit, n, catLabels[cat]||cat, note);
           }
        } else if(amt > 0) {
           if (isPack || cat === 'Stock_Raw' || cat === 'WeightStock') {
               if (note.startsWith('–ö–æ—Ä:')) addV(rFromProd, n + ' (–∫–æ—Ä—Ä.)', amt, defUnit, n + ' (–∫–æ—Ä—Ä.)');
               return; 
           }
           if(note === '–ü—Ä–∏—Ö–æ–¥' || note === '–ü—Ä–∏—Ö–æ–¥ —Å—ã—Ä—å—è') return; 
           let suffix = note.startsWith('–ö–æ—Ä:') ? ' (–∫–æ—Ä—Ä.)' : '';
           addV(rFromProd, n+suffix, amt, defUnit, n+suffix);
        }
     });
  });

  const fmt = (x) => {
     let r = `<div class="dr-row"><div class="dr-left" style="width:100%; display:flex; justify-content:space-between; align-items:center;"><span class="dr-name">${x.n}</span><span class="dr-qty">${x.v % 1 === 0 ? x.v : x.v.toFixed(2)}${x.u}</span></div>`;
     if (x.src && x.dest && x.dest !== '–ê–≤—Ç–æ' && x.dest !== '–§–∞—Å') r += `<div class="dr-hint" style="width:100%; text-align:right; margin-top:-2px; font-size:10px; color:#64748b;">(${x.src} -> ${x.dest})</div>`;
     r += `</div>`; return r;
  };

  const renderList = (obj) => {
     let vals = Object.values(obj).sort((a,b)=>a.n.localeCompare(b.n));
     if(!vals.length) return '<div style="color:#94a3b8; font-size:11px;">-</div>';
     return vals.map(fmt).join('');
  };

  let blockOutFas = renderList(rOutFas), blockOutVes = renderList(rOutVes), blockOutFeed = renderList(rOutFeed), blockInc = renderList(rInc), blockToProd = renderList(rToProd), blockFromProd = renderList(rFromProd), blockAuto = renderList(rAuto); 

  let screenHtml = `<div style="font-weight:900;text-align:center;font-size:16px;margin-bottom:15px;color:var(--p)">–î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢ ${ds}</div><div class="dr-card"><div class="dr-sec">–û–¢–ì–†–£–ó–ö–ò –°–û –°–ö–õ–ê–î–ê:</div><div class="dr-sub">- —Ñ–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</div><div style="margin-bottom:8px;">${blockOutFas}</div><div class="dr-sub">- –≤–µ—Å–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</div><div style="margin-bottom:8px;">${blockOutVes}</div><div class="dr-sub">- –æ—Ç—Ö–æ–¥—ã</div><div>${blockOutFeed}</div></div><div class="dr-card"><div class="dr-sec">–ü–†–ò–•–û–î –ù–ê –°–ö–õ–ê–î:</div><div>${blockInc}</div></div><div class="dr-card"><div class="dr-sec">–£–®–õ–û –í –ü–ï–†–ï–†–ê–ë–û–¢–ö–£:</div><div>${blockToProd}</div></div><div class="dr-card"><div class="dr-sec">–ü–†–ò–•–û–î –ù–ê –°–ö–õ–ê–î –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê:</div><div>${blockFromProd}</div></div><div class="dr-card"><div class="dr-sec">–ê–í–¢–û–°–ü–ò–°–ê–ù–ò–ï –£–ü–ê–ö–û–í–ö–ò:</div><div>${blockAuto}</div></div>`;
  let printHtml = `<div style="font-weight:900;text-align:center;font-size:16px;margin-bottom:15px;color:#000;">–î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢ ${ds}</div><div class="dr-print-wrap"><div class="dr-print-col"><div class="dr-sec">–û–¢–ì–†–£–ó–ö–ò –°–û –°–ö–õ–ê–î–ê:</div><div class="dr-sub" style="margin-bottom:4px; font-weight:bold;">- —Ñ–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</div><div style="margin-bottom:8px;">${blockOutFas}</div><div class="dr-sub" style="margin-bottom:4px; font-weight:bold;">- –≤–µ—Å–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</div><div style="margin-bottom:8px;">${blockOutVes}</div><div class="dr-sub" style="margin-bottom:4px; font-weight:bold;">- –æ—Ç—Ö–æ–¥—ã</div><div style="margin-bottom:15px;">${blockOutFeed}</div><div class="dr-sec">–ü–†–ò–•–û–î –ù–ê –°–ö–õ–ê–î:</div><div>${blockInc}</div></div><div class="dr-print-col"><div class="dr-sec">–£–®–õ–û –í –ü–ï–†–ï–†–ê–ë–û–¢–ö–£:</div><div style="margin-bottom:15px;">${blockToProd}</div><div class="dr-sec">–ü–†–ò–•–û–î –ù–ê –°–ö–õ–ê–î –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê:</div><div style="margin-bottom:15px;">${blockFromProd}</div><div class="dr-sec">–ê–í–¢–û–°–ü–ò–°–ê–ù–ò–ï –£–ü–ê–ö–û–í–ö–ò:</div><div>${blockAuto}</div></div></div>`;

  gID('print-view').innerHTML = printHtml;
  gID('mB').innerHTML = screenHtml + `<button class="btn-main" onclick="window.print()" style="margin-top:15px;background:#0f172a">üñ®Ô∏è –ü–ï–ß–ê–¢–¨</button>`;
}

function genMonthReport(){const m=gID('repMth').value;if(!m)return alert('–ú–µ—Å—è—Ü?');const[y,mt]=m.split('-'),sd=`${y}-${mt}-01`,ed=`${y}-${mt}-31`;const res={};stockCatsAll.forEach(c=>{if(data[c])Object.values(data[c]).forEach(v=>{if(v.name){if(!res[c])res[c]={};if(!res[c][v.name])res[c][v.name]={s:0,i:0,o:0};const a=v.amount,vd=v.date.split('T')[0];if(vd<sd)res[c][v.name].s+=a;else if(vd<=ed){if(a>0)res[c][v.name].i+=a;else res[c][v.name].o+=Math.abs(a)}}})});let h=`<div style="text-align:center;font-weight:900">–û–¢–ß–ï–¢: ${m}</div><table style="width:100%;font-size:10px;border-collapse:collapse" border="1"><tr><td>–ù–ê–ó–í–ê–ù–ò–ï</td><td>–ù–ê–ß</td><td>–ü–†–ò–•</td><td>–†–ê–°–•</td><td>–ö–û–ù</td></tr>`;Object.keys(res).forEach(c=>{h+=`<tr><td colspan="5" style="background:#eee"><b>${c}</b></td></tr>`;Object.keys(res[c]).forEach(n=>{const i=res[c][n],e=i.s+i.i-i.o;if(Math.abs(i.s)+i.i+i.o>0.1)h+=`<tr><td>${n}</td><td>${Math.round(i.s)}</td><td>${Math.round(i.i)}</td><td>${Math.round(i.o)}</td><td><b>${Math.round(e)}</b></td></tr>`})});gID('print-view').innerHTML=h+'</table>';gID('mB').innerHTML=h+`</table><button class="btn-main" onclick="window.print()">–ü–ï–ß–ê–¢–¨</button>`}

function makeSmart(id,l,p){let o=`<option value="">${p}</option>`;l.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW" style="color:blue">NEW...</option>`;return `<select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${o}</select><input type="text" id="i_${id}" class="smart-inp" style="display:none" placeholder="${p}">`}
function checkSmart(id){const s=gID('s_'+id),i=gID('i_'+id);if(s.value==='NEW'){s.style.display='none';i.style.display='block';i.focus()}else{i.style.display='none';i.value=''}}
function getSmartVal(id){const s=gID('s_'+id),i=gID('i_'+id);return s.style.display==='none'?i.value:s.value}
function getHistoryDeep(f){const s=new Set();['Vibro_Report','Krup_Report','ZSHM_Report'].forEach(d=>{if(data[d])Object.values(data[d]).forEach(v=>{if(v[f])s.add(v[f])})});return Array.from(s).sort()}

window.delRec=async (c,i)=>{if(!confirm('–£–î–ê–õ–ò–¢–¨ –ó–ê–ü–ò–°–¨ –ò –í–ï–†–ù–£–¢–¨ –¢–û–í–ê–† –ù–ê –°–ö–õ–ê–î?'))return;const u={};u[`/${c}/${i}`]=null;stockCatsAll.forEach(cat=>{if(data[cat]){Object.entries(data[cat]).forEach(([key,val])=>{if(val.fLink===i)u[`/${cat}/${key}`]=null})}});try{await db.update(u);alert('–£–¥–∞–ª–µ–Ω–æ, —Ç–æ–≤–∞—Ä –≤–æ–∑–≤—Ä–∞—â–µ–Ω')}catch(e){alert(e)}};

function addTimeRow(n='',r=''){const i=Date.now()+Math.random();gID('tsRows').insertAdjacentHTML('beforeend',`<div class="ts-row" id="tr_${i}" style="display:grid;grid-template-columns:1fr 80px 30px;gap:2px;margin-bottom:2px"><input type="text" id="tn_${i}" placeholder="–§–ò–û" value="${n}"><input type="number" id="trate_${i}" placeholder="–°—Ç–∞–≤–∫–∞" value="${r}"><button onclick="this.parentElement.remove()" style="background:red;color:white;border:none">x</button></div>`)}
async function saveTimesheetBatch(){const d=gID('gTD').value,s=gID('gTS').value,e=gID('gTE').value,u={},cr=[];let t=0;D.querySelectorAll('#tsRows .ts-row').forEach(r=>{const k=r.id.split('_')[1],n=gID('tn_'+k).value,rt=parseFloat(gID('trate_'+k).value);if(n&&rt>0){cr.push({name:n,rate:rt});t+=rt;u['/Timesheet/'+db.child('Timesheet').push().key]={date:d,name:n,start:s,end:e,rate:rt,ts:new Date().toISOString()}}});if(!cr.length)return alert('–ü—É—Å—Ç–æ');try{await db.update(u);localStorage.setItem('activeCrew',JSON.stringify(cr));alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –í—Å–µ–≥–æ: '+t)}catch(err){alert(err)}}
function renderTsList(c){const d=data.Timesheet||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card"><div class="j-head">${v.date.split('-').reverse().join('.')}</div><div>${v.name}: ${v.start}-${v.end} (${v.rate} –≥—Ä–Ω)</div>${isAdmin?`<button onclick="delRec('Timesheet','${i}')" style="color:red;border:none;background:0 0;margin-top:5px">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}

window.openAddPrice=function(){aId=null;gID('mdl').style.display='flex';gID('mT').innerText='–î–û–ë–ê–í–ò–¢–¨ –í –ü–†–ê–ô–°';gID('mB').innerHTML=`<div>–¢–û–í–ê–† <input type="text" id="prN"></div><div>–î–õ–Ø –ü–ï–ß–ê–¢–ò (–Ω–∞–∫–ª–∞–¥–Ω–∞—è) <input type="text" id="prP" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div><div>–¶–ï–ù–ê –û–ü–¢ <input type="number" id="prO"></div><div>–¶–ï–ù–ê –†–û–ó–ù–ò–¶–ê <input type="number" id="prR"></div><button class="btn-main" onclick="sPrice()">–°–û–•–†–ê–ù–ò–¢–¨</button>`};
window.editPrice=function(id,n,p,o,r){
 aId=id;gID('mdl').style.display='flex';gID('mT').innerText='–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨';
 const sN=String(n).replace(/"/g,'&quot;'), sP=String(p||'').replace(/"/g,'&quot;');
 gID('mB').innerHTML=`<div>–¢–û–í–ê–† <input type="text" id="prN" value="${sN}"></div><div>–î–õ–Ø –ü–ï–ß–ê–¢–ò (–Ω–∞–∫–ª–∞–¥–Ω–∞—è) <input type="text" id="prP" value="${sP}"></div><div>–¶–ï–ù–ê –û–ü–¢ <input type="number" id="prO" value="${o}"></div><div>–¶–ï–ù–ê –†–û–ó–ù–ò–¶–ê <input type="number" id="prR" value="${r}"></div><button class="btn-main" onclick="sPrice()">–°–û–•–†–ê–ù–ò–¢–¨</button>`
};
window.sPrice=async function(){const n=gID('prN').value,p=gID('prP').value,o=parseFloat(gID('prO').value)||0,r=parseFloat(gID('prR').value)||0;if(!n)return alert('–ù–∞–∑–≤–∞–Ω–∏–µ?');const k=aId||db.child('PriceList').push().key;try{await db.child('PriceList/'+k).set({name:n,printName:p,priceOpt:o,priceRoz:r});closeModal()}catch(e){alert(e)}};
window.delPrice=async function(i){if(confirm('–£–¥–∞–ª–∏—Ç—å?')){await db.child('PriceList/'+i).remove();loadData()}};

window.printPriceList = function() {
 const d = data.PriceList || {};
 const cats = {'–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è':[],'–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è':[],'–î–í –≤–µ—Å':[],'–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞':[],'–ü—Ä–æ—á–µ–µ':[]};
 const g=new Set();if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(x=>g.add(x.name));
 const w=new Set();if(data.WeightStock)Object.values(data.WeightStock).forEach(x=>w.add(x.name));
 const dv=new Set();if(data.Stock_DV)Object.values(data.Stock_DV).forEach(x=>dv.add(x.name));
 const f=new Set();if(data.Stock_Feed)Object.values(data.Stock_Feed).forEach(x=>f.add(x.name));
 
 Object.entries(d).forEach(([i,v])=>{
  let po=parseFloat(v.priceOpt||v.price||0), pr=parseFloat(v.priceRoz||0);
  if(po===0 && pr===0) return; 
  if(g.has(v.name))cats['–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è'].push({v, po, pr});
  else if(w.has(v.name))cats['–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è'].push({v, po, pr});
  else if(dv.has(v.name))cats['–î–í –≤–µ—Å'].push({v, po, pr});
  else if(f.has(v.name))cats['–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'].push({v, po, pr});
  else cats['–ü—Ä–æ—á–µ–µ'].push({v, po, pr});
 });

 const ds = new Date().toLocaleDateString('ru-RU');
 let h = `<div style="font-family:sans-serif; color:#000;">`;
 h += `<div style="font-weight:900;font-size:18px;margin-bottom:15px;text-align:center;">–ü–†–ê–ô–°-–õ–ò–°–¢ –æ—Ç ${ds}</div>`;
 
 Object.keys(cats).forEach(k => {
  if(!cats[k].length) return;
  cats[k].sort((a,b)=>a.v.name.localeCompare(b.v.name));
  
  h += `<div style="font-weight:bold; font-size:16px; margin-top:15px; margin-bottom:5px; border-bottom:1px solid #000; padding-bottom:2px; display:inline-block; padding-right:30px;">${k}</div>`;
  h += `<table style="border-collapse:collapse; font-size:12px; line-height:1.1; margin-bottom:10px; width:auto;">`;
  h += `<thead><tr><th style="text-align:left; border-bottom:1px solid #ccc; padding:2px 15px 2px 0;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th style="text-align:right; border-bottom:1px solid #ccc; padding:2px 15px;">–û–ø—Ç</th><th style="text-align:right; border-bottom:1px solid #ccc; padding:2px 0 2px 15px;">–†–æ–∑–Ω–∏—Ü–∞</th></tr></thead><tbody>`;
  
  cats[k].forEach(item => {
   let n = item.v.printName || item.v.name;
   let opt = item.po > 0 ? item.po : '-';
   let roz = item.pr > 0 ? item.pr : '-';
   h += `<tr><td style="padding:2px 15px 2px 0; border-bottom:1px dashed #eee;">${n}</td><td style="text-align:right; font-weight:bold; padding:2px 15px; border-bottom:1px dashed #eee;">${opt}</td><td style="text-align:right; font-weight:bold; padding:2px 0 2px 15px; border-bottom:1px dashed #eee;">${roz}</td></tr>`;
  });
  h += `</tbody></table>`;
 });
 
 h += `</div>`;
 gID('print-view').innerHTML = h; window.print(); setTimeout(()=>gID('print-view').innerHTML='',800);
};

function rPriceList(c){
 if(!isAdmin){c.innerHTML='<div style="text-align:center;padding:20px">–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞</div>';return}
 const d=data.PriceList||{}, cats={'–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è':[],'–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è':[],'–î–í –≤–µ—Å':[],'–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞':[],'–ü—Ä–æ—á–µ–µ':[]};
 const g=new Set();if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(x=>g.add(x.name));
 const w=new Set();if(data.WeightStock)Object.values(data.WeightStock).forEach(x=>w.add(x.name));
 const dv=new Set();if(data.Stock_DV)Object.values(data.Stock_DV).forEach(x=>dv.add(x.name));
 const f=new Set();if(data.Stock_Feed)Object.values(data.Stock_Feed).forEach(x=>f.add(x.name));
 Object.entries(d).forEach(([i,v])=>{
  if(g.has(v.name))cats['–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è'].push({i,v});
  else if(w.has(v.name))cats['–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è'].push({i,v});
  else if(dv.has(v.name))cats['–î–í –≤–µ—Å'].push({i,v});
  else if(f.has(v.name))cats['–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'].push({i,v});
  else cats['–ü—Ä–æ—á–µ–µ'].push({i,v});
 });
 let h=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><button class="btn-main" onclick="openAddPrice()" style="margin:0">+ –¢–û–í–ê–† –í –ü–†–ê–ô–°</button><button class="btn-main" onclick="printPriceList()" style="background:#0f172a;margin:0">üñ®Ô∏è –ü–ï–ß–ê–¢–¨ –ü–†–ê–ô–°–ê</button></div>`;
 Object.keys(cats).forEach(k=>{if(cats[k].length){
  h+=`<div class="cat-head">${k}</div>`;
  cats[k].sort((a,b)=>a.v.name.localeCompare(b.v.name)).forEach(({i,v})=>{
   h+=`<div class="j-card" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">${v.name}</div>${v.printName?`<div style="font-size:10px;color:#0369a1">–ü–µ—á–∞—Ç—å: ${v.printName}</div>`:''}<div style="font-size:11px;color:#666">–û–ø—Ç: <span style="color:var(--p);font-weight:900">${v.priceOpt||(v.price||0)}</span> | –†–æ–∑–Ω–∏—Ü–∞: <span style="color:var(--s);font-weight:900">${v.priceRoz||0}</span></div></div><div><button onclick="editPrice('${i}','${esc(v.name)}','${esc(v.printName||'')}',${v.priceOpt||(v.price||0)},${v.priceRoz||0})" style="background:#eef2ff;border:none;padding:5px 10px;border-radius:5px;margin-right:5px">‚úèÔ∏è</button><button onclick="delPrice('${i}')" style="background:#fee2e2;color:red;border:none;padding:5px 10px;border-radius:5px">üóëÔ∏è</button></div></div>`
  });
 }});c.innerHTML=h;
}

function rConsolidated(c){
 let h=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:15px"><button class="btn-main" onclick="openModal('dayRep')" style="background:#0f172a;font-size:10px;margin:0">–î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢</button><button class="btn-main" onclick="openModal('monthRep')" style="background:#0f172a;font-size:10px;margin:0">–ú–ï–°–Ø–ß–ù–´–ô</button><button class="btn-main" onclick="printConsolidated()" style="background:var(--s);font-size:10px;margin:0">üñ®Ô∏è –ü–ï–ß–ê–¢–¨ –û–¢–ß–ï–¢–ê</button></div>`;
 const r={};stockCatsAll.forEach(cat=>{if(data[cat]){Object.values(data[cat]).forEach(v=>{if(v.name){if(!r[cat])r[cat]={};r[cat][v.name]=(r[cat][v.name]||0)+v.amount;}})}});
 const drawCat=(name,key)=>{
  if(!r[key])return '';let ch=`<div class="cat-head">${name}</div><div class="item-grid compact-grid" style="grid-template-columns:1fr 1fr">`,has=!1;
  Object.keys(r[key]).sort().forEach(n=>{const v=r[key][n];if(Math.abs(v)>0.1){has=!0;ch+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div></div>`}});
  ch+='</div>';return has?ch:'';
 };
 h+=drawCat('–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è','–ì–æ—Ç–æ–≤–∞—è')+drawCat('–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è','WeightStock')+drawCat('–î–í –≤–µ—Å','Stock_DV')+drawCat('–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞','Stock_Feed')+drawCat('–°—ã—Ä—å–µ','Stock_Raw')+drawCat('–ü/–§','Stock_Semi');
 const pk={'–ü–ª–µ–Ω–∫–∞':'–ü–ª–µ–Ω–∫–∞','–ü–∞–∫–µ—Ç—ã':'–ü–∞–∫–µ—Ç—ã','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'–°–∫–æ—Ç—á','–ú–µ—à–∫–∏':'–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏':'–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞':'–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'};
 Object.keys(pk).forEach(k=>{
  if(r[k]){
   let ph=`<div class="cat-head">${pk[k]}</div><div class="item-grid compact-grid" style="grid-template-columns:1fr 1fr">`,hp=!1;
   Object.keys(r[k]).sort().forEach(n=>{const v=r[k][n];if(Math.abs(v)>0.1){hp=!0;ph+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${(k==='–ü–ª–µ–Ω–∫–∞'||k==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')?v.toFixed(2):Math.round(v)}</div></div>`}});
   ph+='</div>';if(hp)h+=ph;
  }
 });
 if(isAdmin)h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:20px"><button class="btn-main" onclick="openModal('arch')" style="background:red">–°–í–ï–†–¢–´–í–ê–ù–ò–ï</button><button class="btn-main" onclick="openModal('closeMonth')" style="background:orange;color:#000">–ó–ê–ö–†–´–¢–¨ –ú–ï–°–Ø–¶</button></div>`;
 c.innerHTML=h;
}

window.printConsolidated=function(){
 const r={};stockCatsAll.forEach(cat=>{if(data[cat]){Object.values(data[cat]).forEach(v=>{if(v.name){if(!r[cat])r[cat]={};r[cat][v.name]=(r[cat][v.name]||0)+v.amount}})}});
 const bL=(t,k,u)=>{
  if(!r[k])return '';
  let i=Object.keys(r[k]).sort().filter(n=>Math.abs(r[k][n])>0.1).map(n=>{
   let val=(k==='–ü–ª–µ–Ω–∫–∞'||k==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')?r[k][n].toFixed(2):Math.round(r[k][n]);
   return `<div style="font-size:12px;font-weight:normal;margin-bottom:2px">${n} <b>${val}${u}</b></div>`;
  });
  if(!i.length)return '';
  return `<div style="font-size:14px;font-weight:bold;margin-top:10px;margin-bottom:5px">${t}</div>`+i.join('');
 };
 let L=bL('–§–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è','–ì–æ—Ç–æ–≤–∞—è','—à—Ç')+bL('–ü–æ–∫—É–ø–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è','WeightStock','–∫–≥')+bL('–î–í –≤–µ—Å','Stock_DV','–∫–≥')+bL('–û—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞','Stock_Feed','–∫–≥');
 let R=bL('–ü/–§','Stock_Semi','–∫–≥')+bL('–°—ã—Ä—å–µ','Stock_Raw','–∫–≥');
 const pk={'–ü–ª–µ–Ω–∫–∞':{n:'–ü–ª–µ–Ω–∫–∞',u:'–∫–≥'},'–ü–∞–∫–µ—Ç—ã':{n:'–ü–∞–∫–µ—Ç—ã',u:'—à—Ç'},'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':{n:'–°–∫–æ—Ç—á',u:'—à—Ç'},'–ú–µ—à–∫–∏':{n:'–ú–µ—à–∫–∏',u:'—à—Ç'},'–ù–∏—Ç–∫–∏':{n:'–ù–∏—Ç–∫–∏',u:'—à—Ç'},'–≠—Ç–∏–∫–µ—Ç–∫–∞':{n:'–≠—Ç–∏–∫–µ—Ç–∫–∞',u:'—à—Ç'},'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':{n:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',u:'—à—Ç'},'–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':{n:'–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞',u:'—à—Ç'}};
 Object.keys(pk).forEach(k=>{R+=bL(pk[k].n,k,pk[k].u)});
 let ds=new Date().toLocaleDateString('ru-RU'),h=`<div style="text-align:center;font-weight:900;font-size:18px;margin-bottom:15px;color:#000">–°–í–û–î–ù–´–ô –û–¢–ß–ï–¢ –û–°–¢–ê–¢–ö–û–í (${ds})</div><div style="display:flex;width:100%;gap:20px;color:#000"><div style="flex:1;width:50%">${L}</div><div style="flex:1;width:50%">${R}</div></div>`;
 gID('print-view').innerHTML=h;window.print();setTimeout(()=>gID('print-view').innerHTML='',800);
}

async function archiveRawBatch(n){if(!confirm(`–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–∏—é "${n}"?`))return;const k=db.child('Stock_Archive').push().key,u={},d=data.Stock_Raw||{};let t=0;Object.entries(d).forEach(([id,v])=>{if(v.name===n){t+=v.amount;u['/Stock_Raw/'+id]=null}});u['/Stock_Archive/'+k]={name:n,amount:t,date:new Date().toISOString(),note:'–ê—Ä—Ö–∏–≤ –ø–∞—Ä—Ç–∏–∏'};if(Object.keys(u).length>1){await db.update(u);alert('–ü–∞—Ä—Ç–∏—è –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');closeModal();loadData();}}
function rRawArch(c){const d=data.Stock_Archive||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card" style="display:flex;justify-content:space-between"><div><b>${v.name}</b>: ${v.amount.toFixed(2)} –∫–≥</div>${isAdmin?`<button onclick="delRec('Stock_Archive','${i}')" style="color:red;border:none;background:0 0">–£–î–ê–õ–ò–¢–¨</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
async function runArchive(){const d=gID('archDate').value;if(!d)return;if(prompt('–í–≤–µ–¥–∏—Ç–µ ARCHIVE –¥–ª—è —Å–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–æ '+d)!=='ARCHIVE')return;const u={};stockCatsAll.forEach(c=>{if(!['Timesheet','PriceList','ArchInvoices','ArchIncoming','ArchPackIn','Suppliers','InvoiceSettings'].includes(c)){const cd=data[c]||{},res={};Object.entries(cd).forEach(([k,v])=>{if(v.date.split('T')[0]<=d){res[v.name]=(res[v.name]||0)+v.amount;u[`/${c}/${k}`]=null}});Object.keys(res).forEach(n=>{if(Math.abs(res[n])>0.01)u[`/${c}/${db.child(c).push().key}`]={name:n,amount:res[n],date:d+"T23:59:59Z",note:'–°–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ'}})}});if(Object.keys(u).length){await db.update(u);alert('–£—Å–ø–µ—à–Ω–æ —Å–≤–µ—Ä–Ω—É—Ç–æ')}closeModal()}
async function runCloseMonth(){const d=gID('cmDate').value;if(!d)return;if(prompt('–í–≤–µ–¥–∏—Ç–µ CLOSE –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è')!=='CLOSE')return;const u={};stockCatsAll.forEach(c=>{if(!['Timesheet','PriceList','ArchInvoices','ArchIncoming','ArchPackIn','Suppliers','InvoiceSettings'].includes(c)){const cd=data[c]||{};Object.entries(cd).forEach(([k,v])=>{if(v.date.split('T')[0]<=d)u[`/${c}/${k}`]=null})}});if(Object.keys(u).length){await db.update(u);alert('–ú–µ—Å—è—Ü –∑–∞–∫—Ä—ã—Ç, –æ—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω—É–ª–µ–Ω—ã')}closeModal()}
</script></body></html>
