<!DOCTYPE html><html lang="uk" translate="no"><head><meta charset="UTF-8"><meta name="google" content="notranslate"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>–°–∫–ª–∞–¥ v771</title><script>window.onerror=function(m,u,l){alert("ERR:"+m+"\nL:"+l);return!1}</script><link rel="icon" type="image/png" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png"><style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:0}
:root{--bg:#f8fafc;--p:#4338ca;--d:#dc2626;--s:#059669;--t:#0f172a;--w:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:2px;padding-bottom:60px;color:var(--t);overflow-x:hidden;width:100vw}
#lockScreen{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:opacity .3s}
.lock-hidden{opacity:0;pointer-events:none}
.lock-logo{max-width:80%;height:auto;margin-bottom:20px}
.lock-title{font-size:16px;font-weight:900;color:#475569;letter-spacing:2px;margin-bottom:30px;text-transform:uppercase}
.lock-inp{width:100%;max-width:250px;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e1;border-radius:12px;margin-bottom:10px;font-weight:700}
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;max-width:100%}
.dash-item{background:var(--w);border-radius:16px;padding:5px;text-align:center;box-shadow:0 4px 6px -1px #0000001a;color:var(--p);font-weight:800;text-transform:uppercase;font-size:11px;border:1px solid #cbd5e1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;position:relative}
.dash-item:active{transform:scale(.97);background:#eef2ff}
.card{background:var(--w);border-radius:16px;padding:10px;margin-bottom:6px;box-shadow:0 2px 4px -1px #00000014;border:1px solid #e2e8f0;position:relative;width:100%}
.btn-main{background:var(--p);color:#fff;border:none;width:100%;padding:12px;font-size:12px;font-weight:800;border-radius:12px;margin:4px 0;text-transform:uppercase;box-shadow:0 4px 10px #4338ca33;transition:.2s;cursor:pointer}
.btn-main:active{transform:translateY(1px);box-shadow:none}
.btn-main:disabled{background:#94a3b8}
.bottom-nav{display:none;position:fixed;bottom:5px;left:5px;right:5px;background:#fff;border-radius:20px;box-shadow:0 10px 40px -5px #00000033;padding:5px;z-index:900;grid-template-columns:1fr 1fr;gap:5px;border:1px solid #cbd5e1}
.bottom-nav button{background:0 0;border:none;padding:10px;border-radius:14px;color:#64748b;font-weight:900;font-size:11px;text-transform:uppercase;transition:.2s}
.bottom-nav button.nav-btn-active{background:#e0e7ff;color:var(--p)}
body.nav-active .bottom-nav{display:grid}
input,select{width:100%;padding:0 5px;margin:2px 0;border:1px solid #94a3b8;border-radius:8px;font-size:12px;height:35px;background:#fff;font-weight:700;color:#0f172a}
input:focus,select:focus{border-color:var(--p);background:#f8fafc;outline:2px solid #e0e7ff}
.item-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px}
.item-card{background:#fff;border-radius:8px;padding:6px 2px;text-align:center;box-shadow:0 2px 5px #00000014;border:1px solid #cbd5e1;position:relative;display:flex;flex-direction:column;justify-content:space-between}
.item-title{font-size:8px;font-weight:900;text-transform:uppercase;color:#1e293b;margin-bottom:2px;height:22px;overflow:hidden;line-height:1.1;word-break:break-word}
.item-qty{font-size:12px;font-weight:900;color:#000;margin-bottom:2px}
.compact-grid .item-card{padding:3px 2px;min-height:30px}
.compact-grid .item-title{height:auto;margin-bottom:2px;font-size:8px;line-height:1}
.compact-grid .item-qty{font-size:11px;margin-bottom:0}
.alarm-blink{background:#fee2e2!important;border:2px solid #ef4444!important;color:#b91c1c!important;animation:blink .8s infinite alternate}
@keyframes blink{0%{border-color:red;opacity:1}100%{border-color:#fca5a5;opacity:.6}}
.val-pos{color:#2563eb!important}.val-neg{color:#dc2626!important}
.modal{display:none;position:fixed;inset:0;background:#000000b3;z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-box{background:#fff;width:98%;max-width:400px;border-radius:16px;max-height:96vh;display:flex;flex-direction:column}
.modal-body{overflow-y:auto;padding:10px}
.rep-card{background:#fff;border-radius:16px;padding:8px 12px;margin-bottom:8px;box-shadow:0 2px 5px #0000000d;border:1px solid #e2e8f0}
.j-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;box-shadow:0 2px 4px -1px #00000014;border:1px solid #e2e8f0}
.j-head{font-weight:900;font-size:13px;color:var(--p);margin-bottom:4px}
.logo-box{text-align:center;margin:15px 0}
.logo-img{max-width:95%;max-height:220px;object-fit:contain}
.z-head{font-size:11px;color:#047857;font-weight:900;text-align:center;margin:10px 0 5px;background:#ecfdf5;padding:5px;border-radius:4px;border:1px solid #a7f3d0}
.cat-head{font-size:13px;font-weight:900;color:var(--p);margin:15px 0 5px;border-bottom:2px solid var(--p);text-transform:uppercase}
.grid-3{display:grid;grid-template-columns:1fr 1.5fr 1fr;gap:5px;margin-bottom:5px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:5px}
.grid-2x2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:5px}
.btn-sel{background:#f1f5f9;border:1px solid #cbd5e1;padding:8px;border-radius:8px;font-size:10px;font-weight:800;color:#475569;text-transform:uppercase;width:100%;transition:0.2s}
.btn-sel.active{background:#e0e7ff;border-color:var(--p);color:var(--p)}
.lbl-small{font-size:10px;font-weight:900;color:#64748b;margin-bottom:2px;display:block;text-transform:uppercase}
.head-wrap{transition:max-height .3s;overflow:hidden;max-height:500px}
.head-wrap.collapsed{max-height:0;margin:0;border:none}
.btn-top{position:absolute;top:10px;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:900;border:none;box-shadow:0 2px 5px rgba(0,0,0,0.15);z-index:100;cursor:pointer;text-transform:uppercase}
.btn-adm-off{left:10px;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1}
.btn-adm-on{left:10px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5}
.btn-exit{right:10px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5}
.ver-info{position:absolute;top:40px;left:15px;font-size:9px;color:#64748b;font-weight:900;z-index:100}
.mini-inv{width:100%;border-collapse:collapse;font-size:9px;margin-top:8px;cursor:pointer;background:#fafafa}
.mini-inv th,.mini-inv td{border:1px solid #ddd;padding:2px;text-align:center}
#print-view{display:none;background:#fff;width:100%;height:100%;position:fixed;top:0;left:0;z-index:9999;padding:10px;overflow-y:auto;color:#000}

@media print{
  body *{visibility:hidden}
  #print-view,#print-view *{visibility:visible}
  #print-view{position:absolute;top:0;left:0;display:block;width:100%}
  
  /* –°–¢–ò–õ–Ü –ù–ê–ö–õ–ê–î–ù–û–á - –ù–ï –ó–ú–Ü–ù–ï–ù–û */
  .pr-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:9px;border:2px solid #000!important;table-layout:fixed}
  .pr-table thead{display:table-header-group!important}
  .pr-table tbody{display:table-row-group!important}
  .pr-table tr{display:table-row!important;height:3.5mm!important}
  .pr-table th{border:1px solid #000;border-left:2px solid #000;border-right:2px solid #000;padding:1px;text-align:center;vertical-align:middle;line-height:1}
  .pr-table td{border:1px solid #000;border-left:2px solid #000;border-right:2px solid #000;padding:0;text-align:center;vertical-align:middle;line-height:1;overflow:hidden;white-space:nowrap}
  .pr-table th:nth-child(1),.pr-table td:nth-child(1){width:5%}
  .pr-table th:nth-child(2),.pr-table td:nth-child(2){width:55%;text-align:left!important;padding-left:2px;white-space:normal;word-wrap:break-word}
  .pr-table th:nth-child(3),.pr-table td:nth-child(3){width:10%}
  .pr-table th:nth-child(4),.pr-table td:nth-child(4){width:5%}
  .pr-table th:nth-child(5),.pr-table td:nth-child(5){width:10%}
  .pr-table th:nth-child(6),.pr-table td:nth-child(6){width:15%}
  .pr-lbl{font-weight:normal} .pr-val{font-weight:bold}
  .t-row td{border:none!important;padding-top:6px!important;height:auto!important}
  .t-lbl{text-align:right!important;padding-right:4px!important;font-weight:900;font-size:10px}
  .t-box{border:2px solid #000!important;font-weight:900!important;font-size:10px!important;padding:2px!important}

  /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ó–í–ï–î–ï–ù–û–ì–û –ó–í–Ü–¢–£ (–î–í–Ü –ö–û–õ–û–ù–ö–ò, 12px) */
  .rep-print-container{display:flex;width:100%;gap:20px;font-size:12px;line-height:1.1}
  .rep-col{flex:1;width:50%}
  .rep-cat-title{font-weight:900;text-transform:uppercase;border-bottom:2px solid #000;margin-top:10px;margin-bottom:5px;padding-bottom:2px;font-size:13px}
  .rep-item{padding:1px 0}
  .rep-item-name{font-weight:600;margin-right:4px}
  .rep-item-val{font-weight:900}
}
@media(min-width:800px){body,.bottom-nav,#lockScreen{max-width:500px;margin:0 auto;left:auto;right:auto;transform:none}}
</style></head>
<body>
<div id="lockScreen"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo"><div class="lock-title">–û–ë–õ–Ü–ö</div><input type="email" id="appEmail" class="lock-inp" placeholder="Email"><input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-main" style="max-width:250px" onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button><div id="loginStatus" style="margin-top:10px;color:#64748b;font-weight:700"></div></div>
<div id="act"></div><div id="cnt"></div>
<div class="bottom-nav"><button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button><button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button></div>
<div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:10px 15px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0;font-size:15px;font-weight:900"></h4><button onclick="closeModal()" style="border:none;background:0 0;font-size:20px;color:#999">‚úï</button></div><div id="mB" class="modal-body"></div></div></div>
<div id="confMdl" class="modal"><div id="confBox" class="modal-box" style="text-align:center;padding:20px"><h3 style="margin:0 0 10px">–ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–ù–Ø</h3><div id="confContent" style="background:#f1f5f9;padding:10px;text-align:left;max-height:60vh;overflow-y:auto;white-space:pre-wrap;font-size:12px;margin-bottom:15px"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="closeConf()" style="background:#ccc;color:#333">–ù–Ü</button><button class="btn-main" onclick="doConfirm()" style="background:green">–¢–ê–ö</button></div></div></div>
<div id="print-view"></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
const WS_CFG={'VIBRO':{title:'–í—ñ–±—Ä–æ—Å—Ç—ñ–ª',db:'Vibro_Report',prefix:'v',note:'–í—ñ–±—Ä–æ'},'KRUP':{title:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞',db:'Krup_Report',prefix:'k',note:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞'},'ZSHM':{title:'–ó–®–ú –ó–º—ñ–Ω–∞',db:'ZSHM_Report',prefix:'z',note:'–ó–®–ú'}};
const D=document,gID=i=>D.getElementById(i);
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();
let cur='Home',data={},aId=null,archSub='',corrMode=!1,isLogged=!1,isAdmin=!1,corrCtx={},useStretch=!1,shipBasket={},pendingAction=null,priceMode='opt',priceEdit=!1;
const stockCatsAll=['Stock_DV','Stock_Semi','Stock_Feed','Stock_Raw','WeightStock','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞','Timesheet','PriceList','Suppliers','ArchInvoices','ArchIncoming','ArchPackIn'];

function closeModal(){gID('mdl').style.display='none';gID('confMdl').style.display='none';}

auth.onAuthStateChanged(u=>{if(u){gID('lockScreen').classList.add('lock-hidden');D.body.classList.add('nav-active');isLogged=!0;if(localStorage.getItem('admT')==='1')isAdmin=!0;initAppData()}else{gID('lockScreen').classList.remove('lock-hidden');D.body.classList.remove('nav-active');isLogged=!1;isAdmin=!1;gID('cnt').innerHTML='';data={}}});
function initAppData(){renderHome();stockCatsAll.forEach(p=>{db.child(p).on('value',s=>{data[p]=s.val()||{};if(cur!=='Home')loadData()})});db.child('Timesheet').on('value',s=>{data.Timesheet=s.val()||{}})}
function tryLogin(){const e=gID('appEmail').value,p=gID('appPass').value;if(!e||!p)return alert('–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ');auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message))}
function tryAdmin(){if(isAdmin){isAdmin=!1;localStorage.removeItem('admT');corrMode=!1;renderHome();return alert('–ê–¥–º—ñ–Ω –≤–∏–º–∫–Ω–µ–Ω–æ')}const p=prompt('–ü–∞—Ä–æ–ª—å:');if(p==='3011'){isAdmin=!0;localStorage.setItem('admT','1');renderHome();alert('–ê–¥–º—ñ–Ω —É–≤—ñ–º–∫–Ω–µ–Ω–æ')}}

function renderHome(){if(!isLogged)return;cur='Home';D.body.classList.remove('nav-active');gID('act').innerHTML='';
 const adm=isAdmin?`<button onclick="tryAdmin()" class="btn-top btn-adm-on">–ê–î–ú–Ü–ù –í–ö–õ</button>`:`<button onclick="tryAdmin()" class="btn-top btn-adm-off">–ê–î–ú–Ü–ù</button>`;
 const ver=`<div class="ver-info">v 771<br>${document.lastModified}</div>`;
 const cleanBtn=isAdmin?`<button class="btn-main" onclick="runZeroCleanup()" style="background:red;margin-top:15px;box-shadow:0 4px 10px rgba(220,38,38,0.3)">üßπ –û–ß–ò–°–¢–ò–¢–ò –î–£–ë–õ–Ü</button>`:'';
 gID('cnt').innerHTML=adm+ver+`<button onclick="firebase.auth().signOut()" class="btn-top btn-exit">–í–ò–•–Ü–î</button>
 <div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div>
 <div class="dash-grid">
  <div class="dash-item" onclick="setCat('StockRoot')"><span>üìÇ –°–ö–õ–ê–î</span></div>
  <div class="dash-item" onclick="setCat('ProdSub')"><span>üõ†Ô∏è –í–ò–†–û–ë–ù–ò–¶–¢–í–û</span></div>
  <div class="dash-item" onclick="setCat('Timesheet')"><span>üìÖ –¢–ê–ë–ï–õ–¨</span></div>
  <div class="dash-item" onclick="setCat('Consolidated')"><span>üìä –ó–í–ï–î–ï–ù–ò–ô</span></div>
  <div class="dash-item" onclick="setCat('PriceList')"><span>üí∞ –ü–†–ê–ô–°</span></div>
 </div>${cleanBtn}`;updNav()}

function goBack(){const m={'StockArchive':'Stock_Raw','TsCal':'Timesheet','Timesheet':'Home','StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','PackSub':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'PackSub','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'PackSub','ArchPackIn':'PackSub','Consolidated':'Home','PriceList':'Home'};let n=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')n=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(n)}
function updNav(){gID('navM').className=cur==='Home'?'nav-btn-active':'';gID('navB').className=cur!=='Home'?'nav-btn-active':''}
function ensureData(p){if(!Array.isArray(p))p=[p];p.forEach(x=>{if(!data[x])db.child(x).on('value',s=>{data[x]=s.val()||{};loadData()})})}

function setCat(c){cur=c;D.body.classList.add('nav-active');gID('act').innerHTML='';const ct=gID('cnt');
 if(c==='Home'){renderHome();return}
 if(['Invoices','ArchSubIn','ArchSubOut'].includes(c))ensureData(['ArchIncoming','ArchInvoices']);
 if(['ProdSub','–§–∞—Å–æ–≤–∫–∞','Kruporushka','Vibro','ZSHM'].includes(c))ensureData(['–§–∞—Å–æ–≤–∫–∞','Krup_Report','Vibro_Report','ZSHM_Report']);
 if(c==='StockArchive')ensureData('Stock_Archive');if(['PackSub','ArchPackIn'].includes(c))ensureData('ArchPackIn');
 if(c==='Timesheet'){const td=new Date().toISOString().split('T')[0];
  if(isAdmin){ct.innerHTML=`<div class="card"><div style="text-align:center;font-weight:900;margin-bottom:10px">–¢–ê–ë–ï–õ–¨</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><input type="date" id="gTD" value="${td}"><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px"><input type="time" id="gTS" value="08:00"><input type="time" id="gTE" value="17:00"></div></div><div id="tsRows"></div><button class="btn-main" onclick="addTimeRow()" style="background:#fff;color:var(--p);border:1px solid #ccc">+ –õ–Æ–î–ò–ù–£</button><button class="btn-main" onclick="saveTimesheetBatch()">–ó–ë–ï–†–ï–ì–¢–ò</button></div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–†</button>`;setTimeout(()=>{const s=localStorage.getItem('activeCrew');if(s){const n=JSON.parse(s);if(n.length)n.forEach(x=>typeof x==='object'?addTimeRow(x.name,x.rate):addTimeRow(x));else addTimeRow()}else addTimeRow()},50)}
  else ct.innerHTML=`<div class="z-head">–¢–ê–ë–ï–õ–¨</div><button class="btn-main" onclick="setCat('TsCal')" style="background:#eef2ff;color:var(--p);border:1px solid var(--p)">üìÖ –ö–ê–õ–ï–ù–î–ê–†</button>`
 }
 else if(c==='TsCal'){ct.innerHTML=`<div class="z-head">–û–ë–ï–†–Ü–¢–¨</div><div id="tsList" class="item-grid"></div>`;loadData()}
 else if(c==='StockRoot'){
  let b=isAdmin?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px"><button class="btn-main" style="background:var(--s);margin:0" onclick="openModal('inc')">üì• –ü–†–ò–•–Ü–î</button><button class="btn-main" style="background:var(--d);margin:0" onclick="openModal('ship')">üöö –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</button></div><button class="btn-main" id="corrTile" onclick="toggleCorr()" style="background:#fff;color:var(--p);border:1px solid var(--p);margin-bottom:15px">üîß –ö–û–†–ï–ö–¶–Ü–Ø</button>`:'';
  ct.innerHTML=`${b}<div class="dash-grid"><div class="dash-item" onclick="setCat('StockList')">–§–ê–°–û–í–ê–ù–ê –ü–†–û–î–£–ö–¶–Ü–Ø</div><div class="dash-item" onclick="setCat('WeightStock')">–ü–û–ö–£–ü–ù–ê –ü–†–û–î–£–ö–¶–Ü–Ø</div><div class="dash-item" onclick="setCat('Stock_DV')">–í–õ–ê–°–ù–ï –í–ò–†–û–ë–ù–ò–¶–¢–í–û</div><div class="dash-item" onclick="setCat('Stock_Feed')">–í–Ü–î–•–û–î–ò –í–ò–†–û–ë–ù–ò–¶–¢–í–ê</div><div class="dash-item" onclick="setCat('Stock_Raw')">–°–ò–†–û–í–ò–ù–ê</div><div class="dash-item" onclick="setCat('Stock_Semi')">–ü/–§</div><div class="dash-item" onclick="setCat('PackSub')">–£–ü–ê–ö–û–í–ö–ê</div><div class="dash-item" onclick="setCat('Invoices')">–ê–†–•–Ü–í</div></div><div id="corrCtls" style="margin-top:15px;display:flex;gap:5px;justify-content:center"></div>`
 }
 else if(c==='Stock_Raw'){ct.innerHTML=(isAdmin?`<button class="btn-main" style="background:#e0f2fe;color:#0369a1;margin-bottom:10px" onclick="setCat('StockArchive')">üóÑÔ∏è –ê–†–•–Ü–í</button>`:'')+`<div class="z-head">–°–ò–†–û–í–ò–ù–ê</div><div id="rawList">...</div>`;if(isAdmin&&!corrMode)gID('act').innerHTML=`<button class="btn-main" style="background:var(--s);padding:8px" onclick="openModal('addRaw')">–ü–†–ò–•–Ü–î</button>`}
 else if(c==='PackSub'){if(isAdmin)gID('act').innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü–†–ò–•–Ü–î</button>`;ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–õ–Ü–í–ö–ê</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–ê–ö–ï–¢–ò</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–ö–û–¢–ß</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–Ü–®–ö–ò</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–ò–¢–ö–ò</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–ï–¢–ò–ö–ï–¢–ö–ê</div><div class="dash-item" onclick="setCat('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')">–°–¢–†–ï–ô–ß</div><div class="dash-item" onclick="setCat('–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')">–¢–ï–†–ú–û</div><div class="dash-item" onclick="setCat('ArchPackIn')" style="background:#f1f5f9;color:#64748b">–ê–†–•–Ü–í</div></div>`}
 else if(c==='ProdSub'){ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–§–ê–°–£–í–ê–ù–ù–Ø</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö–†–£–ü–û–†–£–®–ö–ê</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í–Ü–ë–†–û–°–¢–Ü–õ</div></div>`;if(isAdmin)ct.innerHTML+=`<button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–Ü–î –°–ò–†–û–í–ò–ù–ò</button>`}
 else if(c==='–§–∞—Å–æ–≤–∫–∞'){if(isAdmin)gID('act').innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('fas')">–ù–û–í–ò–ô</button>`}
 else if(['Kruporushka','Vibro','ZSHM'].includes(c)){const k={'Kruporushka':'KRUP','Vibro':'VIBRO','ZSHM':'ZSHM'}[c];if(isAdmin)gID('act').innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('${k}')">–ù–û–í–ò–ô</button>`}
 else if(c==='PriceList'){ct.innerHTML='<div class="z-head">üí∞ –ü–†–ê–ô–°</div><div id="priceListCont">...</div>';rPriceList(gID('priceListCont'))}
 else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü–†–ò–•–û–î–ò</div><div class="dash-item" onclick="setCat('ArchSubOut')">–í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</div></div>`;
 else if(['ArchSubIn','ArchSubOut'].includes(c)){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ó–ê –î–ê–¢–û–Æ</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ó–ê –Ü–ú'–Ø–ú</div></div>`}
 else if(c==='Consolidated'){ct.innerHTML='<div style="text-align:center;padding:20px">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';loadData()}
 else if(c==='StockArchive'){ct.innerHTML='<div class="z-head">–ê–†–•–Ü–í –°–ò–†–û–í–ò–ù–ò</div><div id="archRawList">...</div>';loadData()}
 loadData();updCorrBtn();updNav()
}
function loadData(){const c=gID('cnt');if(['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub','Timesheet'].includes(cur))return;
 if(cur==='Stock_Raw')rRaw(gID('rawList'));else if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(['Kruporushka','Vibro','ZSHM'].includes(cur))rWorkshopList(c,{'Kruporushka':'KRUP','Vibro':'VIBRO','ZSHM':'ZSHM'}[cur]);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Consolidated')rConsolidated(c);else if(cur==='TsCal')renderTsList(c);else if(cur==='PriceList')rPriceList(gID('priceListCont'));else if(cur==='StockArchive')rRawArch(gID('archRawList'));else rGen(c)}

const gP=c=>{let i=[];if(['WeightStock','Stock_DV'].includes(c))i=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1 —Ñ—Ä","–ê—Ä–Ω–∞—É—Ç–∫–∞ 2 —Ñ—Ä","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"];else if(c==='–ì–æ—Ç–æ–≤–∞—è')i=["–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 1","–ê—Ä–Ω–∞—É—Ç–∫–∞ 1/0.9 2","–ê—Ä—Ç–µ–∫ 1/0.9","–ë–∞—Å–º–∞—Ç–∏ –≥–æ–ª–¥ 1/0.8","–ë–∞—Å–º–∞—Ç–∏ 1/0.8","–ë—É–ª–≥—É—Ä 1/0.4","–ì–æ—Ä–æ—Ö 1/0.9","–ì—Ä–µ—á–∫–∞ 1/0.9","–ö—É–∫—É—Ä—É–∑–∞ 1/0.9","–ö—É–∫.–º—É–∫–∞ 1/0.5","–ö—É—Å –∫—É—Å 1/0.4","–ö—É—Ç—è 1/0.5","–ú–∞–Ω–∫–∞ 1/0.8","–ù—É—Ç 1/0.4","–ü–µ—Ä–ª–æ–≤–∫–∞ 1/0.9","–ü—à–µ–Ω–∏—á–∫–∞ 1/0.9","–ü—à–æ–Ω–æ 1/0.9","–†–∏—Å –¥–ª 1/0.9","–†–∏—Å –∫—Ä 1/0.9","–†–∏—Å –ø—Ä 1/0.9","–•–ª–æ–ø—å—è 1/0.5","–ß–µ—á–µ–≤–∏—Ü–∞ 1/0.4","–Ø—á–∫–∞ 1/0.9"];const s=new Set(i),k=c==='WeightStock'?'WeightStock':(c==='Stock_DV'?'Stock_DV':(c==='Stock_Feed'?'Stock_Feed':(c==='Stock_Raw'?'Stock_Raw':(c==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è'))));if(data[k])Object.values(data[k]).forEach(v=>s.add(v.name));return Array.from(s).filter(x=>x).sort()};
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort()},gPackS=()=>{const s=new Set();if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.supplier)s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()},gBuyS=()=>{const s=new Set();if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.supplier&&v.type==='GOODS')s.add(v.supplier)});return Array.from(s).filter(x=>x).sort()};
const toggleCorr=()=>{if(!isAdmin)return;corrMode=!corrMode;updCorrBtn();loadData()},updCorrBtn=()=>{const t=gID('corrTile');if(t){t.innerText=corrMode?'–ö–û–†–ï–ö–¶–Ü–Ø: –í–ö–õ':'üîß –ö–û–†–ï–ö–¶–Ü–Ø';t.style.background=corrMode?'#fef3c7':'#fff';t.style.color=corrMode?'#d97706':'var(--p)'}const c=gID('corrCtls');if(c)c.innerHTML=''};

function showH(c,n){const d=data[c]||{},r=[];Object.entries(d).forEach(([k,v])=>{if(v.name===n)r.push({...v,id:k})});r.sort((a,b)=>(b.date+(b.ts||'00:00')).localeCompare(a.date+(a.ts||'00:00')));let h=`<div style="font-weight:900;text-align:center">${n}</div>`;if(['Stock_Raw','Stock_Archive'].includes(c)){const l=r[0]||r.find(x=>x.amount>0);if(l)h+=`<button class="btn-main" onclick="genBatchReport('${c}','${n}','${l.date}',${l.amount})" style="background:#0f172a;font-size:10px;margin-bottom:10px">üìÑ –ó–í–Ü–¢ –ü–ê–†–¢–Ü–á</button>`}if(!r.length)h+='<div style="text-align:center;color:#999">–ü—É—Å—Ç–æ</div>';else r.forEach(v=>{const cl=v.amount>=0?'val-pos':'val-neg',s=v.amount>0?'+':'';h+=`<div class="rep-card"><div style="display:flex;justify-content:space-between"><div><div style="font-weight:900;font-size:12px">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div class="${cl}" style="font-weight:900;font-size:14px">${s}${parseFloat(v.amount.toFixed(2))}</div></div>${(isAdmin||corrMode)?`<button onclick="delRec('${c}','${v.id}')" style="border:none;background:0 0;color:red">üóëÔ∏è</button>`:''}</div><div style="font-size:11px;color:#666">${v.note||'-'}</div></div>`});gID('mT').innerText='–Ü–°–¢–û–†–Ü–Ø';gID('mB').innerHTML=h;gID('mdl').style.display='flex'}
function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><button class="history-btn" onclick="showH('–ì–æ—Ç–æ–≤–∞—è','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','–ì–æ—Ç–æ–≤–∞—è','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><button class="history-btn" onclick="showH('WeightStock','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','WeightStock','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rRaw(c){const t={};if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{const v=t[n];h+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div><div style="display:flex;gap:2px"><button class="history-btn" onclick="showH('Stock_Raw','${n}')" style="width:100%">üìú</button>${isAdmin?`<button class="history-btn" onclick="archiveRawBatch('${n}')" style="width:auto;background:#e0f2fe">üì¶</button>`:''}</div><button class="corr-btn" onclick="openModal('corr','Stock_Raw','${n}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rGen(c){const d=data[cur]||{},t={};Object.values(d).forEach(v=>{if(v.name)t[v.name]=(t[v.name]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const v=t[k];let a=v<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&v<50)a=!0;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&v<30)a=!0;if(cur==='–ü–∞–∫–µ—Ç—ã'&&v<3000)a=!0;let u='–∫–≥',dv=Math.round(v);if(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ü–∞–∫–µ—Ç—ã','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞'].includes(cur))u='—à—Ç';if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')dv=v.toFixed(1);if(cur==='–ü–ª–µ–Ω–∫–∞'){dv=v.toFixed(2);u='–∫–≥'}h+=`<div class="item-card ${a?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${dv}<small style="font-size:10px">${u}</small></div><button class="history-btn" onclick="showH('${cur}','${k}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}','${k}')">¬±</button></div>`});c.innerHTML=h+'</div>'}
function rFas(c){const d=data['–§–∞—Å–æ–≤–∫–∞']||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card"><div class="j-head">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div style="font-size:11px">–ü–ª—ñ–≤–∫–∞: ${v.filmName||'-'} (–í–∑: ${v.vzial||0}, –ó–∞–ª: ${v.ostatok||0})</div><div style="margin-top:5px;font-size:11px"><b>–°–∏—Ä–æ–≤–∏–Ω–∞:</b><br>${v.items?v.items.map(x=>`${x.name}: ${x.amount}–∫–≥`).join('<br>'):''}</div><div style="margin-top:5px;font-size:11px"><b>–í–∏—Ö—ñ–¥:</b><br>${v.outputItems?v.outputItems.map(x=>`${x.name} (${x.size}): ${x.count}—à—Ç`).join('<br>'):''}</div>${isAdmin?`<button onclick="delRec('–§–∞—Å–æ–≤–∫–∞','${i}')" style="color:red;border:none;background:0 0;margin-top:5px">DEL</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
function rWorkshopList(c,k){const dbN=WS_CFG[k].db,d=data[dbN]||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card"><div class="j-head">${v.date.split('T')[0].split('-').reverse().join('.')} | ${WS_CFG[k].title}</div><div style="font-size:11px">–û–ø–µ—Ä: ${v.operator||'-'} | –ü–æ–º: ${v.assistant||'-'}</div><div style="margin-top:5px;font-size:11px"><b>–°–∏—Ä–æ–≤–∏–Ω–∞:</b> ${v.rawMix||'-'}</div><div style="margin-top:5px;font-size:11px"><b>–í–∏—Ö—ñ–¥:</b><br>${v.items?v.items.map(x=>`${x.n} (${x.type}): ${x.q}—à—Ç x ${x.w}–∫–≥`).join('<br>'):''}</div>${isAdmin?`<button onclick="delRec('${dbN}','${i}')" style="color:red;border:none;background:0 0;margin-top:5px">DEL</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
function rArchPack(c){const d=data.ArchPackIn||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card"><div class="j-head">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div>${v.name} (${v.amount})</div><div>${v.supplier}</div>${isAdmin?`<button onclick="delRec('ArchPackIn','${i}')" style="color:red;border:none;background:0 0">DEL</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}

function rInvD(c){rInvGen(c,'date')}
function rInvC(c){rInvGen(c,'client')}
function rInvGen(c,key){
 const k=archSub==='In'?'ArchIncoming':'ArchInvoices',d=data[k]||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';
 l.forEach(([i,v])=>{
  if(k==='ArchInvoices'){
   let rows='';
   if(v.items)v.items.forEach((it,idx)=>{if(idx<4){const p=it.split('|');rows+=`<tr><td>${idx+1}</td><td style="text-align:left">${p[0].substring(0,12)}..</td><td>${p[1]}</td><td>${parseFloat(p[5]).toFixed(2)}</td></tr>`}});
   if(v.items&&v.items.length>4)rows+=`<tr><td colspan="4">...</td></tr>`;
   h+=`<div class="j-card" onclick="viewInvoice('${i}')" style="padding:8px">
    <div class="j-head" style="font-size:11px">${v.date.split('T')[0].split('-').reverse().join('.')} | ‚Ññ${v.num||'-'}</div>
    <div style="font-size:11px;font-weight:700;margin-bottom:2px">${v.client||'-'}</div>
    <table class="mini-inv"><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–°—É–º–∞</th></tr>${rows}</table>
    <div style="text-align:right;font-size:10px;font-weight:900;margin-top:4px">–í—Å—å–æ–≥–æ: ${parseFloat(v.totalSum||0).toFixed(2)}</div>
    ${isAdmin?`<button onclick="event.stopPropagation();delRec('${k}','${i}')" style="color:red;border:none;background:0 0;margin-top:5px;width:100%">–í–ò–î–ê–õ–ò–¢–ò</button>`:''}
   </div>`;
  }else{
   h+=`<div class="j-card"><div class="j-head">${v.date.split('T')[0].split('-').reverse().join('.')}</div><div>${v.supplier}</div><div style="font-size:10px;color:#666">‚Ññ${v.num||'-'}</div><div style="font-size:10px;margin-top:5px"><b>${v.name}</b>: ${v.amount}</div>${isAdmin?`<button onclick="delRec('${k}','${i}')" style="color:red;border:none;background:0 0;margin-top:5px">DEL</button>`:''}</div>`;
  }
 });
 c.innerHTML=h||'–ü—É—Å—Ç–æ';
}

window.viewInvoice=function(id){
 const v=data.ArchInvoices[id];if(!v)return;
 const dt=new Date(v.date),dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 let h=`<div id="shipPrev"><div style="text-align:center;font-weight:900">–ù–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ ${v.num||'---'} –≤—ñ–¥ ${dStr} —Ä.</div><div style="font-size:12px;margin-top:5px;line-height:1.4"><span class="pr-lbl">–í—ñ–¥:</span> <span class="pr-val">${v.supplierName||'-'}</span><br><span class="pr-lbl">–ö–æ–º—É:</span> <span class="pr-val">${v.client}</span><br><span class="pr-lbl">–£–≥–æ–¥–∞:</span> <span class="pr-val">${v.agreement||'-'}</span></div><table style="width:100%;font-size:11px;border-collapse:collapse;margin-top:5px" border="1"><thead><tr style="background:#eee"><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 if(v.items)v.items.forEach((it,idx)=>{const p=it.split('|'); tw+=parseFloat(p[1])||0; h+=`<tr><td style="text-align:center">${idx+1}</td><td>${p[0]}</td><td style="text-align:center">${p[1]}</td><td style="text-align:center">${p[2]}</td><td style="text-align:center">${parseFloat(p[4]).toFixed(2)}</td><td style="text-align:center">${parseFloat(p[5]).toFixed(2)}</td></tr>`});
 h+=`<tr><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${parseFloat(v.totalSum||0).toFixed(2)}</td></tr></tbody></table><div style="display:flex;justify-content:space-between;margin-top:20px;font-size:12px"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: _____________</div><div>–ü—Ä–∏–π–Ω—è–≤: _____________</div></div><button class="btn-main" onclick="reprintInv('${id}')" style="margin-top:15px;background:#0f172a">üñ®Ô∏è –î–†–£–ö</button></div>`;
 gID('mB').innerHTML=h;gID('mT').innerText='–ù–ê–ö–õ–ê–î–ù–ê (–ê–†–•–Ü–í)';gID('mdl').style.display='flex'
};

window.reprintInv=function(id){
 const v=data.ArchInvoices[id];if(!v)return;
 const dt=new Date(v.date),dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 let h=`<div style="font-weight:900;font-size:16px;margin-bottom:10px">–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ ${v.num||'---'} –≤—ñ–¥ ${dStr} —Ä.</div><div style="font-size:12px;margin-bottom:10px;line-height:1.4"><span class="pr-lbl">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:</span> <span class="pr-val">${v.supplierName||'-'}</span><br><span class="pr-lbl">–ü–æ–∫—É–ø–µ—Ü—å:</span> <span class="pr-val">${v.client}</span><br><span class="pr-lbl">–î–æ–≥–æ–≤—ñ—Ä:</span> <span class="pr-val">${v.agreement||'-'}</span></div><table class="pr-table"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 if(v.items)v.items.forEach((it,idx)=>{const p=it.split('|'); tw+=parseFloat(p[1])||0; h+=`<tr><td>${idx+1}</td><td style="text-align:left">${p[0]}</td><td>${p[1]}</td><td>${p[2]}</td><td>${parseFloat(p[4]).toFixed(2)}</td><td>${parseFloat(p[5]).toFixed(2)}</td></tr>`});
 h+=`<tr class="t-row"><td colspan="2" class="t-lbl">–†–∞–∑–æ–º:</td><td class="t-box">${tw}</td><td style="border:none!important"></td><td class="t-lbl">–í—Å—å–æ–≥–æ:</td><td class="t-box">${parseFloat(v.totalSum||0).toFixed(2)}</td></tr></tbody></table><div style="margin-top:5px;font-size:11px;font-weight:bold">–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏: ${numToWords(v.totalSum||0)}</div><div style="display:flex;justify-content:space-between;margin-top:30px;font-size:12px;font-weight:bold"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: __________________</div><div>–ü—Ä–∏–π–Ω—è–≤: __________________</div></div>`;
 gID('print-view').innerHTML=h;window.print();setTimeout(()=>gID('print-view').innerHTML='',800)
};
function numToWords(n){
 const u_m=['','–æ–¥–∏–Ω','–¥–≤–∞','—Ç—Ä–∏','—á–æ—Ç–∏—Ä–∏','–ø\'—è—Ç—å','—à—ñ—Å—Ç—å','—Å—ñ–º','–≤—ñ—Å—ñ–º','–¥–µ–≤\'—è—Ç—å'];
 const u_f=['','–æ–¥–Ω–∞','–¥–≤—ñ','—Ç—Ä–∏','—á–æ—Ç–∏—Ä–∏','–ø\'—è—Ç—å','—à—ñ—Å—Ç—å','—Å—ñ–º','–≤—ñ—Å—ñ–º','–¥–µ–≤\'—è—Ç—å'];
 const t1=['–¥–µ—Å—è—Ç—å','–æ–¥–∏–Ω–∞–¥—Ü—è—Ç—å','–¥–≤–∞–Ω–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–Ω–∞–¥—Ü—è—Ç—å','—á–æ—Ç–∏—Ä–Ω–∞–¥—Ü—è—Ç—å','–ø\'—è—Ç–Ω–∞–¥—Ü—è—Ç—å','—à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç—å','—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å','–≤—ñ—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å','–¥–µ–≤\'—è—Ç–Ω–∞–¥—Ü—è—Ç—å'];
 const t2=['','','–¥–≤–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–¥—Ü—è—Ç—å','—Å–æ—Ä–æ–∫','–ø\'—è—Ç–¥–µ—Å—è—Ç','—à—ñ—Å—Ç–¥–µ—Å—è—Ç','—Å—ñ–º–¥–µ—Å—è—Ç','–≤—ñ—Å—ñ–º–¥–µ—Å—è—Ç','–¥–µ–≤\'—è–Ω–æ—Å—Ç–æ'];
 const h=['','—Å—Ç–æ','–¥–≤—ñ—Å—Ç—ñ','—Ç—Ä–∏—Å—Ç–∞','—á–æ—Ç–∏—Ä–∏—Å—Ç–∞','–ø\'—è—Ç—Å–æ—Ç','—à—ñ—Å—Ç—Å–æ—Ç','—Å—ñ–º—Å–æ—Ç','–≤—ñ—Å—ñ–º—Å–æ—Ç','–¥–µ–≤\'—è—Ç—Å–æ—Ç'];
 let ip=Math.floor(n),fp=Math.round((n-ip)*100),fs=fp.toString().padStart(2,'0');
 if(ip===0)return `–ù—É–ª—å –≥—Ä–∏–≤–µ–Ω—å ${fs} –∫–æ–ø—ñ–π–æ–∫`;
 function gg(n,isFem){
  let r='',c=Math.floor(n/100),d=Math.floor((n%100)/10),u0=n%10;
  if(c>0)r+=h[c]+' ';
  if(d===1)r+=t1[u0]+' ';
  else{if(d>1)r+=t2[d]+' ';if(u0>0)r+=(isFem&&(u0===1||u0===2)?u_f[u0]:u_m[u0])+' ';}
  return r;
 }
 let w='',m=Math.floor(ip/1000000),th=Math.floor((ip%1000000)/1000),rm=ip%1000;
 if(m>0){w+=gg(m,0);let l=m%10,l2=m%100;if(l2>=11&&l2<=14)w+='–º—ñ–ª—å–π–æ–Ω—ñ–≤ ';else if(l===1)w+='–º—ñ–ª—å–π–æ–Ω ';else if(l>=2&&l<=4)w+='–º—ñ–ª—å–π–æ–Ω–∏ ';else w+='–º—ñ–ª—å–π–æ–Ω—ñ–≤ ';}
 if(th>0){w+=gg(th,1);let l=th%10,l2=th%100;if(l2>=11&&l2<=14)w+='—Ç–∏—Å—è—á ';else if(l===1)w+='—Ç–∏—Å—è—á–∞ ';else if(l>=2&&l<=4)w+='—Ç–∏—Å—è—á—ñ ';else w+='—Ç–∏—Å—è—á ';}
 if(rm>0)w+=gg(rm,0);
 w=w.trim();w=w.charAt(0).toUpperCase()+w.slice(1);
 let l=ip%10,l2=ip%100,cr='–≥—Ä–∏–≤–µ–Ω—å';
 if(l2>=11&&l2<=14)cr='–≥—Ä–∏–≤–µ–Ω—å';else if(l===1)cr='–≥—Ä–∏–≤–Ω—è';else if(l>=2&&l<=4)cr='–≥—Ä–∏–≤–Ω—ñ';
 return `${w} ${cr} ${fs} –∫–æ–ø—ñ–π–æ–∫`;
}

function openModal(t,a,b){gID('mdl').style.display='flex';const m=gID('mB'),h=gID('mT'),d=new Date().toISOString().split('T')[0];m.innerHTML='';aId=a;
 if(t==='inc'){h.innerText='–ü–†–ò–•–Ü–î (–ö–£–ü–û–í–ê–ù–ê)';m.innerHTML=`<div style="margin-bottom:10px">–î–ê–¢–ê <input type="date" id="iD" value="${d}"></div><div style="margin-bottom:10px">–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö ${makeSmart('iS',gBuyS(),'–û–±–µ—Ä—ñ—Ç—å...')}</div><div style="margin-bottom:10px">–¢–û–í–ê–† ${makeSmart('iN',gP('WeightStock'),'–ù–∞–∑–≤–∞')}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div>–í–ê–ì–ê (–ö–ì) <input type="number" id="iA"></div><div>–ù–ê–ö–õ ‚Ññ <input type="text" id="iNum"></div></div><button class="btn-main" onclick="sInc()">–ó–ë–ï–†–ï–ì–¢–ò</button>`}
 else if(t==='ship'){
  shipBasket={};
  h.innerText='–í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø';
  m.innerHTML=`<div style="background:#f8fafc;padding:5px;border:1px solid #e2e8f0;border-radius:10px"><div id="shipHead" class="head-wrap"><div class="grid-3"><div><span class="lbl-small">–î–ê–¢–ê</span><input type="date" id="hD" value="${d}"></div><div><span class="lbl-small">–ù–ê–ö–õ ‚Ññ</span><input type="text" id="hNum"></div><div><span class="lbl-small">–£–ì–û–î–ê</span><input type="text" id="hAg"></div></div><div class="grid-2"><div><span class="lbl-small">–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö</span>${makeSmart('hMyFop',data.Suppliers?Object.values(data.Suppliers).map(x=>x.name):[],'–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö')}</div><div><span class="lbl-small">–û–¢–†–ò–ú–£–í–ê–ß</span>${makeSmart('hC',gCl(),'–ö–ª—ñ—î–Ω—Ç...')}</div></div><div class="grid-3" style="align-items:end;margin-top:5px"><button id="btnOpt" class="btn-sel ${priceMode==='opt'?'active':''}" onclick="setPriceMode('opt')">–û–ü–¢</button><button id="btnRoz" class="btn-sel ${priceMode==='roz'?'active':''}" onclick="setPriceMode('roz')">–†–û–ó–î–†–Ü–ë</button><button id="btnStr" class="btn-sel" onclick="toggleStr(this)">–°–¢–†–ï–ô–ß: –ù–Ü</button></div></div><button class="btn-main" style="background:#e2e8f0;color:#334155;margin-top:5px;padding:8px" onclick="gID('shipHead').classList.toggle('collapsed')">üîΩ –ó–ì–û–†–ù–£–¢–ò / –†–û–ó–ì–û–†–ù–£–¢–ò –®–ê–ü–ö–£</button></div><div id="shipBtns" class="grid-2x2" style="margin-top:5px"><button class="btn-sel active" onclick="loadBulk('–ì–æ—Ç–æ–≤–∞—è')">–§–ê–°–û–í–ê–ù–ê</button><button class="btn-sel" onclick="loadBulk('WeightStock')">–ü–û–ö–£–ü–ù–ê</button><button class="btn-sel" onclick="loadBulk('Stock_DV')">–í–õ–ê–°–ù–ï</button><button class="btn-sel" onclick="loadBulk('Stock_Feed')">–í–Ü–î–•–û–î–ò</button></div><div id="shpR" style="max-height:50vh;overflow-y:auto;border:1px solid #eee;margin-bottom:5px;border-radius:8px;padding:5px"></div><button class="btn-main" onclick="sShip()">–î–ê–õ–Ü</button>`;
  loadBulk(cur==='StockRoot'?'–ì–æ—Ç–æ–≤–∞—è':cur);
 }
 else if(t==='addRaw'){h.innerText='–ü–†–ò–•–Ü–î –°–ò–†–û–í–ò–ù–ò';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="rD" value="${d}"></div><div>–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö ${makeSmart('rSupp',gBuyS(),'–û–±–µ—Ä—ñ—Ç—å')}</div><div>–°–ò–†–û–í–ò–ù–ê ${makeSmart('rN',gP('Stock_Raw'),'–ù–∞–∑–≤–∞')}</div><div>–í–ê–ì–ê <input type="number" id="rA"></div><button class="btn-main" onclick="sRawInc()">–ó–ë–ï–†–ï–ì–¢–ò</button>`}
 else if(t==='addMatPack'){h.innerText='–ü–†–ò–•–Ü–î –ú–ê–¢–ï–†–Ü–ê–õ–Ü–í';m.innerHTML=`<div>–ö–ê–¢–ï–ì–û–†–Ü–Ø <select id="pCat" class="smart-sel" onchange="updPackList()"><option value="–ü–ª–µ–Ω–∫–∞">–ü–ª—ñ–≤–∫–∞</option><option value="–ü–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option><option value="–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º">–°–∫–æ—Ç—á</option><option value="–ú–µ—à–∫–∏">–ú–µ—à–∫–∏</option><option value="–ù–∏—Ç–∫–∏">–ù–∏—Ç–∫–∏</option><option value="–≠—Ç–∏–∫–µ—Ç–∫–∞">–≠—Ç–∏–∫–µ—Ç–∫–∞</option><option value="–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞">–°—Ç—Ä–µ–π—á</option><option value="–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞">–¢–µ—Ä–º–æ</option></select></div><div>–î–ê–¢–ê <input type="date" id="pD" value="${d}"></div><div>–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö ${makeSmart('pS',gPackS(),'–û–±–µ—Ä—ñ—Ç—å')}</div><div>–¢–û–í–ê–† <div id="pProdCont"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div>–ö–Ü–õ–¨–ö–Ü–°–¢–¨ <input type="number" id="pA"></div><div>–ù–ê–ö–õ ‚Ññ <input type="text" id="pNum"></div></div><button class="btn-main" onclick="sPack()">–ó–ë–ï–†–ï–ì–¢–ò</button>`;setTimeout(updPackList,100)}
 else if(t==='fas'){h.innerText='–§–ê–°–£–í–ê–ù–ù–Ø';m.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><div>–î–ê–¢–ê <input type="date" id="fD" value="${d}"></div><div>–ó–ê–õ. –ü–õ–Ü–í–ö–ò <input type="number" id="fOs"></div></div><div>–í–ó–Ø–õ–ò –ü–õ–Ü–í–ö–ò (5+5...) <input type="text" id="fVz"></div><div class="z-head">–°–ò–†–û–í–ò–ù–ê</div><div id="fasRows"></div><button class="btn-main" style="background:#fff;color:#000;border:1px solid #ccc" onclick="addFasRow()">+ –°–ò–†–û–í–ò–ù–ê</button><div class="z-head">–í–ò–•–Ü–î</div><div id="fasOutRows"></div><button class="btn-main" style="background:#fff;color:#000;border:1px solid #ccc" onclick="addFasOutRow()">+ –ü–†–û–î–£–ö–¶–Ü–Ø</button><button class="btn-main" onclick="sFas()">–ó–ë–ï–†–ï–ì–¢–ò</button>`;setTimeout(()=>{addFasRow();addFasOutRow()},100)}
 else if(t==='corr'){h.innerText='–ö–û–†–ï–ö–¶–Ü–Ø';corrCtx={cat:a,name:b};m.innerHTML=`<div style="text-align:center;font-weight:900">${b}</div><div>–î–ê–¢–ê <input type="date" id="cD" value="${d}"></div><div>–ù–û–í–ò–ô –ó–ê–õ–ò–®–û–ö <input type="number" id="cA"></div><div>–ü–†–ò–ß–ò–ù–ê <input type="text" id="cR"></div><button class="btn-main" onclick="sCorr()">–ó–ë–ï–†–ï–ì–¢–ò</button><div style="margin-top:10px;border-top:1px dashed #ccc"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc" onclick="renameItem('${b}','${a}')">–ü–ï–†–ï–ô–ú–ï–ù–£–í–ê–¢–ò</button><button class="btn-main" style="background:#fee2e2;color:red" onclick="delItemBatch('${b}','${a}')">–í–ò–î–ê–õ–ò–¢–ò –ö–ê–†–¢–ö–£</button></div>`}
 else if(['KRUP','VIBRO','ZSHM'].includes(t))renderWorkshopModal(t,h,m,d);
 else if(t==='dayRep'){h.innerText='–î–ï–ù–ù–ò–ô –ó–í–Ü–¢';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="repDate" value="${d}"></div><button class="btn-main" onclick="genDayReport()">–°–§–û–†–ú–£–í–ê–¢–ò</button>`}
 else if(t==='monthRep'){h.innerText='–ú–Ü–°–Ø–ß–ù–ò–ô –ó–í–Ü–¢';m.innerHTML=`<div>–ú–Ü–°–Ø–¶–¨ <input type="month" id="repMth"></div><button class="btn-main" onclick="genMonthReport()">–°–§–û–†–ú–£–í–ê–¢–ò</button>`}
 else if(t==='fix'){h.innerText='–§–Ü–ö–°–ê–¶–Ü–Ø';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="fixDate" value="${d}"></div><button class="btn-main" id="btnFix" onclick="sFixBal()">OK</button>`}
 else if(t==='arch'){h.innerText='–ó–ì–û–†–¢–ê–ù–ù–Ø';m.innerHTML=`<div>–î–ê–¢–ê <input type="date" id="archDate"></div><button class="btn-main" id="btnArch" onclick="runArchive()" style="background:red">OK</button>`}
 else if(t==='closeMonth'){h.innerText='–ó–ê–ö–†–ò–¢–¢–Ø –ú–Ü–°–Ø–¶–Ø';m.innerHTML=`<div>–ö–Ü–ù–ï–¶–¨ –ú–Ü–°–Ø–¶–Ø <input type="date" id="cmDate"></div><button class="btn-main" id="btnCM" onclick="runCloseMonth()">OK</button>`}
}

function loadBulk(c){D.querySelectorAll('.bulk-q').forEach(i=>{const n=i.dataset.n,ct=i.dataset.cat,v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const bs=D.querySelectorAll('#shipBtns button');bs.forEach(b=>{let t=b.innerText,a=!1;if(c==='–ì–æ—Ç–æ–≤–∞—è'&&t.includes('–§–ê–°–û–í–ê–ù–ê'))a=!0;if(c==='WeightStock'&&t.includes('–ü–û–ö–£–ü–ù–ê'))a=!0;if(c==='Stock_DV'&&t.includes('–í–õ–ê–°–ù–ï'))a=!0;if(c==='Stock_Feed'&&t.includes('–í–Ü–î–•–û–î–ò'))a=!0;b.className='btn-sel '+(a?'active':'')});const s={};if(data[c])Object.values(data[c]).forEach(v=>{if(v.name)s[v.name]=(s[v.name]||0)+v.amount});let h=`<div class="item-grid">`;Object.keys(s).sort().forEach(n=>{const v=s[n];if(v>0){const k=n+'::'+c,sv=shipBasket[k]?shipBasket[k].w:'';h+=`<div class="item-card"><div class="item-title">${n}</div><div style="font-size:10px;color:#888;margin-bottom:2px">–ó–∞–ª:${Math.round(v)}</div><input type="number" class="bulk-q" data-n="${n}" data-cat="${c}" style="width:100%;height:30px" value="${sv}"></div>`}});gID('shpR').innerHTML=h+`</div>`}
window.setPriceMode=function(m){priceMode=m;gID('btnOpt').className='btn-sel '+(m==='opt'?'active':'');gID('btnRoz').className='btn-sel '+(m==='roz'?'active':'');};
function toggleStr(b){useStretch=!useStretch;b.className='btn-sel '+(useStretch?'active':'');b.innerText=useStretch?'–°–¢–†–ï–ô–ß: –¢–ê–ö':'–°–¢–†–ï–ô–ß: –ù–Ü'}

async function sShip(){const d=gID('hD').value,nm=gID('hNum').value,ag=gID('hAg').value,dv=d+"T12:00:00Z",c=getSmartVal('hC'),mf=getSmartVal('hMyFop'),pm=priceMode;if(!c)return alert('–û—Ç—Ä–∏–º—É–≤–∞—á?');D.querySelectorAll('.bulk-q').forEach(i=>{const n=i.dataset.n,ct=i.dataset.cat,v=parseFloat(i.value),k=n+'::'+ct;if(v>0)shipBasket[k]={w:v,c:ct,n:n};else delete shipBasket[k]});const it=[];let tw=0,tm=0,pdb={};if(data.PriceList)Object.values(data.PriceList).forEach(v=>pdb[v.name]=v);Object.values(shipBasket).forEach(v=>{let po=pdb[v.n]||{},pr=pm==='opt'?(po.priceOpt!==undefined?po.priceOpt:(po.price||0)):(po.priceRoz!==undefined?po.priceRoz:0),sm=pr*v.w;it.push({n:v.n,w:v.w,c:v.c,p:pr,s:sm});tw+=v.w;tm+=sm});if(!it.length)return alert('–ü—É—Å—Ç–æ');let h=`<div id="shipPrev"><div style="text-align:center"><b>–ù–ê–ö–õ–ê–î–ù–ê ‚Ññ ${nm||'---'}</b> (${pm==='opt'?'–û–ü–¢':'–†–û–ó–î–†–Ü–ë'})</div><div style="font-size:12px;margin-top:5px"><b>–í—ñ–¥:</b> ${mf||'-'}<br><b>–ö–æ–º—É:</b> ${c}<br><b>–£–≥–æ–¥–∞:</b> ${ag||'-'}</div><table style="width:100%;font-size:11px;border-collapse:collapse;margin-top:5px"><tr style="background:#eee"><td>–¢–û–í–ê–†</td><td>–ö-–¢–¨</td><td>–¶–Ü–ù–ê</td><td>–°–£–ú–ê</td></tr>`;it.forEach(x=>{h+=`<tr><td>${x.n}</td><td>${x.w}</td><td>${x.p}</td><td>${x.s.toFixed(2)}</td></tr>`});h+=`<tr><td colspan="2" style="text-align:right;border:none;font-weight:bold;padding-right:5px">–†–∞–∑–æ–º:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tw}</td><td style="border:none"></td><td style="text-align:right;border:none;font-weight:bold;padding-right:5px">–í—Å—å–æ–≥–æ:</td><td style="text-align:center;border:2px solid #000;font-weight:bold">${tm.toFixed(2)}</td></tr></table><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:10px"><button class="btn-main" onclick="execShip()">–°–ü–ò–°–ê–¢–ò</button><button class="btn-main" onclick="printAndConfirm()" style="background:#0f172a">–î–†–£–ö</button></div></div>`;window.tempShipData={it,c,nm,dv,mf,tw,ag,tm,mode:pm};gID('mB').innerHTML=h;gID('mT').innerText='–ü–ï–†–ï–í–Ü–†–ö–ê';gID('mdl').style.display='flex'}
window.printAndConfirm=function(){printShipInvoice(window.tempShipData);setTimeout(()=>{if(confirm("–ù–∞–∫–ª–∞–¥–Ω–∞ –ø—ñ—à–ª–∞ —É –¥—Ä—É–∫. –°–ø–∏—Å–∞—Ç–∏ —Ç–æ–≤–∞—Ä –∑—ñ —Å–∫–ª–∞–¥—É?"))execShip()},800)};
async function execShip(){const d=window.tempShipData;if(!d)return;try{const lk=db.child('ArchInvoices').push().key,u={},is=d.it.map(x=>`${x.n}|${x.w}|${x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'}|${x.c}|${x.p}|${x.s}`);u['/ArchInvoices/'+lk]={date:d.dv,client:d.c,num:d.nm,agreement:d.ag,items:is,supplierName:d.mf,ts:new Date().toISOString(),totalSum:d.tm,priceMode:d.mode};d.it.forEach(i=>{u[`/${i.c}/${db.child(i.c).push().key}`]={name:i.n,amount:-i.w,date:d.dv,note:`–û—Ç–≥—Ä: ${d.c}`,fLink:lk,ts:new Date().toISOString()}});if(useStretch){const q=parseFloat((d.tw/5000).toFixed(2));if(q>0)u['/–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞/'+db.child('–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞').push().key]={name:'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞',amount:-q,date:d.dv,note:'–ê–≤—Ç–æ',fLink:lk,ts:new Date().toISOString()}}if(d.mf&&d.mf!=='–ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö'){let fe=!1;if(data.Suppliers)Object.values(data.Suppliers).forEach(v=>{if(v.name===d.mf)fe=!0});if(!fe)u['/Suppliers/'+db.child('Suppliers').push().key]={name:d.mf}}await db.update(u);closeModal();alert('–°–ø–∏—Å–∞–Ω–æ –∑—ñ —Å–∫–ª–∞–¥—É');D.querySelectorAll('.bulk-q').forEach(i=>i.value='');window.shipBasket={}}catch(e){alert(e)}}

function printShipInvoice(d){
 const dt=new Date(d.dv),dStr=dt.getDate().toString().padStart(2,'0')+'.'+(dt.getMonth()+1).toString().padStart(2,'0')+'.'+dt.getFullYear();
 let tw=0;
 let h=`<div style="font-weight:900;font-size:16px;margin-bottom:10px">–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞ ‚Ññ ${d.nm||'---'} –≤—ñ–¥ ${dStr} —Ä.</div><div style="font-size:12px;margin-bottom:10px;line-height:1.4"><span class="pr-lbl">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:</span> <span class="pr-val">${d.mf||'-'}</span><br><span class="pr-lbl">–ü–æ–∫—É–ø–µ—Ü—å:</span> <span class="pr-val">${d.c}</span><br><span class="pr-lbl">–î–æ–≥–æ–≤—ñ—Ä:</span> <span class="pr-val">${d.ag||'-'}</span></div><table class="pr-table"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>`;
 d.it.forEach((x,idx)=>{const ed=x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥'; tw+=x.w; h+=`<tr><td>${idx+1}</td><td style="text-align:left">${x.n}</td><td>${x.w}</td><td>${ed}</td><td>${x.p.toFixed(2)}</td><td>${x.s.toFixed(2)}</td></tr>`});
 h+=`<tr class="t-row"><td colspan="2" class="t-lbl">–†–∞–∑–æ–º:</td><td class="t-box">${tw}</td><td style="border:none!important"></td><td class="t-lbl">–í—Å—å–æ–≥–æ:</td><td class="t-box">${d.tm.toFixed(2)}</td></tr></tbody></table><div style="margin-top:5px;font-size:11px;font-weight:bold">–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏: ${numToWords(d.tm)}</div><div style="display:flex;justify-content:space-between;margin-top:30px;font-size:12px;font-weight:bold"><div>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤: __________________</div><div>–ü—Ä–∏–π–Ω—è–≤: __________________</div></div>`;
 gID('print-view').innerHTML=h;window.print();setTimeout(()=>gID('print-view').innerHTML='',800)
}

async function sInc(){const d=gID('iD').value+"T12:00:00Z",s=getSmartVal('iS'),n=getSmartVal('iN'),a=parseFloat(gID('iA').value),nm=gID('iNum').value;if(!s||!n||!a)return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');try{const k=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+k]={date:d,supplier:s,name:n,amount:a,num:nm,type:'GOODS',ts:new Date().toISOString()};u['/WeightStock/'+db.child('WeightStock').push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥',fLink:k,ts:new Date().toISOString()};await db.update(u);closeModal()}catch(e){alert(e)}}
async function sRawInc(){const d=gID('rD').value+"T12:00:00Z",s=getSmartVal('rSupp'),n=getSmartVal('rN'),a=parseFloat(gID('rA').value);if(!s||!n||!a)return alert('–î–∞–Ω—ñ?');try{const k=db.child('ArchIncoming').push().key,u={};u['/ArchIncoming/'+k]={date:d,supplier:s,name:n,amount:a,type:'RAW',ts:new Date().toISOString()};u['/Stock_Raw/'+db.child('Stock_Raw').push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥',fLink:k,ts:new Date().toISOString()};await db.update(u);closeModal()}catch(e){alert(e)}}
async function sPack(){const cat=gID('pCat').value,d=gID('pD').value+"T12:00:00Z",s=getSmartVal('pS'),n=getSmartVal('pProd'),a=parseFloat(gID('pA').value),nm=gID('pNum').value;if(!s||!n||!a)return alert('–î–∞–Ω—ñ?');try{const k=db.child('ArchPackIn').push().key,u={};u['/ArchPackIn/'+k]={date:d,supplier:s,name:n,amount:a,category:cat,num:nm,ts:new Date().toISOString()};u['/'+cat+'/'+db.child(cat).push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥',fLink:k,ts:new Date().toISOString()};await db.update(u);closeModal()}catch(e){alert(e)}}
function updPackList(){const c=gID('pCat').value;let l=[];if(c==='–ü–ª–µ–Ω–∫–∞')l=["–ü–ª–µ–Ω–∫–∞ 300—Ö400","–ü–ª–µ–Ω–∫–∞ 370—Ö500","–ü–ª–µ–Ω–∫–∞ 400—Ö500","–ü–ª–µ–Ω–∫–∞ 420—Ö550"];else if(c==='–ü–∞–∫–µ—Ç—ã')l=["300x400","370x500","400x500","420x550"];else if(c==='–ú–µ—à–∫–∏')l=["–ú–µ—à–æ–∫ 25–∫–≥","–ú–µ—à–æ–∫ 50–∫–≥","–ú–µ—à–æ–∫ –±–µ–ª—ã–π"];else if(c==='–ù–∏—Ç–∫–∏')l=["–ù–∏—Ç–∫–∏"];else if(c==='–≠—Ç–∏–∫–µ—Ç–∫–∞')l=["–≠—Ç–∏–∫–µ—Ç–∫–∞"];else if(c==='–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞')l=["–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞"];else if(c==='–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞')l=["–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞"];else if(c==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')l=["–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º"];const s=new Set(l);if(data[c])Object.values(data[c]).forEach(v=>s.add(v.name));gID('pProdCont').innerHTML=makeSmart('pProd',Array.from(s).sort(),'–¢–æ–≤–∞—Ä')}
async function sCorr(){const c=corrCtx.cat,n=corrCtx.name,d=gID('cD').value+"T12:00:00Z",na=parseFloat(gID('cA').value),r=gID('cR').value;if(isNaN(na))return alert('–ß–∏—Å–ª–æ?');let cur=0;if(data[c])Object.values(data[c]).forEach(v=>{if(v.name===n)cur+=v.amount});const diff=na-cur;if(Math.abs(diff)<0.001)return alert('–ù–µ –∑–º—ñ–Ω–∏–ª–æ—Å—å');try{await db.child(c).push({name:n,amount:diff,date:d,note:`–ö–æ—Ä: ${r}`,ts:new Date().toISOString()});closeModal()}catch(e){alert(e)}}
async function renameItem(oldN,cat){const newN=prompt("–ù–æ–≤–∞ –Ω–∞–∑–≤–∞:",oldN);if(!newN||newN===oldN)return;if(!confirm(`–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ "${oldN}" -> "${newN}"?`))return;const u={},d=data[cat]||{};Object.entries(d).forEach(([k,v])=>{if(v.name===oldN)u[`/${cat}/${k}/name`]=newN});if(Object.keys(u).length){await db.update(u);closeModal();alert('–û–ö')}else alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ')}
async function delItemBatch(nm,cat){if(!confirm(`–í–ò–î–ê–õ–ò–¢–ò –í–°–Æ –Ü–°–¢–û–†–Ü–Æ "${nm}"? –¶–ï –ù–ï–ó–í–û–†–û–¢–ù–¨–û!`))return;if(prompt('–í–≤–µ–¥—ñ—Ç—å DELETE')!=='DELETE')return;const u={},d=data[cat]||{};Object.entries(d).forEach(([k,v])=>{if(v.name===nm)u[`/${cat}/${k}`]=null});if(Object.keys(u).length){await db.update(u);closeModal();alert('–í–∏–¥–∞–ª–µ–Ω–æ')}else alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ')}

function renderWorkshopModal(t,te,be,td){const c=WS_CFG[t],p=c.prefix;te.innerText=c.title;be.innerHTML=`<div style="margin-bottom:10px">–î–ê–¢–ê <input type="date" id="${p}D" value="${td}"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><div>–û–ü–ï–†–ê–¢–û–† ${makeSmart(p+'Op',getHistoryDeep('operator'),'–ü—Ä—ñ–∑–≤–∏—â–µ')}</div><div>–ü–û–ú–Ü–ß–ù–ò–ö ${makeSmart(p+'As',getHistoryDeep('assistant'),'–ü—Ä—ñ–∑–≤–∏—â–µ')}</div></div><div style="background:#f9fafb;padding:5px;border:1px solid #eee;margin:5px 0"><b>–°–ò–†–û–í–ò–ù–ê</b><select id="${p}WH" class="smart-sel" onchange="updGenRaw('${p}')"><option value="Stock_Semi">–ü/–§</option><option value="Stock_Raw" ${t!=='VIBRO'?'selected':''}>–°–∏—Ä–æ–≤–∏–Ω–∞</option><option value="Stock_DV">–î–í</option></select><div id="${p}RawCont"></div><input type="number" id="${p}RawW" placeholder="–ö–≥" readonly style="background:#eee"></div><div class="z-head">–ü–†–û–î–£–ö–¶–Ü–Ø (–î–í)</div><div id="${p}RowsDV"></div><button class="btn-main" onclick="addGenRow('${p}','DV')" style="background:#fff;color:blue;border:1px solid blue">+ –†–Ø–î</button><div class="z-head">–ü/–§</div><div id="${p}RowsSemi"></div><button class="btn-main" onclick="addGenRow('${p}','Semi')" style="background:#fff;color:orange;border:1px solid orange">+ –†–Ø–î</button><div class="z-head">–ö–û–†–ú–ê</div><div id="${p}RowsFeed"></div><button class="btn-main" onclick="addGenRow('${p}','Feed')" style="background:#fff;color:brown;border:1px solid brown">+ –†–Ø–î</button><button class="btn-main" onclick="saveGen('${t}')" id="btnS">–ó–ë–ï–†–ï–ì–¢–ò</button>`;setTimeout(()=>{updGenRaw(p);addGenRow(p,'DV');addGenRow(p,'Semi');addGenRow(p,'Feed')},50)}
function updGenRaw(p){const w=gID(p+'WH').value,m={};if(data[w])Object.values(data[w]).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});gID(p+'RawCont').innerHTML=makeSmart(p+'RawItem',Object.keys(m).sort(),'–ù–∞–∑–≤–∞')}
function addGenRow(p,s){const i=Date.now()+Math.random(),t=s==='DV'?'Stock_DV':(s==='Semi'?'Stock_Semi':'Stock_Feed'),ss=new Set();if(data[t])Object.values(data[t]).forEach(v=>ss.add(v.name));let o=`<option value="">–û–±—Ä–∞—Ç–∏</option>`;Array.from(ss).sort().forEach(x=>o+=`<option value="${x}">${x}</option>`);gID(p+'Rows'+s).insertAdjacentHTML('beforeend',`<div class="dyn-row" id="${p}r_${i}" style="display:grid;grid-template-columns:1fr 0.5fr 0.5fr 30px;gap:2px;margin-bottom:2px"><select id="n_${i}" class="smart-sel" style="font-size:10px">${o}</select><input type="number" id="q_${i}" placeholder="—à—Ç" oninput="calcGen('${p}')"><input type="number" id="w_${i}" placeholder="–∫–≥" oninput="calcGen('${p}')"><button onclick="this.parentElement.remove();calcGen('${p}')" style="background:red;color:white;border:none">x</button></div>`)}
function calcGen(p){let t=0;['DV','Semi','Feed'].forEach(s=>{const r=gID(p+'Rows'+s).children;for(let x of r){const k=x.id.split('_')[1],q=parseFloat(gID('q_'+k).value)||0,w=parseFloat(gID('w_'+k).value)||0;t+=q*w}});gID(p+'RawW').value=t.toFixed(1)}
async function saveGen(t){const c=WS_CFG[t],p=c.prefix,rn=getSmartVal(p+'RawItem'),rw=parseFloat(gID(p+'RawW').value),d=gID(p+'D').value+"T12:00:00Z";if(!rn||rw<=0)return alert('–°–∏—Ä–æ–≤–∏–Ω–∞?');const it=[];['DV','Semi','Feed'].forEach(s=>{const r=gID(p+'Rows'+s).children;for(let x of r){const k=x.id.split('_')[1],n=gID('n_'+k).value,q=parseFloat(gID('q_'+k).value),w=parseFloat(gID('w_'+k).value);if(n&&q>0)it.push({n,q,w,l:0,type:s})}});if(!it.length)return alert('–ü—Ä–æ–¥—É–∫—Ü—ñ—è?');try{const id=db.child(c.db).push().key,u={},rwh=gID(p+'WH').value;u[`/${rwh}/${db.child(rwh).push().key}`]={name:rn,amount:-rw,date:d,note:c.note,fLink:id,ts:new Date().toISOString()};it.forEach(i=>{let dst=i.type==='DV'?'Stock_DV':(i.type==='Semi'?'Stock_Semi':'Stock_Feed');u[`/${dst}/${db.child(dst).push().key}`]={name:i.n,amount:(i.q*i.w),date:d,note:c.note,fLink:id,ts:new Date().toISOString()}});u[`/${c.db}/${id}`]={date:d,items:it,rawMix:`${rn} (${rw}kg)`,operator:getSmartVal(p+'Op'),assistant:getSmartVal(p+'As'),type:t};await db.update(u);closeModal()}catch(e){alert(e)}}

// –û–ù–û–í–õ–ï–ù–û: –î–ò–ù–ê–ú–Ü–ß–ù–ò–ô –í–ò–ë–Ü–† –°–ò–†–û–í–ò–ù–ò –Ü–ó –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø–ú –ó–ê–õ–ò–®–ö–Ü–í
window.addFasRow=function(){
 const i=Date.now()+Math.random().toString().slice(2,7);
 gID('fasRows').insertAdjacentHTML('beforeend',`<div id="fr_${i}" style="display:grid;grid-template-columns:1fr 1fr 0.5fr 30px;gap:2px"><select id="fs_${i}" onchange="updFasRawList('${i}')"><option value="WeightStock">–ö—É–ø</option><option value="Stock_DV">–î–í</option></select><select id="fn_${i}"><option value="">–û–±–µ—Ä—ñ—Ç—å...</option></select><input type="number" id="fq_${i}" placeholder="–∫–≥"><button onclick="this.parentElement.remove()">x</button></div>`);
 setTimeout(()=>updFasRawList(i),50);
};
window.updFasRawList=function(i){
 const src=gID('fs_'+i).value, sel=gID('fn_'+i), m={};
 if(data[src])Object.values(data[src]).forEach(v=>{if(v.name)m[v.name]=(m[v.name]||0)+v.amount});
 let h='<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
 Object.keys(m).sort().forEach(k=>{
  if(Math.round(m[k])>0) h+=`<option value="${k}">${k} (${Math.round(m[k])} –∫–≥)</option>`;
 });
 sel.innerHTML=h;
};

// –û–ù–û–í–õ–ï–ù–û: –í–°–¢–ê–ù–û–í–õ–ï–ù–ò–ô –°–ü–ò–°–û–ö –î–õ–Ø –í–ò–•–û–î–£ –ì–û–¢–û–í–û–á –§–ê–°–û–í–ö–ò
window.addFasOutRow=function(){
 const i=Date.now()+Math.random().toString().slice(2,7);
 let opts='<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
 gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>opts+=`<option value="${p}">${p}</option>`);
 gID('fasOutRows').insertAdjacentHTML('beforeend',`<div id="fo_${i}" style="display:grid;grid-template-columns:1fr 1fr 0.5fr 30px;gap:2px"><select id="on_${i}">${opts}</select><select id="os_${i}"><option>300√ó400</option><option>370√ó500</option><option>400√ó500</option><option>420√ó550</option></select><input type="number" id="oq_${i}" placeholder="—à—Ç"><button onclick="this.parentElement.remove()">x</button></div>`);
};

async function sFas(){const d=gID('fD').value+"T12:00:00Z",ri=[],oi=[];let tp=0,tv=0;for(let x of gID('fasRows').children){const k=x.id.split('_')[1],n=gID('fn_'+k).value,q=parseFloat(gID('fq_'+k).value),s=gID('fs_'+k).value;if(n&&q){ri.push({name:n,amount:q,source:s});tp+=q}}for(let x of gID('fasOutRows').children){const k=x.id.split('_')[1],n=gID('on_'+k).value,sz=gID('os_'+k).value,q=parseFloat(gID('oq_'+k).value);if(n&&q){oi.push({name:n,size:sz,count:q});tv+=q}}if(!ri.length||!oi.length)return alert('–ü—É—Å—Ç–æ');try{const id=db.child('–§–∞—Å–æ–≤–∫–∞').push().key,u={},ts=new Date().toISOString(),vz=gID('fVz').value,os=parseFloat(gID('fOs').value)||0,vt=vz.split('+').reduce((a,b)=>a+parseFloat(b)||0,0),pu=Math.abs(vt-os);u['/–§–∞—Å–æ–≤–∫–∞/'+id]={date:d,items:ri,outputItems:oi,vzial:vt,ostatok:os,filmName:oi[0].name};ri.forEach(i=>{u[`/${i.source}/${db.child(i.source).push().key}`]={name:i.name,amount:-i.amount,date:d,note:'–§–∞—Å',fLink:id,ts:ts}});oi.forEach(i=>{u['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:i.name,amount:i.count,date:d,note:'–§–∞—Å',fLink:id,ts:ts};const k=i.name==="–ö—É—Ç—è"?19.8:9.9;u['/–ü–∞–∫–µ—Ç—ã/'+db.child('–ü–∞–∫–µ—Ç—ã').push().key]={name:i.size,amount:-Math.round(i.count/k),date:d,note:'–ê–≤—Ç–æ',fLink:id,ts:ts}});if(pu>0)u['/–ü–ª–µ–Ω–∫–∞/'+db.child('–ü–ª–µ–Ω–∫–∞').push().key]={name:oi[0].name,amount:-pu,date:d,note:'–ê–≤—Ç–æ',fLink:id,ts:ts};await db.update(u);closeModal()}catch(e){alert(e)}}

function genDayReport(){const d=gID('repDate').value;if(!d)return;const ds=d.split('-').reverse().join('.'),r={inc:[],out:[],used:[],prod:[],pack:{}};const add=(a,n,v,u,s)=>{r[a].push({n,v,u,s})};if(data.ArchIncoming)Object.values(data.ArchIncoming).forEach(v=>{if(v.date.startsWith(d))add('inc',v.name,v.amount,v.type==='RAW'?'–∫–≥':'–∫–≥',v.supplier)});if(data.ArchPackIn)Object.values(data.ArchPackIn).forEach(v=>{if(v.date.startsWith(d))add('inc',v.name,v.amount,'—à—Ç',v.supplier)});if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>{if(v.date.startsWith(d))v.items.forEach(i=>{const p=i.split('|');add('out',p[0],parseFloat(p[1]),p[2],v.client)})});['–§–∞—Å–æ–≤–∫–∞','Vibro_Report','Krup_Report','ZSHM_Report'].forEach(k=>{if(data[k])Object.values(data[k]).forEach(v=>{if(v.date.startsWith(d)){if(v.items)v.items.forEach(i=>add('used',i.name||i.n,i.amount||((i.q*i.w)+(i.l||0)),'–∫–≥',v.type||'–§–∞—Å'));if(v.outputItems)v.outputItems.forEach(o=>add('prod',o.name,o.count,'—à—Ç','–§–∞—Å'));else if(v.vyhod)add('prod',v.name,v.vyhod,'—à—Ç','–§–∞—Å');if(k!=='–§–∞—Å–æ–≤–∫–∞'&&v.items)v.items.forEach(i=>add('prod',i.n,(i.q*i.w)+(i.l||0),'–∫–≥',v.type))}})});['–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º','–ú–µ—à–∫–∏','–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞'].forEach(c=>{if(data[c])Object.values(data[c]).forEach(v=>{if(v.date.startsWith(d)&&v.amount<0&&v.note&&v.note.includes('–ê–≤—Ç–æ')){if(!r.pack[c])r.pack[c]=[];r.pack[c].push({n:v.name,v:Math.abs(v.amount)})}})});const bl=t=>`<span style="color:blue">${t}</span>`,rd=t=>`<span style="color:red">${t}</span>`;let h=`<div style="font-weight:900;text-align:center">–ó–í–Ü–¢ ${ds}</div><hr>`;h+=`<b>üì• –ü–†–ò–•–Ü–î</b><br>`+(r.inc.length?r.inc.map(x=>bl(`+${x.n} ${x.v}${x.u}`)).join('<br>'):'-')+'<br>';h+=`<b>üöö –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø</b><br>`+(r.out.length?r.out.map(x=>rd(`-${x.n} ${x.v}${x.u}`)).join('<br>'):'-')+'<br>';h+=`<b>üî® –í–ò–†–û–ë–ù–ò–¶–¢–í–û</b><br>`+(r.prod.length?r.prod.map(x=>bl(`+${x.n} ${x.v}${x.u}`)).join('<br>'):'-')+'<br>';h+=`<b>üì¶ –ú–ê–¢–ï–†–Ü–ê–õ–ò (–ê–í–¢–û)</b><br>`;Object.keys(r.pack).forEach(k=>{h+=`<u>${k}</u>: `+r.pack[k].map(x=>rd(`${x.v}`)).join(', ')+'<br>'});gID('print-view').innerHTML=h;gID('mB').innerHTML=h+`<button class="btn-main" onclick="window.print()">–î–†–£–ö</button>`}
function genMonthReport(){const m=gID('repMth').value;if(!m)return alert('–ú—ñ—Å—è—Ü—å?');const[y,mt]=m.split('-'),sd=`${y}-${mt}-01`,ed=`${y}-${mt}-31`;const res={};stockCatsAll.forEach(c=>{if(data[c])Object.values(data[c]).forEach(v=>{if(v.name){if(!res[c])res[c]={};if(!res[c][v.name])res[c][v.name]={s:0,i:0,o:0};const a=v.amount,vd=v.date.split('T')[0];if(vd<sd)res[c][v.name].s+=a;else if(vd<=ed){if(a>0)res[c][v.name].i+=a;else res[c][v.name].o+=Math.abs(a)}}})});let h=`<div style="text-align:center;font-weight:900">–ó–í–Ü–¢: ${m}</div><table style="width:100%;font-size:10px;border-collapse:collapse" border="1"><tr><td>–ù–ê–ó–í–ê</td><td>–ü–û–ß</td><td>–ü–†–ò–•</td><td>–í–ò–¢–†</td><td>–ö–Ü–ù</td></tr>`;Object.keys(res).forEach(c=>{h+=`<tr><td colspan="5" style="background:#eee"><b>${c}</b></td></tr>`;Object.keys(res[c]).forEach(n=>{const i=res[c][n],e=i.s+i.i-i.o;if(Math.abs(i.s)+i.i+i.o>0.1)h+=`<tr><td>${n}</td><td>${Math.round(i.s)}</td><td>${Math.round(i.i)}</td><td>${Math.round(i.o)}</td><td><b>${Math.round(e)}</b></td></tr>`})});gID('print-view').innerHTML=h+'</table>';gID('mB').innerHTML=h+`</table><button class="btn-main" onclick="window.print()">–î–†–£–ö</button>`}

function makeSmart(id,l,p){let o=`<option value="">${p}</option>`;l.forEach(x=>o+=`<option value="${x}">${x}</option>`);o+=`<option value="NEW" style="color:blue">NEW...</option>`;return `<select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${o}</select><input type="text" id="i_${id}" class="smart-inp" style="display:none" placeholder="${p}">`}
function checkSmart(id){const s=gID('s_'+id),i=gID('i_'+id);if(s.value==='NEW'){s.style.display='none';i.style.display='block';i.focus()}else{i.style.display='none';i.value=''}}
function getSmartVal(id){const s=gID('s_'+id),i=gID('i_'+id);return s.style.display==='none'?i.value:s.value}
function getHistoryDeep(f){const s=new Set();['Vibro_Report','Krup_Report','ZSHM_Report'].forEach(d=>{if(data[d])Object.values(data[d]).forEach(v=>{if(v[f])s.add(v[f])})});return Array.from(s).sort()}

window.delRec=async (c,i)=>{if(!confirm('–í–ò–î–ê–õ–ò–¢–ò –ó–ê–ü–ò–° –¢–ê –ü–û–í–ï–†–ù–£–¢–ò –¢–û–í–ê–† –ù–ê –°–ö–õ–ê–î?'))return;const u={};u[`/${c}/${i}`]=null;stockCatsAll.forEach(cat=>{if(data[cat]){Object.entries(data[cat]).forEach(([key,val])=>{if(val.fLink===i)u[`/${cat}/${key}`]=null})}});try{await db.update(u);alert('–í–∏–¥–∞–ª–µ–Ω–æ, —Ç–æ–≤–∞—Ä –ø–æ–≤–µ—Ä–Ω—É—Ç–æ')}catch(e){alert(e)}};

function addTimeRow(n='',r=''){const i=Date.now()+Math.random();gID('tsRows').insertAdjacentHTML('beforeend',`<div class="ts-row" id="tr_${i}" style="display:grid;grid-template-columns:1fr 80px 30px;gap:2px;margin-bottom:2px"><input type="text" id="tn_${i}" placeholder="–ü–Ü–ë" value="${n}"><input type="number" id="trate_${i}" placeholder="–°—Ç–∞–≤–∫–∞" value="${r}"><button onclick="this.parentElement.remove()" style="background:red;color:white;border:none">x</button></div>`)}
async function saveTimesheetBatch(){const d=gID('gTD').value,s=gID('gTS').value,e=gID('gTE').value,u={},cr=[];let t=0;D.querySelectorAll('#tsRows .ts-row').forEach(r=>{const k=r.id.split('_')[1],n=gID('tn_'+k).value,rt=parseFloat(gID('trate_'+k).value);if(n&&rt>0){cr.push({name:n,rate:rt});t+=rt;u['/Timesheet/'+db.child('Timesheet').push().key]={date:d,name:n,start:s,end:e,rate:rt,ts:new Date().toISOString()}}});if(!cr.length)return alert('–ü—É—Å—Ç–æ');try{await db.update(u);localStorage.setItem('activeCrew',JSON.stringify(cr));alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ! –í—Å—å–æ–≥–æ: '+t)}catch(err){alert(err)}}
function renderTsList(c){const d=data.Timesheet||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card"><div class="j-head">${v.date.split('-').reverse().join('.')}</div><div>${v.name}: ${v.start}-${v.end} (${v.rate} –≥—Ä–Ω)</div>${isAdmin?`<button onclick="delRec('Timesheet','${i}')" style="color:red;border:none;background:0 0;margin-top:5px">DEL</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}

window.openAddPrice=function(){aId=null;gID('mdl').style.display='flex';gID('mT').innerText='–î–û–î–ê–¢–ò –í –ü–†–ê–ô–°';gID('mB').innerHTML=`<div>–¢–û–í–ê–† <input type="text" id="prN"></div><div>–¶–Ü–ù–ê –û–ü–¢ <input type="number" id="prO"></div><div>–¶–Ü–ù–ê –†–û–ó–î–†–Ü–ë <input type="number" id="prR"></div><button class="btn-main" onclick="sPrice()">–ó–ë–ï–†–ï–ì–¢–ò</button>`};
window.editPrice=function(id,n,o,r){aId=id;gID('mdl').style.display='flex';gID('mT').innerText='–†–ï–î–ê–ì–£–í–ê–¢–ò';gID('mB').innerHTML=`<div>–¢–û–í–ê–† <input type="text" id="prN" value="${n}"></div><div>–¶–Ü–ù–ê –û–ü–¢ <input type="number" id="prO" value="${o}"></div><div>–¶–Ü–ù–ê –†–û–ó–î–†–Ü–ë <input type="number" id="prR" value="${r}"></div><button class="btn-main" onclick="sPrice()">–ó–ë–ï–†–ï–ì–¢–ò</button>`};
window.sPrice=async function(){const n=gID('prN').value,o=parseFloat(gID('prO').value)||0,r=parseFloat(gID('prR').value)||0;if(!n)return alert('–ù–∞–∑–≤–∞?');const k=aId||db.child('PriceList').push().key;try{await db.child('PriceList/'+k).set({name:n,priceOpt:o,priceRoz:r});closeModal()}catch(e){alert(e)}};
window.delPrice=async function(i){if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')){await db.child('PriceList/'+i).remove();loadData()}};

function rPriceList(c){
 if(!isAdmin){c.innerHTML='<div style="text-align:center;padding:20px">–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞</div>';return}
 const d=data.PriceList||{}, cats={'–§–∞—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è':[],'–ü–æ–∫—É–ø–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è':[],'–í–ª–∞—Å–Ω–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ':[],'–í—ñ–¥—Ö–æ–¥–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞':[],'–Ü–Ω—à–µ':[]};
 const g=new Set();if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(x=>g.add(x.name));
 const w=new Set();if(data.WeightStock)Object.values(data.WeightStock).forEach(x=>w.add(x.name));
 const dv=new Set();if(data.Stock_DV)Object.values(data.Stock_DV).forEach(x=>dv.add(x.name));
 const f=new Set();if(data.Stock_Feed)Object.values(data.Stock_Feed).forEach(x=>f.add(x.name));
 Object.entries(d).forEach(([i,v])=>{
  if(g.has(v.name))cats['–§–∞—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è'].push({i,v});
  else if(w.has(v.name))cats['–ü–æ–∫—É–ø–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è'].push({i,v});
  else if(dv.has(v.name))cats['–í–ª–∞—Å–Ω–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ'].push({i,v});
  else if(f.has(v.name))cats['–í—ñ–¥—Ö–æ–¥–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞'].push({i,v});
  else cats['–Ü–Ω—à–µ'].push({i,v});
 });
 let h=`<button class="btn-main" onclick="openAddPrice()" style="margin-bottom:10px">+ –¢–û–í–ê–† –£ –ü–†–ê–ô–°</button>`;
 Object.keys(cats).forEach(k=>{if(cats[k].length){
  h+=`<div class="cat-head">${k}</div>`;
  cats[k].sort((a,b)=>a.v.name.localeCompare(b.v.name)).forEach(({i,v})=>{
   h+=`<div class="j-card" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">${v.name}</div><div style="font-size:11px;color:#666">–û–ø—Ç: <span style="color:var(--p);font-weight:900">${v.priceOpt||(v.price||0)}</span> | –†–æ–∑–¥—Ä—ñ–±: <span style="color:var(--s);font-weight:900">${v.priceRoz||0}</span></div></div><div><button onclick="editPrice('${i}','${v.name}',${v.priceOpt||(v.price||0)},${v.priceRoz||0})" style="background:#eef2ff;border:none;padding:5px 10px;border-radius:5px;margin-right:5px">‚úèÔ∏è</button><button onclick="delPrice('${i}')" style="background:#fee2e2;color:red;border:none;padding:5px 10px;border-radius:5px">üóëÔ∏è</button></div></div>`
  });
 }});c.innerHTML=h;
}

function rConsolidated(c){
 let h=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:15px"><button class="btn-main" onclick="openModal('dayRep')" style="background:#0f172a;font-size:10px;margin:0">–î–ï–ù–ù–ò–ô –ó–í–Ü–¢</button><button class="btn-main" onclick="openModal('monthRep')" style="background:#0f172a;font-size:10px;margin:0">–ú–Ü–°–Ø–ß–ù–ò–ô</button><button class="btn-main" onclick="printConsolidated()" style="background:var(--s);font-size:10px;margin:0">üñ®Ô∏è –î–†–£–ö –ó–í–Ü–¢–£</button></div>`;
 const r={};stockCatsAll.forEach(cat=>{if(data[cat]){Object.values(data[cat]).forEach(v=>{if(v.name){if(!r[cat])r[cat]={};r[cat][v.name]=(r[cat][v.name]||0)+v.amount;}})}});
 const drawCat=(name,key)=>{
  if(!r[key])return '';let ch=`<div class="cat-head">${name}</div><div class="item-grid compact-grid" style="grid-template-columns:1fr 1fr">`,has=!1;
  Object.keys(r[key]).sort().forEach(n=>{const v=r[key][n];if(Math.abs(v)>0.1){has=!0;ch+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${Math.round(v)}</div></div>`}});
  ch+='</div>';return has?ch:'';
 };
 h+=drawCat('–§–∞—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è','–ì–æ—Ç–æ–≤–∞—è')+drawCat('–ü–æ–∫—É–ø–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è','WeightStock')+drawCat('–í–ª–∞—Å–Ω–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ','Stock_DV')+drawCat('–í—ñ–¥—Ö–æ–¥–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞','Stock_Feed')+drawCat('–°–∏—Ä–æ–≤–∏–Ω–∞','Stock_Raw')+drawCat('–ü/–§','Stock_Semi');
 const pk={'–ü–ª–µ–Ω–∫–∞':'–ü–ª—ñ–≤–∫–∞','–ü–∞–∫–µ—Ç—ã':'–ü–∞–∫–µ—Ç–∏','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'–°–∫–æ—Ç—á','–ú–µ—à–∫–∏':'–ú—ñ—à–∫–∏','–ù–∏—Ç–∫–∏':'–ù–∏—Ç–∫–∏','–≠—Ç–∏–∫–µ—Ç–∫–∞':'–ï—Ç–∏–∫–µ—Ç–∫–∞','–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':'–°—Ç—Ä–µ–π—á –ø–ª—ñ–≤–∫–∞','–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':'–¢–µ—Ä–º–æ —Å—Ç—Ä—ñ—á–∫–∞'};
 Object.keys(pk).forEach(k=>{
  if(r[k]){
   let ph=`<div class="cat-head">${pk[k]}</div><div class="item-grid compact-grid" style="grid-template-columns:1fr 1fr">`,hp=!1;
   Object.keys(r[k]).sort().forEach(n=>{const v=r[k][n];if(Math.abs(v)>0.1){hp=!0;ph+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty ${v>=0?'val-pos':'val-neg'}">${(k==='–ü–ª–µ–Ω–∫–∞'||k==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')?v.toFixed(2):Math.round(v)}</div></div>`}});
   ph+='</div>';if(hp)h+=ph;
  }
 });
 if(isAdmin)h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:20px"><button class="btn-main" onclick="openModal('arch')" style="background:red">–ó–ì–û–†–¢–ê–ù–ù–Ø</button><button class="btn-main" onclick="openModal('closeMonth')" style="background:orange;color:#000">–ó–ê–ö–†–ò–¢–ò –ú–Ü–°–Ø–¶–¨</button></div>`;
 c.innerHTML=h;
}

window.printConsolidated=function(){
 const r={};stockCatsAll.forEach(cat=>{if(data[cat]){Object.values(data[cat]).forEach(v=>{if(v.name){if(!r[cat])r[cat]={};r[cat][v.name]=(r[cat][v.name]||0)+v.amount}})}});
 const bL=(t,k,u)=>{if(!r[k])return '';let i=Object.keys(r[k]).sort().filter(n=>Math.abs(r[k][n])>0.1).map(n=>`<div class="rep-item"><span class="rep-item-name">${n}</span><span class="rep-item-val">${(k==='–ü–ª–µ–Ω–∫–∞'||k==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')?r[k][n].toFixed(2):Math.round(r[k][n])}${u}</span></div>`);if(!i.length)return '';return `<div class="rep-cat-title">${t}</div>`+i.join('')};
 let L=bL('–§–∞—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è','–ì–æ—Ç–æ–≤–∞—è','—à—Ç')+bL('–ü–æ–∫—É–ø–Ω–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è','WeightStock','–∫–≥')+bL('–í–ª–∞—Å–Ω–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ','Stock_DV','–∫–≥')+bL('–í—ñ–¥—Ö–æ–¥–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞','Stock_Feed','–∫–≥');
 let R=bL('–ü/–§','Stock_Semi','–∫–≥')+bL('–°–∏—Ä–æ–≤–∏–Ω–∞','Stock_Raw','–∫–≥');
 const pk={'–ü–ª–µ–Ω–∫–∞':{n:'–ü–ª—ñ–≤–∫–∞',u:'–∫–≥'},'–ü–∞–∫–µ—Ç—ã':{n:'–ü–∞–∫–µ—Ç–∏',u:'—à—Ç'},'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':{n:'–°–∫–æ—Ç—á',u:'—à—Ç'},'–ú–µ—à–∫–∏':{n:'–ú—ñ—à–∫–∏',u:'—à—Ç'},'–ù–∏—Ç–∫–∏':{n:'–ù–∏—Ç–∫–∏',u:'—à—Ç'},'–≠—Ç–∏–∫–µ—Ç–∫–∞':{n:'–ï—Ç–∏–∫–µ—Ç–∫–∞',u:'—à—Ç'},'–°—Ç—Ä–µ–π—á –ø–ª–µ–Ω–∫–∞':{n:'–°—Ç—Ä–µ–π—á –ø–ª—ñ–≤–∫–∞',u:'—à—Ç'},'–¢–µ—Ä–º–æ –ª–µ–Ω—Ç–∞':{n:'–¢–µ—Ä–º–æ —Å—Ç—Ä—ñ—á–∫–∞',u:'—à—Ç'}};
 Object.keys(pk).forEach(k=>{R+=bL(pk[k].n,k,pk[k].u)});
 let ds=new Date().toLocaleDateString('uk-UA'),h=`<div style="text-align:center;font-weight:900;font-size:18px;margin-bottom:10px">–ó–í–ï–î–ï–ù–ò–ô –ó–í–Ü–¢ –ó–ê–õ–ò–®–ö–Ü–í (${ds})</div><div class="rep-print-container"><div class="rep-col">${L}</div><div class="rep-col">${R}</div></div>`;
 gID('print-view').innerHTML=h;window.print();setTimeout(()=>gID('print-view').innerHTML='',800);
}

// –û–ù–û–í–õ–ï–ù–û: –°–ï–†–í–Ü–°–ù–ê –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø –î–£–ë–õ–Ü–í –ù–£–õ–¨–û–í–ò–• –ó–ê–õ–ò–®–ö–Ü–í
window.runZeroCleanup=async function(){
 if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –Ω—É–ª—å–æ–≤–∏—Ö –∑–∞–ª–∏—à–∫—ñ–≤ –ø–æ –≤—Å—ñ–π –±–∞–∑—ñ? –¶–µ –æ—á–∏—Å—Ç–∏—Ç—å —ñ—Å—Ç–æ—Ä—ñ—é –≤—ñ–¥ —Å–º—ñ—Ç—Ç—è.')) return;
 if(prompt('–í–≤–µ–¥—ñ—Ç—å CLEAN –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è:')!=='CLEAN') return;
 const u={};
 let c=0;
 stockCatsAll.forEach(cat=>{
  if(data[cat]){
   const s=new Set();
   Object.entries(data[cat]).forEach(([k,v])=>{
    if(Math.abs(v.amount)<0.001){
     const h=`${v.date}_${v.name}_${v.note||''}`;
     if(s.has(h)){u[`/${cat}/${k}`]=null;c++;}
     else s.add(h);
    }
   });
  }
 });
 if(c>0){
  try{await db.update(u);alert(`–£—Å–ø—ñ—à–Ω–æ! –í–∏–¥–∞–ª–µ–Ω–æ —Å–º—ñ—Ç—Ç—è: ${c} –∑–∞–ø–∏—Å—ñ–≤. –ë–∞–∑–∞ —Å—Ç–∞–ª–∞ –ª–µ–≥—à–æ—é.`)}catch(e){alert(e)}
 }else{alert('–ë–∞–∑–∞ —á–∏—Å—Ç–∞, –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!')}
};

async function archiveRawBatch(n){if(!confirm(`–ó–∞–∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ –ø–∞—Ä—Ç—ñ—é "${n}"?`))return;const k=db.child('Stock_Archive').push().key,u={},d=data.Stock_Raw||{};let t=0;Object.entries(d).forEach(([id,v])=>{if(v.name===n){t+=v.amount;u['/Stock_Raw/'+id]=null}});u['/Stock_Archive/'+k]={name:n,amount:t,date:new Date().toISOString(),note:'–ê—Ä—Ö—ñ–≤ –ø–∞—Ä—Ç—ñ—ó'};if(Object.keys(u).length>1){await db.update(u);alert('–ü–∞—Ä—Ç—ñ—é –∑–∞–∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ')}}
function rRawArch(c){const d=data.Stock_Archive||{},l=Object.entries(d).sort((a,b)=>b[1].date.localeCompare(a[1].date));let h='';l.forEach(([i,v])=>{h+=`<div class="j-card" style="display:flex;justify-content:space-between"><div><b>${v.name}</b>: ${v.amount.toFixed(2)} –∫–≥</div>${isAdmin?`<button onclick="delRec('Stock_Archive','${i}')" style="color:red;border:none;background:0 0">DEL</button>`:''}</div>`});c.innerHTML=h||'–ü—É—Å—Ç–æ'}
async function runArchive(){const d=gID('archDate').value;if(!d)return;if(prompt('–í–≤–µ–¥—ñ—Ç—å ARCHIVE –¥–ª—è –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –±–∞–∑–∏ –¥–æ '+d)!=='ARCHIVE')return;const u={};stockCatsAll.forEach(c=>{if(!['Timesheet','PriceList','ArchInvoices','ArchIncoming','ArchPackIn','Suppliers'].includes(c)){const cd=data[c]||{},res={};Object.entries(cd).forEach(([k,v])=>{if(v.date.split('T')[0]<=d){res[v.name]=(res[v.name]||0)+v.amount;u[`/${c}/${k}`]=null}});Object.keys(res).forEach(n=>{if(Math.abs(res[n])>0.01)u[`/${c}/${db.child(c).push().key}`]={name:n,amount:res[n],date:d+"T23:59:59Z",note:'–ó–≥–æ—Ä—Ç–∞–Ω–Ω—è'}})}});if(Object.keys(u).length){await db.update(u);alert('–£—Å–ø—ñ—à–Ω–æ –∑–≥–æ—Ä–Ω—É—Ç–æ')}closeModal()}
async function runCloseMonth(){const d=gID('cmDate').value;if(!d)return;if(prompt('–í–≤–µ–¥—ñ—Ç—å CLOSE –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è')!=='CLOSE')return;const u={};stockCatsAll.forEach(c=>{if(!['Timesheet','PriceList','ArchInvoices','ArchIncoming','ArchPackIn','Suppliers'].includes(c)){const cd=data[c]||{};Object.entries(cd).forEach(([k,v])=>{if(v.date.split('T')[0]<=d)u[`/${c}/${k}`]=null})}});if(Object.keys(u).length){await db.update(u);alert('–ú—ñ—Å—è—Ü—å –∑–∞–∫—Ä–∏—Ç–æ, –∑–∞–ª–∏—à–∫–∏ –æ–±–Ω—É–ª–µ–Ω–æ')}closeModal()}
</script></body></html>
